<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title | default: site.title }}</title>
  <meta name="description" content="{{ page.description | default: site.description }}">
  <meta name="color-scheme" content="light dark">
  
  <!-- Favicons - Updated paths -->
  <link rel="icon" type="image/png" href="{{ '/assets/images/favicons/favicon-96x96.png' | relative_url }}" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="{{ '/assets/images/favicons/favicon.svg' | relative_url }}" />
  <link rel="shortcut icon" href="{{ '/assets/images/favicons/favicon.ico' | relative_url }}" />
  <link rel="apple-touch-icon" sizes="180x180" href="{{ '/assets/images/favicons/apple-touch-icon.png' | relative_url }}" />
  <meta name="apple-mobile-web-app-title" content="Bay Area Discounts" />
  <link rel="manifest" href="{{ '/assets/images/favicons/site.webmanifest' | relative_url }}" />
  
  <!-- PWA Theme Color -->
  <meta name="theme-color" content="#00acc1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- Instant theme application - prevents flash of wrong theme -->
  <script>
    (function() {
      var theme = localStorage.getItem('theme-preference') || 'auto';
      var isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    })();
  </script>

  <!-- Core styles - Design tokens must load first -->
  <link rel="stylesheet" href="{{ '/assets/css/design-tokens.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/base.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/responsive-optimized.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/accessibility-toolbar.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/read-more.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/features.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/flutter-interactions.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/modern-ui.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/modals.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/components.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/desktop-sidebar.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/for-you.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/eligibility-wizard.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/eligibility-guide.css' | relative_url }}">

  <!-- Privacy-friendly analytics by Plausible -->
  <link rel="preconnect" href="https://plausible.baytides.org" crossorigin>
  <script defer data-domain="{{ site.url | replace: 'https://', '' | replace: 'http://', '' }}" src="https://plausible.baytides.org/js/script.js"></script>

  <!-- Sentry Error Tracking (privacy-preserving, errors only) -->
  <script
    src="https://js.sentry-cdn.com/e45b1ba128934c2ef59964ec0fa76b4f.min.js"
    crossorigin="anonymous"
  ></script>
  <script>
    if (window.Sentry) {
      Sentry.onLoad(function() {
        Sentry.init({
          // No performance tracing - errors only
          tracesSampleRate: 0,
          // No session replay
          replaysSessionSampleRate: 0,
          replaysOnErrorSampleRate: 0,
          // Strip PII from error reports
          beforeSend(event) {
            // Remove IP address
            if (event.user) {
              delete event.user.ip_address;
            }
            // Remove any request headers that might contain PII
            if (event.request) {
              delete event.request.cookies;
              delete event.request.headers;
            }
            return event;
          },
          // Don't send default PII
          sendDefaultPii: false,
        });
      });
    }
  </script>

  <!-- SEO / social -->
  <link rel="canonical" href="{{ page.url | absolute_url }}">
  <meta property="og:title" content="{{ page.title | default: site.title }}">
  <meta property="og:description" content="{{ page.description | default: site.description }}">
  <meta property="og:url" content="{{ page.url | absolute_url }}">
  <meta property="og:type" content="website">
  <meta property="og:image" content="{{ site.url }}{{ '/assets/images/logo/banner.png' | relative_url }}">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="{{ page.title | default: site.title }}">
  <meta name="twitter:description" content="{{ page.description | default: site.description }}">
  <meta name="twitter:image" content="{{ site.url }}{{ '/assets/images/logo/banner.png' | relative_url }}">
</head>
<body class="{% if page.sidebar != false %}has-sidebar{% endif %}">
  <a class="skip-link" href="#main-content">Skip to main content</a>

  {% if page.sidebar != false %}
    {% include desktop-sidebar.html %}
  {% endif %}

  {% include utility-bar.html %}

  <main id="main-content" role="main">
    <div class="container">
      {% if page.actions == true %}
        <!-- Share button temporarily disabled (archive kept) -->
      {% endif %}
      {{ content }}
    </div>
  </main>

  {% include footer.html %}
  {% include mobile-bottom-nav.html %}

  <!-- Shared Utilities (must load first) -->
  <script src="{{ '/assets/js/utils.js' | relative_url }}"></script>

  <!-- Search/Filter JavaScript - exclude from students page -->
  {% if page.url != '/students.html' %}
    <script src="{{ '/assets/js/search-filter.js' | relative_url }}"></script>
    <script src="{{ '/assets/js/filter-presets.js' | relative_url }}"></script>
    <script src="{{ '/assets/js/program-modal.js' | relative_url }}"></script>
  {% endif %}

  <!-- Feedback System -->
  <script src="{{ '/assets/js/feedback.js' | relative_url }}"></script>

  <!-- APCA Contrast Checker (WCAG 3.0) -->
  <script src="{{ '/assets/js/apca-contrast.js' | relative_url }}"></script>

  <!-- Accessibility Toolbar -->
  <script src="{{ '/assets/js/accessibility-toolbar.js' | relative_url }}"></script>

  <!-- Simple Language Mode Enhancements -->
  <script src="{{ '/assets/js/simple-language.js' | relative_url }}"></script>

  <!-- Read More Functionality -->
  <script src="{{ '/assets/js/read-more.js' | relative_url }}"></script>

  <!-- Flutter-Inspired Interactions (Ripples, Haptics) -->
  <script src="{{ '/assets/js/flutter-interactions.js' | relative_url }}"></script>

  <!-- Desktop Sidebar Navigation -->
  <script src="{{ '/assets/js/desktop-sidebar.js' | relative_url }}"></script>

  <!-- Keyboard Shortcuts -->
  <script src="{{ '/assets/js/keyboard-shortcuts.js' | relative_url }}"></script>

  <!-- For You / Personalization -->
  <script src="{{ '/assets/js/for-you.js' | relative_url }}"></script>

  <!-- Eligibility Wizard -->
  <script src="{{ '/assets/js/eligibility-wizard.js' | relative_url }}"></script>

  <!-- Eligibility Guide Interactive Features -->
  <script src="{{ '/assets/js/eligibility-guide.js' | relative_url }}"></script>

  <!-- Inline JavaScript for PWA and global search -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // ============== GLOBAL SEARCH FUNCTIONALITY ==============
      
      const globalSearch = document.querySelector('input[type="search"]#global-search');
      
      if (globalSearch) {
        globalSearch.addEventListener('input', function() {
          const query = this.value.toLowerCase();
          const tables = document.querySelectorAll('table');
          
          tables.forEach(table => {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(query) ? '' : 'none';
            });
          });
        });
      }
      
      // Keyboard shortcut (Ctrl/Cmd + K) to focus global search
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          if (globalSearch) globalSearch.focus();
        }
      });
      
      // Announce search results to screen readers
      const searchBoxes = document.querySelectorAll('.table-search');
      searchBoxes.forEach(box => {
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.style.cssText = 'position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;';
        box.parentNode.insertBefore(announcement, box.nextSibling);
        
        box.addEventListener('keyup', function() {
          const visibleRows = Array.from(this.nextElementSibling.nextElementSibling.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none').length;
          announcement.textContent = `${visibleRows} result${visibleRows !== 1 ? 's' : ''} found`;
        });
      });
      
      // ============== PWA FUNCTIONALITY ==============
      
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register("{{ '/sw.js' | relative_url }}")
            .then(registration => {
              console.log('ServiceWorker registered:', registration);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed:', err);
            });
        });
      }

      // Expose install prompt globally for utility bar install button
      window.deferredPrompt = null;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        window.deferredPrompt = e;

        // Show the install button in the utility bar
        const installItem = document.getElementById('install-app-item');
        if (installItem) {
          installItem.style.display = '';
        }
      });

      // Helper to trigger install from utility bar
      window.triggerPWAInstall = async () => {
        if (!window.deferredPrompt) {
          return;
        }
        window.deferredPrompt.prompt();
        const { outcome } = await window.deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        window.deferredPrompt = null;

        // Hide the install button after prompt
        const installItem = document.getElementById('install-app-item');
        if (installItem) {
          installItem.style.display = 'none';
        }
      };

      window.addEventListener('appinstalled', () => {
        console.log('PWA installed');
        window.deferredPrompt = null;

        // Hide the install button
        const installItem = document.getElementById('install-app-item');
        if (installItem) {
          installItem.style.display = 'none';
        }
      });

      // Initialize search/filter after page loads
      if (typeof searchFilter !== 'undefined' && searchFilter.buildIndex) {
        searchFilter.buildIndex();
      }
    });
  </script>
</body>
</html>
