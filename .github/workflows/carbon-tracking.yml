name: Carbon Footprint Tracking

on:
  workflow_run:
    workflows: ['CI', 'Deploy Website (Azure)']
    types: [completed]
  schedule:
    # Run weekly summary on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  track-carbon:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Get workflow run data
        id: workflow-data
        uses: actions/github-script@v8
        with:
          script: |
            // Get recent workflow runs from the past week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const workflows = ['CI', 'Deploy Website (Azure)', 'Build FOSS APK'];
            let totalMinutes = 0;
            let runCount = 0;

            for (const workflowName of workflows) {
              try {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflowName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '.yml',
                  created: `>=${oneWeekAgo.toISOString().split('T')[0]}`,
                  status: 'completed',
                  per_page: 100
                });

                for (const run of runs.data.workflow_runs) {
                  // Get timing for each run
                  const timing = await github.rest.actions.getWorkflowRunUsage({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });

                  if (timing.data.run_duration_ms) {
                    totalMinutes += timing.data.run_duration_ms / 60000;
                    runCount++;
                  }
                }
              } catch (e) {
                console.log(`Could not fetch ${workflowName}: ${e.message}`);
              }
            }

            core.setOutput('total_minutes', totalMinutes.toFixed(2));
            core.setOutput('run_count', runCount);

            // Estimate carbon using eco-ci methodology
            // Average GitHub runner: ~10W TDP, ~0.4 kg CO2e/kWh (US grid average)
            const kWh = (totalMinutes / 60) * 0.01; // 10W = 0.01 kW
            const carbonGrams = kWh * 400; // 400g CO2e per kWh (conservative estimate)

            core.setOutput('estimated_kwh', kWh.toFixed(4));
            core.setOutput('estimated_carbon_grams', carbonGrams.toFixed(2));

      - name: Generate carbon report
        run: |
          mkdir -p .carbon-reports
          cat > .carbon-reports/weekly-summary.json << 'EOF'
          {
            "generated_at": "${{ github.event.workflow_run.created_at || github.event.repository.updated_at }}",
            "period": "weekly",
            "metrics": {
              "total_ci_minutes": ${{ steps.workflow-data.outputs.total_minutes || 0 }},
              "workflow_runs": ${{ steps.workflow-data.outputs.run_count || 0 }},
              "estimated_kwh": ${{ steps.workflow-data.outputs.estimated_kwh || 0 }},
              "estimated_carbon_grams": ${{ steps.workflow-data.outputs.estimated_carbon_grams || 0 }}
            },
            "offsets": {
              "github_renewable_energy_percent": 100,
              "azure_carbon_neutral": true,
              "cloudflare_green_hosting": true
            },
            "notes": "GitHub Actions runners are powered by 100% renewable energy. Azure and Cloudflare both operate carbon-neutral infrastructure."
          }
          EOF

          echo "## Weekly Carbon Footprint Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| CI Minutes Used | ${{ steps.workflow-data.outputs.total_minutes || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Runs | ${{ steps.workflow-data.outputs.run_count || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Energy (kWh) | ${{ steps.workflow-data.outputs.estimated_kwh || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Carbon (g CO2e) | ${{ steps.workflow-data.outputs.estimated_carbon_grams || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Green Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions: 100% renewable energy" >> $GITHUB_STEP_SUMMARY
          echo "- Azure: Carbon neutral since 2012" >> $GITHUB_STEP_SUMMARY
          echo "- Cloudflare: 100% renewable energy" >> $GITHUB_STEP_SUMMARY

      - name: Upload carbon report
        uses: actions/upload-artifact@v4
        with:
          name: carbon-report-${{ github.run_number }}
          path: .carbon-reports/
          retention-days: 90
