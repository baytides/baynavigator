name: F-Droid Repo Update

# Generates F-Droid repository index files
on:
  workflow_run:
    workflows: ['Release']
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  update-repo:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Setup repo directory
        run: |
          mkdir -p repo

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Get latest release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest release
          RELEASE_JSON=$(gh release view --json tagName,name,publishedAt,assets)
          TAG=$(echo "$RELEASE_JSON" | jq -r '.tagName')
          VERSION="${TAG#v}"
          PUBLISHED=$(echo "$RELEASE_JSON" | jq -r '.publishedAt')

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "PUBLISHED=$PUBLISHED" >> $GITHUB_OUTPUT

          # Download FOSS APK
          gh release download "$TAG" --pattern "*-foss.apk" --dir repo --clobber || true

          # Rename to standard F-Droid format
          if [ -f "repo/bay-navigator-foss.apk" ]; then
            mv "repo/bay-navigator-foss.apk" "repo/org.baytides.baynavigator_${VERSION}.apk"
          fi

      - name: Setup F-Droid repo keystore
        run: |
          # Decode the repo signing keystore from secrets
          echo "${{ secrets.FDROID_KEYSTORE_BASE64 }}" | base64 -d > fdroid-keystore.p12
          chmod 600 fdroid-keystore.p12

      - name: Copy icon
        run: |
          mkdir -p repo/icons
          # Fetch icon from main branch since we're on gh-pages
          curl -sL "https://raw.githubusercontent.com/baytides/baynavigator/main/assets/images/favicons/favicon-96x96.png" -o repo/icons/icon.png
          # Also copy to repo root for F-Droid repo icon
          cp repo/icons/icon.png repo/icon.png

      - name: Generate F-Droid repo index
        run: |
          VERSION="${{ steps.release.outputs.VERSION }}"
          PUBLISHED="${{ steps.release.outputs.PUBLISHED }}"
          APK_PATH="repo/org.baytides.baynavigator_${VERSION}.apk"
          TIMESTAMP=$(date +%s)

          if [ ! -f "$APK_PATH" ]; then
            echo "No FOSS APK found, skipping index generation"
            exit 0
          fi

          # Get APK info using aapt2
          AAPT_OUTPUT=$(aapt2 dump badging "$APK_PATH" 2>/dev/null || aapt dump badging "$APK_PATH" 2>/dev/null || true)
          VERSION_CODE=$(echo "$AAPT_OUTPUT" | grep -oP "versionCode='\K[^']+" || echo "")
          VERSION_NAME=$(echo "$AAPT_OUTPUT" | grep -oP "versionName='\K[^']+" || echo "")
          MIN_SDK=$(echo "$AAPT_OUTPUT" | grep -oP "minSdkVersion='\K[^']+" || echo "24")

          # Fallbacks
          VERSION_CODE="${VERSION_CODE:-10403}"
          VERSION_NAME="${VERSION_NAME:-$VERSION}"

          # Get file info
          FILE_SIZE=$(stat -c%s "$APK_PATH")
          SHA256=$(sha256sum "$APK_PATH" | cut -d' ' -f1)
          APK_FILENAME=$(basename "$APK_PATH")
          ADDED_DATE=$(date -d "$PUBLISHED" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)

          # Extract APK signing certificate fingerprints using apksigner from Android SDK
          # sig = MD5 of the signing certificate (lowercase, no colons)
          # signer = SHA256 of the signing certificate (lowercase, no colons)
          APKSIGNER="${ANDROID_HOME}/build-tools/$(ls ${ANDROID_HOME}/build-tools/ | tail -1)/apksigner"
          echo "Using apksigner: $APKSIGNER"

          CERT_OUTPUT=$("$APKSIGNER" verify --print-certs "$APK_PATH" 2>&1) || true
          echo "Cert output: $CERT_OUTPUT"

          SIG_SHA256=$(echo "$CERT_OUTPUT" | grep "certificate SHA-256" | head -1 | sed 's/.*: //' | tr -d ' ' | tr '[:upper:]' '[:lower:]')
          SIG_MD5=$(echo "$CERT_OUTPUT" | grep "certificate MD5" | head -1 | sed 's/.*: //' | tr -d ' ' | tr '[:upper:]' '[:lower:]')

          echo "Certificate fingerprints - MD5: $SIG_MD5, SHA256: $SIG_SHA256"

          # Copy icon with version code name for F-Droid
          cp repo/icons/icon.png "repo/icons/org.baytides.baynavigator.${VERSION_CODE}.png"

          # Generate index-v2.json (modern F-Droid format with localized strings)
          ADDED_TIMESTAMP=$(date -d "$ADDED_DATE" +%s000 2>/dev/null || echo $((TIMESTAMP * 1000)))
          TIMESTAMP_MS=$((TIMESTAMP * 1000))

          # Calculate icon hash and size
          ICON_SHA256=$(sha256sum "repo/icons/org.baytides.baynavigator.${VERSION_CODE}.png" | cut -d' ' -f1)
          ICON_SIZE=$(stat -c%s "repo/icons/org.baytides.baynavigator.${VERSION_CODE}.png")

          jq -cn \
            --argjson timestamp "$TIMESTAMP_MS" \
            --argjson added "$ADDED_TIMESTAMP" \
            --argjson versionCode "$VERSION_CODE" \
            --argjson size "$FILE_SIZE" \
            --argjson minSdk "$MIN_SDK" \
            --argjson iconSize "$ICON_SIZE" \
            --arg versionName "$VERSION_NAME" \
            --arg hash "$SHA256" \
            --arg signer "$SIG_SHA256" \
            --arg apkName "$APK_FILENAME" \
            --arg iconPath "/icons/org.baytides.baynavigator.${VERSION_CODE}.png" \
            --arg iconHash "$ICON_SHA256" \
            '{
              repo: {
                name: {"en-US": "Bay Navigator"},
                description: {"en-US": "Bay Navigator FOSS Repository - Free and open-source builds without proprietary dependencies"},
                icon: {"en-US": {name: "/icons/icon.png", sha256: $iconHash, size: $iconSize}},
                address: "https://foss.baynavigator.org/repo",
                timestamp: $timestamp,
                categories: {
                  "Money": {
                    name: {"en-US": "Money"}
                  }
                }
              },
              packages: {
                "org.baytides.baynavigator": {
                  metadata: {
                    name: {"en-US": "Bay Navigator"},
                    summary: {"en-US": "Discover discount programs across the Bay Area"},
                    description: {"en-US": "Browse hundreds of discount and assistance programs available to Bay Area residents.\n\nFeatures:\n* Filter by county, category, and eligibility\n* Save your favorite programs\n* Search across all programs\n* Works offline\n* No ads, no tracking\n\nThis is the FOSS build without proprietary dependencies."},
                    license: "Proprietary",
                    webSite: "https://baynavigator.org",
                    sourceCode: "https://github.com/baytides/baynavigator",
                    issueTracker: "https://github.com/baytides/baynavigator/issues",
                    categories: ["Money"],
                    added: $added,
                    lastUpdated: $timestamp,
                    icon: {"en-US": {name: $iconPath, sha256: $iconHash, size: $iconSize}}
                  },
                  versions: {
                    ($hash): {
                      added: $timestamp,
                      file: {
                        name: ("/" + $apkName),
                        sha256: $hash,
                        size: $size
                      },
                      manifest: {
                        versionName: $versionName,
                        versionCode: $versionCode,
                        minSdkVersion: $minSdk,
                        targetSdkVersion: 35,
                        signer: {sha256: [$signer]},
                        nativecode: ["arm64-v8a", "armeabi-v7a", "x86", "x86_64"]
                      }
                    }
                  }
                }
              }
            }' > repo/index-v2.json

          # Calculate index-v2.json hash and size for entry.json
          INDEX_V2_SHA256=$(sha256sum repo/index-v2.json | cut -d' ' -f1)
          INDEX_V2_SIZE=$(stat -c%s repo/index-v2.json)

          # Also generate index-v1.json for legacy clients
          jq -cn \
            --argjson timestamp "$TIMESTAMP" \
            --argjson added "$ADDED_TIMESTAMP" \
            --argjson lastUpdated "$TIMESTAMP_MS" \
            --argjson versionCode "$VERSION_CODE" \
            --argjson size "$FILE_SIZE" \
            --argjson minSdk "$MIN_SDK" \
            --arg versionName "$VERSION_NAME" \
            --arg hash "$SHA256" \
            --arg sig "$SIG_MD5" \
            --arg signer "$SIG_SHA256" \
            --arg apkName "$APK_FILENAME" \
            --arg iconName "icons/org.baytides.baynavigator.${VERSION_CODE}.png" \
            '{
              repo: {
                timestamp: $timestamp,
                version: 21,
                name: "Bay Navigator",
                icon: "icon.png",
                address: "https://foss.baynavigator.org/repo",
                description: "Bay Navigator FOSS Repository - Free and open-source builds without proprietary dependencies"
              },
              apps: [{
                packageName: "org.baytides.baynavigator",
                name: "Bay Navigator",
                summary: "Discover discount programs across the Bay Area",
                description: "Browse hundreds of discount and assistance programs available to Bay Area residents.\n\nFeatures:\n* Filter by county, category, and eligibility\n* Save your favorite programs\n* Search across all programs\n* Works offline\n* No ads, no tracking\n\nThis is the FOSS build without proprietary dependencies.",
                license: "Proprietary",
                webSite: "https://baynavigator.org",
                sourceCode: "https://github.com/baytides/baynavigator",
                issueTracker: "https://github.com/baytides/baynavigator/issues",
                categories: ["Money"],
                added: $added,
                lastUpdated: $lastUpdated,
                icon: $iconName
              }],
              packages: {
                "org.baytides.baynavigator": [{
                  packageName: "org.baytides.baynavigator",
                  versionName: $versionName,
                  versionCode: $versionCode,
                  added: $lastUpdated,
                  size: $size,
                  minSdkVersion: $minSdk,
                  targetSdkVersion: 35,
                  hash: $hash,
                  hashType: "sha256",
                  sig: $sig,
                  signer: $signer,
                  apkName: $apkName,
                  nativecode: ["arm64-v8a", "armeabi-v7a", "x86", "x86_64"]
                }]
              }
            }' > repo/index-v1.json

          # Also generate legacy index.xml for older clients
          cat > repo/index.xml << XMLEOF
          <?xml version="1.0" encoding="UTF-8"?>
          <fdroid>
            <repo name="Bay Navigator" icon="icons/icon.png" url="https://foss.baynavigator.org/repo" version="21" timestamp="$TIMESTAMP">
              <description>Bay Navigator FOSS Repository</description>
            </repo>
            <application id="org.baytides.baynavigator">
              <id>org.baytides.baynavigator</id>
              <added>$ADDED_DATE</added>
              <lastupdated>$(date +%Y-%m-%d)</lastupdated>
              <name>Bay Navigator</name>
              <summary>Discover discount programs across the Bay Area</summary>
              <desc>Browse hundreds of discount and assistance programs available to Bay Area residents. Filter by county, category, and eligibility. Save favorites, search programs, and access them offline.</desc>
              <license>Proprietary</license>
              <categories>Money</categories>
              <category>Money</category>
              <web>https://baynavigator.org</web>
              <source>https://github.com/baytides/baynavigator</source>
              <tracker>https://github.com/baytides/baynavigator/issues</tracker>
              <marketversion>$VERSION_NAME</marketversion>
              <marketvercode>$VERSION_CODE</marketvercode>
              <package>
                <version>$VERSION_NAME</version>
                <versioncode>$VERSION_CODE</versioncode>
                <apkname>$APK_FILENAME</apkname>
                <hash type="sha256">$SHA256</hash>
                <size>$FILE_SIZE</size>
                <added>$ADDED_DATE</added>
              </package>
            </application>
          </fdroid>
          XMLEOF

          echo "Generated index files for version $VERSION_NAME ($VERSION_CODE)"

      - name: Sign F-Droid repo index
        run: |
          # Create signed JAR from index-v1.json
          if [ -f "repo/index-v1.json" ]; then
            # Calculate SHA256 of index-v1.json for entry.json
            INDEX_V1_SHA256=$(sha256sum repo/index-v1.json | cut -d' ' -f1)
            INDEX_V1_SIZE=$(stat -c%s repo/index-v1.json)

            # Create a temp directory for signing
            mkdir -p temp_jar
            cp repo/index-v1.json temp_jar/

            # Create unsigned JAR
            cd temp_jar
            jar cf ../repo/index-v1.unsigned.jar index-v1.json
            cd ..

            # Sign the JAR using jarsigner with SHA-256
            jarsigner -keystore fdroid-keystore.p12 \
              -storetype PKCS12 \
              -storepass "${{ secrets.FDROID_KEYSTORE_PASSWORD }}" \
              -digestalg SHA-256 \
              -sigalg SHA256withRSA \
              -signedjar repo/index-v1.jar \
              repo/index-v1.unsigned.jar \
              fdroid-repo

            # Clean up
            rm -rf temp_jar repo/index-v1.unsigned.jar

            echo "Created signed index-v1.jar"

            # Calculate index-v2.json hash and size for entry.json
            INDEX_V2_SHA256=$(sha256sum repo/index-v2.json | cut -d' ' -f1)
            INDEX_V2_SIZE=$(stat -c%s repo/index-v2.json)

            # Create entry.json pointing to index-v2.json (required for modern F-Droid clients)
            ENTRY_TIMESTAMP=$(date +%s)
            printf '{"timestamp":%s000,"version":20002,"maxAge":14,"index":{"name":"/index-v2.json","sha256":"%s","size":%s,"numPackages":1}}' \
              "$ENTRY_TIMESTAMP" "$INDEX_V2_SHA256" "$INDEX_V2_SIZE" > repo/entry.json

            echo "Created entry.json"

            # Sign entry.json as entry.jar
            mkdir -p temp_jar
            cp repo/entry.json temp_jar/

            cd temp_jar
            jar cf ../repo/entry.unsigned.jar entry.json
            cd ..

            jarsigner -keystore fdroid-keystore.p12 \
              -storetype PKCS12 \
              -storepass "${{ secrets.FDROID_KEYSTORE_PASSWORD }}" \
              -digestalg SHA-256 \
              -sigalg SHA256withRSA \
              -signedjar repo/entry.jar \
              repo/entry.unsigned.jar \
              fdroid-repo

            rm -rf temp_jar repo/entry.unsigned.jar

            echo "Created signed entry.jar"
          fi

          # Also sign the legacy index.xml
          if [ -f "repo/index.xml" ]; then
            mkdir -p temp_jar
            cp repo/index.xml temp_jar/

            cd temp_jar
            jar cf ../repo/index.unsigned.jar index.xml
            cd ..

            jarsigner -keystore fdroid-keystore.p12 \
              -storetype PKCS12 \
              -storepass "${{ secrets.FDROID_KEYSTORE_PASSWORD }}" \
              -digestalg SHA-256 \
              -sigalg SHA256withRSA \
              -signedjar repo/index.jar \
              repo/index.unsigned.jar \
              fdroid-repo

            rm -rf temp_jar repo/index.unsigned.jar

            echo "Created signed index.jar"
          fi

          # List generated files
          echo "Generated repo files:"
          ls -la repo/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Clean up sensitive files
          rm -f fdroid-keystore.p12

          # Add all repo files including signed indexes
          git add repo/

          git diff --staged --quiet || git commit -m "Update F-Droid repo for ${{ steps.release.outputs.TAG }}"
          git push
