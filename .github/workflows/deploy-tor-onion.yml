name: Deploy Tor Hidden Service VM

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - get-onion-address
        default: 'deploy'

permissions:
  id-token: write
  contents: write

env:
  RESOURCE_GROUP: baynavigator-tor-rg
  LOCATION: westus2

jobs:
  deploy-tor-vm:
    if: github.event.inputs.action == 'deploy'
    runs-on: ubuntu-latest
    name: Deploy Tor Hidden Service VM

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --tags project=baynavigator purpose=tor-hidden-service

      - name: Deploy Bicep template
        uses: azure/arm-deploy@v2
        id: deploy
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.RESOURCE_GROUP }}
          template: infrastructure/tor-onion/main.bicep
          parameters: sshPublicKey="${{ secrets.TOR_VM_SSH_PUBLIC_KEY }}" backendUrl=https://baynavigator.org
          failOnStdErr: false

      - name: Deployment summary
        run: |
          echo "## ðŸ§… Tor Hidden Service Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait ~2-3 minutes for cloud-init to complete" >> $GITHUB_STEP_SUMMARY
          echo "2. Run the 'get-onion-address' action to retrieve your .onion address" >> $GITHUB_STEP_SUMMARY
          echo "3. Or SSH to the VM and run: \`sudo cat /var/lib/tor/baynavigator/hostname\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SSH Access" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deploy.outputs.sshCommand }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  get-onion-address:
    if: github.event.inputs.action == 'get-onion-address'
    runs-on: ubuntu-latest
    name: Get .onion Address

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get VM Public IP
        id: vm
        run: |
          FQDN=$(az network public-ip show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name baynavigator-tor-pip \
            --query "dnsSettings.fqdn" -o tsv)
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TOR_VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.vm.outputs.fqdn }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Retrieve .onion Address
        id: onion
        run: |
          ONION_ADDRESS=$(ssh -o StrictHostKeyChecking=no azureuser@${{ steps.vm.outputs.fqdn }} \
            "sudo cat /var/lib/tor/baynavigator/hostname" 2>/dev/null || echo "NOT_READY")
          echo "address=$ONION_ADDRESS" >> $GITHUB_OUTPUT

      - name: Update site config with .onion address
        if: steps.onion.outputs.address != 'NOT_READY'
        run: |
          # Update the site-config.yml with the .onion address
          sed -i 's|^onion_address:.*|onion_address: "${{ steps.onion.outputs.address }}"|' src/data/site-config.yml

          # Check if there are changes
          if git diff --quiet src/data/site-config.yml; then
            echo "No changes to .onion address"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Updating .onion address in site config"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        id: update

      - name: Commit and push .onion address
        if: steps.update.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/data/site-config.yml
          git commit -m "Update .onion address to ${{ steps.onion.outputs.address }}"
          git push

      - name: Display .onion Address
        run: |
          echo "## Bay Navigator .onion Address" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.onion.outputs.address }}" != "NOT_READY" ]; then
            echo "### Your .onion address:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.onion.outputs.address }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Access your site via Tor Browser at:" >> $GITHUB_STEP_SUMMARY
            echo "**http://${{ steps.onion.outputs.address }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.update.outputs.changed }}" == "true" ]; then
              echo "The .onion address has been saved to the repository and will appear on the About page after the next deployment." >> $GITHUB_STEP_SUMMARY
            else
              echo "The .onion address is already up to date in the repository." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "Tor hidden service is still initializing. Please wait a few minutes and try again." >> $GITHUB_STEP_SUMMARY
          fi
