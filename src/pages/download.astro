---
import BaseLayout from '../layouts/BaseLayout.astro';

// Fetch latest release from GitHub API at build time
let latestRelease = null;
let fossApk = null;

try {
  const response = await fetch('https://api.github.com/repos/baytides/baynavigator/releases/latest');
  if (response.ok) {
    latestRelease = await response.json();
    fossApk = latestRelease.assets?.find((a: any) => a.name === 'bay-navigator-foss.apk');
  }
} catch (e) {
  console.error('Failed to fetch release:', e);
}

const version = latestRelease?.tag_name || 'v0.1.0';
const releaseDate = latestRelease?.published_at
  ? new Date(latestRelease.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
  : null;
const downloadUrl = fossApk?.browser_download_url || `https://github.com/baytides/baynavigator/releases/latest/download/bay-navigator-foss.apk`;
const downloadSize = fossApk?.size ? (fossApk.size / 1024 / 1024).toFixed(1) : null;
---

<BaseLayout
  title="Download"
  description="Download the Bay Navigator Android app - free, open source, and privacy-focused."
>
  <section class="section">
    <div class="container-page">
      <div class="max-w-3xl mx-auto">
        <h1 class="text-4xl font-bold text-neutral-900 dark:text-white mb-6">
          Download Bay Navigator
        </h1>

        <p class="text-lg text-neutral-600 dark:text-neutral-300 mb-8">
          Get the Bay Navigator app for Android. Free, open source, and works offline.
        </p>

        <!-- FOSS APK Download Card -->
        <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-6 mb-8">
          <div class="flex items-start gap-4">
            <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg">
              <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.523 2H6.477C5.1 2 4 3.1 4 4.477v15.046C4 20.9 5.1 22 6.477 22h11.046C18.9 22 20 20.9 20 19.523V4.477C20 3.1 18.9 2 17.523 2zM12 3.5c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zm0 18c-1.105 0-2-.895-2-2h4c0 1.105-.895 2-2 2zm5-4H7V6h10v11.5z"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <h2 class="text-xl font-bold text-neutral-900 dark:text-white">
                  Android APK (FOSS)
                </h2>
                <span class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-medium px-2 py-0.5 rounded">
                  Open Source
                </span>
              </div>
              <p class="text-neutral-600 dark:text-neutral-300 mb-4">
                Direct download for Android devices. No Google Play required.
              </p>

              <div class="flex flex-wrap items-center gap-4 mb-4 text-sm text-neutral-500 dark:text-neutral-400">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                  </svg>
                  {version}
                </span>
                {downloadSize && (
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                    </svg>
                    {downloadSize} MB
                  </span>
                )}
                {releaseDate && (
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    {releaseDate}
                  </span>
                )}
              </div>

              <a
                href={downloadUrl}
                class="inline-flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white font-medium px-6 py-3 rounded-lg transition-colors no-underline"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download APK
              </a>
            </div>
          </div>
        </div>

        <!-- Installation Instructions -->
        <div class="bg-primary-50 dark:bg-primary-900/20 border-l-4 border-primary-500 p-4 rounded-r-lg mb-8">
          <h3 class="font-semibold text-neutral-900 dark:text-white mb-2">Installation Instructions</h3>
          <ol class="text-neutral-700 dark:text-neutral-300 space-y-1 list-decimal list-inside">
            <li>Download the APK file to your Android device</li>
            <li>Open the file (you may need to allow installation from unknown sources)</li>
            <li>Follow the on-screen prompts to install</li>
          </ol>
        </div>

        <hr class="my-8 border-neutral-200 dark:border-neutral-700" />

        <!-- Other Download Options -->
        <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-4">
          Other Options
        </h2>

        <!-- App Store Badges (horizontal, same height) -->
        <div class="flex flex-wrap items-center justify-center gap-4 mb-6">
          <!-- App Store badge -->
          <div class="flex flex-col items-center gap-2">
            <img
              src="https://tools.applemediaservices.com/api/badges/download-on-the-app-store/black/en-us?size=250x83"
              alt="Download on the App Store"
              class="h-[40px] w-auto grayscale opacity-60"
            />
            <p class="text-xs text-neutral-500 dark:text-neutral-400">Coming soon</p>
          </div>
          <!-- Google Play badge -->
          <div class="flex flex-col items-center gap-2">
            <img
              src="https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png"
              alt="Get it on Google Play"
              class="h-[40px] w-auto grayscale opacity-60"
            />
            <p class="text-xs text-neutral-500 dark:text-neutral-400">Coming soon</p>
          </div>
        </div>

        <!-- Other options -->
        <div class="grid gap-4 sm:grid-cols-3 mb-8">
          <!-- F-Droid (coming soon) -->
          <div class="bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg p-4 opacity-60">
            <div class="flex items-center gap-3 mb-2">
              <svg class="w-6 h-6 text-neutral-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,5A3,3 0 0,1 15,8A3,3 0 0,1 12,11A3,3 0 0,1 9,8A3,3 0 0,1 12,5M17.13,17C15.92,18.85 14.11,20.24 12,20.92C9.89,20.24 8.08,18.85 6.87,17C6.53,16.5 6.24,16 6,15.47C6,13.82 8.71,12.47 12,12.47C15.29,12.47 18,13.79 18,15.47C17.76,16 17.47,16.5 17.13,17Z"/>
              </svg>
              <span class="font-medium text-neutral-700 dark:text-neutral-300">F-Droid</span>
            </div>
            <p class="text-sm text-neutral-500 dark:text-neutral-400">Coming soon</p>
          </div>

          <!-- Apple Vision Pro (coming soon) -->
          <div class="bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg p-4 opacity-60">
            <div class="flex items-center gap-3 mb-2">
              <svg class="w-6 h-6 text-neutral-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z"/>
              </svg>
              <span class="font-medium text-neutral-700 dark:text-neutral-300">Apple Vision Pro</span>
            </div>
            <p class="text-sm text-neutral-500 dark:text-neutral-400">Coming soon</p>
          </div>
        </div>

        <hr class="my-8 border-neutral-200 dark:border-neutral-700" />

        <!-- Why FOSS -->
        <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-4">
          Why Open Source?
        </h2>
        <ul class="text-neutral-600 dark:text-neutral-300 space-y-3 mb-8">
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span><strong>No tracking</strong> - The FOSS version has no analytics or crash reporting</span>
          </li>
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span><strong>Transparent</strong> - <a href="https://github.com/baytides/baynavigator">View the source code</a> and verify what the app does</span>
          </li>
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span><strong>No Google services</strong> - Works without Google Play Services installed</span>
          </li>
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span><strong>Community maintained</strong> - Anyone can contribute improvements</span>
          </li>
        </ul>

        <!-- All Releases Link -->
        <div class="text-center">
          <a
            href="https://github.com/baytides/baynavigator/releases"
            class="text-primary-600 dark:text-primary-400 hover:underline inline-flex items-center gap-1"
          >
            View all releases on GitHub
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
            </svg>
          </a>
        </div>

        <div class="mt-12">
          <a href="/" class="btn-secondary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Home
          </a>
        </div>

        <!-- Trademark Attributions -->
        <div class="mt-12 pt-8 border-t border-neutral-200 dark:border-neutral-700">
          <p class="text-xs text-neutral-400 dark:text-neutral-500 leading-relaxed">
            Apple and the Apple logo are trademarks of Apple Inc., registered in the U.S. and other countries.
            App Store is a service mark of Apple Inc.
            Google Play and the Google Play logo are trademarks of Google LLC.
          </p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
