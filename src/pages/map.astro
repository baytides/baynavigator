---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';

// Get PMTiles URL from environment variable
const pmtilesUrl =
  import.meta.env.PUBLIC_PMTILES_URL ||
  'https://baytidesstorage.blob.core.windows.net/tiles/bayarea.pmtiles';

// Get Azure Maps key from environment variable (PUBLIC_ prefix exposes to client)
const azureMapsKey = import.meta.env.PUBLIC_AZURE_MAPS_KEY || '';
---

<BaseLayout title="Map" description="Explore Bay Area resources on an interactive map">
  <!-- Pass environment variables to client-side script -->
  <script is:inline define:vars={{ pmtilesUrl, azureMapsKey }}>
    window.__PMTILES_URL__ = pmtilesUrl;
    window.__AZURE_MAPS_KEY__ = azureMapsKey;
    // Detect if accessing via Tor (.onion)
    window.__IS_ONION__ = window.location.hostname.endsWith('.onion');
  </script>
  <!-- Map Container -->
  <div
    id="map-container"
    class="relative w-full"
    style="height: calc(100vh - 180px); min-height: 500px;"
  >
    <!-- Loading State -->
    <div
      id="map-loading"
      class="absolute inset-0 flex items-center justify-center bg-neutral-100 dark:bg-neutral-800 z-10"
      role="status"
      aria-live="polite"
    >
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4">
        </div>
        <p class="text-neutral-600 dark:text-neutral-300" data-i18n="map.loading">Loading map...</p>
      </div>
    </div>

    <!-- Tor/Onion Notice with Static Map Alternative -->
    <div
      id="tor-notice"
      class="hidden absolute inset-0 bg-neutral-100 dark:bg-neutral-800 z-10 overflow-y-auto"
    >
      <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-6">
          <div
            class="inline-flex items-center gap-2 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 px-4 py-2 rounded-full text-sm mb-4"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Tor-Safe View</span>
          </div>
          <h2 class="text-xl font-semibold text-neutral-900 dark:text-white mb-2">
            Browse Programs by County
          </h2>
          <p class="text-neutral-600 dark:text-neutral-300 text-sm max-w-lg mx-auto">
            The interactive map requires external resources. Here's a privacy-respecting view of all
            programs organized by location.
          </p>
        </div>

        <!-- Static Bay Area SVG Map -->
        <div class="bg-white dark:bg-neutral-900 rounded-xl p-4 mb-6 shadow-sm">
          <svg
            viewBox="0 0 400 350"
            class="w-full max-w-md mx-auto"
            role="img"
            aria-label="Bay Area counties map"
          >
            <!-- Simplified Bay Area county shapes -->
            <g
              class="fill-neutral-200 dark:fill-neutral-700 stroke-neutral-400 dark:stroke-neutral-500"
              stroke-width="1"
            >
              <!-- Sonoma -->
              <path
                id="tor-map-sonoma"
                d="M40,20 L120,15 L130,80 L100,120 L50,100 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Sonoma"></path>
              <!-- Napa -->
              <path
                id="tor-map-napa"
                d="M120,15 L170,20 L175,90 L130,80 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Napa"></path>
              <!-- Solano -->
              <path
                id="tor-map-solano"
                d="M170,20 L260,25 L250,100 L175,90 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Solano"></path>
              <!-- Marin -->
              <path
                id="tor-map-marin"
                d="M50,100 L100,120 L95,180 L70,200 L40,170 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Marin"></path>
              <!-- Contra Costa -->
              <path
                id="tor-map-contracosta"
                d="M130,80 L175,90 L250,100 L240,170 L160,180 L130,150 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Contra Costa"></path>
              <!-- San Francisco -->
              <path
                id="tor-map-sf"
                d="M70,200 L95,180 L100,210 L75,220 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="San Francisco"></path>
              <!-- Alameda -->
              <path
                id="tor-map-alameda"
                d="M130,150 L160,180 L240,170 L260,250 L180,280 L120,230 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Alameda"></path>
              <!-- San Mateo -->
              <path
                id="tor-map-sanmateo"
                d="M75,220 L100,210 L120,230 L130,300 L80,320 L60,280 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="San Mateo"></path>
              <!-- Santa Clara -->
              <path
                id="tor-map-santaclara"
                d="M120,230 L180,280 L260,250 L300,320 L200,350 L130,300 Z"
                class="cursor-pointer hover:fill-primary-200 dark:hover:fill-primary-800 transition-colors"
                data-county="Santa Clara"></path>
            </g>
            <!-- County labels -->
            <g
              class="fill-neutral-700 dark:fill-neutral-300 text-[10px] font-medium pointer-events-none"
              text-anchor="middle"
            >
              <text x="85" y="65">Sonoma</text>
              <text x="150" y="55">Napa</text>
              <text x="210" y="60">Solano</text>
              <text x="70" y="150">Marin</text>
              <text x="185" y="130">Contra Costa</text>
              <text x="85" y="205">SF</text>
              <text x="185" y="215">Alameda</text>
              <text x="95" y="270">San Mateo</text>
              <text x="200" y="300">Santa Clara</text>
            </g>
            <!-- Water (Bay) -->
            <ellipse
              cx="130"
              cy="200"
              rx="30"
              ry="50"
              class="fill-blue-200 dark:fill-blue-900/50 opacity-50"></ellipse>
          </svg>
          <p class="text-xs text-neutral-500 dark:text-neutral-400 text-center mt-2">
            Click a county to filter programs
          </p>
        </div>

        <!-- County Program Counts -->
        <div id="tor-county-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
          <!-- Populated by JavaScript -->
        </div>

        <!-- Programs List -->
        <div id="tor-programs-list" class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm">
          <div
            class="p-4 border-b border-neutral-200 dark:border-neutral-700 flex items-center justify-between"
          >
            <h3 id="tor-programs-title" class="font-semibold text-neutral-900 dark:text-white">
              All Programs
            </h3>
            <span id="tor-programs-count" class="text-sm text-neutral-500 dark:text-neutral-400"
            ></span>
          </div>
          <div
            id="tor-programs-container"
            class="divide-y divide-neutral-200 dark:divide-neutral-700 max-h-96 overflow-y-auto"
          >
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Alternative Actions -->
        <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
          <a
            href="/directory"
            class="inline-flex items-center justify-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium no-underline transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
            </svg>
            Full Directory
          </a>
          <a
            href="https://baynavigator.org/map"
            class="inline-flex items-center justify-center gap-2 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-700 px-6 py-3 rounded-lg font-medium no-underline transition-colors"
            target="_blank"
            rel="noopener"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              ></path>
            </svg>
            Interactive Map
            <span class="text-xs opacity-70">(clearnet)</span>
          </a>
        </div>
      </div>
    </div>

    <!-- The Map -->
    <div id="map" class="w-full h-full"></div>

    <!-- Map Controls -->
    <div class="absolute top-4 left-4 z-20 flex flex-col gap-2">
      <!-- Location Search -->
      <div class="relative" role="search">
        <label for="location-search" class="sr-only">Search for a location</label>
        <div class="flex items-center bg-white dark:bg-neutral-800 rounded-lg shadow-lg">
          <svg
            class="w-4 h-4 ml-3 text-neutral-600 dark:text-neutral-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            id="location-search"
            placeholder="Search address, city, or ZIP..."
            class="w-48 sm:w-64 px-3 py-2 bg-transparent text-sm text-neutral-900 dark:text-neutral-100 placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded-r-lg"
            autocomplete="off"
            aria-describedby="search-instructions"
            aria-controls="search-suggestions"
            aria-autocomplete="list"
          />
          <button
            id="clear-search"
            type="button"
            class="hidden px-2 py-2 text-neutral-600 hover:text-neutral-900 dark:text-neutral-400 dark:hover:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
            aria-label="Clear search"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          <!-- Use My Location Button -->
          <button
            id="use-my-location"
            type="button"
            class="px-2 py-2 text-neutral-600 hover:text-primary-600 dark:text-neutral-400 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded border-l border-neutral-200 dark:border-neutral-700"
            aria-label="Use my current location"
            title="Use my location"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
        </div>
        <div id="search-instructions" class="sr-only">
          Type a city name, ZIP code, or street address to search. Use arrow keys to navigate
          suggestions, Enter to select. Or use the location button to find programs near you.
        </div>
        <!-- Search Suggestions Dropdown -->
        <div
          id="search-suggestions"
          class="hidden absolute top-full left-0 right-0 mt-1 bg-white dark:bg-neutral-800 rounded-lg shadow-lg max-h-60 overflow-y-auto"
          role="listbox"
          aria-label="Search suggestions"
        >
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <a
        href="/directory"
        class="inline-flex items-center gap-2 bg-white dark:bg-neutral-800 text-sm text-neutral-700 dark:text-neutral-200 px-3 py-2 rounded-lg shadow-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
        aria-label="Browse programs in the directory"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 10h16M4 14h16M4 18h10"></path>
        </svg>
        Browse directory
      </a>
    </div>

    <!-- Layers Toggle Button (bottom-left, above the panel) -->
    <button
      id="legend-toggle"
      type="button"
      class="absolute bottom-4 left-4 z-20 bg-white/95 dark:bg-neutral-900/95 backdrop-blur-sm px-4 py-2.5 rounded-xl shadow-xl text-sm font-medium text-neutral-900 dark:text-neutral-100 hover:bg-white dark:hover:bg-neutral-800 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all"
      aria-expanded="false"
      aria-controls="legend-panel"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
        ></path>
      </svg>
      <span data-i18n="map.layers">Layers</span>
      <span
        id="filter-count"
        class="hidden bg-primary-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center"
      ></span>
    </button>

    <!-- Fullscreen Toggle (top right, offset to avoid MapLibre zoom controls) -->
    <button
      id="fullscreen-toggle"
      type="button"
      class="absolute top-4 right-14 z-20 bg-white dark:bg-neutral-800 p-2 rounded-lg shadow-lg text-neutral-700 dark:text-neutral-300 hover:bg-neutral-50 dark:hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
      aria-label="Toggle fullscreen"
      title="Fullscreen"
    >
      <svg
        id="fullscreen-icon-expand"
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
        ></path>
      </svg>
      <svg
        id="fullscreen-icon-collapse"
        class="w-5 h-5 hidden"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 9V4H4v5h5zm6 0V4h5v5h-5zm0 6v5h5v-5h-5zm-6 0v5H4v-5h5z"></path>
      </svg>
    </button>

    <!-- Combined Filters & Layers Panel - WatchDuty-inspired design -->
    <div
      id="legend-panel"
      class="hidden absolute bottom-4 left-4 z-20 bg-white/95 dark:bg-neutral-900/95 backdrop-blur-sm rounded-xl shadow-xl w-80 max-h-[70vh] overflow-hidden flex flex-col"
      role="region"
      aria-labelledby="legend-heading"
    >
      <!-- Header -->
      <div
        class="px-4 py-3 border-b border-neutral-200 dark:border-neutral-700 flex items-center justify-between"
      >
        <h3 class="font-semibold text-neutral-900 dark:text-white text-sm" data-i18n="map.layers">
          Layers
        </h3>
        <button
          id="legend-close"
          type="button"
          class="p-1 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 text-neutral-500"
          aria-label="Close panel"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="px-4 py-2 border-b border-neutral-200 dark:border-neutral-700">
        <div
          class="flex flex-wrap items-center gap-2 text-xs text-neutral-500 dark:text-neutral-400"
        >
          <span class="text-[0.6rem] font-semibold uppercase tracking-[0.2em]">Jump to</span>
          <a
            href="#map-categories"
            class="rounded-full border border-neutral-200 px-2 py-0.5 text-neutral-600 hover:text-primary-700 dark:border-neutral-700 dark:text-neutral-300 dark:hover:text-primary-300"
            >Categories</a
          >
          <a
            href="#map-transit"
            class="rounded-full border border-neutral-200 px-2 py-0.5 text-neutral-600 hover:text-primary-700 dark:border-neutral-700 dark:text-neutral-300 dark:hover:text-primary-300"
            >Transit</a
          >
          <a
            href="#map-traffic"
            class="rounded-full border border-neutral-200 px-2 py-0.5 text-neutral-600 hover:text-primary-700 dark:border-neutral-700 dark:text-neutral-300 dark:hover:text-primary-300"
            >Traffic</a
          >
        </div>
      </div>

      <!-- Scrollable content area -->
      <div class="overflow-y-auto flex-1">
        <!-- Categories Section (collapsible) -->
        <details class="group" open id="map-categories">
          <summary
            class="px-4 py-2.5 cursor-pointer flex items-center justify-between bg-neutral-50 dark:bg-neutral-800/50 border-b border-neutral-200 dark:border-neutral-700 select-none"
          >
            <div class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-primary-600 dark:text-primary-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                ></path>
              </svg>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white"
                data-i18n="map.categories">Categories</span
              >
            </div>
            <div class="flex items-center gap-2">
              <div class="flex gap-1 mr-2">
                <button
                  id="filter-all"
                  type="button"
                  class="text-xs text-primary-600 dark:text-primary-400 hover:underline px-1.5 py-0.5 rounded hover:bg-primary-50 dark:hover:bg-primary-900/30"
                  data-i18n="map.all">All</button
                >
                <button
                  id="filter-none"
                  type="button"
                  class="text-xs text-neutral-500 hover:underline px-1.5 py-0.5 rounded hover:bg-neutral-100 dark:hover:bg-neutral-700"
                  data-i18n="map.none">None</button
                >
              </div>
              <svg
                class="w-4 h-4 text-neutral-400 transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div
            class="px-4 py-2 space-y-0.5 text-sm border-b border-neutral-200 dark:border-neutral-700"
            id="legend-items"
            role="group"
            aria-label="Category filters"
          >
            <!-- Populated by JavaScript -->
          </div>
        </details>

        <!-- Transit Section (collapsible) -->
        <details class="group" id="map-transit">
          <summary
            class="px-4 py-2.5 cursor-pointer flex items-center justify-between bg-neutral-50 dark:bg-neutral-800/50 border-b border-neutral-200 dark:border-neutral-700 select-none"
          >
            <div class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-blue-600 dark:text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7h8m-8 5h8m-4 5v3m-4 0h8m-8 0a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2m-8 0V9"
                ></path>
              </svg>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white"
                data-i18n="map.transit">Transit</span
              >
            </div>
            <div class="flex items-center gap-2">
              <button
                id="transit-select-none"
                type="button"
                class="text-xs text-neutral-500 hover:underline px-1.5 py-0.5 rounded hover:bg-neutral-100 dark:hover:bg-neutral-700"
                data-i18n="map.clear">Clear</button
              >
              <svg
                class="w-4 h-4 text-neutral-400 transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="px-4 py-2 border-b border-neutral-200 dark:border-neutral-700">
            <!-- Rail -->
            <div class="mb-2">
              <span
                class="text-xs font-medium text-neutral-400 dark:text-neutral-500 uppercase tracking-wide"
                data-i18n="map.rail">Rail</span
              >
              <div id="transit-rail-operators" class="mt-1 space-y-0.5"></div>
            </div>
            <!-- Ferry -->
            <div class="mb-2">
              <span
                class="text-xs font-medium text-neutral-400 dark:text-neutral-500 uppercase tracking-wide"
                data-i18n="map.ferry">Ferry</span
              >
              <div id="transit-ferry-operators" class="mt-1 space-y-0.5"></div>
            </div>
            <!-- Bus -->
            <div class="mb-3">
              <span
                class="text-xs font-medium text-neutral-400 dark:text-neutral-500 uppercase tracking-wide"
                data-i18n="map.bus">Bus</span
              >
              <div id="transit-bus-operators" class="mt-1 space-y-0.5"></div>
            </div>
            <!-- Clipper Card Discounts -->
            <div class="pt-2 border-t border-neutral-200 dark:border-neutral-700">
              <span
                class="text-xs font-medium text-neutral-400 dark:text-neutral-500 uppercase tracking-wide"
                >Clipper Discounts</span
              >
              <div class="mt-1.5 space-y-0.5">
                <a
                  href="/directory#program-clipper-baypass"
                  class="flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400 py-1 px-1.5 rounded hover:bg-neutral-100 dark:hover:bg-neutral-800"
                >
                  <span>Clipper BayPass</span>
                  <span class="text-neutral-400 dark:text-neutral-500">Students</span>
                </a>
                <a
                  href="/directory#program-clipper-start"
                  class="flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400 py-1 px-1.5 rounded hover:bg-neutral-100 dark:hover:bg-neutral-800"
                >
                  <span>Clipper START</span>
                  <span class="text-neutral-400 dark:text-neutral-500">Low-income</span>
                </a>
                <a
                  href="/directory#program-senior-clipper-card"
                  class="flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400 py-1 px-1.5 rounded hover:bg-neutral-100 dark:hover:bg-neutral-800"
                >
                  <span>Senior Clipper</span>
                  <span class="text-neutral-400 dark:text-neutral-500">65+</span>
                </a>
                <a
                  href="/directory#program-clipper-access"
                  class="flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400 py-1 px-1.5 rounded hover:bg-neutral-100 dark:hover:bg-neutral-800"
                >
                  <span>Clipper Access</span>
                  <span class="text-neutral-400 dark:text-neutral-500">Disability</span>
                </a>
              </div>
              <a
                href="https://www.clippercard.com"
                target="_blank"
                rel="noopener"
                class="flex items-center justify-center gap-1 text-xs text-primary-600 dark:text-primary-400 hover:underline mt-2 py-1"
              >
                <span>clippercard.com</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  ></path>
                </svg>
              </a>
            </div>
          </div>
        </details>

        <!-- Traffic Section (collapsible) -->
        <details class="group" open id="map-traffic">
          <summary
            class="px-4 py-2.5 cursor-pointer flex items-center justify-between bg-neutral-50 dark:bg-neutral-800/50 border-b border-neutral-200 dark:border-neutral-700 select-none"
          >
            <div class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-amber-600 dark:text-amber-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white"
                data-i18n="map.traffic">Traffic</span
              >
            </div>
            <svg
              class="w-4 h-4 text-neutral-400 transition-transform group-open:rotate-180"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </summary>
          <div class="px-4 py-2 space-y-1 border-b border-neutral-200 dark:border-neutral-700">
            <label
              class="flex items-center gap-3 cursor-pointer py-1.5 px-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <input
                type="checkbox"
                id="traffic-flow"
                class="w-4 h-4 rounded text-emerald-600 focus:ring-emerald-500 focus:ring-offset-0"
              />
              <span
                class="w-4 h-2.5 rounded-sm flex-shrink-0"
                style="background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);"
              ></span>
              <span
                class="text-sm text-neutral-700 dark:text-neutral-300 flex-1"
                data-i18n="map.trafficFlow">Traffic Flow</span
              >
            </label>
            <label
              class="flex items-center gap-3 cursor-pointer py-1.5 px-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <input
                type="checkbox"
                id="traffic-incidents"
                class="w-4 h-4 rounded text-red-600 focus:ring-red-500 focus:ring-offset-0"
              />
              <svg
                class="w-4 h-4 flex-shrink-0 text-red-500"
                viewBox="0 0 12 12"
                fill="currentColor"><path d="M6 0L12 10.5H0L6 0Z"></path></svg
              >
              <span
                class="text-sm text-neutral-700 dark:text-neutral-300 flex-1"
                data-i18n="map.incidents">Incidents</span
              >
            </label>
            <label
              class="flex items-center gap-3 cursor-pointer py-1.5 px-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <input
                type="checkbox"
                id="traffic-closures"
                class="w-4 h-4 rounded text-amber-600 focus:ring-amber-500 focus:ring-offset-0"
              />
              <svg
                class="w-4 h-4 flex-shrink-0 text-amber-500"
                viewBox="0 0 12 12"
                fill="currentColor"><path d="M6 0L12 10.5H0L6 0Z"></path></svg
              >
              <span
                class="text-sm text-neutral-700 dark:text-neutral-300 flex-1"
                data-i18n="map.laneClosures">Lane Closures</span
              >
            </label>
            <label
              class="flex items-center gap-3 cursor-pointer py-1.5 px-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <input
                type="checkbox"
                id="traffic-cameras"
                class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 focus:ring-offset-0"
              />
              <svg
                class="w-4 h-4 flex-shrink-0 text-blue-500"
                viewBox="0 0 12 12"
                fill="currentColor"><path d="M6 0L12 10.5H0L6 0Z"></path></svg
              >
              <span
                class="text-sm text-neutral-700 dark:text-neutral-300 flex-1"
                data-i18n="map.cameras">Cameras</span
              >
            </label>
            <label
              class="flex items-center gap-3 cursor-pointer py-1.5 px-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <input
                type="checkbox"
                id="traffic-vistas"
                class="w-4 h-4 rounded text-green-600 focus:ring-green-500 focus:ring-offset-0"
              />
              <svg
                class="w-4 h-4 flex-shrink-0 text-green-500"
                viewBox="0 0 12 12"
                fill="currentColor"><path d="M6 0L12 10.5H0L6 0Z"></path></svg
              >
              <span
                class="text-sm text-neutral-700 dark:text-neutral-300 flex-1"
                data-i18n="map.vistaPoints">Vista Points</span
              >
            </label>
          </div>
        </details>

        <!-- Map Options Section (collapsible) -->
        <details class="group">
          <summary
            class="px-4 py-2.5 cursor-pointer flex items-center justify-between bg-neutral-50 dark:bg-neutral-800/50 select-none"
          >
            <div class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-neutral-600 dark:text-neutral-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white"
                data-i18n="map.settings">Settings</span
              >
            </div>
            <svg
              class="w-4 h-4 text-neutral-400 transition-transform group-open:rotate-180"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </summary>
          <div class="px-4 py-2">
            <label
              class="flex items-center gap-3 text-sm text-neutral-700 dark:text-neutral-300 cursor-pointer py-1.5 px-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <input
                type="checkbox"
                id="show-counties"
                class="w-4 h-4 rounded text-primary-600 focus:ring-primary-500 focus:ring-offset-0"
              />
              <span data-i18n="map.countyBoundaries">County boundaries</span>
            </label>
          </div>
        </details>
      </div>

      <!-- Footer -->
      <div
        class="px-4 py-2 border-t border-neutral-200 dark:border-neutral-700 text-xs text-neutral-400 dark:text-neutral-500"
      >
        Data: 511.org · Caltrans · Azure Maps
      </div>
    </div>

    <!-- Context Menu (right-click / long-press) -->
    <div
      id="map-context-menu"
      class="hidden absolute z-30 bg-white dark:bg-neutral-800 rounded-lg shadow-xl py-1 min-w-48"
      role="menu"
    >
      <button
        id="context-isochrone"
        type="button"
        class="w-full px-4 py-2.5 text-left text-sm text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 flex items-center gap-3"
        role="menuitem"
      >
        <svg
          class="w-4 h-4 text-primary-600 dark:text-primary-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span data-i18n="map.showTravelTime">Show travel time from here</span>
      </button>
      <button
        id="context-directions"
        type="button"
        class="w-full px-4 py-2.5 text-left text-sm text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 flex items-center gap-3"
        role="menuitem"
      >
        <svg
          class="w-4 h-4 text-green-600 dark:text-green-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
          ></path>
        </svg>
        <span data-i18n="map.directionsFromHere">Directions from here</span>
      </button>
      <button
        id="context-nearby"
        type="button"
        class="w-full px-4 py-2.5 text-left text-sm text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 flex items-center gap-3"
        role="menuitem"
      >
        <svg
          class="w-4 h-4 text-blue-600 dark:text-blue-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          ></path>
        </svg>
        <span data-i18n="map.findProgramsNearHere">Find programs near here</span>
      </button>
    </div>

    <!-- Isochrone Legend (shown when isochrone is active) -->
    <div
      id="isochrone-legend"
      class="hidden absolute bottom-20 left-4 z-20 bg-white dark:bg-neutral-800 rounded-lg shadow-lg p-3"
    >
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-neutral-900 dark:text-white"
          >Travel Time (driving)</span
        >
        <button
          id="clear-isochrone"
          type="button"
          class="text-xs text-red-600 dark:text-red-400 hover:underline"
        >
          Clear
        </button>
      </div>
      <div class="flex items-center gap-2 text-xs text-neutral-600 dark:text-neutral-300">
        <div class="flex items-center gap-1">
          <div class="w-4 h-3 rounded" style="background: rgba(74, 222, 128, 0.4);"></div>
          <span>5 min</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-4 h-3 rounded" style="background: rgba(250, 204, 21, 0.4);"></div>
          <span>10 min</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-4 h-3 rounded" style="background: rgba(251, 146, 60, 0.4);"></div>
          <span>15 min</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-4 h-3 rounded" style="background: rgba(248, 113, 113, 0.4);"></div>
          <span>20 min</span>
        </div>
      </div>
    </div>

    <!-- Nearby Programs Panel -->
    <div
      id="nearby-panel"
      class="hidden absolute top-4 right-4 z-20 bg-white dark:bg-neutral-800 rounded-lg shadow-lg w-80 max-h-[calc(100%-120px)] overflow-hidden flex flex-col"
      role="region"
      aria-labelledby="nearby-heading"
    >
      <div
        class="p-4 border-b border-neutral-200 dark:border-neutral-700 flex items-center justify-between"
      >
        <div>
          <h3 id="nearby-heading" class="font-semibold text-neutral-900 dark:text-white">
            Nearby Programs
          </h3>
          <p id="nearby-location" class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5"></p>
        </div>
        <button
          id="close-nearby"
          type="button"
          class="p-1 text-neutral-600 hover:text-neutral-900 dark:text-neutral-400 dark:hover:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
          aria-label="Close nearby programs panel"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-2 border-b border-neutral-200 dark:border-neutral-700">
        <p class="text-xs text-green-700 dark:text-green-400 flex items-center gap-1">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
              clip-rule="evenodd"></path>
          </svg>
          Distances calculated on your device - location never sent to servers
        </p>
      </div>
      <div id="nearby-list" class="flex-1 overflow-y-auto p-2 space-y-2">
        <!-- Populated by JavaScript -->
      </div>
      <div class="p-3 border-t border-neutral-200 dark:border-neutral-700 text-center">
        <a href="/directory" class="text-sm text-primary-700 dark:text-primary-300 hover:underline">
          View all in Directory →
        </a>
      </div>
    </div>
  </div>

  <!-- Attribution -->
  <footer
    class="bg-neutral-100 dark:bg-neutral-800 py-2 px-4 text-xs text-neutral-700 dark:text-neutral-300"
  >
    <div class="container-page flex flex-wrap items-center justify-between gap-x-4 gap-y-1">
      <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
        <span>Map data:</span>
        <a
          href="https://www.openstreetmap.org/copyright"
          class="underline hover:text-primary-700 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
          target="_blank"
          rel="noopener">OpenStreetMap<span class="sr-only"> (opens in new tab)</span></a
        >
        <span aria-hidden="true">|</span>
        <a
          href="https://protomaps.com"
          class="underline hover:text-primary-700 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
          target="_blank"
          rel="noopener">Protomaps<span class="sr-only"> (opens in new tab)</span></a
        >
        <span aria-hidden="true">|</span>
        <a
          href="https://caltrans-gis.dot.ca.gov/"
          class="underline hover:text-primary-700 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
          target="_blank"
          rel="noopener">Caltrans<span class="sr-only"> (opens in new tab)</span></a
        >
        <span aria-hidden="true">|</span>
        <a
          href="https://maplibre.org"
          class="underline hover:text-primary-700 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
          target="_blank"
          rel="noopener">MapLibre<span class="sr-only"> (opens in new tab)</span></a
        >
      </div>
      <a
        href="https://github.com/baytides/baynavigator/issues/new?template=outdated-info.yml"
        class="underline hover:text-primary-700 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded flex items-center gap-1"
        target="_blank"
        rel="noopener"
      >
        <svg
          class="w-3 h-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
        Report outdated info<span class="sr-only"> (opens in new tab)</span>
      </a>
    </div>
  </footer>
</BaseLayout>

<style>
  /* MapLibre popup styles */
  :global(.maplibregl-popup-content) {
    padding: 0 !important;
    border-radius: 0.5rem !important;
    overflow: hidden;
    max-width: 300px;
  }

  :global(.dark .maplibregl-popup-content) {
    background: #1f2937 !important;
    color: #f3f4f6 !important;
  }

  :global(.maplibregl-popup-close-button) {
    font-size: 1.25rem;
    padding: 0.25rem 0.5rem;
    color: #6b7280;
  }

  :global(.dark .maplibregl-popup-close-button) {
    color: #9ca3af;
  }

  :global(.maplibregl-popup-close-button:hover) {
    background: #f3f4f6;
  }

  :global(.dark .maplibregl-popup-close-button:hover) {
    background: #374151;
  }

  /* Cluster styling */
  :global(.cluster-marker) {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: bold;
    color: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  /* Search marker styling */
  :global(.search-marker) {
    cursor: pointer;
  }

  :global(.search-marker svg) {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    animation: marker-bounce 0.5s ease-out;
  }

  @keyframes marker-bounce {
    0% {
      transform: translateY(-20px);
      opacity: 0;
    }
    50% {
      transform: translateY(5px);
    }
    100% {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Fullscreen mode */
  :global(.map-fullscreen) {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 9999 !important;
    height: 100vh !important;
    max-height: 100vh !important;
  }

  :global(.map-fullscreen #map) {
    height: 100vh !important;
  }

  /* Hide header/footer in fullscreen */
  :global(body:has(.map-fullscreen) header),
  :global(body:has(.map-fullscreen) footer),
  :global(body:has(.map-fullscreen) nav) {
    display: none !important;
  }

  /* Hover tooltip */
  :global(.map-hover-tooltip) {
    position: absolute;
    background: white;
    padding: 8px 12px;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    z-index: 100;
    max-width: 200px;
    font-size: 13px;
    transform: translate(-50%, -100%);
    margin-top: -10px;
  }

  :global(.dark .map-hover-tooltip) {
    background: #1f2937;
    color: #f3f4f6;
  }

  :global(.map-hover-tooltip::after) {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid white;
  }

  :global(.dark .map-hover-tooltip::after) {
    border-top-color: #1f2937;
  }

  /* BART station marker */
  :global(.bart-marker) {
    background: #009bda;
    border: 2px solid white;
    border-radius: 50%;
    width: 12px;
    height: 12px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  }

  /* Category filter checkbox styles */
  :global(.category-filter) {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.15s;
  }

  :global(.category-filter:hover) {
    background: #f3f4f6;
  }

  :global(.dark .category-filter:hover) {
    background: #374151;
  }

  :global(.category-filter.disabled) {
    opacity: 0.5;
  }

  :global(.category-filter .color-dot) {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  :global(.category-filter.disabled .color-dot) {
    background: #9ca3af !important;
  }

  /* Spiderfy styles for overlapping markers */
  :global(.spider-leg) {
    stroke: rgba(0, 0, 0, 0.5);
    stroke-width: 1;
    pointer-events: none;
  }

  :global(.dark .spider-leg) {
    stroke: rgba(255, 255, 255, 0.5);
  }

  :global(.spider-marker) {
    cursor: pointer;
    transition: transform 0.15s ease;
  }

  :global(.spider-marker:hover) {
    transform: scale(1.2);
    z-index: 100 !important;
  }
</style>

<script>
  import maplibregl from 'maplibre-gl';
  import 'maplibre-gl/dist/maplibre-gl.css';
  import * as pmtiles from 'pmtiles';
  import { layers, namedFlavor } from '@protomaps/basemaps';

  // Bay Area city coordinates (approximate centers)
  // Generated from cities.yml with coordinates
  const CITY_COORDINATES: Record<string, { lat: number; lng: number; county: string }> = {
    // Alameda County
    Alameda: { lat: 37.7652, lng: -122.2416, county: 'Alameda' },
    Albany: { lat: 37.8869, lng: -122.2978, county: 'Alameda' },
    Berkeley: { lat: 37.8716, lng: -122.2727, county: 'Alameda' },
    'Castro Valley': { lat: 37.6941, lng: -122.0864, county: 'Alameda' },
    Dublin: { lat: 37.7022, lng: -121.9358, county: 'Alameda' },
    Emeryville: { lat: 37.8313, lng: -122.2852, county: 'Alameda' },
    Fremont: { lat: 37.5485, lng: -121.9886, county: 'Alameda' },
    Hayward: { lat: 37.6688, lng: -122.0808, county: 'Alameda' },
    Livermore: { lat: 37.6819, lng: -121.7681, county: 'Alameda' },
    Newark: { lat: 37.5297, lng: -122.0402, county: 'Alameda' },
    Oakland: { lat: 37.8044, lng: -122.2712, county: 'Alameda' },
    Piedmont: { lat: 37.8246, lng: -122.2318, county: 'Alameda' },
    Pleasanton: { lat: 37.6604, lng: -121.8758, county: 'Alameda' },
    'San Leandro': { lat: 37.7249, lng: -122.1561, county: 'Alameda' },
    'San Lorenzo': { lat: 37.6808, lng: -122.1244, county: 'Alameda' },
    Sunol: { lat: 37.5977, lng: -121.8836, county: 'Alameda' },
    'Union City': { lat: 37.5934, lng: -122.0439, county: 'Alameda' },
    // Contra Costa County
    Alamo: { lat: 37.8501, lng: -122.0322, county: 'Contra Costa' },
    Antioch: { lat: 38.0049, lng: -121.8058, county: 'Contra Costa' },
    Brentwood: { lat: 37.9317, lng: -121.6961, county: 'Contra Costa' },
    Clayton: { lat: 37.941, lng: -121.9355, county: 'Contra Costa' },
    Concord: { lat: 37.978, lng: -122.0311, county: 'Contra Costa' },
    Danville: { lat: 37.8216, lng: -121.9999, county: 'Contra Costa' },
    'El Cerrito': { lat: 37.9161, lng: -122.3103, county: 'Contra Costa' },
    'El Sobrante': { lat: 37.9774, lng: -122.2947, county: 'Contra Costa' },
    Hercules: { lat: 38.0172, lng: -122.2886, county: 'Contra Costa' },
    Lafayette: { lat: 37.8858, lng: -122.118, county: 'Contra Costa' },
    Martinez: { lat: 38.0194, lng: -122.1341, county: 'Contra Costa' },
    Moraga: { lat: 37.8349, lng: -122.1297, county: 'Contra Costa' },
    Oakley: { lat: 37.9974, lng: -121.7125, county: 'Contra Costa' },
    Orinda: { lat: 37.8771, lng: -122.1797, county: 'Contra Costa' },
    Pinole: { lat: 38.0044, lng: -122.2989, county: 'Contra Costa' },
    Pittsburg: { lat: 38.028, lng: -121.8847, county: 'Contra Costa' },
    'Pleasant Hill': { lat: 37.948, lng: -122.0608, county: 'Contra Costa' },
    Richmond: { lat: 37.9358, lng: -122.3478, county: 'Contra Costa' },
    'San Pablo': { lat: 37.9621, lng: -122.3458, county: 'Contra Costa' },
    'San Ramon': { lat: 37.7799, lng: -121.978, county: 'Contra Costa' },
    'Walnut Creek': { lat: 37.9101, lng: -122.0652, county: 'Contra Costa' },
    // Marin County
    Belvedere: { lat: 37.8724, lng: -122.4647, county: 'Marin' },
    'Corte Madera': { lat: 37.9252, lng: -122.5272, county: 'Marin' },
    Fairfax: { lat: 37.9872, lng: -122.5889, county: 'Marin' },
    Larkspur: { lat: 37.9341, lng: -122.535, county: 'Marin' },
    'Mill Valley': { lat: 37.906, lng: -122.545, county: 'Marin' },
    Novato: { lat: 38.1074, lng: -122.5697, county: 'Marin' },
    Ross: { lat: 37.9624, lng: -122.555, county: 'Marin' },
    'San Anselmo': { lat: 37.9746, lng: -122.5614, county: 'Marin' },
    'San Rafael': { lat: 37.9735, lng: -122.5311, county: 'Marin' },
    Sausalito: { lat: 37.8591, lng: -122.4853, county: 'Marin' },
    Tiburon: { lat: 37.8735, lng: -122.4567, county: 'Marin' },
    // Napa County
    'American Canyon': { lat: 38.1749, lng: -122.2608, county: 'Napa' },
    Calistoga: { lat: 38.5788, lng: -122.5797, county: 'Napa' },
    Napa: { lat: 38.2975, lng: -122.2869, county: 'Napa' },
    'St. Helena': { lat: 38.5052, lng: -122.4703, county: 'Napa' },
    Yountville: { lat: 38.4016, lng: -122.3608, county: 'Napa' },
    // San Francisco
    'San Francisco': { lat: 37.7749, lng: -122.4194, county: 'San Francisco' },
    // San Mateo County
    Atherton: { lat: 37.4613, lng: -122.1978, county: 'San Mateo' },
    Belmont: { lat: 37.5202, lng: -122.2758, county: 'San Mateo' },
    Brisbane: { lat: 37.6808, lng: -122.3999, county: 'San Mateo' },
    Burlingame: { lat: 37.5841, lng: -122.3661, county: 'San Mateo' },
    Colma: { lat: 37.6769, lng: -122.4597, county: 'San Mateo' },
    'Daly City': { lat: 37.6879, lng: -122.4702, county: 'San Mateo' },
    'East Palo Alto': { lat: 37.4688, lng: -122.1411, county: 'San Mateo' },
    'Foster City': { lat: 37.5585, lng: -122.2711, county: 'San Mateo' },
    'Half Moon Bay': { lat: 37.4636, lng: -122.4286, county: 'San Mateo' },
    'Menlo Park': { lat: 37.453, lng: -122.1817, county: 'San Mateo' },
    Millbrae: { lat: 37.5985, lng: -122.3872, county: 'San Mateo' },
    Pacifica: { lat: 37.6138, lng: -122.4869, county: 'San Mateo' },
    'Portola Valley': { lat: 37.3841, lng: -122.235, county: 'San Mateo' },
    'Redwood City': { lat: 37.4852, lng: -122.2364, county: 'San Mateo' },
    'San Bruno': { lat: 37.6305, lng: -122.4111, county: 'San Mateo' },
    'San Carlos': { lat: 37.5072, lng: -122.2611, county: 'San Mateo' },
    'San Mateo': { lat: 37.563, lng: -122.3255, county: 'San Mateo' },
    'South San Francisco': { lat: 37.6547, lng: -122.4077, county: 'San Mateo' },
    // Santa Clara County
    Campbell: { lat: 37.2872, lng: -121.95, county: 'Santa Clara' },
    Cupertino: { lat: 37.323, lng: -122.0322, county: 'Santa Clara' },
    Gilroy: { lat: 37.0058, lng: -121.5683, county: 'Santa Clara' },
    'Los Altos': { lat: 37.3852, lng: -122.1141, county: 'Santa Clara' },
    'Los Gatos': { lat: 37.2266, lng: -121.9746, county: 'Santa Clara' },
    Milpitas: { lat: 37.4323, lng: -121.8996, county: 'Santa Clara' },
    'Morgan Hill': { lat: 37.1305, lng: -121.6544, county: 'Santa Clara' },
    'Mountain View': { lat: 37.3861, lng: -122.0839, county: 'Santa Clara' },
    'Palo Alto': { lat: 37.4419, lng: -122.143, county: 'Santa Clara' },
    'San Jose': { lat: 37.3382, lng: -121.8863, county: 'Santa Clara' },
    'Santa Clara': { lat: 37.3541, lng: -121.9552, county: 'Santa Clara' },
    Saratoga: { lat: 37.2638, lng: -122.023, county: 'Santa Clara' },
    Sunnyvale: { lat: 37.3688, lng: -122.0363, county: 'Santa Clara' },
    // Solano County
    Benicia: { lat: 38.0494, lng: -122.1586, county: 'Solano' },
    Dixon: { lat: 38.4455, lng: -121.8233, county: 'Solano' },
    Fairfield: { lat: 38.2494, lng: -122.04, county: 'Solano' },
    'Rio Vista': { lat: 38.1555, lng: -121.6925, county: 'Solano' },
    'Suisun City': { lat: 38.2383, lng: -122.0011, county: 'Solano' },
    Vacaville: { lat: 38.3566, lng: -121.9877, county: 'Solano' },
    Vallejo: { lat: 38.1041, lng: -122.2566, county: 'Solano' },
    // Sonoma County
    Cloverdale: { lat: 38.8055, lng: -123.0172, county: 'Sonoma' },
    Cotati: { lat: 38.3277, lng: -122.7072, county: 'Sonoma' },
    Healdsburg: { lat: 38.6105, lng: -122.8694, county: 'Sonoma' },
    Petaluma: { lat: 38.2324, lng: -122.6367, county: 'Sonoma' },
    'Rohnert Park': { lat: 38.3396, lng: -122.7011, county: 'Sonoma' },
    'Santa Rosa': { lat: 38.4404, lng: -122.7141, county: 'Sonoma' },
    Sebastopol: { lat: 38.4021, lng: -122.8239, county: 'Sonoma' },
    Sonoma: { lat: 38.2919, lng: -122.458, county: 'Sonoma' },
    Windsor: { lat: 38.5469, lng: -122.8164, county: 'Sonoma' },
  };

  // ZIP code to city and coordinates mapping
  // Using representative coordinates for each ZIP
  const ZIP_COORDINATES: Record<string, { city: string; lat: number; lng: number }> = {
    // Alameda County
    '94501': { city: 'Alameda', lat: 37.7652, lng: -122.2416 },
    '94502': { city: 'Alameda', lat: 37.7374, lng: -122.24 },
    '94536': { city: 'Fremont', lat: 37.5547, lng: -121.9759 },
    '94538': { city: 'Fremont', lat: 37.5134, lng: -121.9401 },
    '94539': { city: 'Fremont', lat: 37.5102, lng: -121.9175 },
    '94541': { city: 'Hayward', lat: 37.6697, lng: -122.087 },
    '94544': { city: 'Hayward', lat: 37.6336, lng: -122.0564 },
    '94545': { city: 'Hayward', lat: 37.6317, lng: -122.1064 },
    '94546': { city: 'Castro Valley', lat: 37.6941, lng: -122.0864 },
    '94550': { city: 'Livermore', lat: 37.6819, lng: -121.7681 },
    '94551': { city: 'Livermore', lat: 37.7021, lng: -121.7222 },
    '94555': { city: 'Fremont', lat: 37.5506, lng: -122.0556 },
    '94560': { city: 'Newark', lat: 37.5297, lng: -122.0402 },
    '94566': { city: 'Pleasanton', lat: 37.6604, lng: -121.8758 },
    '94568': { city: 'Dublin', lat: 37.7022, lng: -121.9358 },
    '94577': { city: 'San Leandro', lat: 37.7249, lng: -122.1561 },
    '94578': { city: 'San Leandro', lat: 37.7058, lng: -122.1283 },
    '94579': { city: 'San Leandro', lat: 37.6917, lng: -122.1278 },
    '94587': { city: 'Union City', lat: 37.5934, lng: -122.0439 },
    '94588': { city: 'Pleasanton', lat: 37.6858, lng: -121.8494 },
    '94601': { city: 'Oakland', lat: 37.7758, lng: -122.2175 },
    '94602': { city: 'Oakland', lat: 37.8024, lng: -122.2106 },
    '94603': { city: 'Oakland', lat: 37.7391, lng: -122.1706 },
    '94605': { city: 'Oakland', lat: 37.7608, lng: -122.165 },
    '94606': { city: 'Oakland', lat: 37.7933, lng: -122.2442 },
    '94607': { city: 'Oakland', lat: 37.8063, lng: -122.2969 },
    '94608': { city: 'Emeryville', lat: 37.8313, lng: -122.2852 },
    '94609': { city: 'Oakland', lat: 37.8366, lng: -122.2619 },
    '94610': { city: 'Oakland', lat: 37.8124, lng: -122.2389 },
    '94611': { city: 'Oakland', lat: 37.8308, lng: -122.2072 },
    '94612': { city: 'Oakland', lat: 37.811, lng: -122.2708 },
    '94618': { city: 'Oakland', lat: 37.8441, lng: -122.2514 },
    '94619': { city: 'Oakland', lat: 37.7824, lng: -122.1817 },
    '94621': { city: 'Oakland', lat: 37.7558, lng: -122.1939 },
    '94702': { city: 'Berkeley', lat: 37.8655, lng: -122.2886 },
    '94703': { city: 'Berkeley', lat: 37.8624, lng: -122.2769 },
    '94704': { city: 'Berkeley', lat: 37.8716, lng: -122.2594 },
    '94705': { city: 'Berkeley', lat: 37.8633, lng: -122.2411 },
    '94706': { city: 'Albany', lat: 37.8869, lng: -122.2978 },
    '94707': { city: 'Berkeley', lat: 37.893, lng: -122.2783 },
    '94708': { city: 'Berkeley', lat: 37.8991, lng: -122.2653 },
    '94709': { city: 'Berkeley', lat: 37.8788, lng: -122.2661 },
    '94710': { city: 'Berkeley', lat: 37.8621, lng: -122.3019 },
    // Contra Costa
    '94506': { city: 'Danville', lat: 37.8216, lng: -121.9999 },
    '94507': { city: 'Alamo', lat: 37.8501, lng: -122.0322 },
    '94509': { city: 'Antioch', lat: 38.0049, lng: -121.8058 },
    '94513': { city: 'Brentwood', lat: 37.9317, lng: -121.6961 },
    '94517': { city: 'Clayton', lat: 37.941, lng: -121.9355 },
    '94518': { city: 'Concord', lat: 37.978, lng: -122.0311 },
    '94519': { city: 'Concord', lat: 37.99, lng: -122.005 },
    '94520': { city: 'Concord', lat: 37.968, lng: -122.02 },
    '94521': { city: 'Concord', lat: 37.96, lng: -121.97 },
    '94523': { city: 'Pleasant Hill', lat: 37.948, lng: -122.0608 },
    '94526': { city: 'Danville', lat: 37.79, lng: -121.97 },
    '94530': { city: 'El Cerrito', lat: 37.9161, lng: -122.3103 },
    '94531': { city: 'Antioch', lat: 37.97, lng: -121.76 },
    '94547': { city: 'Hercules', lat: 38.0172, lng: -122.2886 },
    '94549': { city: 'Lafayette', lat: 37.8858, lng: -122.118 },
    '94553': { city: 'Martinez', lat: 38.0194, lng: -122.1341 },
    '94556': { city: 'Moraga', lat: 37.8349, lng: -122.1297 },
    '94561': { city: 'Oakley', lat: 37.9974, lng: -121.7125 },
    '94563': { city: 'Orinda', lat: 37.8771, lng: -122.1797 },
    '94564': { city: 'Pinole', lat: 38.0044, lng: -122.2989 },
    '94565': { city: 'Pittsburg', lat: 38.028, lng: -121.8847 },
    '94582': { city: 'San Ramon', lat: 37.7799, lng: -121.978 },
    '94583': { city: 'San Ramon', lat: 37.76, lng: -121.96 },
    '94595': { city: 'Walnut Creek', lat: 37.9101, lng: -122.0652 },
    '94596': { city: 'Walnut Creek', lat: 37.9, lng: -122.06 },
    '94597': { city: 'Walnut Creek', lat: 37.92, lng: -122.05 },
    '94598': { city: 'Walnut Creek', lat: 37.92, lng: -122.03 },
    '94801': { city: 'Richmond', lat: 37.9358, lng: -122.3478 },
    '94803': { city: 'El Sobrante', lat: 37.9774, lng: -122.2947 },
    '94804': { city: 'Richmond', lat: 37.92, lng: -122.36 },
    '94805': { city: 'Richmond', lat: 37.93, lng: -122.33 },
    '94806': { city: 'San Pablo', lat: 37.9621, lng: -122.3458 },
    // San Francisco
    '94102': { city: 'San Francisco', lat: 37.7813, lng: -122.4167 },
    '94103': { city: 'San Francisco', lat: 37.7725, lng: -122.4108 },
    '94104': { city: 'San Francisco', lat: 37.7916, lng: -122.4019 },
    '94105': { city: 'San Francisco', lat: 37.7894, lng: -122.3927 },
    '94107': { city: 'San Francisco', lat: 37.7649, lng: -122.3956 },
    '94108': { city: 'San Francisco', lat: 37.7919, lng: -122.4078 },
    '94109': { city: 'San Francisco', lat: 37.7941, lng: -122.4217 },
    '94110': { city: 'San Francisco', lat: 37.7489, lng: -122.4153 },
    '94111': { city: 'San Francisco', lat: 37.7983, lng: -122.4003 },
    '94112': { city: 'San Francisco', lat: 37.7199, lng: -122.4424 },
    '94114': { city: 'San Francisco', lat: 37.7586, lng: -122.435 },
    '94115': { city: 'San Francisco', lat: 37.7866, lng: -122.4378 },
    '94116': { city: 'San Francisco', lat: 37.7435, lng: -122.4859 },
    '94117': { city: 'San Francisco', lat: 37.7702, lng: -122.4439 },
    '94118': { city: 'San Francisco', lat: 37.7822, lng: -122.4608 },
    '94121': { city: 'San Francisco', lat: 37.7785, lng: -122.4922 },
    '94122': { city: 'San Francisco', lat: 37.7589, lng: -122.4844 },
    '94123': { city: 'San Francisco', lat: 37.8002, lng: -122.4378 },
    '94124': { city: 'San Francisco', lat: 37.7316, lng: -122.3872 },
    '94127': { city: 'San Francisco', lat: 37.735, lng: -122.4575 },
    '94129': { city: 'San Francisco', lat: 37.8008, lng: -122.4658 },
    '94130': { city: 'San Francisco', lat: 37.8233, lng: -122.3706 },
    '94131': { city: 'San Francisco', lat: 37.7419, lng: -122.4378 },
    '94132': { city: 'San Francisco', lat: 37.7208, lng: -122.4783 },
    '94133': { city: 'San Francisco', lat: 37.8002, lng: -122.4094 },
    '94134': { city: 'San Francisco', lat: 37.7191, lng: -122.4119 },
    '94158': { city: 'San Francisco', lat: 37.7691, lng: -122.3867 },
    // San Mateo County
    '94002': { city: 'Belmont', lat: 37.5202, lng: -122.2758 },
    '94005': { city: 'Brisbane', lat: 37.6808, lng: -122.3999 },
    '94010': { city: 'Burlingame', lat: 37.5841, lng: -122.3661 },
    '94014': { city: 'Daly City', lat: 37.6879, lng: -122.4702 },
    '94015': { city: 'Daly City', lat: 37.68, lng: -122.48 },
    '94019': { city: 'Half Moon Bay', lat: 37.4636, lng: -122.4286 },
    '94025': { city: 'Menlo Park', lat: 37.453, lng: -122.1817 },
    '94027': { city: 'Atherton', lat: 37.4613, lng: -122.1978 },
    '94028': { city: 'Portola Valley', lat: 37.3841, lng: -122.235 },
    '94030': { city: 'Millbrae', lat: 37.5985, lng: -122.3872 },
    '94044': { city: 'Pacifica', lat: 37.6138, lng: -122.4869 },
    '94061': { city: 'Redwood City', lat: 37.4852, lng: -122.2364 },
    '94062': { city: 'Redwood City', lat: 37.47, lng: -122.25 },
    '94063': { city: 'Redwood City', lat: 37.49, lng: -122.21 },
    '94065': { city: 'Redwood City', lat: 37.53, lng: -122.25 },
    '94066': { city: 'San Bruno', lat: 37.6305, lng: -122.4111 },
    '94070': { city: 'San Carlos', lat: 37.5072, lng: -122.2611 },
    '94080': { city: 'South San Francisco', lat: 37.6547, lng: -122.4077 },
    '94303': { city: 'East Palo Alto', lat: 37.4688, lng: -122.1411 },
    '94401': { city: 'San Mateo', lat: 37.563, lng: -122.3255 },
    '94402': { city: 'San Mateo', lat: 37.55, lng: -122.31 },
    '94403': { city: 'San Mateo', lat: 37.54, lng: -122.3 },
    '94404': { city: 'Foster City', lat: 37.5585, lng: -122.2711 },
    // Santa Clara County
    '94022': { city: 'Los Altos', lat: 37.3852, lng: -122.1141 },
    '94024': { city: 'Los Altos', lat: 37.37, lng: -122.1 },
    '94040': { city: 'Mountain View', lat: 37.3861, lng: -122.0839 },
    '94041': { city: 'Mountain View', lat: 37.39, lng: -122.07 },
    '94043': { city: 'Mountain View', lat: 37.41, lng: -122.08 },
    '94085': { city: 'Sunnyvale', lat: 37.3688, lng: -122.0363 },
    '94086': { city: 'Sunnyvale', lat: 37.37, lng: -122.03 },
    '94087': { city: 'Sunnyvale', lat: 37.35, lng: -122.04 },
    '94089': { city: 'Sunnyvale', lat: 37.41, lng: -122.01 },
    '94301': { city: 'Palo Alto', lat: 37.4419, lng: -122.143 },
    '94304': { city: 'Palo Alto', lat: 37.39, lng: -122.15 },
    '94306': { city: 'Palo Alto', lat: 37.42, lng: -122.13 },
    '95008': { city: 'Campbell', lat: 37.2872, lng: -121.95 },
    '95014': { city: 'Cupertino', lat: 37.323, lng: -122.0322 },
    '95020': { city: 'Gilroy', lat: 37.0058, lng: -121.5683 },
    '95030': { city: 'Los Gatos', lat: 37.2266, lng: -121.9746 },
    '95032': { city: 'Los Gatos', lat: 37.24, lng: -121.96 },
    '95035': { city: 'Milpitas', lat: 37.4323, lng: -121.8996 },
    '95037': { city: 'Morgan Hill', lat: 37.1305, lng: -121.6544 },
    '95050': { city: 'Santa Clara', lat: 37.3541, lng: -121.9552 },
    '95051': { city: 'Santa Clara', lat: 37.35, lng: -121.98 },
    '95054': { city: 'Santa Clara', lat: 37.39, lng: -121.97 },
    '95070': { city: 'Saratoga', lat: 37.2638, lng: -122.023 },
    '95110': { city: 'San Jose', lat: 37.34, lng: -121.89 },
    '95111': { city: 'San Jose', lat: 37.29, lng: -121.82 },
    '95112': { city: 'San Jose', lat: 37.36, lng: -121.89 },
    '95113': { city: 'San Jose', lat: 37.335, lng: -121.89 },
    '95116': { city: 'San Jose', lat: 37.35, lng: -121.85 },
    '95117': { city: 'San Jose', lat: 37.31, lng: -121.96 },
    '95118': { city: 'San Jose', lat: 37.25, lng: -121.89 },
    '95119': { city: 'San Jose', lat: 37.23, lng: -121.78 },
    '95120': { city: 'San Jose', lat: 37.21, lng: -121.85 },
    '95121': { city: 'San Jose', lat: 37.31, lng: -121.81 },
    '95122': { city: 'San Jose', lat: 37.33, lng: -121.83 },
    '95123': { city: 'San Jose', lat: 37.25, lng: -121.83 },
    '95124': { city: 'San Jose', lat: 37.26, lng: -121.92 },
    '95125': { city: 'San Jose', lat: 37.29, lng: -121.89 },
    '95126': { city: 'San Jose', lat: 37.32, lng: -121.91 },
    '95127': { city: 'San Jose', lat: 37.37, lng: -121.81 },
    '95128': { city: 'San Jose', lat: 37.31, lng: -121.94 },
    '95129': { city: 'San Jose', lat: 37.3, lng: -122.01 },
    '95130': { city: 'San Jose', lat: 37.29, lng: -121.98 },
    '95131': { city: 'San Jose', lat: 37.39, lng: -121.9 },
    '95132': { city: 'San Jose', lat: 37.41, lng: -121.86 },
    '95133': { city: 'San Jose', lat: 37.37, lng: -121.87 },
    '95134': { city: 'San Jose', lat: 37.43, lng: -121.94 },
    '95135': { city: 'San Jose', lat: 37.3, lng: -121.76 },
    '95136': { city: 'San Jose', lat: 37.27, lng: -121.85 },
    '95138': { city: 'San Jose', lat: 37.24, lng: -121.75 },
    '95148': { city: 'San Jose', lat: 37.34, lng: -121.78 },
    // Marin County
    '94901': { city: 'San Rafael', lat: 37.9735, lng: -122.5311 },
    '94903': { city: 'San Rafael', lat: 37.99, lng: -122.52 },
    '94904': { city: 'Greenbrae', lat: 37.95, lng: -122.53 },
    '94920': { city: 'Tiburon', lat: 37.8735, lng: -122.4567 },
    '94925': { city: 'Corte Madera', lat: 37.9252, lng: -122.5272 },
    '94930': { city: 'Fairfax', lat: 37.9872, lng: -122.5889 },
    '94939': { city: 'Larkspur', lat: 37.9341, lng: -122.535 },
    '94941': { city: 'Mill Valley', lat: 37.906, lng: -122.545 },
    '94945': { city: 'Novato', lat: 38.1074, lng: -122.5697 },
    '94947': { city: 'Novato', lat: 38.13, lng: -122.55 },
    '94949': { city: 'Novato', lat: 38.08, lng: -122.53 },
    '94960': { city: 'San Anselmo', lat: 37.9746, lng: -122.5614 },
    '94965': { city: 'Sausalito', lat: 37.8591, lng: -122.4853 },
    // Napa County
    '94503': { city: 'American Canyon', lat: 38.1749, lng: -122.2608 },
    '94515': { city: 'Calistoga', lat: 38.5788, lng: -122.5797 },
    '94558': { city: 'Napa', lat: 38.2975, lng: -122.2869 },
    '94559': { city: 'Napa', lat: 38.27, lng: -122.3 },
    '94574': { city: 'St. Helena', lat: 38.5052, lng: -122.4703 },
    '94599': { city: 'Yountville', lat: 38.4016, lng: -122.3608 },
    // Solano County
    '94510': { city: 'Benicia', lat: 38.0494, lng: -122.1586 },
    '94533': { city: 'Fairfield', lat: 38.2494, lng: -122.04 },
    '94534': { city: 'Fairfield', lat: 38.27, lng: -122.06 },
    '94571': { city: 'Rio Vista', lat: 38.1555, lng: -121.6925 },
    '94585': { city: 'Suisun City', lat: 38.2383, lng: -122.0011 },
    '94589': { city: 'Vallejo', lat: 38.1041, lng: -122.2566 },
    '94590': { city: 'Vallejo', lat: 38.11, lng: -122.24 },
    '94591': { city: 'Vallejo', lat: 38.12, lng: -122.22 },
    '95620': { city: 'Dixon', lat: 38.4455, lng: -121.8233 },
    '95687': { city: 'Vacaville', lat: 38.3566, lng: -121.9877 },
    '95688': { city: 'Vacaville', lat: 38.37, lng: -122.0 },
    // Sonoma County
    '94928': { city: 'Rohnert Park', lat: 38.3396, lng: -122.7011 },
    '94931': { city: 'Cotati', lat: 38.3277, lng: -122.7072 },
    '94952': { city: 'Petaluma', lat: 38.2324, lng: -122.6367 },
    '94954': { city: 'Petaluma', lat: 38.25, lng: -122.62 },
    '95401': { city: 'Santa Rosa', lat: 38.4404, lng: -122.7141 },
    '95403': { city: 'Santa Rosa', lat: 38.47, lng: -122.73 },
    '95404': { city: 'Santa Rosa', lat: 38.45, lng: -122.68 },
    '95405': { city: 'Santa Rosa', lat: 38.43, lng: -122.67 },
    '95407': { city: 'Santa Rosa', lat: 38.4, lng: -122.75 },
    '95409': { city: 'Santa Rosa', lat: 38.46, lng: -122.64 },
    '95425': { city: 'Cloverdale', lat: 38.8055, lng: -123.0172 },
    '95448': { city: 'Healdsburg', lat: 38.6105, lng: -122.8694 },
    '95472': { city: 'Sebastopol', lat: 38.4021, lng: -122.8239 },
    '95476': { city: 'Sonoma', lat: 38.2919, lng: -122.458 },
    '95492': { city: 'Windsor', lat: 38.5469, lng: -122.8164 },
  };

  // Category colors matching the GeoJSON
  const CATEGORY_COLORS: Record<string, string> = {
    'Community Services': '#8B5CF6',
    Education: '#3B82F6',
    Equipment: '#6B7280',
    Finance: '#10B981',
    Food: '#F59E0B',
    Health: '#EF4444',
    Legal: '#6366F1',
    'Library Resources': '#8B5CF6',
    'Pet Resources': '#EC4899',
    Recreation: '#14B8A6',
    Museums: '#9333EA',
    Parks: '#22C55E',
    'Parks & Open Space': '#22C55E',
    Technology: '#0EA5E9',
    Transportation: '#F97316',
    Utilities: '#84CC16',
    'Federal Benefits': '#1D4ED8',
  };

  // Get PMTiles URL from window (set by Astro)
  const PMTILES_URL =
    (window as any).__PMTILES_URL__ ||
    'https://baytidesstorage.blob.core.windows.net/tiles/bayarea.pmtiles';

  // Generate full Protomaps basemap styles using @protomaps/basemaps
  const LIGHT_STYLE = {
    version: 8 as const,
    glyphs: 'https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf',
    sprite: 'https://protomaps.github.io/basemaps-assets/sprites/v4/light',
    sources: {
      protomaps: {
        type: 'vector' as const,
        url: `pmtiles://${PMTILES_URL}`,
        attribution: '© <a href="https://openstreetmap.org">OpenStreetMap</a>',
      },
    },
    layers: layers('protomaps', namedFlavor('light'), { lang: 'en' }),
  };

  const DARK_STYLE = {
    version: 8 as const,
    glyphs: 'https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf',
    sprite: 'https://protomaps.github.io/basemaps-assets/sprites/v4/dark',
    sources: {
      protomaps: {
        type: 'vector' as const,
        url: `pmtiles://${PMTILES_URL}`,
        attribution: '© <a href="https://openstreetmap.org">OpenStreetMap</a>',
      },
    },
    layers: layers('protomaps', namedFlavor('dark'), { lang: 'en' }),
  };

  // ========================================
  // TOR-SAFE STATIC VIEW
  // Provides a privacy-respecting alternative when accessing via .onion
  // All data is from bundled JSON - no external requests
  // ========================================
  async function initTorSafeView() {
    const countyGrid = document.getElementById('tor-county-grid');
    const programsContainer = document.getElementById('tor-programs-container');
    const programsTitle = document.getElementById('tor-programs-title');
    const programsCount = document.getElementById('tor-programs-count');

    // Bay Area counties
    const counties = [
      'Alameda',
      'Contra Costa',
      'Marin',
      'Napa',
      'San Francisco',
      'San Mateo',
      'Santa Clara',
      'Solano',
      'Sonoma',
    ];

    // Load programs from local JSON (bundled, no external requests)
    let allPrograms: any[] = [];
    try {
      const response = await fetch('/api/programs.json');
      const data = await response.json();
      allPrograms = data.programs || [];
    } catch (e) {
      console.warn('Could not load programs for Tor view');
    }

    // Count programs per county
    const countsByCounty: Record<string, number> = {};
    counties.forEach((c) => (countsByCounty[c] = 0));

    allPrograms.forEach((program) => {
      const areas = program.serviceArea || [];
      areas.forEach((area: string) => {
        const areaLower = area.toLowerCase();
        counties.forEach((county) => {
          if (areaLower.includes(county.toLowerCase())) {
            countsByCounty[county]++;
          }
        });
        // Count statewide/nationwide programs for all counties
        if (
          areaLower.includes('statewide') ||
          areaLower.includes('nationwide') ||
          areaLower.includes('california')
        ) {
          counties.forEach((county) => countsByCounty[county]++);
        }
      });
    });

    // Helper to escape HTML - sanitizes all user/program data
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render county grid using safe DOM methods
    if (countyGrid) {
      countyGrid.textContent = ''; // Clear safely
      counties.forEach((county) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className =
          'tor-county-btn p-3 bg-white dark:bg-neutral-900 rounded-lg shadow-sm hover:shadow-md transition-all text-left group';
        btn.setAttribute('data-county', county);

        const nameDiv = document.createElement('div');
        nameDiv.className =
          'font-medium text-neutral-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors';
        nameDiv.textContent = county;

        const countDiv = document.createElement('div');
        countDiv.className = 'text-sm text-neutral-500 dark:text-neutral-400';
        countDiv.textContent = `${countsByCounty[county]} programs`;

        btn.appendChild(nameDiv);
        btn.appendChild(countDiv);
        btn.addEventListener('click', () => filterByCounty(county));
        countyGrid.appendChild(btn);
      });
    }

    // Add click handlers for SVG map counties
    document.querySelectorAll('[data-county]').forEach((el) => {
      el.addEventListener('click', () => {
        const county = el.getAttribute('data-county');
        if (county) filterByCounty(county);
      });
    });

    // Filter programs by county
    let currentCounty: string | null = null;

    function filterByCounty(county: string | null) {
      currentCounty = county;

      // Update UI state
      document.querySelectorAll('[data-county]').forEach((el) => {
        if (county && el.getAttribute('data-county') === county) {
          el.classList.add('fill-primary-400', 'dark:fill-primary-600');
          el.classList.remove('fill-neutral-200', 'dark:fill-neutral-700');
        } else {
          el.classList.remove('fill-primary-400', 'dark:fill-primary-600');
          el.classList.add('fill-neutral-200', 'dark:fill-neutral-700');
        }
      });

      // Update button states
      document.querySelectorAll('.tor-county-btn').forEach((btn) => {
        if (county && btn.getAttribute('data-county') === county) {
          btn.classList.add('ring-2', 'ring-primary-500');
        } else {
          btn.classList.remove('ring-2', 'ring-primary-500');
        }
      });

      // Filter and render programs
      const filtered = county
        ? allPrograms.filter((p) => {
            const areas = (p.serviceArea || []).map((a: string) => a.toLowerCase());
            return areas.some(
              (a: string) =>
                a.includes(county.toLowerCase()) ||
                a.includes('statewide') ||
                a.includes('nationwide') ||
                a.includes('california')
            );
          })
        : allPrograms;

      renderPrograms(filtered, county);
    }

    // Render programs list using safe DOM methods
    function renderPrograms(programs: any[], county: string | null) {
      if (programsTitle) {
        programsTitle.textContent = county ? `${county} Programs` : 'All Programs';
      }
      if (programsCount) {
        programsCount.textContent = `${programs.length} programs`;
      }

      if (!programsContainer) return;

      programsContainer.textContent = ''; // Clear safely

      if (programs.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'p-8 text-center text-neutral-500 dark:text-neutral-400';
        const p = document.createElement('p');
        p.textContent = 'No programs found';
        emptyDiv.appendChild(p);
        programsContainer.appendChild(emptyDiv);
        return;
      }

      // Sort by name
      const sorted = [...programs].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

      // Render each program using safe DOM methods
      sorted.slice(0, 50).forEach((program) => {
        const link = document.createElement('a');
        link.href = `/directory?q=${encodeURIComponent(program.name || '')}`;
        link.className =
          'block p-4 hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors';

        const container = document.createElement('div');
        container.className = 'flex items-start gap-3';

        // Color dot
        const dot = document.createElement('div');
        dot.className = 'w-2 h-2 mt-2 rounded-full flex-shrink-0';
        dot.style.backgroundColor =
          CATEGORY_COLORS[program.category as keyof typeof CATEGORY_COLORS] || '#6B7280';

        // Content
        const content = document.createElement('div');
        content.className = 'flex-1 min-w-0';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'font-medium text-neutral-900 dark:text-white truncate';
        nameDiv.textContent = program.name || 'Unknown';

        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'text-sm text-neutral-500 dark:text-neutral-400 truncate';
        categoryDiv.textContent = program.category || '';

        content.appendChild(nameDiv);
        content.appendChild(categoryDiv);

        if (program.phone) {
          const phoneDiv = document.createElement('div');
          phoneDiv.className = 'text-sm text-primary-600 dark:text-primary-400 mt-1';
          phoneDiv.textContent = program.phone;
          content.appendChild(phoneDiv);
        }

        // Arrow icon
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        arrow.setAttribute('class', 'w-5 h-5 text-neutral-400 flex-shrink-0');
        arrow.setAttribute('fill', 'none');
        arrow.setAttribute('stroke', 'currentColor');
        arrow.setAttribute('viewBox', '0 0 24 24');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M9 5l7 7-7 7');
        arrow.appendChild(path);

        container.appendChild(dot);
        container.appendChild(content);
        container.appendChild(arrow);
        link.appendChild(container);
        programsContainer.appendChild(link);
      });

      // Show "view all" link if more than 50 programs
      if (programs.length > 50) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'p-4 text-center';

        const moreLink = document.createElement('a');
        moreLink.href = `/directory${county ? '?county=' + encodeURIComponent(county) : ''}`;
        moreLink.className = 'text-primary-600 dark:text-primary-400 hover:underline text-sm';
        moreLink.textContent = `View all ${programs.length} programs →`;

        moreDiv.appendChild(moreLink);
        programsContainer.appendChild(moreDiv);
      }
    }

    // Initial render - show all programs
    renderPrograms(allPrograms, null);
  }

  // Initialize map
  async function initMap() {
    const loadingEl = document.getElementById('map-loading');
    const torNoticeEl = document.getElementById('tor-notice');
    const legendToggle = document.getElementById('legend-toggle');
    const legendPanel = document.getElementById('legend-panel');
    const legendItems = document.getElementById('legend-items');

    // Check if accessing via Tor (.onion)
    const isOnion = (window as any).__IS_ONION__ || window.location.hostname.endsWith('.onion');

    // Show Tor notice immediately if on .onion domain
    // The map likely won't work due to mixed content and CORS restrictions
    if (isOnion) {
      if (loadingEl) loadingEl.style.display = 'none';
      if (torNoticeEl) torNoticeEl.classList.remove('hidden');
      // Initialize the Tor-safe static view
      initTorSafeView();
      return; // Don't attempt to load the map
    }

    // Register PMTiles protocol
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    // Check dark mode
    const isDark = document.documentElement.classList.contains('dark');

    // Create map
    const map = new maplibregl.Map({
      container: 'map',
      style: isDark ? DARK_STYLE : LIGHT_STYLE,
      center: [-122.2, 37.8], // Bay Area center
      zoom: 9,
      minZoom: 7,
      maxZoom: 18,
    });

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Load GeoJSON data
    map.on('load', async () => {
      // ========================================
      // STATE VARIABLES (hoisted to top to avoid reference errors)
      // ========================================

      // Traffic layer state
      let trafficFlowLayerAdded = false;
      let trafficLayersAdded = false;
      let trafficEventsData: any = null;
      let laneClosuresData: any = null;
      let camerasData: any = null;
      let vistasData: any = null;

      // Transit layer state
      let transitData: any = null;
      let transitRoutesData: any = null;
      let transitLayersAdded = false;
      let activeOperators = new Set<string>();

      // County boundaries state
      let countyBoundariesLoaded = false;
      let countyDataCache: any = null;

      // Get traffic checkbox references
      const trafficIncidentsCheckbox = document.getElementById(
        'traffic-incidents'
      ) as HTMLInputElement;
      const trafficClosuresCheckbox = document.getElementById(
        'traffic-closures'
      ) as HTMLInputElement;
      const trafficCamerasCheckbox = document.getElementById('traffic-cameras') as HTMLInputElement;
      const trafficVistasCheckbox = document.getElementById('traffic-vistas') as HTMLInputElement;
      const trafficFlowCheckbox = document.getElementById('traffic-flow') as HTMLInputElement;

      // Azure Maps Traffic Flow API key (passed from server-side)
      const AZURE_MAPS_KEY = (window as any).__AZURE_MAPS_KEY__ || '';

      // Create pin marker image for program points
      function createPinMarker(color: string, size: number = 28): ImageData {
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size + 8; // Extra height for pin point
        const ctx = canvas.getContext('2d')!;

        const centerX = size / 2;
        const radius = size / 2 - 2;

        // Draw drop shadow
        ctx.beginPath();
        ctx.arc(centerX + 1, radius + 2, radius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fill();

        // Draw white border/background
        ctx.beginPath();
        ctx.arc(centerX, radius, radius + 2, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();

        // Draw colored circle
        ctx.beginPath();
        ctx.arc(centerX, radius, radius - 1, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();

        // Draw pin point (triangle below circle)
        ctx.beginPath();
        ctx.moveTo(centerX - 6, radius + 8);
        ctx.lineTo(centerX, size + 4);
        ctx.lineTo(centerX + 6, radius + 8);
        ctx.closePath();
        ctx.fillStyle = '#ffffff';
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(centerX - 4, radius + 8);
        ctx.lineTo(centerX, size + 1);
        ctx.lineTo(centerX + 4, radius + 8);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();

        return ctx.getImageData(0, 0, size, size + 8);
      }

      // Category colors for pin markers
      const categoryColorMap: Record<string, string> = {
        Food: '#22c55e',
        Health: '#ef4444',
        Housing: '#3b82f6',
        Utilities: '#eab308',
        Transportation: '#a855f7',
        Education: '#6366f1',
        Employment: '#14b8a6',
        Legal: '#6b7280',
        Finance: '#10b981',
        Technology: '#06b6d4',
        Recreation: '#f97316',
        Community: '#ec4899',
        default: '#3b82f6',
      };

      try {
        const response = await fetch('/api/programs.geojson');
        const geojson = await response.json();

        // Store for nearby calculations
        programsGeoJSON = geojson;

        // Create pin marker images for each category
        Object.entries(categoryColorMap).forEach(([category, color]) => {
          const imageName = `pin-${category.toLowerCase().replace(/\s+/g, '-')}`;
          if (!map.hasImage(imageName)) {
            map.addImage(imageName, createPinMarker(color));
          }
        });

        // Add source
        map.addSource('programs', {
          type: 'geojson',
          data: geojson,
          cluster: true,
          clusterMaxZoom: 14,
          clusterRadius: 50,
        });

        // Cluster circles
        map.addLayer({
          id: 'clusters',
          type: 'circle',
          source: 'programs',
          filter: ['has', 'point_count'],
          paint: {
            'circle-color': [
              'step',
              ['get', 'point_count'],
              '#3b82f6', // blue for small clusters
              10,
              '#8b5cf6', // purple for medium
              25,
              '#ef4444', // red for large
            ],
            'circle-radius': ['step', ['get', 'point_count'], 18, 10, 24, 25, 30],
            'circle-stroke-width': 2,
            'circle-stroke-color': '#ffffff',
          },
        });

        // Cluster count labels
        map.addLayer({
          id: 'cluster-count',
          type: 'symbol',
          source: 'programs',
          filter: ['has', 'point_count'],
          layout: {
            'text-field': ['get', 'point_count_abbreviated'],
            'text-font': ['Noto Sans Bold'],
            'text-size': 12,
          },
          paint: {
            'text-color': '#ffffff',
          },
        });

        // Individual program points - using pin markers instead of circles
        // Pin markers are easier to click and visually indicate locations better
        map.addLayer({
          id: 'program-points',
          type: 'symbol',
          source: 'programs',
          filter: ['!', ['has', 'point_count']],
          layout: {
            'icon-image': [
              'match',
              ['get', 'category'],
              'Food',
              'pin-food',
              'Health',
              'pin-health',
              'Housing',
              'pin-housing',
              'Utilities',
              'pin-utilities',
              'Transportation',
              'pin-transportation',
              'Education',
              'pin-education',
              'Employment',
              'pin-employment',
              'Legal',
              'pin-legal',
              'Finance',
              'pin-finance',
              'Technology',
              'pin-technology',
              'Recreation',
              'pin-recreation',
              'Community',
              'pin-community',
              'pin-default', // fallback
            ],
            'icon-size': 1,
            'icon-anchor': 'bottom',
            'icon-allow-overlap': false,
            'icon-ignore-placement': false,
            'icon-padding': 2,
          },
        });

        // Build interactive legend with category filtering
        const categories = new Set<string>();
        const categoryCounts: Record<string, number> = {};
        geojson.features.forEach((f: any) => {
          if (f.properties.category) {
            categories.add(f.properties.category);
            categoryCounts[f.properties.category] =
              (categoryCounts[f.properties.category] || 0) + 1;
          }
        });

        // Track enabled categories (all enabled by default)
        const enabledCategories = new Set<string>(categories);
        const filterCountEl = document.getElementById('filter-count');

        // Forward to unified count function (defined later)
        function updateFilterCount() {
          // This will be called when category filters change
          // The actual badge update is handled by updateLayersCount() for consistency
          // We need to call it with a slight delay to ensure activeOperators is defined
          if (typeof updateLayersCount === 'function') {
            updateLayersCount();
          }
        }

        function updateMapFilter() {
          // Build filter expression for visible categories
          const source = map.getSource('programs') as maplibregl.GeoJSONSource;

          if (enabledCategories.size === categories.size) {
            // All categories enabled - restore full data and remove filter
            source.setData(geojson);
            map.setFilter('program-points', ['!', ['has', 'point_count']]);
            map.setFilter('clusters', ['has', 'point_count']);
          } else if (enabledCategories.size === 0) {
            // No categories enabled - hide all
            source.setData({ type: 'FeatureCollection', features: [] });
            map.setFilter('program-points', null);
            map.setFilter('clusters', null);
          } else {
            // Some categories enabled - filter source data for proper clustering
            const filteredData = {
              ...geojson,
              features: geojson.features.filter((f: any) =>
                enabledCategories.has(f.properties.category)
              ),
            };
            source.setData(filteredData);
            map.setFilter('program-points', ['!', ['has', 'point_count']]);
            map.setFilter('clusters', ['has', 'point_count']);
          }
          updateFilterCount();
        }

        function toggleCategory(cat: string) {
          if (enabledCategories.has(cat)) {
            enabledCategories.delete(cat);
          } else {
            enabledCategories.add(cat);
          }
          updateMapFilter();
          updateLegendUI();
        }

        function updateLegendUI() {
          document.querySelectorAll('.category-filter').forEach((el) => {
            const cat = el.getAttribute('data-category');
            if (cat && !enabledCategories.has(cat)) {
              el.classList.add('disabled');
              const checkbox = el.querySelector('input[type="checkbox"]') as HTMLInputElement;
              if (checkbox) checkbox.checked = false;
            } else {
              el.classList.remove('disabled');
              const checkbox = el.querySelector('input[type="checkbox"]') as HTMLInputElement;
              if (checkbox) checkbox.checked = true;
            }
          });
        }

        if (legendItems) {
          legendItems.innerHTML = Array.from(categories)
            .sort()
            .map(
              (cat) => `
            <label class="category-filter" data-category="${cat}">
              <input type="checkbox" checked class="sr-only" />
              <span class="color-dot" style="background-color: ${CATEGORY_COLORS[cat] || '#6B7280'}"></span>
              <span class="flex-1 text-neutral-700 dark:text-neutral-300">${cat}</span>
              <span class="text-xs text-neutral-500 dark:text-neutral-400">${categoryCounts[cat]}</span>
            </label>
          `
            )
            .join('');

          // Add click handlers for category filtering
          legendItems.querySelectorAll('.category-filter').forEach((el) => {
            el.addEventListener('click', (e) => {
              e.preventDefault(); // Prevent native checkbox toggle
              const cat = el.getAttribute('data-category');
              if (cat) toggleCategory(cat);
            });
          });
        }

        // Filter All/None buttons
        document.getElementById('filter-all')?.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          categories.forEach((cat) => enabledCategories.add(cat));
          updateMapFilter();
          updateLegendUI();
        });

        document.getElementById('filter-none')?.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          enabledCategories.clear();
          updateMapFilter();
          updateLegendUI();
        });

        // Hide loading
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }

        // Traffic flow layer is NOT initialized by default for cleaner map view
        // User can enable it via the Traffic section in the sidebar

        // Spiderfy state
        let spiderMarkers: maplibregl.Marker[] = [];
        let spiderLegs: SVGElement | null = null;
        const SPIDER_LEG_LENGTH = 40; // pixels

        // Clear any existing spider markers
        function clearSpider() {
          spiderMarkers.forEach((m) => m.remove());
          spiderMarkers = [];
          if (spiderLegs) {
            spiderLegs.remove();
            spiderLegs = null;
          }
        }

        // Create spiderfy visualization for overlapping points
        function spiderfy(center: [number, number], features: any[]) {
          clearSpider();

          const count = features.length;
          if (count <= 1) return;

          // Limit spider to 12 items max for readability
          const itemsToShow = features.slice(0, 12);
          const angleStep = (2 * Math.PI) / itemsToShow.length;

          // Create SVG for spider legs
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('class', 'absolute inset-0 pointer-events-none z-10');
          svg.style.overflow = 'visible';
          svg.style.position = 'absolute';
          svg.style.top = '0';
          svg.style.left = '0';
          svg.style.width = '100%';
          svg.style.height = '100%';

          const centerPoint = map.project(center);

          itemsToShow.forEach((feature, i) => {
            const angle = angleStep * i - Math.PI / 2; // Start from top
            const legLength = SPIDER_LEG_LENGTH + (count > 8 ? 10 : 0);

            // Calculate spider point position (in screen space)
            const spiderX = centerPoint.x + Math.cos(angle) * legLength;
            const spiderY = centerPoint.y + Math.sin(angle) * legLength;

            // Convert back to map coordinates
            const spiderLngLat = map.unproject([spiderX, spiderY]);

            // Draw leg line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', String(centerPoint.x));
            line.setAttribute('y1', String(centerPoint.y));
            line.setAttribute('x2', String(spiderX));
            line.setAttribute('y2', String(spiderY));
            line.setAttribute('class', 'spider-leg');
            svg.appendChild(line);

            // Create marker element
            const el = document.createElement('div');
            el.className = 'spider-marker';
            el.style.width = '16px';
            el.style.height = '16px';
            el.style.borderRadius = '50%';
            el.style.backgroundColor = CATEGORY_COLORS[feature.properties.category] || '#6B7280';
            el.style.border = '2px solid white';
            el.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';
            el.title = feature.properties.name;

            // Create marker
            const marker = new maplibregl.Marker({ element: el })
              .setLngLat([spiderLngLat.lng, spiderLngLat.lat])
              .addTo(map);

            // Click handler for spider marker
            el.addEventListener('click', (evt) => {
              evt.stopPropagation();
              clearSpider();

              const props = feature.properties;
              const coords = (feature.geometry as GeoJSON.Point).coordinates as [number, number];

              // Build action buttons (same as regular point click)
              const directionsUrl = `https://maps.apple.com/?daddr=${coords[1]},${coords[0]}`;
              const actionButtons = [
                `
                <a href="${directionsUrl}" target="_blank" rel="noopener" class="flex items-center justify-center gap-1 px-2 py-1.5 bg-neutral-100 dark:bg-neutral-700 hover:bg-neutral-200 dark:hover:bg-neutral-600 rounded text-xs text-neutral-700 dark:text-neutral-200 no-underline" title="Get directions">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                  Directions
                </a>
              `,
              ];

              if (props.phone) {
                actionButtons.push(`
                  <a href="tel:${props.phone.replace(/[^0-9+]/g, '')}" class="flex items-center justify-center gap-1 px-2 py-1.5 bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 rounded text-xs text-green-700 dark:text-green-200 no-underline" title="Call">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    Call
                  </a>
                `);
              }

              if (props.link) {
                actionButtons.push(`
                  <a href="${props.link}" target="_blank" rel="noopener" class="flex items-center justify-center gap-1 px-2 py-1.5 bg-primary-100 dark:bg-primary-900 hover:bg-primary-200 dark:hover:bg-primary-800 rounded text-xs text-primary-700 dark:text-primary-200 no-underline" title="Visit website">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                    Website
                  </a>
                `);
              }

              new maplibregl.Popup({ offset: 15, maxWidth: '280px' })
                .setLngLat([spiderLngLat.lng, spiderLngLat.lat])
                .setHTML(
                  `
                  <div class="p-3">
                    <h3 class="font-semibold text-neutral-900 dark:text-white text-sm mb-1">${props.name}</h3>
                    <p class="text-xs text-primary-600 dark:text-primary-400 mb-2">${props.category}</p>
                    ${props.description ? `<p class="text-xs text-neutral-600 dark:text-neutral-300 mb-2 line-clamp-2">${props.description}</p>` : ''}
                    ${actionButtons.length ? `<div class="flex flex-wrap gap-1.5 pt-1 border-t border-neutral-200 dark:border-neutral-600">${actionButtons.join('')}</div>` : ''}
                  </div>
                `
                )
                .addTo(map);
            });

            spiderMarkers.push(marker);
          });

          // Show "X more" indicator if there are more items
          if (count > 12) {
            const moreEl = document.createElement('div');
            moreEl.className =
              'absolute bg-neutral-800 text-white text-xs px-2 py-1 rounded-full pointer-events-none';
            moreEl.textContent = `+${count - 12} more`;
            moreEl.style.transform = 'translate(-50%, -50%)';
            moreEl.style.top = `${centerPoint.y + SPIDER_LEG_LENGTH + 25}px`;
            moreEl.style.left = `${centerPoint.x}px`;
            svg.appendChild(moreEl as any);
          }

          document.getElementById('map')?.appendChild(svg);
          spiderLegs = svg;
        }

        // Clear spider when clicking elsewhere or zooming
        map.on('click', (e) => {
          // Check if click is on a spider marker or cluster
          const features = map.queryRenderedFeatures(e.point, {
            layers: ['clusters', 'program-points'],
          });
          if (features.length === 0) {
            clearSpider();
          }
        });

        map.on('zoom', clearSpider);
        map.on('move', () => {
          // Update spider leg positions during pan
          if (spiderLegs && spiderMarkers.length > 0) {
            clearSpider();
          }
        });

        // Click on cluster to zoom in or spiderfy at high zoom
        map.on('click', 'clusters', (e) => {
          const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
          if (!features.length) return;

          const clusterId = features[0].properties?.cluster_id;
          const pointCount = features[0].properties?.point_count || 0;
          const source = map.getSource('programs') as maplibregl.GeoJSONSource;
          const clusterCoords = (features[0].geometry as GeoJSON.Point).coordinates as [
            number,
            number,
          ];

          const currentZoom = map.getZoom();

          source.getClusterExpansionZoom(clusterId, (err, expansionZoom) => {
            if (err) return;

            // If we're at or near max useful zoom and can't expand further, spiderfy
            if (
              currentZoom >= 15 &&
              (expansionZoom === null || expansionZoom > 18 || currentZoom >= expansionZoom)
            ) {
              // Get cluster leaves (actual points in the cluster)
              source.getClusterLeaves(clusterId, pointCount, 0, (err2, leaves) => {
                if (err2 || !leaves) return;
                spiderfy(clusterCoords, leaves);
              });
            } else {
              // Otherwise zoom in
              const targetZoom = Math.min((expansionZoom ?? 12) + 1, 18);
              map.flyTo({
                center: clusterCoords,
                zoom: targetZoom,
                duration: 500,
                essential: true,
              });
            }
          });
        });

        // Click on program point to show popup with action buttons
        map.on('click', 'program-points', (e) => {
          if (!e.features || e.features.length === 0) return;

          const feature = e.features[0];
          const props = feature.properties;
          const coords = (feature.geometry as GeoJSON.Point).coordinates.slice() as [
            number,
            number,
          ];

          // Build action buttons
          const actionButtons: string[] = [];

          // Directions button (always available if we have coordinates)
          const directionsUrl = `https://maps.apple.com/?daddr=${coords[1]},${coords[0]}`;
          actionButtons.push(`
            <a href="${directionsUrl}" target="_blank" rel="noopener" class="flex items-center justify-center gap-1 px-2 py-1.5 bg-neutral-100 dark:bg-neutral-700 hover:bg-neutral-200 dark:hover:bg-neutral-600 rounded text-xs text-neutral-700 dark:text-neutral-200 no-underline" title="Get directions">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
              Directions
            </a>
          `);

          // Phone button if available
          if (props.phone) {
            actionButtons.push(`
              <a href="tel:${props.phone.replace(/[^0-9+]/g, '')}" class="flex items-center justify-center gap-1 px-2 py-1.5 bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 rounded text-xs text-green-700 dark:text-green-200 no-underline" title="Call">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                Call
              </a>
            `);
          }

          // Website button if available
          if (props.link) {
            actionButtons.push(`
              <a href="${props.link}" target="_blank" rel="noopener" class="flex items-center justify-center gap-1 px-2 py-1.5 bg-primary-100 dark:bg-primary-900 hover:bg-primary-200 dark:hover:bg-primary-800 rounded text-xs text-primary-700 dark:text-primary-200 no-underline" title="Visit website">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                Website
              </a>
            `);
          }

          const popupContent = `
            <div class="p-3">
              <h3 class="font-semibold text-neutral-900 dark:text-white text-sm mb-1">${props.name}</h3>
              <p class="text-xs text-primary-600 dark:text-primary-400 mb-2">${props.category}</p>
              ${props.description ? `<p class="text-xs text-neutral-600 dark:text-neutral-300 mb-2 line-clamp-2">${props.description}</p>` : ''}
              ${props.address ? `<p class="text-xs text-neutral-600 dark:text-neutral-300 mb-3 flex items-start gap-1"><svg class="w-3 h-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>${props.address}</p>` : ''}
              <div class="flex gap-2 mb-2">
                ${actionButtons.join('')}
              </div>
              <a href="/directory#${props.id}" class="text-xs text-primary-700 dark:text-primary-300 hover:underline flex items-center gap-1">
                View full details
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
              </a>
            </div>
          `;

          new maplibregl.Popup({ offset: 15, maxWidth: '320px' })
            .setLngLat(coords)
            .setHTML(popupContent)
            .addTo(map);
        });

        // Cursor changes
        map.on('mouseenter', 'clusters', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', () => {
          map.getCanvas().style.cursor = '';
        });
        map.on('mouseenter', 'program-points', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'program-points', () => {
          map.getCanvas().style.cursor = '';
        });

        // ========================================
        // HOVER PREVIEW (Desktop only)
        // ========================================
        let hoverTooltip: HTMLDivElement | null = null;

        // Only show hover tooltip on devices that support hover (not touch)
        if (window.matchMedia('(hover: hover)').matches) {
          hoverTooltip = document.createElement('div');
          hoverTooltip.className = 'map-hover-tooltip hidden';
          document.getElementById('map-container')?.appendChild(hoverTooltip);

          map.on('mousemove', 'program-points', (e) => {
            if (!e.features || e.features.length === 0 || !hoverTooltip) return;

            const props = e.features[0].properties;
            const distanceText = userLocation
              ? ` · ${formatDistance(calculateDistance(userLocation.lat, userLocation.lng, e.lngLat.lat, e.lngLat.lng))}`
              : '';

            hoverTooltip.innerHTML = `
              <div class="font-medium text-neutral-900 dark:text-white">${props.name}</div>
              <div class="text-xs text-primary-600 dark:text-primary-400">${props.category}${distanceText}</div>
            `;
            hoverTooltip.style.left = `${e.point.x}px`;
            hoverTooltip.style.top = `${e.point.y}px`;
            hoverTooltip.classList.remove('hidden');
          });

          map.on('mouseleave', 'program-points', () => {
            if (hoverTooltip) hoverTooltip.classList.add('hidden');
          });
        }

        // ========================================
        // COUNTY BOUNDARIES
        // ========================================
        const showCountiesCheckbox = document.getElementById('show-counties') as HTMLInputElement;

        // Load county boundaries from API
        async function loadCountyBoundaries() {
          if (countyBoundariesLoaded) return;

          try {
            const response = await fetch('/api/county-boundaries.json');
            const countyData = await response.json();

            // Cache the data for theme change restoration
            countyDataCache = countyData;

            // Add county boundaries source
            map.addSource('county-boundaries', {
              type: 'geojson',
              data: countyData,
            });

            // Add county fill layer (subtle background)
            map.addLayer(
              {
                id: 'county-fill',
                type: 'fill',
                source: 'county-boundaries',
                paint: {
                  'fill-color': '#6366f1',
                  'fill-opacity': 0.03,
                },
                layout: { visibility: 'none' },
              },
              'clusters'
            ); // Add below clusters

            // Add county boundary lines
            map.addLayer(
              {
                id: 'county-lines',
                type: 'line',
                source: 'county-boundaries',
                paint: {
                  'line-color': '#6366f1',
                  'line-width': 2,
                  'line-opacity': 0.5,
                  'line-dasharray': [4, 2],
                },
                layout: { visibility: 'none' },
              },
              'clusters'
            );

            // Create label points from centroids
            const labelFeatures = countyData.features.map((f: any) => ({
              type: 'Feature',
              properties: { name: f.properties.name },
              geometry: {
                type: 'Point',
                coordinates: f.properties.labelCoordinates,
              },
            }));

            map.addSource('county-labels', {
              type: 'geojson',
              data: { type: 'FeatureCollection', features: labelFeatures },
            });

            // Add county labels
            map.addLayer({
              id: 'county-labels',
              type: 'symbol',
              source: 'county-labels',
              layout: {
                'text-field': ['concat', ['get', 'name'], ' County'],
                'text-size': 13,
                'text-font': ['Noto Sans Bold'],
                'text-transform': 'uppercase',
                'text-letter-spacing': 0.1,
                visibility: 'none',
              },
              paint: {
                'text-color': '#6366f1',
                'text-halo-color': '#ffffff',
                'text-halo-width': 2,
                'text-opacity': 0.8,
              },
            });

            countyBoundariesLoaded = true;
            console.log(`Loaded ${countyData.features.length} county boundaries`);
          } catch (error) {
            console.error('Failed to load county boundaries:', error);
          }
        }

        showCountiesCheckbox?.addEventListener('change', async () => {
          // Lazy load county boundaries on first enable
          if (showCountiesCheckbox.checked && !countyBoundariesLoaded) {
            await loadCountyBoundaries();
          }

          const visibility = showCountiesCheckbox.checked ? 'visible' : 'none';
          if (map.getLayer('county-fill')) {
            map.setLayoutProperty('county-fill', 'visibility', visibility);
          }
          if (map.getLayer('county-lines')) {
            map.setLayoutProperty('county-lines', 'visibility', visibility);
          }
          if (map.getLayer('county-labels')) {
            map.setLayoutProperty('county-labels', 'visibility', visibility);
          }
        });

        // ========================================
        // TRANSIT & TRAFFIC LAYERS (inside combined panel)
        // ========================================
        const transitSelectNone = document.getElementById('transit-select-none');
        const transitRailContainer = document.getElementById('transit-rail-operators');
        const transitFerryContainer = document.getElementById('transit-ferry-operators');
        const transitBusContainer = document.getElementById('transit-bus-operators');

        // Note: transitData, transitLayersAdded, activeOperators are hoisted to top of map.on('load')

        // Load transit data from API
        async function loadTransitData() {
          if (transitData) return transitData;
          try {
            const response = await fetch('/api/transit-stops.json');
            transitData = await response.json();
            return transitData;
          } catch (error) {
            console.error('Failed to load transit data:', error);
            return null;
          }
        }

        // Load transit route lines from API
        async function loadTransitRoutes() {
          if (transitRoutesData) return transitRoutesData;
          try {
            const response = await fetch('/api/transit-routes.json');
            transitRoutesData = await response.json();
            return transitRoutesData;
          } catch (error) {
            console.error('Failed to load transit routes:', error);
            return null;
          }
        }

        // Create operator checkbox UI
        function createOperatorCheckbox(operator: any) {
          const label = document.createElement('label');
          label.className =
            'flex items-center gap-2 cursor-pointer py-1 px-1 rounded hover:bg-neutral-100 dark:hover:bg-neutral-700';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `transit-op-${operator.id}`;
          checkbox.className = 'w-4 h-4 rounded text-primary-600 focus:ring-primary-500';
          checkbox.dataset.operatorId = operator.id;

          const colorDot = document.createElement('span');
          colorDot.className = 'w-3 h-3 rounded-sm flex-shrink-0'; // Square for transit
          colorDot.style.backgroundColor = operator.color;

          const text = document.createElement('span');
          text.className = 'text-sm text-neutral-700 dark:text-neutral-300 flex-1';
          text.textContent = operator.name;

          const count = document.createElement('span');
          count.className = 'text-xs text-neutral-400';
          count.textContent = operator.stationCount.toLocaleString();

          label.appendChild(checkbox);
          label.appendChild(colorDot);
          label.appendChild(text);
          label.appendChild(count);

          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              activeOperators.add(operator.id);
            } else {
              activeOperators.delete(operator.id);
            }
            updateTransitLayers();
          });

          return label;
        }

        // Initialize transit panel UI
        async function initTransitPanel() {
          const data = await loadTransitData();
          if (!data || !data.metadata?.operators) return;

          const operators = data.metadata.operators;

          // Group by type
          const railOps = operators.filter((o: any) => o.type === 'rail');
          const ferryOps = operators.filter((o: any) => o.type === 'ferry');
          const busOps = operators.filter((o: any) => o.type === 'bus');

          railOps.forEach((op: any) =>
            transitRailContainer?.appendChild(createOperatorCheckbox(op))
          );
          ferryOps.forEach((op: any) =>
            transitFerryContainer?.appendChild(createOperatorCheckbox(op))
          );
          busOps.forEach((op: any) => transitBusContainer?.appendChild(createOperatorCheckbox(op)));
        }

        // Add/update transit layers on map
        async function addTransitLayers() {
          if (!transitData || transitLayersAdded) return;

          // Load route lines data
          const routesData = await loadTransitRoutes();

          // Add source for transit route lines (if available)
          if (routesData) {
            map.addSource('transit-routes', {
              type: 'geojson',
              data: routesData as any,
            });

            // Transit route lines layer - rendered below stops
            map.addLayer({
              id: 'transit-routes',
              type: 'line',
              source: 'transit-routes',
              paint: {
                'line-color': ['get', 'color'],
                'line-width': ['interpolate', ['linear'], ['zoom'], 8, 2, 12, 4, 16, 6],
                'line-opacity': 0.85,
              },
              layout: {
                'line-cap': 'round',
                'line-join': 'round',
                visibility: 'none',
              },
              filter: ['==', ['get', 'operatorId'], ''], // Start with nothing visible
            });

            // Route line casing (outline) for better visibility
            map.addLayer(
              {
                id: 'transit-routes-casing',
                type: 'line',
                source: 'transit-routes',
                paint: {
                  'line-color': '#ffffff',
                  'line-width': ['interpolate', ['linear'], ['zoom'], 8, 4, 12, 7, 16, 10],
                  'line-opacity': 0.5,
                },
                layout: {
                  'line-cap': 'round',
                  'line-join': 'round',
                  visibility: 'none',
                },
                filter: ['==', ['get', 'operatorId'], ''], // Start with nothing visible
              },
              'transit-routes' // Insert below the main route line
            );
          }

          // Add source with all transit stops
          map.addSource('transit-stops', {
            type: 'geojson',
            data: transitData as any,
          });

          // Transit circles layer - uses color from feature properties
          map.addLayer({
            id: 'transit-stops',
            type: 'circle',
            source: 'transit-stops',
            paint: {
              'circle-color': ['get', 'color'],
              'circle-radius': ['interpolate', ['linear'], ['zoom'], 8, 3, 12, 5, 16, 8],
              'circle-stroke-width': 1.5,
              'circle-stroke-color': '#ffffff',
              'circle-opacity': 0.9,
            },
            layout: {
              visibility: 'none',
            },
            filter: ['==', ['get', 'operatorId'], ''], // Start with nothing visible
          });

          // Transit labels layer
          map.addLayer({
            id: 'transit-labels',
            type: 'symbol',
            source: 'transit-stops',
            minzoom: 13,
            layout: {
              'text-field': ['get', 'name'],
              'text-size': 10,
              'text-font': ['Noto Sans Regular'],
              'text-offset': [0, 1.2],
              'text-anchor': 'top',
              visibility: 'none',
            },
            paint: {
              'text-color': ['get', 'color'],
              'text-halo-color': '#ffffff',
              'text-halo-width': 1,
            },
            filter: ['==', ['get', 'operatorId'], ''], // Start with nothing visible
          });

          // Click handler for transit stops
          map.on('click', 'transit-stops', (e) => {
            if (!e.features || e.features.length === 0) return;
            const props = e.features[0].properties;
            const coords = (e.features[0].geometry as GeoJSON.Point).coordinates as [
              number,
              number,
            ];
            const [lng, lat] = coords;

            // Build popup content
            const operatorLinks: Record<string, string> = {
              BA: `https://www.bart.gov/stations`,
              CT: `https://www.caltrain.com/stations`,
              SF: `https://www.sfmta.com/getting-around/muni`,
              AC: `https://www.actransit.org`,
              SC: `https://www.vta.org`,
              SM: `https://www.samtrans.com`,
              GG: `https://www.goldengate.org/bus`,
              SA: `https://www.sonomamarintrain.org/stations`,
              GF: `https://www.goldengate.org/ferry`,
              SB: `https://sanfranciscobayferry.com`,
              CC: `https://countyconnection.com`,
              WH: `https://wheelsbus.com`,
              MA: `https://marintransit.org`,
              '3D': `https://trideltatransit.com`,
              WC: `https://westcat.org`,
              UC: `https://www.unioncity.org/transit`,
              CE: `https://acerail.com`,
              AM: `https://www.capitolcorridor.org`,
            };

            // Service alerts links (511.org transit page)
            const alertsLinks: Record<string, string> = {
              BA: 'https://511.org/transit/bart',
              CT: 'https://511.org/transit/caltrain',
              SF: 'https://511.org/transit/sf-muni',
              AC: 'https://511.org/transit/ac-transit',
              SC: 'https://511.org/transit/vta',
              SM: 'https://511.org/transit/samtrans',
              GG: 'https://511.org/transit/golden-gate-transit',
              SA: 'https://511.org/transit/smart',
              GF: 'https://511.org/transit/golden-gate-ferry',
              SB: 'https://511.org/transit/sf-bay-ferry',
              CC: 'https://511.org/transit/county-connection',
              WH: 'https://511.org/transit/wheels',
              MA: 'https://511.org/transit/marin-transit',
              '3D': 'https://511.org/transit/tri-delta-transit',
              WC: 'https://511.org/transit/westcat',
              UC: 'https://511.org/transit/union-city-transit',
              CE: 'https://511.org/transit/ace',
              AM: 'https://511.org/transit/capitol-corridor',
            };

            // OpenStreetMap link for directions
            const osmLink = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=17/${lat}/${lng}`;

            // Check if this is a consolidated station
            let operatorsHtml = '';
            if (props.isConsolidated && props.operators) {
              // Parse operators array (it's stringified in GeoJSON)
              let operators = props.operators;
              if (typeof operators === 'string') {
                try {
                  operators = JSON.parse(operators);
                } catch (e) {
                  operators = [];
                }
              }
              operatorsHtml = `
                <div class="mt-2 pt-2 border-t border-neutral-200 dark:border-neutral-600">
                  <p class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">Served by:</p>
                  <div class="flex flex-wrap gap-1">
                    ${operators
                      .map(
                        (op: any) => `
                      <a href="${operatorLinks[op.id] || '#'}" target="_blank" rel="noopener"
                         class="inline-flex items-center gap-1 text-xs px-1.5 py-0.5 rounded bg-neutral-100 dark:bg-neutral-700 hover:bg-neutral-200 dark:hover:bg-neutral-600">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${op.color}"></span>
                        ${op.name}
                      </a>
                    `
                      )
                      .join('')}
                  </div>
                </div>
              `;
            }

            const primaryOpId = props.operatorId?.split(',')[0] || '';
            const primaryLink = operatorLinks[primaryOpId] || '#';
            const alertsLink = alertsLinks[primaryOpId] || 'https://511.org/transit';

            // Build action links
            const actionsHtml = `
              <div class="mt-2 pt-2 border-t border-neutral-200 dark:border-neutral-600 flex flex-wrap gap-2">
                <a href="${osmLink}" target="_blank" rel="noopener"
                   class="inline-flex items-center gap-1 text-xs text-primary-700 dark:text-primary-300 hover:underline">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  Directions
                </a>
                <a href="${alertsLink}" target="_blank" rel="noopener"
                   class="inline-flex items-center gap-1 text-xs text-amber-700 dark:text-amber-300 hover:underline">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                  </svg>
                  Service Alerts
                </a>
                <a href="${primaryLink}" target="_blank" rel="noopener"
                   class="inline-flex items-center gap-1 text-xs text-neutral-600 dark:text-neutral-300 hover:underline">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  Agency Info
                </a>
              </div>
            `;

            // Build description based on station type
            const descriptionHtml = props.isConsolidated
              ? `<p class="text-xs text-neutral-600 dark:text-neutral-300">Services: ${props.services || props.operator}</p>`
              : `<p class="text-xs text-neutral-600 dark:text-neutral-300">${props.operator} · ${props.type}</p>`;

            new maplibregl.Popup({ offset: 10, maxWidth: '300px' })
              .setLngLat(coords)
              .setHTML(
                `
                <div class="p-2">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${props.color}"></span>
                    <span class="font-semibold text-sm">${props.name}</span>
                  </div>
                  ${descriptionHtml}
                  ${props.isConsolidated ? operatorsHtml : ''}
                  ${actionsHtml}
                </div>
              `
              )
              .addTo(map);
          });

          map.on('mouseenter', 'transit-stops', () => {
            map.getCanvas().style.cursor = 'pointer';
          });
          map.on('mouseleave', 'transit-stops', () => {
            map.getCanvas().style.cursor = '';
          });

          transitLayersAdded = true;
        }

        // Update layer visibility based on selected operators
        async function updateTransitLayers() {
          if (!transitLayersAdded) {
            await addTransitLayers();
          }

          const hasActive = activeOperators.size > 0;
          const hasRoutes = map.getSource('transit-routes');

          if (hasActive) {
            // Build filter for active operators
            // Handle both single operator IDs and comma-separated consolidated IDs
            const operatorArray = Array.from(activeOperators);
            const stopsFilter = [
              'any',
              ['in', ['get', 'operatorId'], ['literal', operatorArray]],
              // For consolidated stations, check if any active operator is in the comma-separated list
              ...operatorArray.map((opId) => ['in', opId, ['string', ['get', 'operatorId']]]),
            ];

            // Route filter - simpler since routes don't have consolidated IDs
            const routesFilter = ['in', ['get', 'operatorId'], ['literal', operatorArray]];

            map.setFilter('transit-stops', stopsFilter as any);
            map.setFilter('transit-labels', stopsFilter as any);
            map.setLayoutProperty('transit-stops', 'visibility', 'visible');
            map.setLayoutProperty('transit-labels', 'visibility', 'visible');

            // Show route lines if source exists
            if (hasRoutes) {
              map.setFilter('transit-routes', routesFilter as any);
              map.setFilter('transit-routes-casing', routesFilter as any);
              map.setLayoutProperty('transit-routes', 'visibility', 'visible');
              map.setLayoutProperty('transit-routes-casing', 'visibility', 'visible');
            }

            // Update count badge (combined with traffic)
            updateLayersCount();
          } else {
            map.setLayoutProperty('transit-stops', 'visibility', 'none');
            map.setLayoutProperty('transit-labels', 'visibility', 'none');

            // Hide route lines if source exists
            if (hasRoutes) {
              map.setLayoutProperty('transit-routes', 'visibility', 'none');
              map.setLayoutProperty('transit-routes-casing', 'visibility', 'none');
            }

            // Update count badge (combined with traffic)
            updateLayersCount();
          }
        }

        // Update combined layers count badge
        // Shows count of non-default filter/layer selections
        function updateLayersCount() {
          // Count hidden categories (deviation from default of all-visible)
          const hiddenCategoryCount = categories.size - enabledCategories.size;

          // Count active transit operators (default is none)
          const transitCount = activeOperators.size;

          // Count non-default traffic options
          // Default: all traffic options OFF (cleaner map view)
          const trafficDeviations = [
            trafficFlowCheckbox?.checked, // Deviation if traffic flow is ON
            trafficIncidentsCheckbox?.checked, // Deviation if incidents is ON
            trafficClosuresCheckbox?.checked, // Deviation if closures is ON
            trafficCamerasCheckbox?.checked, // Deviation if cameras is ON
            trafficVistasCheckbox?.checked, // Deviation if vistas is ON
          ].filter(Boolean).length;

          const totalDeviations = hiddenCategoryCount + transitCount + trafficDeviations;

          // Update combined filter count badge
          if (filterCountEl) {
            if (totalDeviations > 0) {
              filterCountEl.textContent = String(totalDeviations);
              filterCountEl.classList.remove('hidden');
              legendToggle?.classList.add('ring-2', 'ring-primary-500');
            } else {
              filterCountEl.classList.add('hidden');
              legendToggle?.classList.remove('ring-2', 'ring-primary-500');
            }
          }
        }

        // Clear all transit selections
        transitSelectNone?.addEventListener('click', () => {
          activeOperators.clear();
          const checkboxes = document.querySelectorAll(
            '#transit-rail-operators input, #transit-ferry-operators input, #transit-bus-operators input'
          ) as NodeListOf<HTMLInputElement>;
          checkboxes?.forEach((cb) => (cb.checked = false));
          updateTransitLayers();
        });

        // ========================================
        // TRAFFIC LAYER DATA (511.org + Caltrans)
        // ========================================
        // Note: Traffic checkboxes, AZURE_MAPS_KEY, and traffic state variables
        // are hoisted to top of map.on('load') to avoid reference errors

        // Load traffic data
        async function loadTrafficEvents() {
          if (trafficEventsData) return trafficEventsData;
          try {
            const response = await fetch('/api/traffic-events.json');
            trafficEventsData = await response.json();
            return trafficEventsData;
          } catch (error) {
            console.error('Failed to load traffic events:', error);
            return { type: 'FeatureCollection', features: [] };
          }
        }

        async function loadLaneClosures() {
          if (laneClosuresData) return laneClosuresData;
          try {
            const response = await fetch('/api/lane-closures.json');
            laneClosuresData = await response.json();
            return laneClosuresData;
          } catch (error) {
            console.error('Failed to load lane closures:', error);
            return { type: 'FeatureCollection', features: [] };
          }
        }

        async function loadCameras() {
          if (camerasData) return camerasData;
          try {
            const response = await fetch('/api/traffic-cameras.json');
            camerasData = await response.json();
            return camerasData;
          } catch (error) {
            console.error('Failed to load cameras:', error);
            return { type: 'FeatureCollection', features: [] };
          }
        }

        async function loadVistas() {
          if (vistasData) return vistasData;
          try {
            const response = await fetch('/api/vista-points.json');
            vistasData = await response.json();
            return vistasData;
          } catch (error) {
            console.error('Failed to load vista points:', error);
            return { type: 'FeatureCollection', features: [] };
          }
        }

        // Create triangle marker image for traffic layers
        function createTriangleImage(color: string, size: number = 24): ImageData {
          const canvas = document.createElement('canvas');
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d')!;

          // Draw white stroke/background
          ctx.beginPath();
          ctx.moveTo(size / 2, 2);
          ctx.lineTo(size - 2, size - 2);
          ctx.lineTo(2, size - 2);
          ctx.closePath();
          ctx.fillStyle = '#ffffff';
          ctx.fill();

          // Draw colored triangle (slightly smaller)
          ctx.beginPath();
          ctx.moveTo(size / 2, 5);
          ctx.lineTo(size - 5, size - 4);
          ctx.lineTo(5, size - 4);
          ctx.closePath();
          ctx.fillStyle = color;
          ctx.fill();

          return ctx.getImageData(0, 0, size, size);
        }

        // Add traffic layers to map
        async function addTrafficLayers() {
          if (trafficLayersAdded) return;

          // Load all data
          const [events, closures, cameras, vistas] = await Promise.all([
            loadTrafficEvents(),
            loadLaneClosures(),
            loadCameras(),
            loadVistas(),
          ]);

          // Add triangle marker images
          if (!map.hasImage('triangle-red')) {
            map.addImage('triangle-red', createTriangleImage('#EF4444', 24));
          }
          if (!map.hasImage('triangle-amber')) {
            map.addImage('triangle-amber', createTriangleImage('#F59E0B', 20));
          }
          if (!map.hasImage('triangle-blue')) {
            map.addImage('triangle-blue', createTriangleImage('#3B82F6', 18));
          }
          if (!map.hasImage('triangle-green')) {
            map.addImage('triangle-green', createTriangleImage('#22C55E', 22));
          }

          // Add traffic incidents source and layer (triangle)
          map.addSource('traffic-incidents', { type: 'geojson', data: events });
          map.addLayer({
            id: 'traffic-incidents',
            type: 'symbol',
            source: 'traffic-incidents',
            layout: {
              'icon-image': 'triangle-red',
              'icon-size': 1,
              'icon-allow-overlap': true,
              visibility: 'none',
            },
          });

          // Add lane closures source and layer (triangle)
          map.addSource('lane-closures', { type: 'geojson', data: closures });
          map.addLayer({
            id: 'lane-closures',
            type: 'symbol',
            source: 'lane-closures',
            layout: {
              'icon-image': 'triangle-amber',
              'icon-size': 1,
              'icon-allow-overlap': true,
              visibility: 'none',
            },
          });

          // Add cameras source and layer (triangle)
          map.addSource('traffic-cameras', { type: 'geojson', data: cameras });
          map.addLayer({
            id: 'traffic-cameras',
            type: 'symbol',
            source: 'traffic-cameras',
            layout: {
              'icon-image': 'triangle-blue',
              'icon-size': 1,
              'icon-allow-overlap': true,
              visibility: 'none',
            },
          });

          // Add vista points source and layer (triangle)
          map.addSource('vista-points', { type: 'geojson', data: vistas });
          map.addLayer({
            id: 'vista-points',
            type: 'symbol',
            source: 'vista-points',
            layout: {
              'icon-image': 'triangle-green',
              'icon-size': 1,
              'icon-allow-overlap': true,
              visibility: 'none',
            },
          });

          // Click handlers for traffic layers
          map.on('click', 'traffic-incidents', (e) => {
            if (!e.features?.length) return;
            const props = e.features[0].properties;
            const coords = (e.features[0].geometry as GeoJSON.Point).coordinates as [
              number,
              number,
            ];
            new maplibregl.Popup({ offset: 10, maxWidth: '300px' })
              .setLngLat(coords)
              .setHTML(
                `
                <div class="p-2">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span class="font-semibold text-sm">${props.type}</span>
                  </div>
                  <p class="text-xs text-neutral-700 dark:text-neutral-300 mb-2">${props.headline}</p>
                  <p class="text-xs text-neutral-500">Source: ${props.source}</p>
                </div>
              `
              )
              .addTo(map);
          });

          map.on('click', 'lane-closures', (e) => {
            if (!e.features?.length) return;
            const props = e.features[0].properties;
            const coords = (e.features[0].geometry as GeoJSON.Point).coordinates as [
              number,
              number,
            ];
            new maplibregl.Popup({ offset: 10, maxWidth: '280px' })
              .setLngLat(coords)
              .setHTML(
                `
                <div class="p-2">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                    <span class="font-semibold text-sm">${props.route} ${props.direction || ''}</span>
                  </div>
                  <p class="text-xs text-neutral-700 dark:text-neutral-300 mb-1">${props.typeOfWork || props.typeOfClosure}</p>
                  <p class="text-xs text-neutral-500">${props.lanesClosed}/${props.totalLanes} lanes closed</p>
                  ${props.startDate ? `<p class="text-xs text-neutral-400 mt-1">${props.startDate} ${props.startTime || ''}</p>` : ''}
                </div>
              `
              )
              .addTo(map);
          });

          map.on('click', 'traffic-cameras', (e) => {
            if (!e.features?.length) return;
            const props = e.features[0].properties;
            const coords = (e.features[0].geometry as GeoJSON.Point).coordinates as [
              number,
              number,
            ];
            const imageHtml = props.imageUrl
              ? `<img src="${props.imageUrl}" alt="Traffic camera" class="w-full rounded mt-2 max-h-40 object-cover" loading="lazy" />`
              : '';
            new maplibregl.Popup({ offset: 10, maxWidth: '300px' })
              .setLngLat(coords)
              .setHTML(
                `
                <div class="p-2">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                    <span class="font-semibold text-sm">${props.name}</span>
                  </div>
                  <p class="text-xs text-neutral-600">${props.nearbyPlace}, ${props.county}</p>
                  ${imageHtml}
                </div>
              `
              )
              .addTo(map);
          });

          map.on('click', 'vista-points', (e) => {
            if (!e.features?.length) return;
            const props = e.features[0].properties;
            const coords = (e.features[0].geometry as GeoJSON.Point).coordinates as [
              number,
              number,
            ];
            new maplibregl.Popup({ offset: 10, maxWidth: '250px' })
              .setLngLat(coords)
              .setHTML(
                `
                <div class="p-2">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    <span class="font-semibold text-sm">${props.name}</span>
                  </div>
                  <p class="text-xs text-neutral-600">Route ${props.route} · ${props.county} County</p>
                  <a href="https://maps.apple.com/?daddr=${coords[1]},${coords[0]}" target="_blank" rel="noopener" class="text-xs text-primary-600 hover:underline mt-1 block">Get directions →</a>
                </div>
              `
              )
              .addTo(map);
          });

          // Cursor handlers
          ['traffic-incidents', 'lane-closures', 'traffic-cameras', 'vista-points'].forEach(
            (layerId) => {
              map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
              });
              map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
              });
            }
          );

          trafficLayersAdded = true;
        }

        // Add Azure Maps traffic flow layer
        function addTrafficFlowLayer() {
          if (trafficFlowLayerAdded) return;

          // Skip if Azure Maps key is not configured
          if (!AZURE_MAPS_KEY) {
            console.warn('Traffic flow unavailable: PUBLIC_AZURE_MAPS_KEY not configured');
            return;
          }

          try {
            // Add Azure Maps traffic flow tile source (via proxy to reduce API costs)
            if (!map.getSource('azure-traffic-flow')) {
              map.addSource('azure-traffic-flow', {
                type: 'raster',
                tiles: [
                  'https://baytides-integrity.azurewebsites.net/api/traffic-tiles/{z}/{x}/{y}',
                ],
                tileSize: 256,
                attribution: '© Microsoft Azure Maps',
              });
            }

            // Find a suitable layer to insert before (labels layer)
            const layers = map.getStyle().layers;
            let beforeLayerId: string | undefined;
            for (const layer of layers) {
              if (layer.id.includes('label') || layer.id.includes('text')) {
                beforeLayerId = layer.id;
                break;
              }
            }

            // Add traffic flow layer (insert below labels but above roads)
            // Enabled by default for real-time traffic awareness
            map.addLayer(
              {
                id: 'traffic-flow',
                type: 'raster',
                source: 'azure-traffic-flow',
                paint: {
                  'raster-opacity': 0.7,
                },
                layout: {
                  visibility: 'visible',
                },
              },
              beforeLayerId
            );

            trafficFlowLayerAdded = true;
          } catch (error) {
            console.warn('Failed to add traffic flow layer:', error);
          }
        }

        // Update traffic flow layer visibility
        function updateTrafficFlowLayer() {
          if (!trafficFlowLayerAdded) {
            addTrafficFlowLayer();
          }

          const flowVisible = trafficFlowCheckbox?.checked;
          if (map.getLayer('traffic-flow')) {
            map.setLayoutProperty('traffic-flow', 'visibility', flowVisible ? 'visible' : 'none');
          }

          // Update combined layers count badge
          updateLayersCount();
        }

        // Update traffic layer visibility
        async function updateTrafficLayers() {
          // Add layers if not yet added (lazy loading on first checkbox interaction)
          if (!trafficLayersAdded) {
            await addTrafficLayers();
          }

          // Exit if layers still couldn't be added (e.g., API failure)
          if (!trafficLayersAdded) return;

          const incidentsVisible = trafficIncidentsCheckbox?.checked;
          const closuresVisible = trafficClosuresCheckbox?.checked;
          const camerasVisible = trafficCamerasCheckbox?.checked;
          const vistasVisible = trafficVistasCheckbox?.checked;

          map.setLayoutProperty(
            'traffic-incidents',
            'visibility',
            incidentsVisible ? 'visible' : 'none'
          );
          map.setLayoutProperty(
            'lane-closures',
            'visibility',
            closuresVisible ? 'visible' : 'none'
          );
          map.setLayoutProperty(
            'traffic-cameras',
            'visibility',
            camerasVisible ? 'visible' : 'none'
          );
          map.setLayoutProperty('vista-points', 'visibility', vistasVisible ? 'visible' : 'none');

          // Update combined layers count badge
          updateLayersCount();
        }

        // Checkbox change handlers for traffic (async to handle lazy loading)
        [
          trafficIncidentsCheckbox,
          trafficClosuresCheckbox,
          trafficCamerasCheckbox,
          trafficVistasCheckbox,
        ].forEach((cb) => {
          cb?.addEventListener('change', () => updateTrafficLayers());
        });

        // Traffic flow checkbox handler (separate since it uses Azure Maps tiles)
        trafficFlowCheckbox?.addEventListener('change', updateTrafficFlowLayer);

        // Legend panel toggle (combined filters & layers panel)
        // Must be inside map.on('load') to access transit/traffic functions
        const legendClose = document.getElementById('legend-close');

        function openLegendPanel() {
          legendPanel?.classList.remove('hidden');
          legendToggle?.classList.add('hidden');
          legendToggle?.setAttribute('aria-expanded', 'true');
        }

        function closeLegendPanel() {
          legendPanel?.classList.add('hidden');
          legendToggle?.classList.remove('hidden');
          legendToggle?.setAttribute('aria-expanded', 'false');
        }

        legendToggle?.addEventListener('click', async () => {
          openLegendPanel();

          // Initialize transit on first open
          if (!transitData) {
            await initTransitPanel();
            addTransitLayers();
          }
          // Initialize traffic on first open
          if (!trafficLayersAdded) {
            await addTrafficLayers();
            // Sync layer visibility with checkbox states
            updateTrafficLayers();
            updateTrafficFlowLayer();
          }
        });

        legendClose?.addEventListener('click', () => {
          closeLegendPanel();
        });
      } catch (error) {
        console.error('Error loading programs:', error);
        if (loadingEl) {
          loadingEl.innerHTML = `
            <div class="text-center text-red-600">
              <p>Failed to load map data</p>
              <button onclick="location.reload()" class="mt-2 text-primary-600 hover:underline">Retry</button>
            </div>
          `;
        }
      }
    });

    // Fullscreen toggle
    const fullscreenToggle = document.getElementById('fullscreen-toggle');
    const fullscreenIconExpand = document.getElementById('fullscreen-icon-expand');
    const fullscreenIconCollapse = document.getElementById('fullscreen-icon-collapse');
    const mapContainer = document.getElementById('map-container');

    let isFullscreen = false;

    fullscreenToggle?.addEventListener('click', () => {
      isFullscreen = !isFullscreen;

      if (isFullscreen) {
        mapContainer?.classList.add('map-fullscreen');
        fullscreenIconExpand?.classList.add('hidden');
        fullscreenIconCollapse?.classList.remove('hidden');
        fullscreenToggle.setAttribute('aria-label', 'Exit fullscreen');
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
      } else {
        mapContainer?.classList.remove('map-fullscreen');
        fullscreenIconExpand?.classList.remove('hidden');
        fullscreenIconCollapse?.classList.add('hidden');
        fullscreenToggle.setAttribute('aria-label', 'Toggle fullscreen');
        // Restore body scroll
        document.body.style.overflow = '';
      }

      // Resize map to fit new container size
      setTimeout(() => {
        map?.resize();
      }, 100);
    });

    // Exit fullscreen with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isFullscreen) {
        fullscreenToggle?.click();
      }
    });

    // Context Menu functionality
    const contextMenu = document.getElementById('map-context-menu');
    const contextIsochrone = document.getElementById('context-isochrone');
    const contextDirections = document.getElementById('context-directions');
    const contextNearby = document.getElementById('context-nearby');
    const isochroneLegend = document.getElementById('isochrone-legend');
    const clearIsochroneBtn = document.getElementById('clear-isochrone');

    let contextMenuLngLat: [number, number] | null = null;
    let isochroneSourceAdded = false;

    function hideContextMenu() {
      contextMenu?.classList.add('hidden');
    }

    function showContextMenu(x: number, y: number, lngLat: [number, number]) {
      if (!contextMenu) return;

      contextMenuLngLat = lngLat;

      // Position menu, keeping it within viewport
      const menuRect = contextMenu.getBoundingClientRect();
      const mapRect = document.getElementById('map-container')?.getBoundingClientRect();

      if (!mapRect) return;

      let left = x;
      let top = y;

      // Adjust if menu would go off right edge
      if (x + 200 > mapRect.right) {
        left = x - 200;
      }

      // Adjust if menu would go off bottom edge
      if (y + 150 > mapRect.bottom) {
        top = y - 150;
      }

      contextMenu.style.left = `${left}px`;
      contextMenu.style.top = `${top}px`;
      contextMenu.classList.remove('hidden');
    }

    // Right-click handler
    map?.on('contextmenu', (e) => {
      e.preventDefault();
      const lngLat: [number, number] = [e.lngLat.lng, e.lngLat.lat];
      const point = map.project(lngLat);
      const containerRect = document.getElementById('map-container')?.getBoundingClientRect();

      if (containerRect) {
        showContextMenu(point.x + containerRect.left, point.y + containerRect.top, lngLat);
      }
    });

    // Hide context menu on click elsewhere
    document.addEventListener('click', (e) => {
      if (!contextMenu?.contains(e.target as Node)) {
        hideContextMenu();
      }
    });

    map?.on('movestart', hideContextMenu);

    // Isochrone colors (from innermost to outermost)
    const ISOCHRONE_COLORS = [
      { time: 5, color: 'rgba(74, 222, 128, 0.4)', border: 'rgba(74, 222, 128, 0.8)' }, // green
      { time: 10, color: 'rgba(250, 204, 21, 0.4)', border: 'rgba(250, 204, 21, 0.8)' }, // yellow
      { time: 15, color: 'rgba(251, 146, 60, 0.4)', border: 'rgba(251, 146, 60, 0.8)' }, // orange
      { time: 20, color: 'rgba(248, 113, 113, 0.4)', border: 'rgba(248, 113, 113, 0.8)' }, // red
    ];

    // Add isochrone layer source
    function ensureIsochroneSource() {
      if (isochroneSourceAdded) return;

      map?.addSource('isochrone', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] },
      });

      // Add layers for each time band (in reverse order so smaller times are on top)
      ISOCHRONE_COLORS.slice()
        .reverse()
        .forEach((iso, i) => {
          map?.addLayer({
            id: `isochrone-fill-${iso.time}`,
            type: 'fill',
            source: 'isochrone',
            filter: ['==', ['get', 'time'], iso.time],
            paint: {
              'fill-color': iso.color,
              'fill-opacity': 0.6,
            },
          });

          map?.addLayer({
            id: `isochrone-line-${iso.time}`,
            type: 'line',
            source: 'isochrone',
            filter: ['==', ['get', 'time'], iso.time],
            paint: {
              'line-color': iso.border,
              'line-width': 2,
            },
          });
        });

      // Add marker for center point
      map?.addSource('isochrone-center', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] },
      });

      map?.addLayer({
        id: 'isochrone-center',
        type: 'circle',
        source: 'isochrone-center',
        paint: {
          'circle-radius': 8,
          'circle-color': '#3b82f6',
          'circle-stroke-width': 3,
          'circle-stroke-color': '#ffffff',
        },
      });

      isochroneSourceAdded = true;
    }

    // Fetch isochrone data using OpenRouteService API
    async function fetchIsochrone(
      lng: number,
      lat: number
    ): Promise<GeoJSON.FeatureCollection | null> {
      // Using OpenRouteService public API (free tier allows 40 req/min)
      // Note: For production, consider self-hosting Valhalla or OSRM
      const times = [5, 10, 15, 20]; // minutes
      const features: GeoJSON.Feature[] = [];

      // Create approximate isochrones using concentric circles
      // This is a fallback if no API is available
      for (const time of times) {
        // Rough estimate: 5 min ~ 3km at 36km/h average city driving
        const radiusKm = time * 0.6; // km per minute
        const radiusDeg = radiusKm / 111; // approximate degrees

        // Create a circle polygon
        const points = 32;
        const coordinates: [number, number][] = [];

        for (let i = 0; i <= points; i++) {
          const angle = (i / points) * 2 * Math.PI;
          coordinates.push([
            lng + radiusDeg * Math.cos(angle) * 1.3, // Adjust for longitude compression at this latitude
            lat + radiusDeg * Math.sin(angle),
          ]);
        }

        features.push({
          type: 'Feature',
          properties: { time },
          geometry: {
            type: 'Polygon',
            coordinates: [coordinates],
          },
        });
      }

      return {
        type: 'FeatureCollection',
        features: features.reverse(), // Larger areas first so smaller ones render on top
      };
    }

    // Show isochrone from a point
    async function showIsochrone(lngLat: [number, number]) {
      hideContextMenu();
      ensureIsochroneSource();

      // Update center marker
      (map?.getSource('isochrone-center') as maplibregl.GeoJSONSource)?.setData({
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            properties: {},
            geometry: { type: 'Point', coordinates: lngLat },
          },
        ],
      });

      // Fetch and display isochrone
      const isochroneData = await fetchIsochrone(lngLat[0], lngLat[1]);

      if (isochroneData) {
        (map?.getSource('isochrone') as maplibregl.GeoJSONSource)?.setData(isochroneData);
        isochroneLegend?.classList.remove('hidden');
      }
    }

    // Clear isochrone
    function clearIsochrone() {
      if (map?.getSource('isochrone')) {
        (map.getSource('isochrone') as maplibregl.GeoJSONSource).setData({
          type: 'FeatureCollection',
          features: [],
        });
      }
      if (map?.getSource('isochrone-center')) {
        (map.getSource('isochrone-center') as maplibregl.GeoJSONSource).setData({
          type: 'FeatureCollection',
          features: [],
        });
      }
      isochroneLegend?.classList.add('hidden');
    }

    // Context menu handlers
    contextIsochrone?.addEventListener('click', () => {
      if (contextMenuLngLat) {
        showIsochrone(contextMenuLngLat);
      }
    });

    contextDirections?.addEventListener('click', () => {
      if (contextMenuLngLat) {
        hideContextMenu();
        const [lng, lat] = contextMenuLngLat;
        window.open(`https://maps.apple.com/?daddr=${lat},${lng}`, '_blank');
      }
    });

    contextNearby?.addEventListener('click', () => {
      if (contextMenuLngLat) {
        hideContextMenu();
        // Trigger the nearby programs functionality using this location
        const [lng, lat] = contextMenuLngLat;

        // Fly to location
        map?.flyTo({
          center: contextMenuLngLat,
          zoom: 13,
          duration: 500,
        });

        // Update nearby panel with this location
        if (nearbyPanel && nearbyLocation && nearbyList && programsGeoJSON) {
          userLocation = { lat, lng };
          nearbyLocation.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

          // Calculate distances and show nearby
          const distances = programsGeoJSON.features.map((f: any) => {
            const [fLng, fLat] = f.geometry.coordinates;
            const dist = haversineDistance(lat, lng, fLat, fLng);
            return { ...f, distance: dist };
          });

          distances.sort((a: any, b: any) => a.distance - b.distance);
          const nearby = distances.slice(0, 10);

          nearbyList.innerHTML = nearby
            .map(
              (f: any) => `
            <button type="button" class="w-full p-3 text-left hover:bg-neutral-50 dark:hover:bg-neutral-700 focus:bg-neutral-50 dark:focus:bg-neutral-700 focus:outline-none border-b border-neutral-200 dark:border-neutral-700 last:border-b-0" data-lng="${f.geometry.coordinates[0]}" data-lat="${f.geometry.coordinates[1]}">
              <div class="font-medium text-sm text-neutral-900 dark:text-white">${f.properties.name}</div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5">${f.properties.category}</div>
              <div class="text-xs text-primary-600 dark:text-primary-400 mt-0.5">${f.distance.toFixed(1)} mi away</div>
            </button>
          `
            )
            .join('');

          nearbyPanel.classList.remove('hidden');
        }
      }
    });

    clearIsochroneBtn?.addEventListener('click', clearIsochrone);

    // Location search functionality
    const searchInput = document.getElementById('location-search') as HTMLInputElement;
    const clearSearch = document.getElementById('clear-search');
    const suggestionsEl = document.getElementById('search-suggestions');
    const useMyLocationBtn = document.getElementById('use-my-location');
    const nearbyPanel = document.getElementById('nearby-panel');
    const nearbyList = document.getElementById('nearby-list');
    const nearbyLocation = document.getElementById('nearby-location');
    const closeNearbyBtn = document.getElementById('close-nearby');

    // Store GeoJSON data for nearby calculations
    let programsGeoJSON: any = null;
    let userLocation: { lat: number; lng: number } | null = null;

    // Track keyboard selection index for search suggestions
    let selectedIndex = -1;

    interface SearchResult {
      type: 'city' | 'zip' | 'address';
      name: string;
      displayName: string;
      lat: number;
      lng: number;
      county?: string;
    }

    // Bay Area bounding box for Nominatim queries
    const BAY_AREA_BOUNDS = {
      minLat: 36.8,
      maxLat: 38.9,
      minLon: -123.5,
      maxLon: -121.0,
    };

    // Search for matching cities and ZIP codes (local lookup)
    function searchLocationsLocal(query: string): SearchResult[] {
      const results: SearchResult[] = [];
      const q = query.toLowerCase().trim();

      if (!q) return results;

      // Check if query looks like a ZIP code (all digits)
      const isZipQuery = /^\d+$/.test(q);

      if (isZipQuery) {
        // Search ZIP codes
        Object.entries(ZIP_COORDINATES).forEach(([zip, data]) => {
          if (zip.startsWith(q)) {
            results.push({
              type: 'zip',
              name: zip,
              displayName: `${zip} (${data.city})`,
              lat: data.lat,
              lng: data.lng,
            });
          }
        });
      } else {
        // Search cities
        Object.entries(CITY_COORDINATES).forEach(([city, data]) => {
          if (city.toLowerCase().includes(q)) {
            results.push({
              type: 'city',
              name: city,
              displayName: `${city}, ${data.county} County`,
              lat: data.lat,
              lng: data.lng,
              county: data.county,
            });
          }
        });
      }

      // Sort by relevance (exact match first, then alphabetically)
      return results
        .sort((a, b) => {
          const aExact = a.name.toLowerCase() === q;
          const bExact = b.name.toLowerCase() === q;
          if (aExact && !bExact) return -1;
          if (!aExact && bExact) return 1;
          return a.name.localeCompare(b.name);
        })
        .slice(0, 8); // Limit to 8 results
    }

    // Check if query looks like a street address (has number at start or contains street terms)
    function looksLikeAddress(query: string): boolean {
      const q = query.trim().toLowerCase();
      // Starts with a number (like "123 Main St" or "1 Market")
      if (/^\d+\s/.test(q)) return true;
      // Contains a number followed by letters (like "100 california st")
      if (/\d+\s+[a-z]/i.test(q)) return true;
      // Contains common street terms
      const streetTerms = [
        'street',
        'st',
        'avenue',
        'ave',
        'road',
        'rd',
        'boulevard',
        'blvd',
        'drive',
        'dr',
        'lane',
        'ln',
        'way',
        'court',
        'ct',
        'place',
        'pl',
        'circle',
        'cir',
        'highway',
        'hwy',
        'parkway',
        'pkwy',
        'terrace',
        'ter',
        'trail',
        'trl',
        'square',
        'sq',
      ];
      return streetTerms.some(
        (term) => q.includes(` ${term}`) || q.includes(` ${term},`) || q.endsWith(` ${term}`)
      );
    }

    // Geocode address using Azure Maps API (via Azure Function proxy)
    async function geocodeAddress(query: string): Promise<SearchResult[]> {
      const results: SearchResult[] = [];

      try {
        // Call our Azure Function geocoding endpoint
        const url = new URL('https://baytides-integrity.azurewebsites.net/api/geocode');
        url.searchParams.set('q', query);

        const response = await fetch(url.toString());

        if (!response.ok) {
          console.error('Geocoding response not OK:', response.status);
          return results;
        }

        const data = await response.json();

        // Transform Azure Maps results to our format
        for (const item of data.results || []) {
          // Build a nice display name
          const parts = [];
          if (item.streetAddress) parts.push(item.streetAddress);
          if (item.city) parts.push(item.city);
          if (item.state) parts.push(item.state);
          if (item.postalCode) parts.push(item.postalCode);
          const displayName = parts.join(', ') || item.name;

          results.push({
            type: 'address',
            name: item.streetAddress || item.name?.split(',')[0] || item.name,
            displayName: displayName,
            lat: item.lat,
            lng: item.lng,
          });
        }
      } catch (error) {
        console.error('Geocoding error:', error);
      }

      return results;
    }

    // Combined search function
    async function searchLocations(query: string): Promise<SearchResult[]> {
      const q = query.trim();
      if (!q) return [];

      // First, get local results (cities and ZIP codes)
      const localResults = searchLocationsLocal(q);

      // Always try geocoding for queries that look like addresses
      // Also geocode if query is 4+ chars and not a perfect city match
      const isExactCityMatch = localResults.some(
        (r) => r.type === 'city' && r.name.toLowerCase() === q.toLowerCase()
      );

      if (looksLikeAddress(q)) {
        // Definitely an address - prioritize geocoding results
        const addressResults = await geocodeAddress(q);
        return [...addressResults, ...localResults.slice(0, 2)].slice(0, 8);
      } else if (!isExactCityMatch && q.length >= 4) {
        // Could be an address or place - try geocoding as supplement
        const addressResults = await geocodeAddress(q);
        // Combine: local first (if good matches), then addresses
        return [...localResults.slice(0, 3), ...addressResults].slice(0, 8);
      }

      return localResults;
    }

    // Render search suggestions
    function renderSuggestions(results: SearchResult[], isLoading = false) {
      if (!suggestionsEl) return;

      if (isLoading) {
        suggestionsEl.innerHTML = `
          <div class="px-4 py-3 text-sm text-neutral-600 dark:text-neutral-300 flex items-center gap-2">
            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M4 12a8 8 0 018-8" class="opacity-75"></path>
            </svg>
            Searching...
          </div>
        `;
        suggestionsEl.classList.remove('hidden');
        return;
      }

      if (results.length === 0) {
        // Show "no results" message for meaningful queries
        if (currentSearchQuery.trim().length >= 3) {
          suggestionsEl.innerHTML = `
            <div class="px-4 py-3 text-sm text-neutral-600 dark:text-neutral-300">
              No locations found for "${currentSearchQuery}". Try a city name, ZIP code, or street address.
            </div>
          `;
          suggestionsEl.classList.remove('hidden');
        } else {
          suggestionsEl.classList.add('hidden');
        }
        return;
      }

      // Get icon for result type
      const getIcon = (type: string) => {
        switch (type) {
          case 'city':
            return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>';
          case 'zip':
            return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>';
          case 'address':
            return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>';
          default:
            return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>';
        }
      };

      // Truncate long display names for addresses
      const truncateDisplayName = (name: string, maxLen = 60) => {
        if (name.length <= maxLen) return name;
        return name.substring(0, maxLen) + '...';
      };

      suggestionsEl.innerHTML = results
        .map(
          (result, index) => `
        <button
          type="button"
          role="option"
          id="search-suggestion-${index}"
          class="w-full px-4 py-3 text-left text-sm hover:bg-neutral-100 dark:hover:bg-neutral-700 focus:bg-neutral-100 dark:focus:bg-neutral-700 focus:outline-none flex items-center gap-3 min-h-[44px] ${index === 0 ? 'rounded-t-lg' : ''} ${index === results.length - 1 ? 'rounded-b-lg' : ''}"
          data-lat="${result.lat}"
          data-lng="${result.lng}"
          data-name="${result.name}"
          data-type="${result.type}"
          tabindex="-1"
        >
          <svg class="w-4 h-4 text-neutral-600 dark:text-neutral-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            ${getIcon(result.type)}
          </svg>
          <span class="text-neutral-900 dark:text-neutral-100 truncate">${truncateDisplayName(result.displayName)}</span>
        </button>
      `
        )
        .join('');

      suggestionsEl.classList.remove('hidden');

      // Reset keyboard selection
      selectedIndex = -1;
      searchInput?.removeAttribute('aria-activedescendant');

      // Add click handlers to suggestion buttons
      suggestionsEl.querySelectorAll('button').forEach((btn) => {
        btn.addEventListener('click', () => {
          const lat = parseFloat(btn.getAttribute('data-lat') || '0');
          const lng = parseFloat(btn.getAttribute('data-lng') || '0');
          const name = btn.getAttribute('data-name') || '';

          flyToLocation(lat, lng, name);
        });
      });
    }

    // Fly to location and optionally add a marker
    let searchMarker: maplibregl.Marker | null = null;

    function flyToLocation(lat: number, lng: number, name: string) {
      // Remove existing search marker
      if (searchMarker) {
        searchMarker.remove();
      }

      // Fly to location
      map.flyTo({
        center: [lng, lat],
        zoom: 13,
        duration: 1500,
        essential: true,
      });

      // Add a marker for the searched location
      const markerEl = document.createElement('div');
      markerEl.className = 'search-marker';
      markerEl.innerHTML = `
        <svg class="w-8 h-8 text-primary-600 drop-shadow-lg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
      `;

      searchMarker = new maplibregl.Marker({ element: markerEl, anchor: 'bottom' })
        .setLngLat([lng, lat])
        .addTo(map);

      // Update input and hide suggestions
      if (searchInput) {
        searchInput.value = name;
      }
      if (suggestionsEl) {
        suggestionsEl.classList.add('hidden');
      }
      if (clearSearch) {
        clearSearch.classList.remove('hidden');
      }

      // Show nearby programs panel
      userLocation = { lat, lng };
      showNearbyPrograms(lat, lng, name);
    }

    // Haversine formula to calculate distance between two points (on-device, privacy-preserving)
    function calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
      const R = 3959; // Earth's radius in miles
      const dLat = ((lat2 - lat1) * Math.PI) / 180;
      const dLon = ((lon2 - lon1) * Math.PI) / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos((lat1 * Math.PI) / 180) *
          Math.cos((lat2 * Math.PI) / 180) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Format distance for display
    function formatDistance(miles: number): string {
      if (miles < 0.1) return 'Less than 0.1 mi';
      if (miles < 1) return `${miles.toFixed(1)} mi`;
      return `${miles.toFixed(1)} mi`;
    }

    // Show nearby programs panel with sorted list
    function showNearbyPrograms(lat: number, lng: number, locationName: string) {
      if (!programsGeoJSON || !nearbyPanel || !nearbyList || !nearbyLocation) return;

      // Calculate distances for all programs (on-device)
      const programsWithDistance = programsGeoJSON.features
        .map((feature: any) => {
          const [pLng, pLat] = feature.geometry.coordinates;
          const distance = calculateDistance(lat, lng, pLat, pLng);
          return {
            ...feature.properties,
            distance,
            coordinates: feature.geometry.coordinates,
          };
        })
        .filter((p: any) => p.distance <= 10) // Within 10 miles
        .sort((a: any, b: any) => a.distance - b.distance)
        .slice(0, 20); // Top 20 nearest

      // Update location display
      nearbyLocation.textContent = locationName;

      // Render programs list
      if (programsWithDistance.length === 0) {
        nearbyList.innerHTML = `
          <div class="p-4 text-center text-neutral-600 dark:text-neutral-400">
            <p>No programs found within 10 miles.</p>
            <p class="text-sm mt-2">Try searching a different location.</p>
          </div>
        `;
      } else {
        nearbyList.innerHTML = programsWithDistance
          .map(
            (p: any) => `
          <button
            type="button"
            class="nearby-item w-full text-left p-3 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors"
            data-lng="${p.coordinates[0]}"
            data-lat="${p.coordinates[1]}"
            data-id="${p.id}"
          >
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <p class="font-medium text-neutral-900 dark:text-white text-sm truncate">${p.name}</p>
                <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">${p.category}</p>
              </div>
              <span class="text-xs font-medium text-primary-700 dark:text-primary-300 whitespace-nowrap">
                ${formatDistance(p.distance)}
              </span>
            </div>
            ${p.address ? `<p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1 truncate">${p.address}</p>` : ''}
          </button>
        `
          )
          .join('');

        // Add click handlers to fly to program
        nearbyList.querySelectorAll('.nearby-item').forEach((btn) => {
          btn.addEventListener('click', () => {
            const pLng = parseFloat(btn.getAttribute('data-lng') || '0');
            const pLat = parseFloat(btn.getAttribute('data-lat') || '0');

            map.flyTo({
              center: [pLng, pLat],
              zoom: 15,
              duration: 1000,
            });
          });
        });
      }

      // Show the panel
      nearbyPanel.classList.remove('hidden');
    }

    // Close nearby panel handler
    closeNearbyBtn?.addEventListener('click', () => {
      nearbyPanel?.classList.add('hidden');
    });

    // Use My Location button handler
    useMyLocationBtn?.addEventListener('click', async () => {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser.');
        return;
      }

      // Update button to show loading state
      const originalContent = useMyLocationBtn.innerHTML;
      useMyLocationBtn.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M4 12a8 8 0 018-8" class="opacity-75"></path>
        </svg>
      `;
      useMyLocationBtn.setAttribute('disabled', 'true');

      try {
        const position = await new Promise<GeolocationPosition>((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000,
          });
        });

        const { latitude, longitude } = position.coords;

        // Fly to user's location and show nearby programs
        flyToLocation(latitude, longitude, 'Your Location');
      } catch (error: any) {
        let message = 'Unable to get your location.';
        if (error.code === 1) {
          message = 'Location access denied. Please enable location permissions.';
        } else if (error.code === 2) {
          message = 'Location unavailable. Please try again.';
        } else if (error.code === 3) {
          message = 'Location request timed out. Please try again.';
        }
        alert(message);
      } finally {
        // Restore button
        useMyLocationBtn.innerHTML = originalContent;
        useMyLocationBtn.removeAttribute('disabled');
      }
    });

    // Handle search input
    let searchDebounce: ReturnType<typeof setTimeout> | null = null;
    let currentSearchQuery = '';

    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value;
      currentSearchQuery = query;

      // Show/hide clear button
      if (clearSearch) {
        if (query) {
          clearSearch.classList.remove('hidden');
        } else {
          clearSearch.classList.add('hidden');
        }
      }

      // Debounce search
      if (searchDebounce) clearTimeout(searchDebounce);

      // Show loading state for address-like queries
      if (query.trim().length >= 3 && looksLikeAddress(query)) {
        renderSuggestions([], true);
      }

      searchDebounce = setTimeout(
        async () => {
          if (query !== currentSearchQuery) return; // Query changed, skip
          const results = await searchLocations(query);
          if (query === currentSearchQuery) {
            // Still the current query
            renderSuggestions(results);
          }
        },
        looksLikeAddress(query) ? 400 : 150
      ); // Longer debounce for address queries
    });

    // Handle keyboard navigation
    function updateSelectedSuggestion(newIndex: number) {
      const buttons = suggestionsEl?.querySelectorAll('button[role="option"]');
      if (!buttons || buttons.length === 0) return;

      // Clamp index
      if (newIndex < 0) newIndex = buttons.length - 1;
      if (newIndex >= buttons.length) newIndex = 0;

      // Remove highlight from previous
      if (selectedIndex >= 0 && selectedIndex < buttons.length) {
        buttons[selectedIndex].classList.remove('bg-neutral-100', 'dark:bg-neutral-700');
        buttons[selectedIndex].setAttribute('aria-selected', 'false');
      }

      // Add highlight to new
      selectedIndex = newIndex;
      buttons[selectedIndex].classList.add('bg-neutral-100', 'dark:bg-neutral-700');
      buttons[selectedIndex].setAttribute('aria-selected', 'true');
      searchInput?.setAttribute('aria-activedescendant', `search-suggestion-${selectedIndex}`);

      // Scroll into view if needed
      (buttons[selectedIndex] as HTMLElement).scrollIntoView({ block: 'nearest' });
    }

    function selectCurrentSuggestion() {
      const buttons = suggestionsEl?.querySelectorAll('button[role="option"]');
      if (!buttons || selectedIndex < 0 || selectedIndex >= buttons.length) return false;

      const btn = buttons[selectedIndex] as HTMLElement;
      const lat = parseFloat(btn.getAttribute('data-lat') || '0');
      const lng = parseFloat(btn.getAttribute('data-lng') || '0');
      const name = btn.getAttribute('data-name') || '';

      flyToLocation(lat, lng, name);
      selectedIndex = -1;
      return true;
    }

    searchInput?.addEventListener('keydown', async (e) => {
      const isOpen = suggestionsEl && !suggestionsEl.classList.contains('hidden');

      if (e.key === 'Escape') {
        suggestionsEl?.classList.add('hidden');
        selectedIndex = -1;
        searchInput.removeAttribute('aria-activedescendant');
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (isOpen) {
          updateSelectedSuggestion(selectedIndex + 1);
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (isOpen) {
          updateSelectedSuggestion(selectedIndex - 1);
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        // If a suggestion is selected, use it
        if (isOpen && selectedIndex >= 0 && selectCurrentSuggestion()) {
          return;
        }
        // Otherwise search for the query
        const query = searchInput.value.trim();
        renderSuggestions([], true); // Show loading
        const results = await searchLocations(query);
        if (results.length > 0) {
          flyToLocation(results[0].lat, results[0].lng, results[0].name);
        } else {
          renderSuggestions([]); // Hide if no results
        }
      }
    });

    // Clear search
    clearSearch?.addEventListener('click', () => {
      if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
      }
      if (suggestionsEl) {
        suggestionsEl.classList.add('hidden');
      }
      if (clearSearch) {
        clearSearch.classList.add('hidden');
      }
      if (searchMarker) {
        searchMarker.remove();
        searchMarker = null;
      }
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('#location-search') && !target.closest('#search-suggestions')) {
        suggestionsEl?.classList.add('hidden');
      }
    });

    // Show suggestions when focusing on search input with existing value
    searchInput?.addEventListener('focus', async () => {
      const query = searchInput.value;
      if (query) {
        // For quick focus, use local results first
        const localResults = searchLocationsLocal(query);
        if (localResults.length > 0) {
          renderSuggestions(localResults);
        } else if (query.length >= 3) {
          // Try full search with geocoding
          const results = await searchLocations(query);
          renderSuggestions(results);
        }
      }
    });

    // Listen for theme changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const isDarkNow = document.documentElement.classList.contains('dark');

          // Capture current state before style change
          const wasTrafficFlowVisible = trafficFlowCheckbox?.checked;
          const wasTrafficIncidentsVisible = trafficIncidentsCheckbox?.checked;
          const wasTrafficClosuresVisible = trafficClosuresCheckbox?.checked;
          const wasTrafficCamerasVisible = trafficCamerasCheckbox?.checked;
          const wasTrafficVistasVisible = trafficVistasCheckbox?.checked;
          const wasCountyVisible = showCountiesCheckbox?.checked;
          const savedActiveOperators = new Set(activeOperators);

          // Set the new style
          map.setStyle(isDarkNow ? DARK_STYLE : LIGHT_STYLE);

          // After style loads, re-add all dynamic layers
          map.once('style.load', async () => {
            // Reset layer-added flags since the style cleared everything
            trafficFlowLayerAdded = false;
            trafficLayersAdded = false;
            transitLayersAdded = false;
            countyBoundariesLoaded = false;

            // Re-add programs layer (always present)
            if (programsGeoJSON) {
              // Re-create pin marker images
              Object.entries(categoryColorMap).forEach(([category, color]) => {
                const imageName = `pin-${category.toLowerCase().replace(/\s+/g, '-')}`;
                if (!map.hasImage(imageName)) {
                  map.addImage(imageName, createPinMarker(color));
                }
              });

              map.addSource('programs', {
                type: 'geojson',
                data: programsGeoJSON,
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50,
              });

              map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'programs',
                filter: ['has', 'point_count'],
                paint: {
                  'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#3b82f6',
                    10,
                    '#8b5cf6',
                    25,
                    '#ef4444',
                  ],
                  'circle-radius': ['step', ['get', 'point_count'], 18, 10, 24, 25, 30],
                  'circle-stroke-width': 2,
                  'circle-stroke-color': '#ffffff',
                },
              });

              map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'programs',
                filter: ['has', 'point_count'],
                layout: {
                  'text-field': ['get', 'point_count_abbreviated'],
                  'text-font': ['Noto Sans Bold'],
                  'text-size': 12,
                },
                paint: {
                  'text-color': '#ffffff',
                },
              });

              map.addLayer({
                id: 'program-points',
                type: 'symbol',
                source: 'programs',
                filter: ['!', ['has', 'point_count']],
                layout: {
                  'icon-image': [
                    'match',
                    ['get', 'category'],
                    'Food',
                    'pin-food',
                    'Health',
                    'pin-health',
                    'Housing',
                    'pin-housing',
                    'Utilities',
                    'pin-utilities',
                    'Transportation',
                    'pin-transportation',
                    'Education',
                    'pin-education',
                    'Employment',
                    'pin-employment',
                    'Legal',
                    'pin-legal',
                    'Finance',
                    'pin-finance',
                    'Technology',
                    'pin-technology',
                    'Recreation',
                    'pin-recreation',
                    'Community',
                    'pin-community',
                    'pin-default',
                  ],
                  'icon-size': 1,
                  'icon-anchor': 'bottom',
                  'icon-allow-overlap': false,
                  'icon-ignore-placement': false,
                  'icon-padding': 2,
                },
              });

              // Re-apply category filter if any
              if (typeof updateMapFilter === 'function') {
                updateMapFilter();
              }
            }

            // Re-add traffic flow layer if it was visible
            if (wasTrafficFlowVisible && AZURE_MAPS_KEY) {
              addTrafficFlowLayer();
            }

            // Re-add traffic layers if any were loaded
            if (trafficEventsData || laneClosuresData || camerasData || vistasData) {
              // Add triangle marker images
              if (!map.hasImage('triangle-red')) {
                map.addImage('triangle-red', createTriangleImage('#EF4444', 24));
              }
              if (!map.hasImage('triangle-amber')) {
                map.addImage('triangle-amber', createTriangleImage('#F59E0B', 20));
              }
              if (!map.hasImage('triangle-blue')) {
                map.addImage('triangle-blue', createTriangleImage('#3B82F6', 18));
              }
              if (!map.hasImage('triangle-green')) {
                map.addImage('triangle-green', createTriangleImage('#22C55E', 22));
              }

              if (trafficEventsData) {
                map.addSource('traffic-incidents', { type: 'geojson', data: trafficEventsData });
                map.addLayer({
                  id: 'traffic-incidents',
                  type: 'symbol',
                  source: 'traffic-incidents',
                  layout: {
                    'icon-image': 'triangle-red',
                    'icon-size': 1,
                    'icon-allow-overlap': true,
                    visibility: wasTrafficIncidentsVisible ? 'visible' : 'none',
                  },
                });
              }

              if (laneClosuresData) {
                map.addSource('lane-closures', { type: 'geojson', data: laneClosuresData });
                map.addLayer({
                  id: 'lane-closures',
                  type: 'symbol',
                  source: 'lane-closures',
                  layout: {
                    'icon-image': 'triangle-amber',
                    'icon-size': 1,
                    'icon-allow-overlap': true,
                    visibility: wasTrafficClosuresVisible ? 'visible' : 'none',
                  },
                });
              }

              if (camerasData) {
                map.addSource('traffic-cameras', { type: 'geojson', data: camerasData });
                map.addLayer({
                  id: 'traffic-cameras',
                  type: 'symbol',
                  source: 'traffic-cameras',
                  layout: {
                    'icon-image': 'triangle-blue',
                    'icon-size': 1,
                    'icon-allow-overlap': true,
                    visibility: wasTrafficCamerasVisible ? 'visible' : 'none',
                  },
                });
              }

              if (vistasData) {
                map.addSource('vista-points', { type: 'geojson', data: vistasData });
                map.addLayer({
                  id: 'vista-points',
                  type: 'symbol',
                  source: 'vista-points',
                  layout: {
                    'icon-image': 'triangle-green',
                    'icon-size': 1,
                    'icon-allow-overlap': true,
                    visibility: wasTrafficVistasVisible ? 'visible' : 'none',
                  },
                });
              }

              trafficLayersAdded = true;
            }

            // Re-add transit layers if they were loaded
            if (transitData && transitRoutesData) {
              map.addSource('transit-routes', {
                type: 'geojson',
                data: transitRoutesData,
              });

              map.addLayer(
                {
                  id: 'transit-routes',
                  type: 'line',
                  source: 'transit-routes',
                  paint: {
                    'line-color': ['get', 'color'],
                    'line-width': 3,
                    'line-opacity': 0.8,
                  },
                  layout: { visibility: 'none' },
                },
                'clusters'
              );

              map.addSource('transit-stops', {
                type: 'geojson',
                data: transitData,
              });

              map.addLayer(
                {
                  id: 'transit-stops',
                  type: 'circle',
                  source: 'transit-stops',
                  paint: {
                    'circle-color': ['get', 'color'],
                    'circle-radius': 5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ffffff',
                  },
                  filter: ['==', ['get', 'operator'], ''],
                  layout: { visibility: 'none' },
                },
                'clusters'
              );

              map.addLayer({
                id: 'transit-labels',
                type: 'symbol',
                source: 'transit-stops',
                minzoom: 13,
                layout: {
                  'text-field': ['get', 'name'],
                  'text-size': 10,
                  'text-font': ['Noto Sans Regular'],
                  'text-offset': [0, 1.2],
                  'text-anchor': 'top',
                  visibility: 'none',
                },
                paint: {
                  'text-color': '#475569',
                  'text-halo-color': '#ffffff',
                  'text-halo-width': 1,
                },
                filter: ['==', ['get', 'operator'], ''],
              });

              transitLayersAdded = true;

              // Restore active operators
              activeOperators = savedActiveOperators;
              if (activeOperators.size > 0) {
                updateTransitLayers();
              }
            }

            // Re-add county boundaries if they were visible
            if (wasCountyVisible && countyDataCache) {
              map.addSource('county-boundaries', {
                type: 'geojson',
                data: countyDataCache,
              });

              map.addLayer(
                {
                  id: 'county-fill',
                  type: 'fill',
                  source: 'county-boundaries',
                  paint: {
                    'fill-color': '#6366f1',
                    'fill-opacity': 0.03,
                  },
                  layout: { visibility: 'visible' },
                },
                'clusters'
              );

              map.addLayer(
                {
                  id: 'county-lines',
                  type: 'line',
                  source: 'county-boundaries',
                  paint: {
                    'line-color': '#6366f1',
                    'line-width': 2,
                    'line-opacity': 0.5,
                    'line-dasharray': [4, 2],
                  },
                  layout: { visibility: 'visible' },
                },
                'clusters'
              );

              const labelFeatures = countyDataCache.features.map((f: any) => ({
                type: 'Feature',
                properties: { name: f.properties.name },
                geometry: {
                  type: 'Point',
                  coordinates: f.properties.labelCoordinates,
                },
              }));

              map.addSource('county-labels', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: labelFeatures },
              });

              map.addLayer({
                id: 'county-labels',
                type: 'symbol',
                source: 'county-labels',
                layout: {
                  'text-field': ['concat', ['get', 'name'], ' County'],
                  'text-size': 13,
                  'text-font': ['Noto Sans Bold'],
                  'text-transform': 'uppercase',
                  'text-letter-spacing': 0.1,
                  visibility: 'visible',
                },
                paint: {
                  'text-color': '#6366f1',
                  'text-halo-color': '#ffffff',
                  'text-halo-width': 2,
                  'text-opacity': 0.8,
                },
              });

              countyBoundariesLoaded = true;
            }
          });
        }
      });
    });

    observer.observe(document.documentElement, { attributes: true });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
</script>
