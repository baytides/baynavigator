---
import BaseLayout from '../layouts/BaseLayout.astro';
import SearchBar from '../components/SearchBar.astro';
import ProgramCard from '../components/ProgramCard.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load all programs for search (hidden by default, shown on search)
const dataDir = path.join(process.cwd(), 'src/data');
const NON_PROGRAM_FILES = [
  'cities.yml',
  'groups.yml',
  'zipcodes.yml',
  'suppressed.yml',
  'site-config.yml',
  'bay-area-jurisdictions.yml',
  'city-profiles.yml',
];

// Load suppressed programs
const suppressedFile = path.join(dataDir, 'suppressed.yml');
let suppressedIds = new Set<string>();
if (fs.existsSync(suppressedFile)) {
  const suppressedData = yaml.load(fs.readFileSync(suppressedFile, 'utf8')) as any[];
  if (Array.isArray(suppressedData)) {
    suppressedIds = new Set(suppressedData.map((s) => s.id));
  }
}

const allPrograms: any[] = [];
const files = fs
  .readdirSync(dataDir)
  .filter((f) => f.endsWith('.yml') && !NON_PROGRAM_FILES.includes(f));

for (const file of files) {
  const content = fs.readFileSync(path.join(dataDir, file), 'utf8');
  const data = yaml.load(content) as any;

  // Handle both formats: array of programs or object with {category, programs}
  const programs = Array.isArray(data) ? data : data.programs || [];

  for (const program of programs) {
    // Use program's own category if present, otherwise derive from filename
    const category =
      program.category ||
      file
        .replace('.yml', '')
        .replace(/-/g, ' ')
        .replace(/\b\w/g, (c: string) => c.toUpperCase());
    const id =
      program.id ||
      `${category.toLowerCase().replace(/\s+/g, '-')}-${(program.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;

    if (!suppressedIds.has(id)) {
      allPrograms.push({
        ...program,
        id,
        category,
        groups: program.groups || [],
      });
    }
  }
}
---

<BaseLayout
  title="Home"
  description="Find free and low-cost programs for food, housing, healthcare, utilities, and more across the San Francisco Bay Area."
>
  <!-- Hero Section -->
  <section class="hero">
    <div class="container-page text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        Find programs, services, and resources in the San Francisco Bay Area
      </h1>
      <p class="text-xl text-primary-100 mb-8 max-w-2xl mx-auto">
        Discover free and low-cost resources for food, housing, healthcare, utilities, and more.
      </p>
      <div class="max-w-2xl mx-auto">
        <SearchBar
          placeholder="Search for food assistance, utilities, healthcare..."
          size="large"
        />
      </div>
    </div>
  </section>

  <!-- Search Results (hidden by default, shown when searching) -->
  <section id="search-results" class="section hidden">
    <div class="container-page">
      <div class="flex items-center justify-between mb-6">
        <p id="home-results-count" class="text-neutral-600 dark:text-neutral-300">
          0 programs found
        </p>
        <button
          id="clear-search"
          class="text-sm text-primary-700 dark:text-primary-300 hover:underline"
        >
          Clear search
        </button>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="home-programs-grid">
        {
          allPrograms.map((program) => (
            <div class="home-program-card hidden" data-program-id={program.id}>
              <ProgramCard
                id={program.id}
                name={program.name}
                category={program.category}
                area={program.area}
                description={program.description}
                whatTheyOffer={program.what_they_offer}
                howToGetIt={program.how_to_get_it}
                phone={program.phone}
                link={program.link}
                linkText={program.link_text}
                groups={program.groups}
                verifiedBy={program.verified_by}
                verifiedDate={program.verified_date}
              />
            </div>
          ))
        }
      </div>

      <div id="no-results" class="hidden py-8">
        <div class="text-center mb-6">
          <p class="text-neutral-600 dark:text-neutral-300 mb-4">
            No programs found matching your search.
          </p>
          <a href="/directory" class="btn-primary">Browse All Programs</a>
        </div>

        <!-- Zero-result fallback resources -->
        <div
          class="mt-6 p-4 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-xl"
        >
          <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-3">
            Can't find what you need? Try these resources:
          </h3>
          <div class="grid gap-3 sm:grid-cols-2">
            <!-- 2-1-1 -->
            <a
              href="tel:211"
              class="flex items-center gap-3 p-3 bg-white dark:bg-neutral-800 rounded-lg hover:shadow-md transition-shadow no-underline"
            >
              <div
                class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold"
              >
                211
              </div>
              <div>
                <div class="font-medium text-neutral-900 dark:text-white">Call 2-1-1</div>
                <div class="text-sm text-neutral-600 dark:text-neutral-400">
                  Free referrals to local services 24/7
                </div>
              </div>
            </a>
            <!-- Bay Area Legal Aid -->
            <a
              href="tel:1-800-551-5554"
              class="flex items-center gap-3 p-3 bg-white dark:bg-neutral-800 rounded-lg hover:shadow-md transition-shadow no-underline"
            >
              <div
                class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"
                  ></path>
                </svg>
              </div>
              <div>
                <div class="font-medium text-neutral-900 dark:text-white">Bay Area Legal Aid</div>
                <div class="text-sm text-neutral-600 dark:text-neutral-400">
                  Free legal help: 1-800-551-5554
                </div>
              </div>
            </a>
            <!-- CalFresh -->
            <a
              href="https://www.getcalfresh.org"
              target="_blank"
              rel="noopener"
              class="flex items-center gap-3 p-3 bg-white dark:bg-neutral-800 rounded-lg hover:shadow-md transition-shadow no-underline"
            >
              <div
                class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                  ></path>
                </svg>
              </div>
              <div>
                <div class="font-medium text-neutral-900 dark:text-white">GetCalFresh.org</div>
                <div class="text-sm text-neutral-600 dark:text-neutral-400">
                  Apply for food assistance online
                </div>
              </div>
            </a>
            <!-- BenefitsCal -->
            <a
              href="https://benefitscal.com"
              target="_blank"
              rel="noopener"
              class="flex items-center gap-3 p-3 bg-white dark:bg-neutral-800 rounded-lg hover:shadow-md transition-shadow no-underline"
            >
              <div
                class="w-10 h-10 bg-amber-600 rounded-full flex items-center justify-center text-white"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                  ></path>
                </svg>
              </div>
              <div>
                <div class="font-medium text-neutral-900 dark:text-white">BenefitsCal</div>
                <div class="text-sm text-neutral-600 dark:text-neutral-400">
                  Apply for CA benefits (CalFresh, Medi-Cal)
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <div class="text-center mt-8">
        <a href="/directory" class="text-primary-700 dark:text-primary-300 hover:underline">
          View all programs in directory ‚Üí
        </a>
      </div>
    </div>
  </section>

  <!-- Category Tiles - SMC Connect style -->
  <section class="section bg-neutral-50 dark:bg-neutral-800">
    <div class="container-page">
      <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-2 text-center">
        Browse by Category
      </h2>
      <p class="text-neutral-600 dark:text-neutral-300 text-center mb-8">
        Select a category to find programs and services
      </p>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- Food -->
        <a
          href="/directory?category=Food"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üçé</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Food
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            Food banks, meals, CalFresh
          </p>
        </a>

        <!-- Community Services -->
        <a
          href="/directory?category=Community%20Services"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üèòÔ∏è</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Community
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            Local services, housing, shelters
          </p>
        </a>

        <!-- Health -->
        <a
          href="/directory?category=Health"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üè•</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Health
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            Medi-Cal, clinics, mental health
          </p>
        </a>

        <!-- Utilities -->
        <a
          href="/directory?category=Utilities"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üí°</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Utilities
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            CARE, FERA, bill assistance
          </p>
        </a>

        <!-- Transit -->
        <a
          href="/directory?category=Public%20Transit"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üöå</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Transit
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            Clipper discounts, paratransit
          </p>
        </a>

        <!-- Education -->
        <a
          href="/directory?category=Education"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üìö</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Education
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            Job training, college programs
          </p>
        </a>

        <!-- Legal -->
        <a
          href="/directory?category=Legal%20Services"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow"
        >
          <div class="text-4xl mb-3" aria-hidden="true">‚öñÔ∏è</div>
          <h3
            class="text-base font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Legal
          </h3>
          <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-1">
            Free legal aid, immigration help
          </p>
        </a>

        <!-- View All -->
        <a
          href="/directory"
          class="card text-center group no-underline hover:no-underline hover:shadow-lg transition-shadow bg-primary-50 dark:bg-primary-900/30 border-primary-200 dark:border-primary-800"
        >
          <div class="text-4xl mb-3" aria-hidden="true">üìã</div>
          <h3
            class="text-base font-semibold text-primary-900 dark:text-primary-200 group-hover:text-primary-800 dark:group-hover:text-primary-100"
          >
            View All
          </h3>
          <p class="text-xs text-primary-800 dark:text-primary-200 mt-1">Browse full directory</p>
        </a>
      </div>

      <!-- Quick Links Row -->
      <div class="mt-8 flex flex-wrap justify-center gap-4">
        <a
          href="/eligibility"
          class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-full text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-600 no-underline transition-colors"
        >
          <svg
            class="w-4 h-4 text-primary-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Eligibility Guides
        </a>
        <a
          href="/directory?group=seniors"
          class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-full text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-600 no-underline transition-colors"
        >
          <span aria-hidden="true">üëµ</span>
          Seniors (60+)
        </a>
        <a
          href="/directory?group=veterans"
          class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-full text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-600 no-underline transition-colors"
        >
          <span aria-hidden="true">üéñÔ∏è</span>
          Veterans
        </a>
        <a
          href="/directory?group=families"
          class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-full text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-600 no-underline transition-colors"
        >
          <span aria-hidden="true">üë®‚Äçüë©‚Äçüëß</span>
          Families
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
