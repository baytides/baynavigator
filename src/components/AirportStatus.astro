---
interface Props {
  code: string;
  name?: string;
  showWeather?: boolean;
  compact?: boolean;
}

interface AirportStatusData {
  Name: string;
  City: string;
  State: string;
  ICAO: string;
  IATA: string;
  SupportedAirport: boolean;
  Delay: boolean;
  DelayCount: number;
  Status: Array<{ Reason: string }>;
  Weather: {
    Weather: Array<{ Temp: string[] }>;
    Visibility: number[];
    Temp: string[];
    Wind: string[];
    Meta: Array<{ Updated: string }>;
  };
}

const { code, name, showWeather = true, compact = false } = Astro.props;

// Fetch airport status at build time (server-side, no CORS issues)
let initialStatus: AirportStatusData | null = null;
try {
  const response = await fetch(`https://external-api.faa.gov/asws/api/airport/status/${code}`);
  if (response.ok) {
    initialStatus = await response.json();
  }
} catch (error) {
  console.error(`Failed to fetch status for ${code}:`, error);
}

// Prepare initial display values from build-time data
const hasDelay = initialStatus?.Delay ?? false;
const delayCount = initialStatus?.DelayCount ?? 0;
const statusClass = initialStatus ? (hasDelay ? 'delay' : 'ok') : 'loading';
const statusText = initialStatus
  ? hasDelay
    ? delayCount === 1
      ? '1 delay'
      : `${delayCount} delays`
    : 'No delays'
  : 'Checking...';
const temp = initialStatus?.Weather?.Temp?.[0] || '';
const conditions = initialStatus?.Weather?.Weather?.[0]?.Temp?.[0] || '';
const wind = initialStatus?.Weather?.Wind?.[0] || '';
const visibility = initialStatus?.Weather?.Visibility?.[0];
const delays =
  initialStatus?.Status?.filter(
    (s) => s.Reason && s.Reason !== 'No known delays for this airport'
  ) || [];
---

<div class:list={['airport-status', { compact }]} data-airport={code}>
  <div class="airport-header">
    <span class="airport-code">{code}</span>
    {name && <span class="airport-name">{name}</span>}
    <span class="status-indicator" data-status={statusClass}>
      <span class="status-dot"></span>
      <span class="status-text">{statusText}</span>
    </span>
  </div>

  {
    showWeather && (
      <div class="weather-info" data-weather>
        {temp && <span class="weather-temp">{temp}</span>}
        {conditions && <span class="weather-conditions">{conditions}</span>}
        {wind && wind !== 'Calm' && <span class="weather-wind">{wind}</span>}
        {visibility && visibility < 10 && (
          <span class="weather-visibility">Visibility: {visibility} mi</span>
        )}
      </div>
    )
  }

  <div class="delay-info" data-delays>
    {delays.map((d) => <div class="delay-alert">{d.Reason}</div>)}
  </div>
</div>

<style>
  .airport-status {
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 8px;
    padding: 12px;
    background: var(--card-bg, #fff);
  }

  .airport-status.compact {
    padding: 8px 12px;
  }

  .airport-header {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .airport-code {
    font-weight: 700;
    font-size: 1.1em;
    color: var(--text-primary, #1f2937);
  }

  .airport-name {
    color: var(--text-secondary, #6b7280);
    font-size: 0.9em;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85em;
    margin-left: auto;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #94a3b8;
    flex-shrink: 0;
  }

  [data-status='ok'] .status-dot {
    background: #22c55e;
  }

  [data-status='ok'] .status-text {
    color: #16a34a;
  }

  [data-status='delay'] .status-dot {
    background: #f59e0b;
  }

  [data-status='delay'] .status-text {
    color: #d97706;
  }

  [data-status='closed'] .status-dot {
    background: #ef4444;
  }

  [data-status='closed'] .status-text {
    color: #dc2626;
  }

  [data-status='loading'] .status-dot {
    animation: pulse 1.5s infinite;
  }

  [data-status='error'] .status-dot {
    background: #94a3b8;
  }

  [data-status='error'] .status-text {
    color: #6b7280;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.4;
    }
  }

  .weather-info {
    margin-top: 8px;
    font-size: 0.85em;
    color: var(--text-secondary, #6b7280);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .weather-info:empty {
    display: none;
  }

  .compact .weather-info {
    margin-top: 4px;
    font-size: 0.8em;
  }

  .delay-info {
    margin-top: 8px;
  }

  .delay-info:empty {
    display: none;
  }

  .compact .delay-info {
    margin-top: 4px;
  }

  :global(.delay-alert) {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 4px;
    padding: 8px 10px;
    font-size: 0.9em;
    color: #92400e;
    margin-top: 4px;
  }

  :global(.delay-alert:first-child) {
    margin-top: 0;
  }

  .compact :global(.delay-alert) {
    padding: 6px 8px;
    font-size: 0.8em;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .airport-status {
      border-color: var(--border-color, #374151);
      background: var(--card-bg, #1f2937);
    }

    .airport-code {
      color: var(--text-primary, #f9fafb);
    }

    .airport-name {
      color: var(--text-secondary, #9ca3af);
    }

    .weather-info {
      color: var(--text-secondary, #9ca3af);
    }

    :global(.delay-alert) {
      background: #78350f;
      border-color: #b45309;
      color: #fef3c7;
    }
  }
</style>
