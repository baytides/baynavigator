---
import FavoritesButton from './FavoritesButton.astro';
import ShareButton from './ShareButton.astro';

interface Amenity {
  name: string;
  link?: string;
  ssid?: string; // WiFi network name
  password?: string; // WiFi password (optional, omit for open networks)
}

// Amenities can be either objects with name/link/ssid or just strings
type AmenityInput = Amenity | string;

// Normalize amenity to consistent format
function normalizeAmenity(amenity: AmenityInput): Amenity {
  if (typeof amenity === 'string') {
    return { name: amenity };
  }
  return amenity;
}

// Generate WiFi URL from SSID and optional password
// Format: wifi://ssid (open) or wifi://:password@ssid (WPA)
function generateWifiUrl(ssid: string, password?: string): string {
  const encodedSsid = encodeURIComponent(ssid);
  if (password) {
    const encodedPassword = encodeURIComponent(password);
    return `wifi://:${encodedPassword}@${encodedSsid}`;
  }
  return `wifi://${encodedSsid}`;
}

// Check if amenity is a WiFi amenity
function isWifiAmenity(amenity: Amenity): boolean {
  return (
    !!amenity.ssid ||
    amenity.name.toLowerCase().includes('wifi') ||
    amenity.name.toLowerCase().includes('wi-fi')
  );
}

interface Props {
  id: string;
  name: string;
  category: string;
  area: string;
  description?: string;
  whatTheyOffer?: string;
  howToGetIt?: string;
  phone?: string;
  link?: string;
  linkText?: string;
  groups?: string[];
  verifiedBy?: string;
  verifiedDate?: string;
  // New fields for parks/places
  city?: string;
  address?: string;
  mapLink?: string;
  amenities?: AmenityInput[];
  feeInfo?: string;
}

const {
  id,
  name,
  category,
  area,
  description,
  whatTheyOffer,
  howToGetIt,
  phone,
  link,
  linkText = 'Learn More',
  groups = [],
  verifiedBy,
  verifiedDate,
  city,
  address,
  mapLink,
  amenities = [],
  feeInfo,
} = Astro.props;

// Format verified date for display
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
};

// Calculate data freshness
const getDataFreshness = (
  dateStr?: string
): { status: 'fresh' | 'aging' | 'stale' | 'unknown'; message: string; daysAgo?: number } => {
  if (!dateStr) {
    return { status: 'unknown', message: 'Verification date unknown' };
  }

  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = Math.abs(now.getTime() - date.getTime());
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays <= 90) {
    return { status: 'fresh', message: `Verified ${diffDays} days ago`, daysAgo: diffDays };
  } else if (diffDays <= 180) {
    return {
      status: 'aging',
      message: `Last verified ${Math.floor(diffDays / 30)} months ago`,
      daysAgo: diffDays,
    };
  } else {
    const months = Math.floor(diffDays / 30);
    return {
      status: 'stale',
      message: `Last verified ${months} months ago - may need updating`,
      daysAgo: diffDays,
    };
  }
};

const dataFreshness = verifiedDate ? getDataFreshness(verifiedDate) : getDataFreshness();

// Shorten long verification source names for display
const shortVerifiedByNames: Record<string, string> = {
  'National Park Service': 'NPS',
  'California State Parks': 'CA Parks',
  'Institute of Museum and Library Services': 'IMLS',
  'USA.gov': 'USA.gov',
  ThroughLine: 'ThroughLine',
  '511.org': '511.org',
  Amtrak: 'Amtrak',
  FlixBus: 'FlixBus',
};
const displayVerifiedBy = verifiedBy ? shortVerifiedByNames[verifiedBy] || verifiedBy : null;

// Category badge colors - using 900-level text for AAA contrast (7:1 ratio)
const categoryColors: Record<string, string> = {
  Food: 'bg-green-100 text-green-900 dark:bg-green-900 dark:text-green-100',
  Health: 'bg-red-100 text-red-900 dark:bg-red-900 dark:text-red-100',
  Housing: 'bg-blue-100 text-blue-900 dark:bg-blue-900 dark:text-blue-100',
  Utilities: 'bg-yellow-100 text-yellow-900 dark:bg-yellow-900 dark:text-yellow-100',
  Transportation: 'bg-purple-100 text-purple-900 dark:bg-purple-900 dark:text-purple-100',
  Education: 'bg-indigo-100 text-indigo-900 dark:bg-indigo-900 dark:text-indigo-100',
  'Legal Services': 'bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-100',
  Finance: 'bg-emerald-100 text-emerald-900 dark:bg-emerald-900 dark:text-emerald-100',
  Technology: 'bg-cyan-100 text-cyan-900 dark:bg-cyan-900 dark:text-cyan-100',
  Recreation: 'bg-orange-100 text-orange-900 dark:bg-orange-900 dark:text-orange-100',
  'Community Services': 'bg-pink-100 text-pink-900 dark:bg-pink-900 dark:text-pink-100',
  'Parks & Open Space': 'bg-lime-100 text-lime-900 dark:bg-lime-900 dark:text-lime-100',
  Museums: 'bg-violet-100 text-violet-900 dark:bg-violet-900 dark:text-violet-100',
  'Library Resources': 'bg-amber-100 text-amber-900 dark:bg-amber-900 dark:text-amber-100',
  'Tax Preparation': 'bg-teal-100 text-teal-900 dark:bg-teal-900 dark:text-teal-100',
  Childcare: 'bg-rose-100 text-rose-900 dark:bg-rose-900 dark:text-rose-100',
  'Pet Resources': 'bg-fuchsia-100 text-fuchsia-900 dark:bg-fuchsia-900 dark:text-fuchsia-100',
  Equipment: 'bg-slate-100 text-slate-900 dark:bg-slate-800 dark:text-slate-100',
  'Public Transit': 'bg-sky-100 text-sky-900 dark:bg-sky-900 dark:text-sky-100',
};

const badgeColor =
  categoryColors[category] ||
  'bg-neutral-100 text-neutral-800 dark:bg-neutral-800 dark:text-neutral-200';

// Display location - prefer city if available, else area
const displayLocation = city || area;
---

<article
  class="card group transition-all duration-300"
  data-category={category.toLowerCase()}
  data-groups={groups.join(',')}
  data-verified={verifiedBy ? 'true' : 'false'}
  data-program-id={id}
  id={`program-${id}`}
  data-program-data={JSON.stringify({
    id,
    name,
    category,
    location: displayLocation,
    description,
    whatTheyOffer,
    howToGetIt,
    phone,
    address,
    mapLink,
    link,
    linkText,
    feeInfo,
    amenities: amenities.map((a) => {
      if (typeof a === 'string') return { name: a };
      return { name: a.name, ssid: a.ssid, password: a.password, link: a.link };
    }),
    verifiedBy,
    verifiedDate,
  })}
>
  <div class="flex flex-wrap items-start justify-between gap-2 mb-3">
    <div class="flex flex-wrap items-center gap-2">
      <span class={`badge ${badgeColor}`}>{category}</span>
      {
        displayVerifiedBy && (
          <span
            class="inline-flex items-center gap-1 text-xs text-blue-900 dark:text-blue-100 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded-full"
            data-tooltip={`Information verified by ${verifiedBy}${verifiedDate ? ` on ${formatDate(verifiedDate)}` : ''}. Data sourced from official government records.`}
            data-tooltip-position="bottom"
            tabindex="0"
          >
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path
                fill-rule="evenodd"
                d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"
              />
            </svg>
            {displayVerifiedBy}
          </span>
        )
      }
      {/* Data freshness indicator - only show for stale data */}
      {
        dataFreshness.status === 'stale' && (
          <span
            class="inline-flex items-center gap-1 text-xs text-amber-900 dark:text-amber-100 bg-amber-50 dark:bg-amber-900/30 px-2 py-0.5 rounded-full"
            data-tooltip={dataFreshness.message}
            data-tooltip-position="bottom"
            tabindex="0"
            role="status"
          >
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path
                fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="sr-only" data-i18n="program.dataOutdated">
              Data may be outdated:
            </span>
            <span data-i18n="program.needsReview">Needs review</span>
          </span>
        )
      }
    </div>
    <span class="text-sm text-neutral-600 dark:text-neutral-300">{displayLocation}</span>
  </div>

  <h3
    class="text-xl font-semibold text-neutral-900 dark:text-white mb-2 group-hover:text-primary-700 dark:group-hover:text-primary-300"
    data-program-name
  >
    {name}
  </h3>

  {description && <p class="text-neutral-600 dark:text-neutral-300 mb-4">{description}</p>}

  {/* Address with map link */}
  {
    address && (
      <p class="text-sm text-neutral-600 dark:text-neutral-300 mb-2">
        {mapLink ? (
          <a
            href={mapLink}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 hover:text-primary-700 dark:hover:text-primary-300"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            {address}
          </a>
        ) : (
          <span class="inline-flex items-center gap-1">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            {address}
          </span>
        )}
      </p>
    )
  }

  {/* Fee info */}
  {
    feeInfo && (
      <p class="text-sm text-neutral-600 dark:text-neutral-300 mb-2">
        <span class="font-medium">ðŸ’µ {feeInfo}</span>
      </p>
    )
  }

  {/* Amenities */}
  {
    amenities.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-4">
        {amenities.map((rawAmenity) => {
          const amenity = normalizeAmenity(rawAmenity);
          const hasWifi = isWifiAmenity(amenity);
          const wifiUrl = amenity.ssid ? generateWifiUrl(amenity.ssid, amenity.password) : null;
          const href = wifiUrl || amenity.link;

          return href ? (
            <a
              href={href}
              target={wifiUrl ? undefined : '_blank'}
              rel={wifiUrl ? undefined : 'noopener noreferrer'}
              class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-100 dark:bg-neutral-700 rounded text-xs text-neutral-700 dark:text-neutral-200 hover:bg-neutral-200 dark:hover:bg-neutral-600"
              title={wifiUrl ? `Connect to WiFi: ${amenity.ssid}` : amenity.name}
            >
              {hasWifi && (
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 18c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm-4.9-2.3c2.7-2.7 7.1-2.7 9.8 0l1.4-1.4c-3.5-3.5-9.1-3.5-12.6 0l1.4 1.4zm-2.8-2.8c4.3-4.3 11.2-4.3 15.4 0l1.4-1.4c-5-5-13.2-5-18.2 0l1.4 1.4zM1.5 10c5.8-5.8 15.2-5.8 21 0l1.4-1.4c-6.6-6.6-17.2-6.6-23.8 0L1.5 10z" />
                </svg>
              )}
              {amenity.name}
            </a>
          ) : (
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-100 dark:bg-neutral-700 rounded text-xs text-neutral-700 dark:text-neutral-200">
              {hasWifi && (
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 18c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm-4.9-2.3c2.7-2.7 7.1-2.7 9.8 0l1.4-1.4c-3.5-3.5-9.1-3.5-12.6 0l1.4 1.4zm-2.8-2.8c4.3-4.3 11.2-4.3 15.4 0l1.4-1.4c-5-5-13.2-5-18.2 0l1.4 1.4zM1.5 10c5.8-5.8 15.2-5.8 21 0l1.4-1.4c-6.6-6.6-17.2-6.6-23.8 0L1.5 10z" />
                </svg>
              )}
              {amenity.name}
            </span>
          );
        })}
      </div>
    )
  }

  {
    whatTheyOffer && (
      <details class="mb-4">
        <summary
          class="cursor-pointer text-sm font-medium text-primary-700 dark:text-primary-300 hover:underline"
          data-i18n="program.whatTheyOffer"
        >
          What they offer
        </summary>
        <div class="mt-2 pl-4 text-sm text-neutral-600 dark:text-neutral-300 prose-width whitespace-pre-line">
          {whatTheyOffer}
        </div>
      </details>
    )
  }

  {
    howToGetIt && (
      <details class="mb-4">
        <summary
          class="cursor-pointer text-sm font-medium text-primary-700 dark:text-primary-300 hover:underline"
          data-i18n="program.howToGetIt"
        >
          How to get it
        </summary>
        <div class="mt-2 pl-4 text-sm text-neutral-600 dark:text-neutral-300">{howToGetIt}</div>
      </details>
    )
  }

  <div
    class="flex flex-wrap items-center gap-4 mt-auto pt-4 border-t border-neutral-100 dark:border-neutral-700"
  >
    {
      link && (
        <a href={link} target="_blank" rel="noopener noreferrer" class="btn-primary text-sm">
          {linkText}
          <svg
            class="w-4 h-4 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
            />
          </svg>
        </a>
      )
    }

    {
      phone && (
        <a
          href={`tel:${phone.replace(/\D/g, '')}`}
          class="inline-flex items-center text-sm text-neutral-600 dark:text-neutral-300 hover:text-primary-700 dark:hover:text-primary-300 no-underline"
        >
          <svg
            class="w-4 h-4 mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
            />
          </svg>
          {phone}
        </a>
      )
    }

    <div class="flex items-center gap-1 ml-auto">
      <button
        type="button"
        class="more-details-btn text-sm text-primary-700 dark:text-primary-300 hover:underline focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 rounded px-2 py-1"
        aria-label={`View more details about ${name}`}
      >
        More details
      </button>
      <FavoritesButton programId={id} programName={name} />
      <ShareButton
        title={name}
        text={description || `${name} - ${category} resource in ${displayLocation}`}
        url={`https://baynavigator.org/directory#program-${id}`}
      />
    </div>
  </div>
</article>

<script>
  function initMoreDetailsButtons(): void {
    document.querySelectorAll('.more-details-btn').forEach((btn) => {
      // Skip if already initialized
      if (btn.hasAttribute('data-initialized')) return;
      btn.setAttribute('data-initialized', 'true');

      btn.addEventListener('click', (e) => {
        const card = (e.currentTarget as HTMLElement).closest('[data-program-data]');
        if (!card) return;

        const dataAttr = card.getAttribute('data-program-data');
        if (!dataAttr) return;

        try {
          const programData = JSON.parse(dataAttr);
          const openModal = (window as any).openProgramDetailModal;
          if (openModal) {
            openModal(programData, e.currentTarget as HTMLElement);
          }
        } catch (err) {
          console.error('Failed to parse program data:', err);
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initMoreDetailsButtons);
  document.addEventListener('astro:page-load', initMoreDetailsButtons);
</script>
