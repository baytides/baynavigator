---
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';

interface Props {
  placeholder?: string;
  size?: 'default' | 'large';
  apiEndpoint?: string;
}

const {
  placeholder = 'Search programs...',
  size = 'default',
  apiEndpoint = 'https://baytides-link-checker.azurewebsites.net/api/assistant',
} = Astro.props;

// Load search configuration at build time
let searchConfig = { synonyms: {}, best_bets: {}, suggestions: [], query_rewrites: {} };
try {
  const configPath = path.join(process.cwd(), 'src/data/search-config.yml');
  const configContent = fs.readFileSync(configPath, 'utf8');
  searchConfig = yaml.load(configContent) as typeof searchConfig;
} catch (e) {
  console.warn('Could not load search-config.yml:', e);
}

const sizeClasses = size === 'large' ? 'py-4 pl-12 pr-12 text-lg' : 'py-3 pl-10 pr-10';
---

<div class="search-container">
  <div class="relative">
    <label for="search-input" class="sr-only" data-i18n="common.search">Search programs</label>

    <!-- Search icon -->
    <svg
      class={`search-icon absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 ${size === 'large' ? 'w-6 h-6 left-4' : 'w-5 h-5'}`}
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>

    <!-- AI indicator (shows when AI is processing) -->
    <div
      id="ai-indicator"
      class={`hidden absolute top-1/2 -translate-y-1/2 ${size === 'large' ? 'right-4' : 'right-3'}`}
    >
      <span
        class="inline-flex items-center gap-1 text-xs text-primary-600 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/50 px-2 py-0.5 rounded-full"
      >
        <svg class="w-3 h-3 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
          ></path>
        </svg>
        <span id="ai-status-text">AI</span>
      </span>
    </div>

    <!-- Loading spinner -->
    <div
      id="search-loading"
      class={`hidden absolute top-1/2 -translate-y-1/2 ${size === 'large' ? 'right-4' : 'right-3'}`}
    >
      <svg class="w-5 h-5 animate-spin text-primary-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
    </div>

    <input
      type="search"
      id="search-input"
      class={`search-input ${sizeClasses}`}
      placeholder={placeholder}
      autocomplete="off"
    />
  </div>

  <!-- AI Toggle Pill -->
  <div class="relative flex items-center justify-end mt-2 gap-2">
    <span
      class="text-xs text-neutral-600 dark:text-neutral-300"
      data-tooltip="Smart Search uses AI to understand your question and find relevant programs. Turn it off for simple keyword matching."
      data-tooltip-position="left"
      data-i18n="search.smartSearch"
      tabindex="0">Smart search</span
    >
    <button
      type="button"
      id="ai-toggle"
      class="ai-toggle-btn ai-toggle-on"
      role="switch"
      aria-checked="true"
      aria-label="Toggle AI-powered search"
      data-tooltip="AI-powered search helps find programs using natural language. Turn off to use keyword search only."
      data-tooltip-position="bottom"
    >
      <span class="ai-toggle-track">
        <span class="ai-toggle-thumb"></span>
      </span>
    </button>
  </div>

  <!-- Search hints -->
  <div
    id="search-hints"
    class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 p-3 z-50"
  >
    <p class="text-xs text-neutral-600 dark:text-neutral-300 mb-2" data-i18n="search.trySearching">
      Try searching for:
    </p>
    <div class="flex flex-wrap gap-2 mb-3">
      <button type="button" class="search-hint-btn" data-type="keyword">food assistance</button>
      <button type="button" class="search-hint-btn" data-type="keyword">utility bill help</button>
      <button type="button" class="search-hint-btn" data-type="keyword">healthcare</button>
      <button type="button" class="search-hint-btn" data-type="keyword">senior programs</button>
    </div>
    <p class="text-xs text-neutral-600 dark:text-neutral-300 mb-2" data-i18n="search.orAskQuestion">
      Or ask a question:
    </p>
    <div class="flex flex-wrap gap-2">
      <button type="button" class="search-hint-btn ai-hint" data-type="ai"
        >I'm a senior who needs help with bills</button
      >
      <button type="button" class="search-hint-btn ai-hint" data-type="ai"
        >Low-income family looking for food</button
      >
    </div>
  </div>
</div>

<!-- Store API endpoint and search config in data attributes -->
<div
  id="search-config"
  data-api-endpoint={apiEndpoint}
  data-synonyms={JSON.stringify(searchConfig.synonyms || {})}
  data-best-bets={JSON.stringify(searchConfig.best_bets || {})}
  data-suggestions={JSON.stringify(searchConfig.suggestions || [])}
  data-query-rewrites={JSON.stringify(searchConfig.query_rewrites || {})}
  class="hidden"
>
</div>

<!-- Type-ahead dropdown -->
<div id="typeahead-dropdown" class="typeahead-dropdown hidden">
  <ul id="typeahead-list" role="listbox" aria-label="Search suggestions"></ul>
</div>

<!-- Screen reader announcements (aria-live regions) -->
<div class="sr-only" aria-live="polite" aria-atomic="true" id="search-announcer"></div>
<div class="sr-only" aria-live="assertive" aria-atomic="true" id="search-urgent-announcer"></div>

<script>
  import Fuse from 'fuse.js';

  // Load config
  const configEl = document.getElementById('search-config');
  const API_ENDPOINT = configEl?.dataset?.apiEndpoint || '';

  // Load search enhancements from build-time config
  const SYNONYMS: Record<string, string[]> = JSON.parse(configEl?.dataset?.synonyms || '{}');
  const BEST_BETS: Record<string, string[]> = JSON.parse(configEl?.dataset?.bestBets || '{}');
  const SUGGESTIONS: string[] = JSON.parse(configEl?.dataset?.suggestions || '[]');
  const QUERY_REWRITES: Record<string, string> = JSON.parse(
    configEl?.dataset?.queryRewrites || '{}'
  );

  // Type-ahead elements
  const typeaheadDropdown = document.getElementById('typeahead-dropdown');
  const typeaheadList = document.getElementById('typeahead-list');
  let selectedSuggestionIndex = -1;

  // Expand query with synonyms
  function expandWithSynonyms(query: string): string[] {
    const terms = query.toLowerCase().split(/\s+/);
    const expanded = new Set<string>([query.toLowerCase()]);

    // Check each term and multi-word phrases for synonyms
    for (const term of terms) {
      if (SYNONYMS[term]) {
        SYNONYMS[term].forEach((syn) => expanded.add(syn));
      }
    }

    // Check for multi-word phrases
    const queryLower = query.toLowerCase();
    for (const [phrase, synonyms] of Object.entries(SYNONYMS)) {
      if (queryLower.includes(phrase)) {
        synonyms.forEach((syn) => expanded.add(syn));
      }
    }

    return Array.from(expanded);
  }

  // Rewrite natural language queries
  function rewriteQuery(query: string): string {
    const queryLower = query.toLowerCase().trim();

    // Check for exact rewrites first
    if (QUERY_REWRITES[queryLower]) {
      return QUERY_REWRITES[queryLower];
    }

    // Check for partial matches
    for (const [pattern, rewrite] of Object.entries(QUERY_REWRITES)) {
      if (queryLower.includes(pattern)) {
        return rewrite;
      }
    }

    return query;
  }

  // Get best bets for a query
  function getBestBets(query: string): string[] {
    const queryLower = query.toLowerCase().trim();
    const terms = queryLower.split(/\s+/);

    // Check for exact match first
    if (BEST_BETS[queryLower]) {
      return BEST_BETS[queryLower];
    }

    // Check individual terms
    for (const term of terms) {
      if (BEST_BETS[term]) {
        return BEST_BETS[term];
      }
    }

    return [];
  }

  // Show type-ahead suggestions
  function showTypeahead(query: string) {
    if (!typeaheadDropdown || !typeaheadList || query.length < 2) {
      hideTypeahead();
      return;
    }

    const queryLower = query.toLowerCase();
    const matches = SUGGESTIONS.filter((s) => s.toLowerCase().includes(queryLower)).slice(0, 6);

    if (matches.length === 0) {
      hideTypeahead();
      return;
    }

    typeaheadList.innerHTML = matches
      .map(
        (suggestion, i) => `
      <li role="option"
          class="typeahead-item ${i === selectedSuggestionIndex ? 'selected' : ''}"
          data-suggestion="${suggestion}">
        <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <span>${highlightMatch(suggestion, query)}</span>
      </li>
    `
      )
      .join('');

    typeaheadDropdown.classList.remove('hidden');

    // Add click handlers
    typeaheadList.querySelectorAll('.typeahead-item').forEach((item) => {
      item.addEventListener('click', () => {
        const suggestion = (item as HTMLElement).dataset.suggestion;
        if (suggestion && searchInput) {
          (searchInput as HTMLInputElement).value = suggestion;
          hideTypeahead();
          performSearch();
        }
      });
    });
  }

  function hideTypeahead() {
    typeaheadDropdown?.classList.add('hidden');
    selectedSuggestionIndex = -1;
  }

  function highlightMatch(text: string, query: string): string {
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
  }

  // Handle keyboard navigation for type-ahead
  function handleTypeaheadKeydown(e: KeyboardEvent) {
    const items = typeaheadList?.querySelectorAll('.typeahead-item') || [];
    if (items.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
      updateTypeaheadSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
      updateTypeaheadSelection(items);
    } else if (e.key === 'Tab' && selectedSuggestionIndex >= 0) {
      e.preventDefault();
      const selected = items[selectedSuggestionIndex] as HTMLElement;
      const suggestion = selected?.dataset?.suggestion;
      if (suggestion && searchInput) {
        (searchInput as HTMLInputElement).value = suggestion;
        hideTypeahead();
      }
    } else if (e.key === 'Escape') {
      hideTypeahead();
    }
  }

  function updateTypeaheadSelection(items: NodeListOf<Element>) {
    items.forEach((item, i) => {
      if (i === selectedSuggestionIndex) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    });
  }

  // Check if we're on the homepage (has home-program-card elements)
  const isHomepage = document.querySelectorAll('.home-program-card').length > 0;
  const homeResultsSection = document.getElementById('search-results');
  const homeResultsCount = document.getElementById('home-results-count');
  const noResultsEl = document.getElementById('no-results');
  const clearSearchBtn = document.getElementById('clear-search');

  // Build search index from program cards (directory page or homepage)
  const cards = isHomepage
    ? document.querySelectorAll('.home-program-card [data-category]')
    : document.querySelectorAll('[data-category]');

  const cardWrappers = isHomepage ? document.querySelectorAll('.home-program-card') : null;

  const programs = Array.from(cards).map((card, index) => {
    const nameEl = card.querySelector('h3');
    const descEl = card.querySelector('p');
    const areaEl = card.querySelector('[class*="text-neutral-600"], [class*="text-neutral-500"]');
    const id = card.id?.replace('program-', '') || '';
    // For homepage, the wrapper element controls visibility
    const wrapper = isHomepage && cardWrappers ? cardWrappers[index] : null;

    return {
      index,
      element: card,
      wrapper,
      id,
      name: nameEl?.textContent?.trim() || '',
      description: descEl?.textContent?.trim() || '',
      category: card.getAttribute('data-category') || '',
      groups: card.getAttribute('data-groups')?.split(',') || [],
      area: areaEl?.textContent?.trim() || '',
      text: card.textContent?.trim() || '',
    };
  });

  // Configure Fuse.js with weighted search
  const fuse = new Fuse(programs, {
    keys: [
      { name: 'name', weight: 0.4 },
      { name: 'description', weight: 0.3 },
      { name: 'category', weight: 0.2 },
      { name: 'area', weight: 0.1 },
    ],
    threshold: 0.4,
    distance: 100,
    minMatchCharLength: 2,
    includeScore: true,
    includeMatches: true,
    ignoreLocation: true,
    useExtendedSearch: true,
  });

  const searchInput = document.getElementById('search-input');
  const searchHints = document.getElementById('search-hints');
  const aiIndicator = document.getElementById('ai-indicator');
  const aiStatusText = document.getElementById('ai-status-text');
  const searchLoading = document.getElementById('search-loading');
  const aiToggle = document.getElementById('ai-toggle');
  const hintButtons = document.querySelectorAll('.search-hint-btn');

  // Aria-live announcers for screen readers
  const searchAnnouncer = document.getElementById('search-announcer');
  const urgentAnnouncer = document.getElementById('search-urgent-announcer');

  // Announce search results to screen readers
  function announceToScreenReader(message: string, urgent = false) {
    const announcer = urgent ? urgentAnnouncer : searchAnnouncer;
    if (announcer) {
      // Clear and re-set to ensure announcement
      announcer.textContent = '';
      setTimeout(() => {
        announcer.textContent = message;
      }, 100);
    }
  }

  let activeCategory = 'all';
  let debounceTimer;
  let isAISearching = false;
  let lastAIQuery = '';
  let isOffline = !navigator.onLine;

  // Load AI preference from localStorage (defaults to true when online, false when offline)
  let aiEnabled = !isOffline && localStorage.getItem('aiSearchEnabled') !== 'false';

  // Initialize toggle state
  function updateToggleState() {
    if (aiToggle) {
      // When offline, always show as off and disabled
      const effectiveEnabled = aiEnabled && !isOffline;
      aiToggle.setAttribute('aria-checked', String(effectiveEnabled));

      if (isOffline) {
        aiToggle.classList.add('ai-toggle-disabled');
      } else {
        aiToggle.classList.remove('ai-toggle-disabled');
      }

      if (effectiveEnabled) {
        aiToggle.classList.add('ai-toggle-on');
        aiToggle.classList.remove('ai-toggle-off');
      } else {
        aiToggle.classList.remove('ai-toggle-on');
        aiToggle.classList.add('ai-toggle-off');
      }
    }
  }
  updateToggleState();

  // Show offline notice
  function showOfflineNotice() {
    // Remove any existing notice
    const existingNotice = document.getElementById('offline-notice');
    if (existingNotice) existingNotice.remove();

    // Create and show notice
    const notice = document.createElement('div');
    notice.id = 'offline-notice';
    notice.className = 'offline-notice';
    notice.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m-2.829-2.829a5 5 0 010-7.07m-2.829 2.829a1 1 0 010 1.414"/>
      </svg>
      <span>You're offline. Connect to the internet to use smart search.</span>
    `;
    aiToggle?.parentElement?.appendChild(notice);

    // Auto-remove after 3 seconds
    setTimeout(() => notice.remove(), 3000);
  }

  // Handle toggle click
  aiToggle?.addEventListener('click', () => {
    // If offline, show notice and don't toggle
    if (isOffline) {
      showOfflineNotice();
      return;
    }

    aiEnabled = !aiEnabled;
    localStorage.setItem('aiSearchEnabled', String(aiEnabled));
    updateToggleState();

    // If AI is now disabled, hide any AI indicators
    if (!aiEnabled) {
      hideAIIndicator();
    }

    // Re-run search with new setting
    if (searchInput?.value) {
      performSearch();
    }
  });

  // Track online/offline status
  window.addEventListener('online', () => {
    isOffline = false;
    // Restore AI enabled state from localStorage when coming back online
    aiEnabled = localStorage.getItem('aiSearchEnabled') !== 'false';
    updateToggleState();
  });
  window.addEventListener('offline', () => {
    isOffline = true;
    // If we were showing AI indicator, hide it
    hideAIIndicator();
    updateToggleState();
  });

  // Detect if query needs AI assistance
  function isComplexQuery(query) {
    const trimmed = query.trim();

    // Demographic terms that should trigger AI even as single words
    // These map to specific group filters that fuzzy search might miss
    // Comprehensive list based on groups.yml categories
    const demographicTerms = new RegExp(
      '^(' +
        [
          // Income-eligible synonyms
          'low.?income',
          'ebt',
          'snap',
          'calfresh',
          'calworks',
          'medi.?cal',
          'medicaid',
          'ssi',
          'ssdi',
          'welfare',
          'poor',
          'poverty',
          // Seniors synonyms
          'senior',
          'seniors',
          'elderly',
          'older.?adult',
          'retiree',
          'retired',
          'aging',
          // Youth synonyms
          'youth',
          'young',
          'teen',
          'teenager',
          'child',
          'children',
          'kid',
          'kids',
          'minor',
          'adolescent',
          // College students synonyms
          'student',
          'students',
          'college',
          'university',
          'grad.?student',
          'undergraduate',
          'graduate',
          // Veterans synonyms
          'veteran',
          'veterans',
          'military',
          'army',
          'navy',
          'marines',
          'air.?force',
          'coast.?guard',
          'active.?duty',
          'reservist',
          // Families synonyms
          'family',
          'families',
          'parent',
          'parents',
          'mother',
          'father',
          'mom',
          'dad',
          'single.?parent',
          // Disability synonyms
          'disabled',
          'disability',
          'disabilities',
          'handicapped',
          'blind',
          'deaf',
          'wheelchair',
          'ada',
          // LGBTQ+ synonyms
          'lgbtq?',
          'lgbt',
          'gay',
          'lesbian',
          'bisexual',
          'transgender',
          'queer',
          'trans',
          'nonbinary',
          'non.?binary',
          'pansexual',
          'asexual',
          'intersex',
          'pride',
          // First responders synonyms
          'first.?responder',
          'firefighter',
          'police',
          'officer',
          'cop',
          'emt',
          'paramedic',
          // Teachers synonyms
          'teacher',
          'teachers',
          'educator',
          'professor',
          'instructor',
          // Job seekers synonyms
          'unemployed',
          'job.?seeker',
          'jobless',
          'laid.?off',
          // Immigrants synonyms
          'immigrant',
          'immigrants',
          'refugee',
          'refugees',
          'undocumented',
          'daca',
          'dreamer',
          'asylum',
          'migrant',
          // Unhoused synonyms
          'homeless',
          'unhoused',
          'houseless',
          'unsheltered',
          'shelter',
          // Pregnant/Women synonyms
          'pregnant',
          'pregnancy',
          'expecting',
          'expectant',
          'prenatal',
          'maternal',
          'woman',
          'women',
          'female',
          // Caregivers synonyms
          'caregiver',
          'caregivers',
          // Foster youth synonyms
          'foster',
          'foster.?youth',
          'foster.?care',
          'aged.?out',
          // Formerly incarcerated synonyms
          'incarcerated',
          'formerly.?incarcerated',
          'reentry',
          'ex.?offender',
          'parolee',
          'probation',
          // Nonprofits
          'nonprofit',
          'non.?profit',
          'ngo',
          'charity',
        ].join('|') +
        ')$',
      'i'
    );

    if (demographicTerms.test(trimmed)) {
      return true; // Single demographic terms should use AI
    }

    // Simple patterns that don't need AI
    const simplePatterns = [
      /^\d{5}$/, // ZIP code
      /^[a-zA-Z]{1,20}$/, // Single word (generic)
      /^[a-zA-Z]+\s+[a-zA-Z]+$/, // Two words
      /^(food|health|housing|utilities|transportation|education|legal|finance|technology|recreation|community)$/i, // Category names
    ];

    for (const pattern of simplePatterns) {
      if (pattern.test(trimmed)) return false;
    }

    // Complex query indicators
    const complexIndicators = [
      trimmed.length > 30, // Long queries
      /\b(i'm|i am|my|me|we|our)\b/i.test(trimmed), // First person
      /\b(need|looking for|help with|want|qualify)\b/i.test(trimmed), // Intent words
      // Demographics - expanded to include more identity terms
      /\b(senior|elderly|disabled|veteran|family|child|low.?income|immigrant|refugee|homeless|unhoused)\b/i.test(
        trimmed
      ),
      /\b(lgbtq?|gay|lesbian|bisexual|transgender|queer|nonbinary|trans)\b/i.test(trimmed), // LGBTQ+ terms
      /\b(woman|women|female|mother|pregnant|expecting)\b/i.test(trimmed), // Women-specific
      /\b(student|college|university|graduate|undergraduate)\b/i.test(trimmed), // Students
      /\b(teacher|educator|nurse|first.?responder|firefighter|police|emt)\b/i.test(trimmed), // Professions
      /\b(foster|formerly.?incarcerated|reentry|caregiver)\b/i.test(trimmed), // Special circumstances
      /\b(years?\s+old|\d{2}\s+year)\b/i.test(trimmed), // Age mentions
      /\b(living\s+in|from|near)\b/i.test(trimmed), // Location context
      trimmed.split(/\s+/).length >= 5, // 5+ words
    ];

    const complexCount = complexIndicators.filter(Boolean).length;
    return complexCount >= 2;
  }

  // Track active category filter
  document.addEventListener('click', (e) => {
    const filterBtn = e.target.closest('[data-filter]');
    if (filterBtn) {
      activeCategory = filterBtn.getAttribute('data-filter') || 'all';
      performSearch();
    }
  });

  function showLoading(show) {
    if (show) {
      searchLoading?.classList.remove('hidden');
      aiIndicator?.classList.add('hidden');
    } else {
      searchLoading?.classList.add('hidden');
    }
  }

  function showAIIndicator(status) {
    aiIndicator?.classList.remove('hidden');
    searchLoading?.classList.add('hidden');
    if (aiStatusText) aiStatusText.textContent = status;
  }

  function hideAIIndicator() {
    aiIndicator?.classList.add('hidden');
  }

  async function performAISearch(query) {
    if (isAISearching || query === lastAIQuery) return;

    isAISearching = true;
    lastAIQuery = query;
    showLoading(true);

    try {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: `Find programs matching this request. Return ONLY the program names that match, nothing else. Request: ${query}`,
          history: [],
          mode: 'filter', // Tell the API we just want filtering, not conversation
        }),
      });

      if (!response.ok) throw new Error('AI search failed');

      const data = await response.json();

      // Extract program IDs/names from AI response
      const matchedPrograms = data.programs || [];
      const matchedIds = new Set(
        matchedPrograms.map((p) => (p.id || p.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-'))
      );

      // Also extract any program names mentioned in the message
      const messageText = data.message || '';
      programs.forEach((p) => {
        if (messageText.toLowerCase().includes(p.name.toLowerCase())) {
          matchedIds.add(p.id);
        }
      });

      // Filter cards based on AI results
      let visibleCount = 0;

      if (isHomepage) {
        // Homepage: show results section and filter cards
        homeResultsSection?.classList.remove('hidden');

        programs.forEach((p) => {
          const matchesAI = matchedIds.size === 0 || matchedIds.has(p.id);
          if (p.wrapper) {
            if (matchesAI) {
              p.wrapper.classList.remove('hidden');
              visibleCount++;
            } else {
              p.wrapper.classList.add('hidden');
            }
          }
        });

        // Update count
        if (homeResultsCount) {
          homeResultsCount.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found`;
        }
        if (visibleCount === 0) {
          noResultsEl?.classList.remove('hidden');
        } else {
          noResultsEl?.classList.add('hidden');
        }
      } else {
        // Directory page
        programs.forEach((p) => {
          const matchesAI = matchedIds.size === 0 || matchedIds.has(p.id);
          const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
          const shouldShow = matchesAI && matchesCategory;

          p.element.style.display = shouldShow ? '' : 'none';
          if (shouldShow) visibleCount++;
        });
      }

      // If AI returned programs, show them; otherwise fall back to fuzzy search
      if (matchedIds.size > 0 && visibleCount > 0) {
        showAIIndicator(`AI found ${visibleCount}`);
        announceToScreenReader(
          `AI search found ${visibleCount} program${visibleCount !== 1 ? 's' : ''} for "${query}"`
        );
        if (!isHomepage) {
          updateResultsCount(visibleCount, query, true);
        }
      } else {
        // Fall back to fuzzy search
        hideAIIndicator();
        performFuzzySearch(query);
      }
    } catch (error) {
      console.error('AI search error:', error);
      // Fall back to fuzzy search on error
      hideAIIndicator();
      performFuzzySearch(query);
    } finally {
      isAISearching = false;
      showLoading(false);
    }
  }

  function performFuzzySearch(query) {
    if (isHomepage) {
      // Homepage: show/hide search results section
      if (!query) {
        // No query - hide results section
        homeResultsSection?.classList.add('hidden');
        programs.forEach((p) => {
          if (p.wrapper) p.wrapper.classList.add('hidden');
        });
        noResultsEl?.classList.add('hidden');
        return;
      }

      // Show results section
      homeResultsSection?.classList.remove('hidden');

      // Apply search enhancements
      const rewrittenQuery = rewriteQuery(query);
      const expandedTerms = expandWithSynonyms(rewrittenQuery);
      const bestBetIds = new Set(getBestBets(query));

      // Fuzzy search with Fuse.js - search for all expanded terms
      const allResults = new Map();
      for (const term of expandedTerms) {
        const results = fuse.search(term);
        results.forEach((r) => {
          const existing = allResults.get(r.item.index);
          if (!existing || r.score < existing.score) {
            allResults.set(r.item.index, r);
          }
        });
      }
      const matchedIndices = new Set(allResults.keys());

      let visibleCount = 0;
      const bestBetPrograms: typeof programs = [];
      const regularPrograms: typeof programs = [];

      programs.forEach((p) => {
        const matchesSearch = matchedIndices.has(p.index);
        const isBestBet = bestBetIds.has(p.id);

        if (matchesSearch || isBestBet) {
          if (isBestBet) {
            bestBetPrograms.push(p);
          } else {
            regularPrograms.push(p);
          }
          if (p.wrapper) {
            p.wrapper.classList.remove('hidden');
            // Mark best bets for styling
            if (isBestBet) {
              p.wrapper.classList.add('best-bet');
            } else {
              p.wrapper.classList.remove('best-bet');
            }
            visibleCount++;
          }
        } else {
          if (p.wrapper) {
            p.wrapper.classList.add('hidden');
            p.wrapper.classList.remove('best-bet');
          }
        }
      });

      // Update count and show/hide no results
      if (homeResultsCount) {
        homeResultsCount.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found`;
      }
      if (visibleCount === 0) {
        noResultsEl?.classList.remove('hidden');
        announceToScreenReader(`No programs found for "${query}". Try different search terms.`);
      } else {
        noResultsEl?.classList.add('hidden');
        announceToScreenReader(
          `Found ${visibleCount} program${visibleCount !== 1 ? 's' : ''} for "${query}"`
        );
      }
    } else {
      // Directory page: original behavior with enhancements
      if (!query) {
        // No search query - show all (respect category filter)
        programs.forEach((p) => {
          const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
          // Also respect location filter if active
          const locationHidden = p.element.hasAttribute('data-location-hidden');
          p.element.style.display = matchesCategory && !locationHidden ? '' : 'none';
          p.element.classList.remove('best-bet');
        });
        hideAIIndicator();
      } else {
        // Apply search enhancements
        const rewrittenQuery = rewriteQuery(query);
        const expandedTerms = expandWithSynonyms(rewrittenQuery);
        const bestBetIds = new Set(getBestBets(query));

        // Fuzzy search with Fuse.js - search for all expanded terms
        const allResults = new Map();
        for (const term of expandedTerms) {
          const results = fuse.search(term);
          results.forEach((r) => {
            const existing = allResults.get(r.item.index);
            if (!existing || r.score < existing.score) {
              allResults.set(r.item.index, r);
            }
          });
        }
        const matchedIndices = new Set(allResults.keys());

        programs.forEach((p) => {
          const matchesSearch = matchedIndices.has(p.index);
          const isBestBet = bestBetIds.has(p.id);
          const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
          const locationHidden = p.element.hasAttribute('data-location-hidden');
          const shouldShow = (matchesSearch || isBestBet) && matchesCategory && !locationHidden;

          p.element.style.display = shouldShow ? '' : 'none';

          // Mark best bets for styling
          if (isBestBet && shouldShow) {
            p.element.classList.add('best-bet');
          } else {
            p.element.classList.remove('best-bet');
          }
        });
      }

      // Update count
      const visibleCount = document.querySelectorAll(
        '[data-category]:not([style*="display: none"])'
      ).length;
      updateResultsCount(visibleCount, query, false);

      // Announce results to screen readers
      if (query) {
        if (visibleCount === 0) {
          announceToScreenReader(`No programs found for "${query}". Try different search terms.`);
        } else {
          announceToScreenReader(
            `Found ${visibleCount} program${visibleCount !== 1 ? 's' : ''} for "${query}"`
          );
        }
      }
    }
  }

  function updateResultsCount(count, query, isAI) {
    const counter = document.getElementById('results-count');
    if (counter) {
      const queryInfo = query ? ` for "${query}"` : '';
      const aiInfo = isAI ? ' (AI-powered)' : '';
      counter.textContent = `${count} program${count !== 1 ? 's' : ''} found${queryInfo}${aiInfo}`;
    }
  }

  // Crisis detection - show appropriate help resources
  // Only triggers on ACTIVE DANGER keywords, not general help-seeking queries
  function checkForCrisis(query) {
    const lowerQuery = query.toLowerCase();

    // Context words that indicate clearly academic/professional queries
    // where the crisis banner would be noise rather than helpful
    // Since our search shows program cards + banner (additive), we're generous
    // with showing the banner - it has a close button if not needed
    const academicProfessionalContext = [
      'statistics',
      'stats',
      'data about',
      'research on',
      'study on',
      'legislation',
      'policy',
      'policies',
      'donate to',
      'donation to',
      'volunteer at',
      'volunteering at',
      'definition of',
      'define ',
      'meaning of',
      'history of',
      'causes of',
      'write about',
      'essay on',
      'paper on',
      'jobs in',
      'career in',
      'work in',
      'degree in',
      'major in',
    ];

    // Only skip banner for clearly academic/professional queries
    for (const contextWord of academicProfessionalContext) {
      if (lowerQuery.includes(contextWord)) {
        return null;
      }
    }

    // For everything else, we show the banner if keywords match because:
    // 1. Banner is additive (doesn't replace search results)
    // 2. User can close it if not relevant
    // 3. Better to show help to someone who needs it than miss someone in crisis

    // Emergency keywords (911) - ONLY active danger situations
    // These indicate someone is in immediate physical danger right now
    const emergencyKeywords = [
      // Urgent help requests
      'need immediate help',
      'urgent help',
      'emergency help',
      'call 911',
      'call the police',
      'call an ambulance',
      'life threatening',
      'life-threatening',
      'in danger',
      'help me now',
      'need help now',
      'please help',
      // Active violence
      'being attacked',
      'attacking me',
      'someone is attacking',
      'being stabbed',
      'stabbing me',
      'knife attack',
      'with a knife',
      'being shot',
      'shooting at',
      'has a gun',
      'with a gun',
      'being beaten',
      'beating me',
      'hitting me',
      'hurting me',
      'someone is hurting',
      'abusing me',
      'being abused',
      // Domestic violence / abuse
      'domestic violence',
      'partner is hitting',
      'spouse is hitting',
      'husband is hitting',
      'wife is hitting',
      'boyfriend is hitting',
      'being raped',
      'sexual assault',
      'being assaulted',
      // Child/elder emergencies
      'child is hurt',
      'baby not breathing',
      'child not breathing',
      'child abuse',
      'elder abuse',
      'abusing my child',
      'hurting my child',
      // Life-threatening medical
      'cant breathe',
      "can't breathe",
      'not breathing',
      'stopped breathing',
      'choking',
      'having a heart attack',
      'having a stroke',
      'having a seizure',
      'severe bleeding',
      'wont stop bleeding',
      "won't stop bleeding",
      'unconscious',
      'passed out',
      'not waking up',
      'unresponsive',
      'allergic reaction',
      'anaphylaxis',
      'swelling up',
      'overdosing',
      'took too many pills',
      'drug overdose',
      // Active emergencies
      'house on fire',
      'building on fire',
      'theres a fire',
      "there's a fire",
      'apartment on fire',
      'smoke everywhere',
      'car accident',
      'bad accident',
      'someone is drowning',
      'fell in water',
      'trapped',
      'being kidnapped',
      'being held hostage',
      'taken hostage',
      'someone broke in',
      'intruder',
      'break in',
      'burglar',
      'robber',
      'being robbed',
      'mugged',
      'being mugged',
      // Imminent threats
      'threatening to kill',
      'going to kill',
      'wants to kill',
      'has a weapon',
      'threatening me',
      'stalking me',
      'following me',
      // Bystander/witness scenarios
      'i think i see',
      'i see someone',
      'someone is being',
      'witness domestic',
      'witnessing abuse',
      'witnessing violence',
      'neighbor is being',
      'hear screaming',
      'hearing screams',
      'sounds like fighting',
      'sounds like abuse',
      'suspicious person',
      'someone suspicious',
      'man with a gun',
      'woman with a gun',
      'person with a gun',
      'man with a knife',
      'woman with a knife',
      'person with a knife',
      'saw someone get',
      'just saw someone',
      'think someone is hurt',
      'someone might be hurt',
      'child left alone',
      'child in car',
      'baby in car',
      'report abuse',
      'report violence',
      'how to report',
    ];

    // Mental health crisis keywords (988)
    // 988 Suicide & Crisis Lifeline - for emotional distress, not just suicidal thoughts
    const mentalHealthKeywords = [
      // Suicidal ideation
      'suicide',
      'suicidal',
      'kill myself',
      'end my life',
      'want to die',
      'dont want to live',
      "don't want to live",
      'no reason to live',
      'better off dead',
      'wish i was dead',
      'wish i were dead',
      'thinking about suicide',
      'considering suicide',
      'planning suicide',
      'suicidal thoughts',
      'thoughts of suicide',
      'ending it all',
      'take my own life',
      'taking my own life',
      // Self-harm
      'self harm',
      'self-harm',
      'cutting myself',
      'hurt myself',
      'harming myself',
      'hurting myself',
      'want to cut',
      'started cutting',
      'burning myself',
      'hitting myself',
      // Depression / hopelessness
      'severely depressed',
      'deep depression',
      'hopeless',
      'no hope',
      'feel empty',
      'feeling empty',
      'worthless',
      'feel worthless',
      'nobody cares',
      'no one cares',
      'nobody loves me',
      'no one loves me',
      'world without me',
      'everyone hates me',
      // Crisis / breakdown
      'mental health crisis',
      'mental breakdown',
      'breaking down',
      'emotional crisis',
      'in crisis',
      'having a crisis',
      'cant go on',
      "can't go on",
      'give up',
      'giving up',
      'cant take it',
      "can't take it",
      'cant handle',
      "can't handle",
      'falling apart',
      'losing my mind',
      'going crazy',
      // Overdose intent
      'overdose myself',
      'take all my pills',
      'take too many pills',
      'swallow all my',
      'drink myself to death',
      // Anxiety / panic
      'panic attack',
      'having a panic attack',
      'severe anxiety',
      'cant stop crying',
      "can't stop crying",
      'crying for hours',
      // Bystander concerns for others
      'friend is suicidal',
      'worried about friend',
      'think my friend',
      'someone i know',
      'family member suicidal',
      'child is suicidal',
      'teen is suicidal',
      'worried someone will',
      'talking about suicide',
      'said they want to die',
      'threatening suicide',
      // Grief / trauma
      'lost someone to suicide',
      'someone died by suicide',
      'survivor of suicide',
      'grief overwhelmed',
      // Veterans specific (988 press 1)
      'veteran crisis',
      'veteran suicide',
      'military suicide',
      'ptsd crisis',
      'combat trauma',
      // LGBTQ+ specific (988 available)
      'lgbtq crisis',
      'coming out crisis',
      'rejected by family',
      'gender identity crisis',
      'trans crisis',
    ];

    for (const keyword of emergencyKeywords) {
      if (lowerQuery.includes(keyword)) {
        return 'emergency';
      }
    }

    for (const keyword of mentalHealthKeywords) {
      if (lowerQuery.includes(keyword)) {
        return 'mental-health';
      }
    }

    return null;
  }

  function showCrisisBanner(type) {
    // Remove existing banner if any
    const existingBanner = document.getElementById('crisis-banner');
    if (existingBanner) existingBanner.remove();

    const isEmergency = type === 'emergency';

    const banner = document.createElement('div');
    banner.id = 'crisis-banner';
    banner.className = `crisis-banner ${isEmergency ? 'emergency' : 'mental-health'}`;
    banner.innerHTML = `
      <div class="crisis-banner-content">
        ${
          isEmergency
            ? `
          <div class="crisis-banner-box">
            <div class="crisis-banner-icon">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div class="crisis-banner-text">
              <strong>Need immediate help?</strong>
              <span>If you or someone is in danger, call emergency services.</span>
            </div>
          </div>
          <a href="tel:911" class="crisis-banner-btn emergency">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            Call 911
          </a>
        `
            : `
          <div class="crisis-banner-box">
            <div class="crisis-banner-icon">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
            </div>
            <div class="crisis-banner-text">
              <strong>You're not alone.</strong>
              <span>Free, confidential 24/7 support. Veterans press 1, Spanish press 2.</span>
            </div>
          </div>
          <div class="crisis-banner-actions">
            <a href="tel:988" class="crisis-banner-btn mental-health">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              Call/Text 988
            </a>
            <a href="https://988lifeline.org/chat/" target="_blank" rel="noopener" class="crisis-banner-btn-secondary">
              Chat Online
            </a>
          </div>
        `
        }
        <button class="crisis-banner-close" aria-label="Dismiss">&times;</button>
      </div>
    `;

    // Insert directly inside the search container, after the input
    const searchContainer = document.querySelector('.search-container');
    if (searchContainer) {
      searchContainer.appendChild(banner);
    } else {
      // Fallback: insert after search input
      const searchInput = document.getElementById('search-input');
      searchInput?.parentElement?.appendChild(banner);
    }

    // Announce crisis resources to screen readers (urgent)
    const urgentMessage = isEmergency
      ? 'If you are in danger, call 911 for emergency services.'
      : 'Crisis support is available. Call or text 988 for the Suicide and Crisis Lifeline, available 24/7.';
    announceToScreenReader(urgentMessage, true);

    // Close handler
    const closeBtn = banner.querySelector('.crisis-banner-close');
    closeBtn?.addEventListener('click', () => banner.remove());
  }

  function performSearch() {
    const query = searchInput?.value.trim() || '';

    // Check for crisis keywords first - show banner but ALSO show relevant programs
    const crisisType = checkForCrisis(query);
    if (crisisType) {
      showCrisisBanner(crisisType);
      // Continue with fuzzy search to show relevant mental health resources
      // (like 988 Suicide & Crisis Lifeline)
      performFuzzySearch(query);
      return; // Skip AI search for crisis queries
    }

    // Clear AI state for new searches
    if (query !== lastAIQuery) {
      hideAIIndicator();
    }

    // Skip AI when offline or disabled - always use fuzzy search
    if (isOffline || !aiEnabled) {
      performFuzzySearch(query);
      return;
    }

    if (isComplexQuery(query)) {
      // Use AI for complex queries (only when online and enabled)
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => performAISearch(query), 500);
    } else {
      // Use fuzzy search for simple queries
      performFuzzySearch(query);
    }
  }

  // Handle Enter key - perform search only on Enter
  searchInput?.addEventListener('keydown', (e) => {
    // Handle type-ahead keyboard navigation
    if (typeaheadDropdown && !typeaheadDropdown.classList.contains('hidden')) {
      handleTypeaheadKeydown(e);
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') return;
      if (e.key === 'Tab' && selectedSuggestionIndex >= 0) return;
    }

    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(debounceTimer);
      searchHints?.classList.add('hidden');
      hideTypeahead();

      // If a suggestion is selected, use it
      if (selectedSuggestionIndex >= 0) {
        const items = typeaheadList?.querySelectorAll('.typeahead-item') || [];
        const selected = items[selectedSuggestionIndex] as HTMLElement;
        if (selected?.dataset?.suggestion) {
          (searchInput as HTMLInputElement).value = selected.dataset.suggestion;
        }
      }

      performSearch();
    } else if (e.key === 'Escape') {
      hideTypeahead();
    }
  });

  // Show type-ahead as user types
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;
    showTypeahead(query);
  });

  // Hide type-ahead when clicking outside
  document.addEventListener('click', (e) => {
    if (
      !searchInput?.contains(e.target as Node) &&
      !typeaheadDropdown?.contains(e.target as Node)
    ) {
      hideTypeahead();
    }
  });

  // Handle hint button clicks
  hintButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      searchInput.value = btn.textContent || '';
      searchHints?.classList.add('hidden');
      hideTypeahead();
      performSearch();
      searchInput.focus();
    });
  });

  // Listen for location changes to re-apply search
  window.addEventListener('locationChanged', () => {
    if (searchInput.value) {
      performSearch();
    }
  });

  // Clear search button (homepage only)
  clearSearchBtn?.addEventListener('click', () => {
    if (searchInput) {
      searchInput.value = '';
      performFuzzySearch('');
      searchInput.focus();
    }
  });
</script>

<style>
  .search-hint-btn {
    @apply text-xs px-2 py-1 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-800 transition-colors;
  }

  .search-hint-btn.ai-hint {
    @apply bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 border border-dashed border-neutral-300 dark:border-neutral-600;
  }

  .search-hint-btn.ai-hint:hover {
    @apply bg-primary-50 dark:bg-primary-900/50 border-primary-300 dark:border-primary-600 text-primary-700 dark:text-primary-300;
  }

  /* AI Toggle Pill Styles */
  .ai-toggle-btn {
    @apply relative inline-flex items-center cursor-pointer;
  }

  .ai-toggle-track {
    @apply relative w-9 h-5 bg-neutral-300 dark:bg-neutral-600 rounded-full transition-colors duration-200;
  }

  .ai-toggle-on .ai-toggle-track {
    @apply bg-primary-600 dark:bg-primary-500;
  }

  .ai-toggle-off .ai-toggle-track {
    @apply bg-neutral-300 dark:bg-neutral-600;
  }

  .ai-toggle-thumb {
    @apply absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-200;
  }

  .ai-toggle-on .ai-toggle-thumb {
    @apply translate-x-4;
  }

  .ai-toggle-off .ai-toggle-thumb {
    @apply translate-x-0;
  }

  .ai-toggle-btn:focus-visible .ai-toggle-track {
    @apply ring-2 ring-primary-500 ring-offset-2 ring-offset-white dark:ring-offset-neutral-900;
  }

  .ai-toggle-disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .ai-toggle-disabled .ai-toggle-track {
    @apply bg-neutral-200 dark:bg-neutral-700;
  }

  .offline-notice {
    @apply absolute right-0 top-full mt-1 flex items-center gap-1.5 text-xs text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg px-3 py-2 shadow-sm z-50 whitespace-nowrap;
    animation: fadeInOut 3s ease-in-out forwards;
  }

  @keyframes fadeInOut {
    0% {
      opacity: 0;
      transform: translateY(-4px);
    }
    10% {
      opacity: 1;
      transform: translateY(0);
    }
    80% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(-4px);
    }
  }

  /* Crisis Banner Styles */
  .crisis-banner {
    @apply w-full mt-4 rounded-xl shadow-lg border-2;
    animation: slideDown 0.3s ease-out;
  }

  .crisis-banner.emergency {
    @apply bg-red-50 dark:bg-red-950 border-red-500;
  }

  .crisis-banner.mental-health {
    @apply bg-blue-50 dark:bg-blue-950 border-blue-500;
  }

  .crisis-banner-content {
    @apply flex flex-wrap items-center justify-between gap-3 p-4;
  }

  .crisis-banner-box {
    @apply flex items-center gap-3;
  }

  .crisis-banner-icon {
    @apply flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center;
  }

  .crisis-banner.emergency .crisis-banner-icon {
    @apply bg-red-500 text-white;
  }

  .crisis-banner.mental-health .crisis-banner-icon {
    @apply bg-blue-500 text-white;
  }

  .crisis-banner-text {
    @apply flex flex-col;
  }

  .crisis-banner-text strong {
    @apply text-base font-bold;
  }

  .crisis-banner.emergency .crisis-banner-text strong {
    @apply text-red-800 dark:text-red-200;
  }

  .crisis-banner.mental-health .crisis-banner-text strong {
    @apply text-blue-800 dark:text-blue-200;
  }

  .crisis-banner-text span {
    @apply text-sm;
  }

  .crisis-banner.emergency .crisis-banner-text span {
    @apply text-red-700 dark:text-red-300;
  }

  .crisis-banner.mental-health .crisis-banner-text span {
    @apply text-blue-700 dark:text-blue-300;
  }

  .crisis-banner-actions {
    @apply flex items-center gap-2;
  }

  .crisis-banner-btn {
    @apply inline-flex items-center gap-2 px-5 py-2.5 rounded-lg font-bold text-base no-underline transition-all hover:scale-105 shadow-md;
  }

  .crisis-banner-btn.emergency {
    @apply bg-red-600 text-white hover:bg-red-700;
  }

  .crisis-banner-btn.mental-health {
    @apply bg-blue-600 text-white hover:bg-blue-700;
  }

  .crisis-banner-btn-secondary {
    @apply inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm no-underline transition-all border-2;
    @apply bg-transparent text-blue-700 dark:text-blue-300 border-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900;
  }

  .crisis-banner-close {
    @apply w-8 h-8 flex items-center justify-center text-2xl leading-none rounded-full transition-colors bg-transparent border-none cursor-pointer;
  }

  .crisis-banner.emergency .crisis-banner-close {
    @apply text-red-400 hover:text-red-600 hover:bg-red-100 dark:hover:bg-red-900;
  }

  .crisis-banner.mental-health .crisis-banner-close {
    @apply text-blue-400 hover:text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Type-ahead Dropdown Styles */
  .typeahead-dropdown {
    @apply absolute top-full left-0 right-0 mt-1 bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 z-50 overflow-hidden;
  }

  .typeahead-item {
    @apply flex items-center gap-2 px-4 py-2.5 cursor-pointer transition-colors;
  }

  .typeahead-item:hover,
  .typeahead-item.selected {
    @apply bg-primary-50 dark:bg-primary-900/30;
  }

  .typeahead-item span {
    @apply text-sm text-neutral-700 dark:text-neutral-200;
  }

  .typeahead-item strong {
    @apply text-primary-600 dark:text-primary-400 font-semibold;
  }

  /* Best Bet Highlighting */
  .best-bet {
    @apply ring-2 ring-primary-400 dark:ring-primary-500 ring-offset-2 dark:ring-offset-neutral-900;
  }

  .best-bet::before {
    content: ' Top Result';
    @apply absolute -top-2 left-4 text-xs font-semibold text-white bg-primary-500 px-2 py-0.5 rounded-full;
  }

  /* Ensure cards have relative positioning for the best-bet badge */
  [data-category].best-bet,
  .home-program-card.best-bet {
    @apply relative;
  }
</style>
