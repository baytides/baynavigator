---
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';

interface Props {
  placeholder?: string;
  size?: 'default' | 'large';
  apiEndpoint?: string;
}

const {
  placeholder = 'Search programs...',
  size = 'default',
  apiEndpoint = 'https://baytides-link-checker.azurewebsites.net/api/assistant',
} = Astro.props;

// Load search configuration at build time
let searchConfig = { synonyms: {}, best_bets: {}, suggestions: [], query_rewrites: {} };
try {
  const configPath = path.join(process.cwd(), 'src/data/search-config.yml');
  const configContent = fs.readFileSync(configPath, 'utf8');
  searchConfig = yaml.load(configContent) as typeof searchConfig;
} catch (e) {
  console.warn('Could not load search-config.yml:', e);
}

// Load chat messages at build time
let chatMessages: any = {};
try {
  const messagesPath = path.join(process.cwd(), 'src/data/chat-messages.yml');
  const messagesContent = fs.readFileSync(messagesPath, 'utf8');
  chatMessages = yaml.load(messagesContent);
} catch (e) {
  console.warn('Could not load chat-messages.yml:', e);
}

const sizeClasses = size === 'large' ? 'py-4 pl-12 pr-12 text-lg' : 'py-3 pl-10 pr-10';
---

<div class="search-container">
  <div class="relative">
    <label for="search-input" class="sr-only" data-i18n="common.search">Search programs</label>

    <!-- Search icon -->
    <svg
      class={`search-icon absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 ${size === 'large' ? 'w-6 h-6 left-4' : 'w-5 h-5'}`}
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>

    <!-- AI indicator (shows when AI is processing) -->
    <div
      id="ai-indicator"
      class={`hidden absolute top-1/2 -translate-y-1/2 ${size === 'large' ? 'right-4' : 'right-3'}`}
    >
      <span
        class="inline-flex items-center gap-1 text-xs text-primary-600 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/50 px-2 py-0.5 rounded-full"
      >
        <svg class="w-3 h-3 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
          ></path>
        </svg>
        <span id="ai-status-text">AI</span>
      </span>
    </div>

    <!-- Loading spinner -->
    <div
      id="search-loading"
      class={`hidden absolute top-1/2 -translate-y-1/2 ${size === 'large' ? 'right-4' : 'right-3'}`}
    >
      <svg class="w-5 h-5 animate-spin text-primary-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
    </div>

    <input
      type="search"
      id="search-input"
      class={`search-input ${sizeClasses}`}
      placeholder={placeholder}
      autocomplete="off"
    />
  </div>

  <!-- Settings row: Location + AI Toggle -->
  <div class="relative flex items-center justify-between mt-2 gap-3 flex-wrap">
    <!-- Location button -->
    <button
      type="button"
      id="location-quick-btn"
      class="inline-flex items-center gap-1.5 text-xs text-neutral-600 dark:text-neutral-300 hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900 rounded transition-colors"
      aria-label="Set your location for better results"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        ></path>
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
      </svg>
      <span id="location-quick-text">Set location</span>
    </button>

    <!-- AI Toggle -->
    <div class="flex items-center gap-2">
      <span
        class="text-xs text-neutral-600 dark:text-neutral-300"
        data-tooltip="Smart Search uses AI to understand your question and find relevant programs. Turn it off for simple keyword matching."
        data-i18n-tooltip="search.smartSearchTooltip"
        data-tooltip-position="left"
        data-i18n="search.smartSearch"
        tabindex="0">Smart search</span
      ><span
        class="ml-1 px-1.5 py-0.5 text-[10px] font-medium rounded-full bg-neutral-200 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-200"
        >Beta</span
      >
      <button
        type="button"
        id="ai-toggle"
        class="ai-toggle-btn ai-toggle-off"
        role="switch"
        aria-checked="false"
        aria-label="Toggle AI-powered search"
        data-tooltip="AI-powered search helps find programs using natural language. Turn off to use keyword search only."
        data-tooltip-position="bottom"
      >
        <span class="ai-toggle-track">
          <span class="ai-toggle-thumb"></span>
        </span>
      </button>
    </div>
  </div>

  <!-- Location popover (shown when location button clicked) -->
  <div
    id="location-popover"
    class="hidden absolute left-0 right-0 mt-2 p-4 bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 z-50"
  >
    <p class="text-sm font-medium text-neutral-900 dark:text-white mb-3">
      Set your location for better results
    </p>
    <div class="flex items-center gap-2 flex-wrap">
      <button
        id="popover-gps-btn"
        type="button"
        class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-md bg-primary-600 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 transition-colors"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        Use my location
      </button>
      <span class="text-neutral-400 text-sm" aria-hidden="true">or</span>
      <div class="flex items-center gap-1">
        <label for="popover-zip-input" class="sr-only">Enter ZIP code or city</label>
        <input
          type="text"
          id="popover-zip-input"
          placeholder="ZIP code or city"
          list="city-list"
          class="px-3 py-2 text-sm rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white w-36 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
        />
        <button
          id="popover-submit-btn"
          type="button"
          class="px-3 py-2 text-sm font-medium rounded-md bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-200 hover:bg-neutral-300 dark:hover:bg-neutral-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 transition-colors"
        >
          Set
        </button>
      </div>
    </div>
    <p class="text-xs text-neutral-400 dark:text-neutral-500 mt-2 flex items-center gap-1">
      <svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path
          fill-rule="evenodd"
          d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
          clip-rule="evenodd"></path>
      </svg>
      Your location stays on your device
    </p>
  </div>

  <!-- Search hints -->
  <div
    id="search-hints"
    class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 p-3 z-50"
  >
    <p class="text-xs text-neutral-600 dark:text-neutral-300 mb-2" data-i18n="search.trySearching">
      Try searching for:
    </p>
    <div class="flex flex-wrap gap-2 mb-3">
      <button type="button" class="search-hint-btn" data-type="keyword">food assistance</button>
      <button type="button" class="search-hint-btn" data-type="keyword">utility bill help</button>
      <button type="button" class="search-hint-btn" data-type="keyword">healthcare</button>
      <button type="button" class="search-hint-btn" data-type="keyword">senior programs</button>
    </div>
    <p class="text-xs text-neutral-600 dark:text-neutral-300 mb-2" data-i18n="search.orAskQuestion">
      Or ask a question:
    </p>
    <div class="flex flex-wrap gap-2">
      <button type="button" class="search-hint-btn ai-hint" data-type="ai"
        >I'm a senior who needs help with bills</button
      >
      <button type="button" class="search-hint-btn ai-hint" data-type="ai"
        >Low-income family looking for food</button
      >
    </div>
  </div>
</div>

<!-- Store API endpoint and search config in data attributes -->
<div
  id="search-config"
  data-api-endpoint={apiEndpoint}
  data-synonyms={JSON.stringify(searchConfig.synonyms || {})}
  data-best-bets={JSON.stringify(searchConfig.best_bets || {})}
  data-suggestions={JSON.stringify(searchConfig.suggestions || [])}
  data-query-rewrites={JSON.stringify(searchConfig.query_rewrites || {})}
  data-chat-messages={JSON.stringify(chatMessages || {})}
  class="hidden"
>
</div>

<!-- Type-ahead dropdown -->
<div id="typeahead-dropdown" class="typeahead-dropdown hidden">
  <ul id="typeahead-list" role="listbox" aria-label="Search suggestions"></ul>
</div>

<!-- Screen reader announcements (aria-live regions) -->
<div class="sr-only" aria-live="polite" aria-atomic="true" id="search-announcer"></div>
<div class="sr-only" aria-live="assertive" aria-atomic="true" id="search-urgent-announcer"></div>

<!-- Smart Search Suggestion (shown when vague query detected with AI off) -->
<div
  id="smart-search-suggestion"
  class="hidden mt-4 p-4 bg-primary-50 dark:bg-primary-900/30 rounded-lg border border-primary-200 dark:border-primary-800"
  role="region"
  aria-label="Smart search suggestion"
>
  <div class="flex items-start gap-3">
    <div class="flex-shrink-0 mt-0.5">
      <svg
        class="w-5 h-5 text-primary-600 dark:text-primary-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
        ></path>
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      <p
        class="text-sm font-medium text-primary-900 dark:text-primary-100 mb-1"
        id="smart-suggestion-title"
      >
        Need help finding specific resources?
      </p>
      <p class="text-sm text-primary-700 dark:text-primary-300 mb-3" id="smart-suggestion-message">
        Turn on Smart Search to help find programs that match your needs.
      </p>
      <div class="flex items-center gap-3 flex-wrap">
        <button
          type="button"
          id="enable-smart-search-btn"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-primary-600 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900 transition-colors"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          Enable Smart Search
        </button>
        <button
          type="button"
          id="dismiss-smart-suggestion-btn"
          class="text-sm text-primary-600 dark:text-primary-400 hover:underline focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900 rounded"
        >
          No thanks
        </button>
      </div>
    </div>
    <button
      type="button"
      id="close-smart-suggestion-btn"
      class="flex-shrink-0 text-primary-400 hover:text-primary-600 dark:text-primary-500 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
      aria-label="Dismiss suggestion"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
</div>

<!-- Smart Search Chat Interface (shown when AI is enabled) -->
<div
  id="smart-chat-container"
  class="hidden mt-4 bg-white dark:bg-neutral-800 rounded-lg border border-neutral-200 dark:border-neutral-700 shadow-sm overflow-hidden"
  role="region"
  aria-label="Smart search conversation"
>
  <!-- Chat Header -->
  <div
    class="flex items-center justify-between px-4 py-2 bg-primary-50 dark:bg-primary-900/30 border-b border-primary-100 dark:border-primary-800"
  >
    <div class="flex items-center gap-2">
      <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" aria-hidden="true"></div>
      <span class="text-sm font-medium text-primary-900 dark:text-primary-100">Smart Search</span>
      <span
        class="text-xs text-primary-600 dark:text-primary-400 bg-primary-100 dark:bg-primary-800 px-1.5 py-0.5 rounded"
        >Beta</span
      >
    </div>
    <button
      type="button"
      id="close-smart-chat-btn"
      class="text-primary-400 hover:text-primary-600 dark:text-primary-500 dark:hover:text-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded p-1"
      aria-label="Close smart search chat"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Chat Messages -->
  <div
    id="smart-chat-messages"
    class="p-4 space-y-3 max-h-64 overflow-y-auto"
    role="log"
    aria-live="polite"
  >
    <!-- Messages will be added here dynamically -->
  </div>

  <!-- Chat Input (for follow-up questions) -->
  <div
    id="smart-chat-input-area"
    class="hidden px-4 py-3 border-t border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-900"
  >
    <div class="flex items-center gap-2">
      <label for="smart-chat-input" class="sr-only">Ask a follow-up question</label>
      <input
        type="text"
        id="smart-chat-input"
        placeholder="Ask a follow-up question..."
        class="flex-1 px-3 py-2 text-sm rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
      />
      <button
        type="button"
        id="smart-chat-send-btn"
        class="px-3 py-2 text-sm font-medium rounded-md bg-primary-600 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900 transition-colors"
        aria-label="Send message"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Quick Action Buttons (shown when AI asks clarifying questions) -->
  <div
    id="smart-chat-actions"
    class="hidden px-4 py-3 border-t border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-900"
  >
    <div id="smart-chat-action-buttons" class="flex flex-wrap gap-2">
      <!-- Action buttons will be added here dynamically -->
    </div>
  </div>
</div>

<!-- Refinement Bar (shown when results are broad) -->
<div
  id="refinement-bar"
  class="hidden mt-4 p-4 bg-neutral-50 dark:bg-neutral-800 rounded-lg border border-neutral-200 dark:border-neutral-700"
  role="region"
  aria-label="Search refinement options"
>
  <!-- Location display/prompt -->
  <div id="location-section" class="mb-4">
    <!-- Shown when location is set -->
    <div id="location-display" class="hidden flex items-center gap-2 text-sm flex-wrap">
      <svg
        class="w-4 h-4 text-neutral-500 dark:text-neutral-400 flex-shrink-0"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        ></path>
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
      </svg>
      <span class="text-neutral-600 dark:text-neutral-300">Location:</span>
      <span id="location-value" class="font-medium text-neutral-900 dark:text-white"></span>
      <span id="location-source" class="text-xs text-neutral-400"></span>
      <button
        id="change-location-btn"
        type="button"
        class="text-primary-600 dark:text-primary-400 hover:underline text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 rounded"
      >
        Change
      </button>
    </div>

    <!-- Shown when no location is set -->
    <div id="location-prompt" class="hidden">
      <p
        class="text-sm text-neutral-600 dark:text-neutral-300 mb-2 font-medium"
        id="location-prompt-label"
      >
        Where are you located?
      </p>
      <div
        class="flex items-center gap-2 flex-wrap"
        role="group"
        aria-labelledby="location-prompt-label"
      >
        <button
          id="use-gps-btn"
          type="button"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 transition-colors"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          Use my location
        </button>
        <span class="text-neutral-400 text-sm" aria-hidden="true">or</span>
        <label for="zip-city-input" class="sr-only">Enter ZIP code or city</label>
        <div class="flex items-center gap-1">
          <input
            type="text"
            id="zip-city-input"
            placeholder="ZIP code or city"
            class="px-3 py-1.5 text-sm rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white w-40 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            autocomplete="postal-code"
          />
          <button
            id="submit-location-btn"
            type="button"
            class="px-3 py-1.5 text-sm font-medium rounded-md bg-primary-600 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 transition-colors"
            aria-label="Set location"
          >
            Go
          </button>
        </div>
      </div>
      <p class="text-xs text-neutral-400 dark:text-neutral-500 mt-2 flex items-center gap-1">
        <svg
          class="w-3 h-3 flex-shrink-0"
          fill="currentColor"
          viewBox="0 0 20 20"
          aria-hidden="true"
        >
          <path
            fill-rule="evenodd"
            d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
            clip-rule="evenodd"></path>
        </svg>
        Your location stays on your device
      </p>
    </div>
  </div>

  <!-- Category buttons -->
  <div id="category-refinement" role="group" aria-labelledby="category-prompt">
    <p id="category-prompt" class="text-sm text-neutral-600 dark:text-neutral-300 mb-3 font-medium">
      What kind of help are you looking for?
    </p>
    <div class="flex flex-wrap gap-2" id="category-buttons" role="list">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Sub-options (shown after category selection) -->
  <div id="suboption-refinement" class="hidden" role="group" aria-labelledby="suboption-prompt">
    <p
      id="suboption-prompt"
      class="text-sm text-neutral-600 dark:text-neutral-300 mb-3 font-medium"
    >
    </p>
    <div class="flex flex-wrap gap-2" id="suboption-buttons" role="list">
      <!-- Populated by JavaScript -->
    </div>
    <button
      id="back-to-categories"
      type="button"
      class="mt-3 text-sm text-primary-600 dark:text-primary-400 hover:underline flex items-center gap-1 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 rounded"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
        ></path>
      </svg>
      Back to all categories
    </button>
  </div>
</div>

<!-- Quick Answer Card container (populated by API response) -->
<div id="quick-answer-container" class="hidden"></div>

<!-- City autocomplete datalist -->
<datalist id="city-list">
  <option value="Alameda"></option>
  <option value="Albany"></option>
  <option value="Berkeley"></option>
  <option value="Concord"></option>
  <option value="Daly City"></option>
  <option value="Dublin"></option>
  <option value="Emeryville"></option>
  <option value="Fremont"></option>
  <option value="Hayward"></option>
  <option value="Livermore"></option>
  <option value="Milpitas"></option>
  <option value="Mountain View"></option>
  <option value="Newark"></option>
  <option value="Oakland"></option>
  <option value="Palo Alto"></option>
  <option value="Pleasanton"></option>
  <option value="Redwood City"></option>
  <option value="Richmond"></option>
  <option value="San Francisco"></option>
  <option value="San Jose"></option>
  <option value="San Leandro"></option>
  <option value="San Mateo"></option>
  <option value="San Rafael"></option>
  <option value="Santa Clara"></option>
  <option value="Sunnyvale"></option>
  <option value="Union City"></option>
  <option value="Vallejo"></option>
  <option value="Walnut Creek"></option>
</datalist>

<script>
  import Fuse from 'fuse.js';

  // Load config
  const configEl = document.getElementById('search-config');
  const API_ENDPOINT = configEl?.dataset?.apiEndpoint || '';

  // Load search enhancements from build-time config
  const SYNONYMS: Record<string, string[]> = JSON.parse(configEl?.dataset?.synonyms || '{}');
  const BEST_BETS: Record<string, string[]> = JSON.parse(configEl?.dataset?.bestBets || '{}');
  const SUGGESTIONS: string[] = JSON.parse(configEl?.dataset?.suggestions || '[]');
  const QUERY_REWRITES: Record<string, string> = JSON.parse(
    configEl?.dataset?.queryRewrites || '{}'
  );

  // Load chat messages from build-time config
  const CHAT_MESSAGES: any = JSON.parse(configEl?.dataset?.chatMessages || '{}');

  // Helper to get a random message from an array
  function getRandomMessage(messages: string[] | undefined, fallback: string): string {
    if (!messages || messages.length === 0) return fallback;
    return messages[Math.floor(Math.random() * messages.length)];
  }

  // Helper to get a message with variable substitution
  function getMessage(
    category: string,
    key: string,
    vars: Record<string, string | number> = {}
  ): string {
    const messages = CHAT_MESSAGES?.[category]?.[key];
    let message = getRandomMessage(
      Array.isArray(messages) ? messages : [messages],
      messages || `[${category}.${key}]`
    );

    // Replace variables like {count}, {location}, etc.
    for (const [varName, value] of Object.entries(vars)) {
      message = message.replace(new RegExp(`\\{${varName}\\}`, 'g'), String(value));
    }
    return message;
  }

  // Refinement configuration (loaded from search-config.yml at build time)
  interface RefinementCategory {
    id: string;
    label: string;
    icon: string;
    search_terms: string[];
    best_bets: string[];
    sub_options: Array<{
      label: string;
      search_terms: string[];
      best_bets: string[];
    }>;
  }

  interface RefinementConfig {
    trigger: {
      min_results: number;
      max_query_length: number;
      vague_terms: string[];
    };
    categories: RefinementCategory[];
  }

  // Refinement trigger settings
  const REFINEMENT_TRIGGER = {
    min_results: 12,
    max_query_length: 10,
    vague_terms: ['help', 'assistance', 'need', 'program', 'benefit', 'services', 'resources'],
  };

  // Category refinement data
  const REFINEMENT_CATEGORIES: RefinementCategory[] = [
    {
      id: 'food',
      label: 'Food',
      icon: 'üçé',
      search_terms: ['food', 'calfresh', 'snap', 'meals'],
      best_bets: ['calfresh-food-assistance', 'sf-marin-food-bank', 'second-harvest-food-bank'],
      sub_options: [
        {
          label: "Can't afford groceries",
          search_terms: ['calfresh', 'food stamps', 'snap'],
          best_bets: ['calfresh-food-assistance'],
        },
        {
          label: 'Need food right now',
          search_terms: ['food bank', 'food pantry', 'emergency food'],
          best_bets: ['sf-marin-food-bank', 'second-harvest-food-bank'],
        },
        {
          label: 'Baby food or formula',
          search_terms: ['wic', 'baby food', 'formula', 'infant nutrition'],
          best_bets: ['wic-program'],
        },
        {
          label: 'Senior meals',
          search_terms: ['meals on wheels', 'senior meals', 'congregate meals'],
          best_bets: ['meals-on-wheels'],
        },
      ],
    },
    {
      id: 'housing',
      label: 'Housing',
      icon: 'üè†',
      search_terms: ['housing', 'rent', 'shelter', 'homeless'],
      best_bets: ['federal-department-of-housing-choice-voucher-section-8'],
      sub_options: [
        {
          label: "Can't pay rent",
          search_terms: ['rental assistance', 'rent help', 'emergency rental'],
          best_bets: ['rental-assistance-program', 'eviction-prevention'],
        },
        {
          label: 'Facing eviction',
          search_terms: ['eviction', 'eviction defense', 'tenant rights'],
          best_bets: ['bay-area-legal-aid', 'eviction-defense-collaborative'],
        },
        {
          label: 'Need a place to stay',
          search_terms: ['shelter', 'homeless', 'navigation center', 'coordinated entry'],
          best_bets: ['coordinated-entry', 'navigation-centers'],
        },
        {
          label: 'Looking to buy a home',
          search_terms: ['first-time homebuyer', 'down payment', 'mortgage assistance'],
          best_bets: ['calhfa-first-time-homebuyer'],
        },
      ],
    },
    {
      id: 'healthcare',
      label: 'Healthcare',
      icon: 'üíä',
      search_terms: ['healthcare', 'medical', 'health insurance', 'doctor'],
      best_bets: ['medi-cal', 'covered-california'],
      sub_options: [
        {
          label: 'Need health insurance',
          search_terms: ['medi-cal', 'covered california', 'health insurance'],
          best_bets: ['medi-cal', 'covered-california'],
        },
        {
          label: 'Mental health support',
          search_terms: ['mental health', 'counseling', 'therapy', 'crisis'],
          best_bets: ['988-suicide-crisis-lifeline', 'county-behavioral-health'],
        },
        {
          label: 'Dental care',
          search_terms: ['dental', 'dentist', 'denti-cal'],
          best_bets: ['denti-cal'],
        },
        {
          label: 'Need to see a doctor',
          search_terms: ['clinic', 'community health', 'primary care'],
          best_bets: ['community-health-centers'],
        },
      ],
    },
    {
      id: 'jobs',
      label: 'Jobs',
      icon: 'üíº',
      search_terms: ['job', 'employment', 'work', 'career'],
      best_bets: ['caljobs', 'sf-jobsnow'],
      sub_options: [
        {
          label: 'Looking for a job',
          search_terms: ['job search', 'caljobs', 'employment'],
          best_bets: ['caljobs', 'sf-jobsnow'],
        },
        {
          label: 'Lost my job',
          search_terms: ['unemployment', 'edd', 'laid off'],
          best_bets: ['edd-unemployment-insurance'],
        },
        {
          label: 'Need job training',
          search_terms: ['job training', 'workforce', 'vocational'],
          best_bets: ['nova-workforce', 'job-corps'],
        },
        {
          label: 'Resume help',
          search_terms: ['resume', 'interview', 'job search'],
          best_bets: ['career-counseling-centers'],
        },
      ],
    },
    {
      id: 'money',
      label: 'Money',
      icon: 'üí∞',
      search_terms: ['cash', 'money', 'welfare', 'bills'],
      best_bets: ['calworks-cash-assistance'],
      sub_options: [
        {
          label: 'Need cash assistance',
          search_terms: ['calworks', 'welfare', 'cash aid', 'general assistance'],
          best_bets: ['calworks-cash-assistance', 'general-assistance'],
        },
        {
          label: 'Disability benefits',
          search_terms: ['ssi', 'ssdi', 'disability'],
          best_bets: ['federal-social-security-supplemental-security-income-ssi'],
        },
        {
          label: 'Help with utility bills',
          search_terms: ['utility', 'liheap', 'care', 'pgcap', 'energy'],
          best_bets: ['care-program-pge', 'liheap'],
        },
        {
          label: 'Retirement/Social Security',
          search_terms: ['retirement', 'social security', 'pension'],
          best_bets: ['federal-social-security-retirement-benefits'],
        },
      ],
    },
    {
      id: 'legal',
      label: 'Legal',
      icon: '‚öñÔ∏è',
      search_terms: ['legal', 'lawyer', 'attorney', 'rights'],
      best_bets: ['bay-area-legal-aid'],
      sub_options: [
        {
          label: 'Free legal help',
          search_terms: ['legal aid', 'free lawyer', 'legal services'],
          best_bets: ['bay-area-legal-aid', 'legal-aid-at-work'],
        },
        {
          label: 'Tenant/landlord issues',
          search_terms: ['tenant rights', 'eviction', 'landlord'],
          best_bets: ['bay-area-legal-aid', 'tenants-union'],
        },
        {
          label: 'Immigration help',
          search_terms: ['immigration', 'citizenship', 'daca', 'visa'],
          best_bets: ['centro-legal-de-la-raza', 'immigration-legal-services'],
        },
      ],
    },
    {
      id: 'family',
      label: 'Family',
      icon: 'üë®‚Äçüë©‚Äçüëß',
      search_terms: ['family', 'children', 'childcare', 'senior'],
      best_bets: ['head-start-bay-area'],
      sub_options: [
        {
          label: 'Childcare/preschool',
          search_terms: ['childcare', 'daycare', 'preschool', 'head start'],
          best_bets: ['head-start-bay-area', 'subsidized-childcare'],
        },
        {
          label: 'After school programs',
          search_terms: ['after school', 'youth programs', 'tutoring'],
          best_bets: ['after-school-all-stars'],
        },
        {
          label: 'Senior services',
          search_terms: ['senior', 'elderly', 'aging', 'meals on wheels'],
          best_bets: ['senior-center', 'meals-on-wheels'],
        },
        {
          label: 'Diapers/baby supplies',
          search_terms: ['diapers', 'baby', 'infant', 'wic'],
          best_bets: ['diaper-bank', 'wic-program'],
        },
      ],
    },
    {
      id: 'education',
      label: 'Education',
      icon: 'üéì',
      search_terms: ['education', 'school', 'college', 'ged'],
      best_bets: ['cal-grant'],
      sub_options: [
        {
          label: 'Paying for college',
          search_terms: ['financial aid', 'fafsa', 'cal grant', 'scholarship'],
          best_bets: ['cal-grant', 'fafsa-help'],
        },
        {
          label: 'GED/Adult education',
          search_terms: ['ged', 'adult education', 'adult school'],
          best_bets: ['career-online-high-school', 'adult-school-sf'],
        },
        {
          label: 'ESL/English classes',
          search_terms: ['esl', 'english', 'language'],
          best_bets: ['esl-classes'],
        },
        {
          label: 'School meals',
          search_terms: ['school meals', 'free lunch', 'summer meals'],
          best_bets: ['national-school-lunch-program'],
        },
      ],
    },
  ];

  // City to county mapping for location lookup
  const CITY_TO_COUNTY: Record<string, string> = {
    alameda: 'Alameda County',
    albany: 'Alameda County',
    berkeley: 'Alameda County',
    dublin: 'Alameda County',
    emeryville: 'Alameda County',
    fremont: 'Alameda County',
    hayward: 'Alameda County',
    livermore: 'Alameda County',
    newark: 'Alameda County',
    oakland: 'Alameda County',
    piedmont: 'Alameda County',
    pleasanton: 'Alameda County',
    'san leandro': 'Alameda County',
    'union city': 'Alameda County',
    concord: 'Contra Costa County',
    antioch: 'Contra Costa County',
    pittsburg: 'Contra Costa County',
    richmond: 'Contra Costa County',
    'walnut creek': 'Contra Costa County',
    'san rafael': 'Marin County',
    novato: 'Marin County',
    napa: 'Napa County',
    'san francisco': 'San Francisco',
    'daly city': 'San Mateo County',
    'redwood city': 'San Mateo County',
    'san mateo': 'San Mateo County',
    'south san francisco': 'San Mateo County',
    milpitas: 'Santa Clara County',
    'mountain view': 'Santa Clara County',
    'palo alto': 'Santa Clara County',
    'san jose': 'Santa Clara County',
    'santa clara': 'Santa Clara County',
    sunnyvale: 'Santa Clara County',
    fairfield: 'Solano County',
    vallejo: 'Solano County',
    'santa rosa': 'Sonoma County',
    petaluma: 'Sonoma County',
  };

  // County coordinates for GPS lookup
  const COUNTY_COORDINATES: Record<string, { lat: number; lng: number }> = {
    'Alameda County': { lat: 37.6017, lng: -121.7195 },
    'Contra Costa County': { lat: 37.9193, lng: -121.9277 },
    'Marin County': { lat: 38.0834, lng: -122.7633 },
    'Napa County': { lat: 38.5025, lng: -122.2654 },
    'San Francisco': { lat: 37.7749, lng: -122.4194 },
    'San Mateo County': { lat: 37.4969, lng: -122.3331 },
    'Santa Clara County': { lat: 37.3541, lng: -121.9552 },
    'Solano County': { lat: 38.2721, lng: -121.9399 },
    'Sonoma County': { lat: 38.578, lng: -122.9888 },
  };

  // Refinement state
  let currentLocation: { source: string; county: string; city?: string; input?: string } | null =
    null;
  let selectedCategory: RefinementCategory | null = null;

  // Type-ahead elements
  const typeaheadDropdown = document.getElementById('typeahead-dropdown');
  const typeaheadList = document.getElementById('typeahead-list');
  let selectedSuggestionIndex = -1;

  // Expand query with synonyms
  function expandWithSynonyms(query: string): string[] {
    const terms = query.toLowerCase().split(/\s+/);
    const expanded = new Set<string>([query.toLowerCase()]);

    // Check each term and multi-word phrases for synonyms
    for (const term of terms) {
      if (SYNONYMS[term]) {
        SYNONYMS[term].forEach((syn) => expanded.add(syn));
      }
    }

    // Check for multi-word phrases
    const queryLower = query.toLowerCase();
    for (const [phrase, synonyms] of Object.entries(SYNONYMS)) {
      if (queryLower.includes(phrase)) {
        synonyms.forEach((syn) => expanded.add(syn));
      }
    }

    return Array.from(expanded);
  }

  // Rewrite natural language queries
  function rewriteQuery(query: string): string {
    const queryLower = query.toLowerCase().trim();

    // Check for exact rewrites first
    if (QUERY_REWRITES[queryLower]) {
      return QUERY_REWRITES[queryLower];
    }

    // Check for partial matches
    for (const [pattern, rewrite] of Object.entries(QUERY_REWRITES)) {
      if (queryLower.includes(pattern)) {
        return rewrite;
      }
    }

    return query;
  }

  // Get best bets for a query
  function getBestBets(query: string): string[] {
    const queryLower = query.toLowerCase().trim();
    const terms = queryLower.split(/\s+/);

    // Check for exact match first
    if (BEST_BETS[queryLower]) {
      return BEST_BETS[queryLower];
    }

    // Check individual terms
    for (const term of terms) {
      if (BEST_BETS[term]) {
        return BEST_BETS[term];
      }
    }

    return [];
  }

  // Show type-ahead suggestions
  function showTypeahead(query: string) {
    if (!typeaheadDropdown || !typeaheadList || query.length < 2) {
      hideTypeahead();
      return;
    }

    const queryLower = query.toLowerCase();
    const matches = SUGGESTIONS.filter((s) => s.toLowerCase().includes(queryLower)).slice(0, 6);

    if (matches.length === 0) {
      hideTypeahead();
      return;
    }

    typeaheadList.innerHTML = matches
      .map(
        (suggestion, i) => `
      <li role="option"
          class="typeahead-item ${i === selectedSuggestionIndex ? 'selected' : ''}"
          data-suggestion="${suggestion}">
        <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <span>${highlightMatch(suggestion, query)}</span>
      </li>
    `
      )
      .join('');

    typeaheadDropdown.classList.remove('hidden');

    // Add click handlers
    typeaheadList.querySelectorAll('.typeahead-item').forEach((item) => {
      item.addEventListener('click', () => {
        const suggestion = (item as HTMLElement).dataset.suggestion;
        if (suggestion && searchInput) {
          (searchInput as HTMLInputElement).value = suggestion;
          hideTypeahead();
          performSearch();
        }
      });
    });
  }

  function hideTypeahead() {
    typeaheadDropdown?.classList.add('hidden');
    selectedSuggestionIndex = -1;
  }

  function highlightMatch(text: string, query: string): string {
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
  }

  // Handle keyboard navigation for type-ahead
  function handleTypeaheadKeydown(e: KeyboardEvent) {
    const items = typeaheadList?.querySelectorAll('.typeahead-item') || [];
    if (items.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
      updateTypeaheadSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
      updateTypeaheadSelection(items);
    } else if (e.key === 'Tab' && selectedSuggestionIndex >= 0) {
      e.preventDefault();
      const selected = items[selectedSuggestionIndex] as HTMLElement;
      const suggestion = selected?.dataset?.suggestion;
      if (suggestion && searchInput) {
        (searchInput as HTMLInputElement).value = suggestion;
        hideTypeahead();
      }
    } else if (e.key === 'Escape') {
      hideTypeahead();
    }
  }

  function updateTypeaheadSelection(items: NodeListOf<Element>) {
    items.forEach((item, i) => {
      if (i === selectedSuggestionIndex) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    });
  }

  // Check if we're on the homepage (has home-program-card elements)
  const isHomepage = document.querySelectorAll('.home-program-card').length > 0;
  const homeResultsSection = document.getElementById('search-results');
  const homeResultsCount = document.getElementById('home-results-count');
  const noResultsEl = document.getElementById('no-results');
  const clearSearchBtn = document.getElementById('clear-search');

  // Build search index from program cards (directory page or homepage)
  const cards = isHomepage
    ? document.querySelectorAll('.home-program-card [data-category]')
    : document.querySelectorAll('[data-category]');

  const cardWrappers = isHomepage ? document.querySelectorAll('.home-program-card') : null;

  const programs = Array.from(cards).map((card, index) => {
    const nameEl = card.querySelector('h3');
    const descEl = card.querySelector('p');
    const areaEl = card.querySelector('[class*="text-neutral-600"], [class*="text-neutral-500"]');
    const id = card.id?.replace('program-', '') || '';
    // For homepage, the wrapper element controls visibility
    const wrapper = isHomepage && cardWrappers ? cardWrappers[index] : null;

    return {
      index,
      element: card,
      wrapper,
      id,
      name: nameEl?.textContent?.trim() || '',
      description: descEl?.textContent?.trim() || '',
      category: card.getAttribute('data-category') || '',
      groups: card.getAttribute('data-groups')?.split(',') || [],
      area: areaEl?.textContent?.trim() || '',
      text: card.textContent?.trim() || '',
    };
  });

  // Configure Fuse.js with weighted search
  const fuse = new Fuse(programs, {
    keys: [
      { name: 'name', weight: 0.4 },
      { name: 'description', weight: 0.3 },
      { name: 'category', weight: 0.2 },
      { name: 'area', weight: 0.1 },
    ],
    threshold: 0.4,
    distance: 100,
    minMatchCharLength: 2,
    includeScore: true,
    includeMatches: true,
    ignoreLocation: true,
    useExtendedSearch: true,
  });

  const searchInput = document.getElementById('search-input');
  const searchHints = document.getElementById('search-hints');
  const aiIndicator = document.getElementById('ai-indicator');
  const aiStatusText = document.getElementById('ai-status-text');
  const searchLoading = document.getElementById('search-loading');
  const aiToggle = document.getElementById('ai-toggle');
  const hintButtons = document.querySelectorAll('.search-hint-btn');

  // Aria-live announcers for screen readers
  const searchAnnouncer = document.getElementById('search-announcer');
  const urgentAnnouncer = document.getElementById('search-urgent-announcer');

  // Announce search results to screen readers
  function announceToScreenReader(message: string, urgent = false) {
    const announcer = urgent ? urgentAnnouncer : searchAnnouncer;
    if (announcer) {
      // Clear and re-set to ensure announcement
      announcer.textContent = '';
      setTimeout(() => {
        announcer.textContent = message;
      }, 100);
    }
  }

  let activeCategory = 'all';
  let debounceTimer;
  let isAISearching = false;
  let lastAIQuery = '';
  let isOffline = !navigator.onLine;

  // Load AI preference from localStorage (defaults to OFF - user must explicitly enable)
  let aiEnabled = !isOffline && localStorage.getItem('aiSearchEnabled') === 'true';

  // Initialize toggle state
  function updateToggleState() {
    if (aiToggle) {
      // When offline, always show as off and disabled
      const effectiveEnabled = aiEnabled && !isOffline;
      aiToggle.setAttribute('aria-checked', String(effectiveEnabled));

      if (isOffline) {
        aiToggle.classList.add('ai-toggle-disabled');
      } else {
        aiToggle.classList.remove('ai-toggle-disabled');
      }

      if (effectiveEnabled) {
        aiToggle.classList.add('ai-toggle-on');
        aiToggle.classList.remove('ai-toggle-off');
      } else {
        aiToggle.classList.remove('ai-toggle-on');
        aiToggle.classList.add('ai-toggle-off');
      }
    }
  }
  updateToggleState();

  // Show offline notice
  function showOfflineNotice() {
    // Remove any existing notice
    const existingNotice = document.getElementById('offline-notice');
    if (existingNotice) existingNotice.remove();

    // Create and show notice
    const notice = document.createElement('div');
    notice.id = 'offline-notice';
    notice.className = 'offline-notice';
    notice.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m-2.829-2.829a5 5 0 010-7.07m-2.829 2.829a1 1 0 010 1.414"/>
      </svg>
      <span>You're offline. Connect to the internet to use smart search.</span>
    `;
    aiToggle?.parentElement?.appendChild(notice);

    // Auto-remove after 3 seconds
    setTimeout(() => notice.remove(), 3000);
  }

  // Handle toggle click
  aiToggle?.addEventListener('click', () => {
    // If offline, show notice and don't toggle
    if (isOffline) {
      showOfflineNotice();
      return;
    }

    aiEnabled = !aiEnabled;
    localStorage.setItem('aiSearchEnabled', String(aiEnabled));
    updateToggleState();

    // If AI is now disabled, hide any AI indicators and chat
    if (!aiEnabled) {
      hideAIIndicator();
      // Hide the chat if it's showing
      const smartChatEl = document.getElementById('smart-chat-container');
      smartChatEl?.classList.add('hidden');
    }

    // Re-run search with new setting
    if (searchInput?.value) {
      // If turning on AI with a query, start the chat
      if (aiEnabled) {
        const smartChatEl = document.getElementById('smart-chat-container');
        if (smartChatEl) {
          // Start chat conversation
          startSmartChatConversation(searchInput.value);
          performAISearch(searchInput.value);
        }
      } else {
        performSearch();
      }
    }
  });

  // Track online/offline status
  window.addEventListener('online', () => {
    isOffline = false;
    // Restore AI enabled state from localStorage when coming back online
    aiEnabled = localStorage.getItem('aiSearchEnabled') === 'true';
    updateToggleState();
  });
  window.addEventListener('offline', () => {
    isOffline = true;
    // If we were showing AI indicator, hide it
    hideAIIndicator();
    updateToggleState();
  });

  // Detect if query needs AI assistance
  function isComplexQuery(query) {
    const trimmed = query.trim();

    // Demographic terms that should trigger AI even as single words
    // These map to specific group filters that fuzzy search might miss
    // Comprehensive list based on groups.yml categories
    const demographicTerms = new RegExp(
      '^(' +
        [
          // Income-eligible synonyms
          'low.?income',
          'ebt',
          'snap',
          'calfresh',
          'calworks',
          'medi.?cal',
          'medicaid',
          'ssi',
          'ssdi',
          'welfare',
          'poor',
          'poverty',
          // Seniors synonyms
          'senior',
          'seniors',
          'elderly',
          'older.?adult',
          'retiree',
          'retired',
          'aging',
          // Youth synonyms
          'youth',
          'young',
          'teen',
          'teenager',
          'child',
          'children',
          'kid',
          'kids',
          'minor',
          'adolescent',
          // College students synonyms
          'student',
          'students',
          'college',
          'university',
          'grad.?student',
          'undergraduate',
          'graduate',
          // Veterans synonyms
          'veteran',
          'veterans',
          'military',
          'army',
          'navy',
          'marines',
          'air.?force',
          'coast.?guard',
          'active.?duty',
          'reservist',
          // Families synonyms
          'family',
          'families',
          'parent',
          'parents',
          'mother',
          'father',
          'mom',
          'dad',
          'single.?parent',
          // Disability synonyms
          'disabled',
          'disability',
          'disabilities',
          'handicapped',
          'blind',
          'deaf',
          'wheelchair',
          'ada',
          // LGBTQ+ synonyms
          'lgbtq?',
          'lgbt',
          'gay',
          'lesbian',
          'bisexual',
          'transgender',
          'queer',
          'trans',
          'nonbinary',
          'non.?binary',
          'pansexual',
          'asexual',
          'intersex',
          'pride',
          // First responders synonyms
          'first.?responder',
          'firefighter',
          'police',
          'officer',
          'cop',
          'emt',
          'paramedic',
          // Teachers synonyms
          'teacher',
          'teachers',
          'educator',
          'professor',
          'instructor',
          // Job seekers synonyms
          'unemployed',
          'job.?seeker',
          'jobless',
          'laid.?off',
          // Immigrants synonyms
          'immigrant',
          'immigrants',
          'refugee',
          'refugees',
          'undocumented',
          'daca',
          'dreamer',
          'asylum',
          'migrant',
          // Unhoused synonyms
          'homeless',
          'unhoused',
          'houseless',
          'unsheltered',
          'shelter',
          // Pregnant/Women synonyms
          'pregnant',
          'pregnancy',
          'expecting',
          'expectant',
          'prenatal',
          'maternal',
          'woman',
          'women',
          'female',
          // Caregivers synonyms
          'caregiver',
          'caregivers',
          // Foster youth synonyms
          'foster',
          'foster.?youth',
          'foster.?care',
          'aged.?out',
          // Formerly incarcerated synonyms
          'incarcerated',
          'formerly.?incarcerated',
          'reentry',
          'ex.?offender',
          'parolee',
          'probation',
          // Nonprofits
          'nonprofit',
          'non.?profit',
          'ngo',
          'charity',
        ].join('|') +
        ')$',
      'i'
    );

    if (demographicTerms.test(trimmed)) {
      return true; // Single demographic terms should use AI
    }

    // Simple patterns that don't need AI
    const simplePatterns = [
      /^\d{5}$/, // ZIP code
      /^[a-zA-Z]{1,20}$/, // Single word (generic)
      /^[a-zA-Z]+\s+[a-zA-Z]+$/, // Two words
      /^(food|health|housing|utilities|transportation|education|legal|finance|technology|recreation|community)$/i, // Category names
    ];

    for (const pattern of simplePatterns) {
      if (pattern.test(trimmed)) return false;
    }

    // Complex query indicators
    const complexIndicators = [
      trimmed.length > 30, // Long queries
      /\b(i'm|i am|my|me|we|our)\b/i.test(trimmed), // First person
      /\b(need|looking for|help with|want|qualify)\b/i.test(trimmed), // Intent words
      // Demographics - expanded to include more identity terms
      /\b(senior|elderly|disabled|veteran|family|child|low.?income|immigrant|refugee|homeless|unhoused)\b/i.test(
        trimmed
      ),
      /\b(lgbtq?|gay|lesbian|bisexual|transgender|queer|nonbinary|trans)\b/i.test(trimmed), // LGBTQ+ terms
      /\b(woman|women|female|mother|pregnant|expecting)\b/i.test(trimmed), // Women-specific
      /\b(student|college|university|graduate|undergraduate)\b/i.test(trimmed), // Students
      /\b(teacher|educator|nurse|first.?responder|firefighter|police|emt)\b/i.test(trimmed), // Professions
      /\b(foster|formerly.?incarcerated|reentry|caregiver)\b/i.test(trimmed), // Special circumstances
      /\b(years?\s+old|\d{2}\s+year)\b/i.test(trimmed), // Age mentions
      /\b(living\s+in|from|near)\b/i.test(trimmed), // Location context
      trimmed.split(/\s+/).length >= 5, // 5+ words
    ];

    const complexCount = complexIndicators.filter(Boolean).length;
    return complexCount >= 2;
  }

  // Track active category filter
  document.addEventListener('click', (e) => {
    const filterBtn = e.target.closest('[data-filter]');
    if (filterBtn) {
      activeCategory = filterBtn.getAttribute('data-filter') || 'all';
      performSearch();
    }
  });

  function showLoading(show) {
    if (show) {
      searchLoading?.classList.remove('hidden');
      aiIndicator?.classList.add('hidden');
    } else {
      searchLoading?.classList.add('hidden');
    }
  }

  function showAIIndicator(status) {
    aiIndicator?.classList.remove('hidden');
    searchLoading?.classList.add('hidden');
    if (aiStatusText) aiStatusText.textContent = status;
  }

  function hideAIIndicator() {
    aiIndicator?.classList.add('hidden');
  }

  // Quick Answer Card display functions
  const quickAnswerContainer = document.getElementById('quick-answer-container');

  function showQuickAnswer(quickAnswer) {
    if (!quickAnswerContainer) return;

    // Clear previous content using safe method
    while (quickAnswerContainer.firstChild) {
      quickAnswerContainer.removeChild(quickAnswerContainer.firstChild);
    }
    quickAnswerContainer.classList.remove('hidden');

    // Create the quick answer card based on type
    const card = document.createElement('div');
    card.className = 'quick-answer-card';
    card.setAttribute('role', 'region');
    card.setAttribute('aria-label', 'Quick answer');

    // Build card content based on response type
    if (quickAnswer.type === 'crisis') {
      card.classList.add('quick-answer-crisis');
      card.setAttribute('role', 'alert');

      const title = document.createElement('h3');
      title.className = 'quick-answer-title';
      title.textContent = quickAnswer.title || 'Help is available.';
      card.appendChild(title);

      if (quickAnswer.resource) {
        const resource = document.createElement('div');
        resource.className = 'quick-answer-resource';

        const name = document.createElement('div');
        name.className = 'quick-answer-resource-name';
        name.textContent = quickAnswer.resource.name;
        resource.appendChild(name);

        if (quickAnswer.resource.description) {
          const desc = document.createElement('div');
          desc.className = 'quick-answer-resource-desc';
          desc.textContent = quickAnswer.resource.description;
          resource.appendChild(desc);
        }

        if (quickAnswer.resource.phone) {
          const phoneLink = document.createElement('a');
          phoneLink.href = 'tel:' + quickAnswer.resource.phone.replace(/[^0-9]/g, '');
          phoneLink.className = 'quick-answer-phone';
          phoneLink.textContent =
            quickAnswer.resource.action || 'Call ' + quickAnswer.resource.phone;
          resource.appendChild(phoneLink);
        }

        card.appendChild(resource);
      }

      if (quickAnswer.secondary) {
        const secondary = document.createElement('div');
        secondary.className = 'quick-answer-secondary';
        secondary.textContent = quickAnswer.secondary.name + ': ' + quickAnswer.secondary.action;
        card.appendChild(secondary);
      }

      // Announce to screen readers immediately
      announceToScreenReader(quickAnswer.title + '. ' + (quickAnswer.resource?.action || ''), true);
    } else if (quickAnswer.type === 'clarify') {
      card.classList.add('quick-answer-clarify');

      const message = document.createElement('p');
      message.className = 'quick-answer-message';
      message.textContent = quickAnswer.message || 'What kind of help are you looking for?';
      card.appendChild(message);

      if (quickAnswer.categories && quickAnswer.categories.length > 0) {
        const buttons = document.createElement('div');
        buttons.className = 'quick-answer-categories';
        buttons.setAttribute('role', 'group');
        buttons.setAttribute('aria-label', 'Category options');

        quickAnswer.categories.forEach((cat) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'quick-answer-category-btn';
          btn.setAttribute('data-search', cat.search || cat.label);

          // Create icon span
          const iconSpan = document.createElement('span');
          iconSpan.className = 'quick-answer-category-icon';
          iconSpan.setAttribute('aria-hidden', 'true');
          iconSpan.textContent = cat.icon || '';
          btn.appendChild(iconSpan);

          // Create label span
          const labelSpan = document.createElement('span');
          labelSpan.textContent = cat.label;
          btn.appendChild(labelSpan);

          // Handle click - perform search with category
          btn.addEventListener('click', () => {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
              (searchInput as HTMLInputElement).value = cat.search || cat.label;
              searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
            hideQuickAnswer();
          });

          buttons.appendChild(btn);
        });

        card.appendChild(buttons);
      }

      announceToScreenReader(quickAnswer.message);
    } else if (
      quickAnswer.type === 'guide' ||
      quickAnswer.type === 'program' ||
      quickAnswer.type === 'eligibility' ||
      quickAnswer.type === 'category_search' ||
      quickAnswer.type === 'guide_with_contact'
    ) {
      card.classList.add('quick-answer-guide');

      if (quickAnswer.title) {
        const title = document.createElement('h3');
        title.className = 'quick-answer-title';
        title.textContent = quickAnswer.title;
        card.appendChild(title);
      }

      if (quickAnswer.summary) {
        const summary = document.createElement('p');
        summary.className = 'quick-answer-summary';
        summary.textContent = quickAnswer.summary;
        card.appendChild(summary);
      }

      // County contact if available
      if (quickAnswer.countyContact) {
        const contact = document.createElement('div');
        contact.className = 'quick-answer-contact';

        const agency = document.createElement('div');
        agency.className = 'quick-answer-agency';
        agency.textContent = quickAnswer.countyContact.agency;
        contact.appendChild(agency);

        const phoneLink = document.createElement('a');
        phoneLink.href = 'tel:' + quickAnswer.countyContact.phone.replace(/[^0-9]/g, '');
        phoneLink.className = 'quick-answer-phone';
        phoneLink.textContent = 'Call ' + quickAnswer.countyContact.phone;
        contact.appendChild(phoneLink);

        card.appendChild(contact);
      }

      // Guide link
      if (quickAnswer.guideUrl) {
        const guideLink = document.createElement('a');
        guideLink.href = quickAnswer.guideUrl;
        guideLink.className = 'quick-answer-link';
        guideLink.textContent = quickAnswer.guideText || 'See eligibility guide';
        card.appendChild(guideLink);
      }

      // Apply link
      if (quickAnswer.applyUrl) {
        const applyLink = document.createElement('a');
        applyLink.href = quickAnswer.applyUrl;
        applyLink.className = 'quick-answer-apply-link';
        applyLink.target = '_blank';
        applyLink.rel = 'noopener noreferrer';
        applyLink.textContent = quickAnswer.applyText || 'Apply online';
        card.appendChild(applyLink);
      }

      announceToScreenReader('Quick answer: ' + (quickAnswer.title || quickAnswer.summary || ''));
    }

    // Add dismiss button for non-crisis cards
    if (quickAnswer.type !== 'crisis') {
      const dismissBtn = document.createElement('button');
      dismissBtn.type = 'button';
      dismissBtn.className = 'quick-answer-dismiss';
      dismissBtn.setAttribute('aria-label', 'Dismiss quick answer');
      dismissBtn.textContent = '√ó';
      dismissBtn.addEventListener('click', hideQuickAnswer);
      card.appendChild(dismissBtn);
    }

    quickAnswerContainer.appendChild(card);
  }

  function hideQuickAnswer() {
    if (quickAnswerContainer) {
      quickAnswerContainer.classList.add('hidden');
      while (quickAnswerContainer.firstChild) {
        quickAnswerContainer.removeChild(quickAnswerContainer.firstChild);
      }
    }
  }

  // Smart Search Suggestion functions
  const smartSuggestionEl = document.getElementById('smart-search-suggestion');
  const smartSuggestionTitle = document.getElementById('smart-suggestion-title');
  const smartSuggestionMessage = document.getElementById('smart-suggestion-message');
  const enableSmartSearchBtn = document.getElementById('enable-smart-search-btn');
  const dismissSmartSuggestionBtn = document.getElementById('dismiss-smart-suggestion-btn');
  const closeSmartSuggestionBtn = document.getElementById('close-smart-suggestion-btn');
  let smartSuggestionDismissed = sessionStorage.getItem('smartSuggestionDismissed') === 'true';

  function showSmartSearchSuggestion(query: string) {
    if (!smartSuggestionEl || smartSuggestionDismissed || aiEnabled || isOffline) return;

    // Customize message based on query
    if (smartSuggestionTitle && smartSuggestionMessage) {
      // Detect what type of help they might need
      const lowerQuery = query.toLowerCase();

      if (/\b(need|looking for|help|find)\b.*\b(food|hungry|eat)\b/i.test(lowerQuery)) {
        smartSuggestionTitle.textContent = 'Looking for food assistance?';
        smartSuggestionMessage.textContent =
          'Smart Search can help find food banks, CalFresh enrollment, and meal programs near you.';
      } else if (
        /\b(need|looking for|help)\b.*\b(housing|rent|shelter|homeless)\b/i.test(lowerQuery)
      ) {
        smartSuggestionTitle.textContent = 'Need housing help?';
        smartSuggestionMessage.textContent =
          'Smart Search can find rental assistance, shelters, and housing programs in your area.';
      } else if (
        /\b(need|looking for|help)\b.*\b(job|work|employment|unemployed)\b/i.test(lowerQuery)
      ) {
        smartSuggestionTitle.textContent = 'Looking for employment help?';
        smartSuggestionMessage.textContent =
          'Smart Search can find job training, career centers, and employment programs for you.';
      } else if (
        /\b(need|looking for|help)\b.*\b(health|doctor|medical|clinic)\b/i.test(lowerQuery)
      ) {
        smartSuggestionTitle.textContent = 'Need healthcare assistance?';
        smartSuggestionMessage.textContent =
          'Smart Search can find free clinics, Medi-Cal enrollment, and health services near you.';
      } else if (/\b(i'm|i am|my|we)\b/i.test(lowerQuery) || query.split(/\s+/).length >= 5) {
        smartSuggestionTitle.textContent = 'Let us help you find the right programs';
        smartSuggestionMessage.textContent =
          'Smart Search understands your situation and can match you with relevant resources.';
      } else {
        smartSuggestionTitle.textContent = 'Need help finding specific resources?';
        smartSuggestionMessage.textContent =
          'Turn on Smart Search to help find programs that match your needs.';
      }
    }

    smartSuggestionEl.classList.remove('hidden');
    announceToScreenReader('Smart Search suggestion available. Enable for better results.');
  }

  function hideSmartSearchSuggestion() {
    smartSuggestionEl?.classList.add('hidden');
  }

  // Handle Enable Smart Search button click
  enableSmartSearchBtn?.addEventListener('click', () => {
    aiEnabled = true;
    localStorage.setItem('aiSearchEnabled', 'true');
    updateToggleState();
    hideSmartSearchSuggestion();

    // Start the chat conversation with the current query
    if (searchInput?.value) {
      startSmartChatConversation(searchInput.value);
      // Perform the AI search which will populate the chat
      performAISearch(searchInput.value);
    }
  });

  // Handle dismiss buttons
  dismissSmartSuggestionBtn?.addEventListener('click', () => {
    smartSuggestionDismissed = true;
    sessionStorage.setItem('smartSuggestionDismissed', 'true');
    hideSmartSearchSuggestion();
  });

  closeSmartSuggestionBtn?.addEventListener('click', () => {
    hideSmartSearchSuggestion();
  });

  // Check if query should trigger smart search suggestion
  function shouldSuggestSmartSearch(query: string): boolean {
    if (!query || aiEnabled || isOffline || smartSuggestionDismissed) return false;

    const trimmed = query.trim().toLowerCase();

    // Patterns that suggest the user might benefit from AI search
    const benefitPatterns = [
      /\b(i'm|i am|my|we|our)\b/i, // First person
      /\b(need|looking for|help with|want|trying to find)\b/i, // Intent words
      /\b(senior|elderly|disabled|veteran|family|child|low.?income|immigrant|homeless)\b/i, // Demographics
      /\b(how|where|what|can i|do i)\b/i, // Questions
    ];

    const matchCount = benefitPatterns.filter((p) => p.test(trimmed)).length;
    const isLongQuery = query.split(/\s+/).length >= 4;

    // Show suggestion if multiple patterns match or it's a long natural language query
    return matchCount >= 1 || isLongQuery;
  }

  // ==========================================
  // Smart Search Chat Interface
  // ==========================================
  const smartChatContainer = document.getElementById('smart-chat-container');
  const smartChatMessages = document.getElementById('smart-chat-messages');
  const smartChatInputArea = document.getElementById('smart-chat-input-area');
  const smartChatInput = document.getElementById('smart-chat-input') as HTMLInputElement;
  const smartChatSendBtn = document.getElementById('smart-chat-send-btn');
  const smartChatActions = document.getElementById('smart-chat-actions');
  const smartChatActionButtons = document.getElementById('smart-chat-action-buttons');
  const closeSmartChatBtn = document.getElementById('close-smart-chat-btn');

  // Chat conversation history
  let chatHistory: Array<{ role: 'user' | 'assistant'; content: string }> = [];

  function showSmartChat() {
    smartChatContainer?.classList.remove('hidden');
    hideSmartSearchSuggestion();
  }

  function hideSmartChat() {
    smartChatContainer?.classList.add('hidden');
    clearChatMessages();
    chatHistory = [];
  }

  function clearChatMessages() {
    if (smartChatMessages) {
      while (smartChatMessages.firstChild) {
        smartChatMessages.removeChild(smartChatMessages.firstChild);
      }
    }
    smartChatInputArea?.classList.add('hidden');
    smartChatActions?.classList.add('hidden');
  }

  function addChatMessage(role: 'user' | 'assistant', content: string, isTyping = false) {
    if (!smartChatMessages) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');
    bubble.className =
      role === 'user'
        ? 'max-w-[85%] px-3 py-2 rounded-lg bg-primary-600 text-white text-sm'
        : 'max-w-[85%] px-3 py-2 rounded-lg bg-neutral-100 dark:bg-neutral-700 text-neutral-900 dark:text-white text-sm';

    if (isTyping) {
      bubble.innerHTML =
        '<span class="typing-indicator"><span></span><span></span><span></span></span>';
      bubble.classList.add('typing-bubble');
    } else {
      bubble.textContent = content;
    }

    messageDiv.appendChild(bubble);
    smartChatMessages.appendChild(messageDiv);

    // Scroll to bottom
    smartChatMessages.scrollTop = smartChatMessages.scrollHeight;

    return messageDiv;
  }

  function removeTypingIndicator() {
    const typingBubble = smartChatMessages?.querySelector('.typing-bubble');
    typingBubble?.parentElement?.remove();
  }

  function showChatActionButtons(buttons: Array<{ label: string; value: string; icon?: string }>) {
    if (!smartChatActionButtons || !smartChatActions) return;

    // Clear existing buttons
    while (smartChatActionButtons.firstChild) {
      smartChatActionButtons.removeChild(smartChatActionButtons.firstChild);
    }

    buttons.forEach((btn) => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className =
        'px-3 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-200 hover:bg-neutral-50 dark:hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors';

      if (btn.icon) {
        button.innerHTML = `<span class="mr-1">${btn.icon}</span>${btn.label}`;
      } else {
        button.textContent = btn.label;
      }

      button.addEventListener('click', () => {
        handleChatAction(btn.value, btn.label);
      });

      smartChatActionButtons.appendChild(button);
    });

    smartChatActions.classList.remove('hidden');
  }

  function hideChatActionButtons() {
    smartChatActions?.classList.add('hidden');
  }

  function showChatInput() {
    smartChatInputArea?.classList.remove('hidden');
    smartChatInput?.focus();
  }

  async function handleChatAction(value: string, label: string) {
    // Add user's selection as a message
    addChatMessage('user', label);
    chatHistory.push({ role: 'user', content: label });
    hideChatActionButtons();

    // If it's a location, save it and continue search
    if (value.startsWith('location:')) {
      const location = value.replace('location:', '');
      localStorage.setItem('userLocation', location);

      // Try to determine county
      const cityLower = location.toLowerCase();
      const county = CITY_TO_COUNTY[cityLower];
      if (county) {
        localStorage.setItem('userCounty', county);
      }

      // Show typing indicator
      addChatMessage('assistant', '', true);

      // Re-run search with location
      setTimeout(() => {
        removeTypingIndicator();
        addChatMessage('assistant', `Got it! Searching for programs in ${location}...`);
        chatHistory.push({
          role: 'assistant',
          content: `Searching for programs in ${location}...`,
        });

        // Perform the search
        if (searchInput?.value) {
          performAISearch(searchInput.value);
        }
      }, 500);
    } else if (value.startsWith('search:')) {
      // It's a category search
      const searchQuery = value.replace('search:', '');
      if (searchInput) {
        (searchInput as HTMLInputElement).value = searchQuery;
      }

      // Show typing indicator
      addChatMessage('assistant', '', true);

      setTimeout(() => {
        removeTypingIndicator();
        performAISearch(searchQuery);
      }, 300);
    } else {
      // Generic action - pass to AI
      addChatMessage('assistant', '', true);
      await sendChatMessage(value);
    }
  }

  async function sendChatMessage(message: string) {
    if (!message.trim()) return;

    // Check if we've reached the message limit
    if (isChatLimitReached()) {
      removeTypingIndicator();
      showChatLimitMessage();
      return;
    }

    // Get user location for context
    const userLocation = localStorage.getItem('userLocation') || '';
    const userCounty = localStorage.getItem('userCounty') || '';

    try {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: message,
          history: chatHistory.slice(-6), // Keep last 6 messages for context
          mode: 'conversation', // Conversational mode for follow-ups
          location: userLocation,
          county: userCounty,
        }),
      });

      if (!response.ok) throw new Error('Chat failed');

      const data = await response.json();
      removeTypingIndicator();

      // Handle the response
      if (data.quickAnswer) {
        handleQuickAnswerInChat(data.quickAnswer);
      } else if (data.message) {
        addChatMessage('assistant', data.message);
        chatHistory.push({ role: 'assistant', content: data.message });

        // If programs found, update the results
        if (data.programs && data.programs.length > 0) {
          filterProgramsByAIResults(data.programs);
        }
      }

      // Check message limit before showing input
      if (isChatLimitReached()) {
        showChatLimitMessage();
      } else {
        showChatInput();
      }
    } catch (error) {
      console.error('Chat error:', error);
      removeTypingIndicator();
      addChatMessage(
        'assistant',
        'Sorry, I had trouble understanding that. Try rephrasing your question.'
      );

      // Still check limit
      if (!isChatLimitReached()) {
        showChatInput();
      }
    }
  }

  function handleQuickAnswerInChat(quickAnswer: any) {
    if (quickAnswer.type === 'clarify' && quickAnswer.categories) {
      // Show clarifying question with action buttons
      addChatMessage('assistant', quickAnswer.message || 'What kind of help are you looking for?');
      chatHistory.push({
        role: 'assistant',
        content: quickAnswer.message || 'What kind of help are you looking for?',
      });

      const buttons = quickAnswer.categories.map((cat: any) => ({
        label: `${cat.icon || ''} ${cat.label}`.trim(),
        value: `search:${cat.search || cat.label}`,
        icon: cat.icon,
      }));
      showChatActionButtons(buttons);
    } else if (quickAnswer.type === 'category_search') {
      // Show category-specific response
      const message = quickAnswer.title
        ? `I can help you find ${quickAnswer.title.toLowerCase()}. ${quickAnswer.summary || ''}`
        : quickAnswer.summary || 'Here are some resources that might help.';
      addChatMessage('assistant', message);
      chatHistory.push({ role: 'assistant', content: message });

      // Ask for location if not set
      const userLocation = localStorage.getItem('userLocation');
      if (!userLocation) {
        setTimeout(() => {
          addChatMessage(
            'assistant',
            'To show you the most relevant programs, what city or ZIP code are you in?'
          );
          chatHistory.push({ role: 'assistant', content: 'What city or ZIP code are you in?' });
          showLocationButtons();
        }, 800);
      } else {
        // Perform the search
        if (quickAnswer.search) {
          performAISearch(quickAnswer.search);
        }
        showChatInput();
      }
    } else {
      // Other quick answer types - show as message
      const message =
        quickAnswer.summary || quickAnswer.title || 'Here are some resources that might help.';
      addChatMessage('assistant', message);
      chatHistory.push({ role: 'assistant', content: message });
      showChatInput();
    }
  }

  function showLocationButtons() {
    // Common Bay Area cities
    const cities = [
      { label: 'San Francisco', value: 'location:San Francisco' },
      { label: 'Oakland', value: 'location:Oakland' },
      { label: 'San Jose', value: 'location:San Jose' },
      { label: 'Other...', value: 'location:other' },
    ];
    showChatActionButtons(cities);

    // Also show text input for custom location
    showChatInput();
    if (smartChatInput) {
      smartChatInput.placeholder = 'Or type your city/ZIP...';
    }
  }

  function filterProgramsByAIResults(matchedPrograms: any[]) {
    const matchedIds = new Set(
      matchedPrograms.map((p) => (p.id || p.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-'))
    );

    let visibleCount = 0;

    if (isHomepage) {
      homeResultsSection?.classList.remove('hidden');
      programs.forEach((p) => {
        const matchesAI = matchedIds.size === 0 || matchedIds.has(p.id);
        if (p.wrapper) {
          if (matchesAI) {
            p.wrapper.classList.remove('hidden');
            visibleCount++;
          } else {
            p.wrapper.classList.add('hidden');
          }
        }
      });
      if (homeResultsCount) {
        homeResultsCount.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found`;
      }
    } else {
      programs.forEach((p) => {
        const matchesAI = matchedIds.size === 0 || matchedIds.has(p.id);
        const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
        const shouldShow = matchesAI && matchesCategory;
        p.element.style.display = shouldShow ? '' : 'none';
        if (shouldShow) visibleCount++;
      });
      updateResultsCount(visibleCount, searchInput?.value || '', true);
    }
  }

  // Handle close chat button
  closeSmartChatBtn?.addEventListener('click', () => {
    hideSmartChat();
    // Turn off AI
    aiEnabled = false;
    localStorage.setItem('aiSearchEnabled', 'false');
    updateToggleState();
  });

  // Handle chat input
  smartChatSendBtn?.addEventListener('click', () => {
    const message = smartChatInput?.value.trim();
    if (message) {
      addChatMessage('user', message);
      chatHistory.push({ role: 'user', content: message });
      smartChatInput.value = '';

      // Check if it looks like a location
      const zipMatch = message.match(/^\d{5}$/);
      const cityMatch = CITY_TO_COUNTY[message.toLowerCase()];

      if (zipMatch || cityMatch) {
        handleChatAction(`location:${message}`, message);
      } else {
        addChatMessage('assistant', '', true);
        sendChatMessage(message);
      }
    }
  });

  smartChatInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      smartChatSendBtn?.click();
    }
  });

  // Message limit for chat conversations (to prevent excessive AI usage)
  const MAX_CHAT_MESSAGES = 6; // 3 exchanges (user + assistant)

  // Start a smart chat conversation
  function startSmartChatConversation(query: string) {
    showSmartChat();
    clearChatMessages();
    chatHistory = [];

    // Add user's query
    addChatMessage('user', query);
    chatHistory.push({ role: 'user', content: query });

    // Show typing indicator
    addChatMessage('assistant', '', true);
  }

  // Check if chat has reached message limit
  function isChatLimitReached(): boolean {
    return chatHistory.length >= MAX_CHAT_MESSAGES;
  }

  // Show final results message when limit is reached
  function showChatLimitMessage() {
    addChatMessage(
      'assistant',
      "I've gathered enough information to help. Here are the programs I found based on our conversation. You can browse the results below or start a new search."
    );
    chatHistory.push({
      role: 'assistant',
      content: 'Here are the programs based on our conversation.',
    });
    hideChatActionButtons();
    smartChatInputArea?.classList.add('hidden');
  }

  async function performAISearch(query) {
    if (isAISearching || query === lastAIQuery) return;

    isAISearching = true;
    lastAIQuery = query;
    showLoading(true);
    hideSmartSearchSuggestion(); // Hide suggestion when AI is active

    // Show the chat interface for AI searches
    if (!smartChatContainer?.classList.contains('hidden') === false) {
      startSmartChatConversation(query);
    }

    // Get user location for location-aware quick answers
    const userLocation = localStorage.getItem('userLocation') || '';
    const userCounty = localStorage.getItem('userCounty') || '';

    try {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: query, // Send raw query - backend handles pattern matching
          history: chatHistory.slice(-6),
          mode: 'filter', // Tell the API we just want filtering, not conversation
          location: userLocation,
          county: userCounty,
        }),
      });

      if (!response.ok) throw new Error('AI search failed');

      const data = await response.json();

      // Remove typing indicator if chat is showing
      if (!smartChatContainer?.classList.contains('hidden')) {
        removeTypingIndicator();
      }

      // Check for quick answer first (Tier 1 - cached responses)
      if (data.quickAnswer) {
        // Show in chat interface if it's open
        if (!smartChatContainer?.classList.contains('hidden')) {
          handleQuickAnswerInChat(data.quickAnswer);

          // Check message limit
          if (isChatLimitReached()) {
            showChatLimitMessage();
          }

          // For crisis or clarify, stop here
          if (data.quickAnswer.type === 'crisis' || data.quickAnswer.type === 'clarify') {
            showLoading(false);
            isAISearching = false;
            return;
          }
        } else {
          // Show traditional quick answer card
          showQuickAnswer(data.quickAnswer);
          // For crisis responses, stop here - don't show regular results
          if (data.quickAnswer.type === 'crisis') {
            showLoading(false);
            isAISearching = false;
            return;
          }
          // For clarify responses, wait for user selection
          if (data.quickAnswer.type === 'clarify') {
            showLoading(false);
            isAISearching = false;
            return;
          }
        }
      } else {
        hideQuickAnswer();

        // Add response message to chat if open
        if (!smartChatContainer?.classList.contains('hidden') && data.message) {
          addChatMessage('assistant', data.message);
          chatHistory.push({ role: 'assistant', content: data.message });

          // Check message limit
          if (isChatLimitReached()) {
            showChatLimitMessage();
          } else {
            showChatInput();
          }
        }
      }

      // Extract program IDs/names from AI response
      const matchedPrograms = data.programs || [];
      const matchedIds = new Set(
        matchedPrograms.map((p) => (p.id || p.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-'))
      );

      // Also extract any program names mentioned in the message
      const messageText = data.message || '';
      programs.forEach((p) => {
        if (messageText.toLowerCase().includes(p.name.toLowerCase())) {
          matchedIds.add(p.id);
        }
      });

      // Filter cards based on AI results
      let visibleCount = 0;

      if (isHomepage) {
        // Homepage: show results section and filter cards
        homeResultsSection?.classList.remove('hidden');

        programs.forEach((p) => {
          const matchesAI = matchedIds.size === 0 || matchedIds.has(p.id);
          if (p.wrapper) {
            if (matchesAI) {
              p.wrapper.classList.remove('hidden');
              visibleCount++;
            } else {
              p.wrapper.classList.add('hidden');
            }
          }
        });

        // Update count
        if (homeResultsCount) {
          homeResultsCount.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found`;
        }
        if (visibleCount === 0) {
          noResultsEl?.classList.remove('hidden');
        } else {
          noResultsEl?.classList.add('hidden');
        }
      } else {
        // Directory page
        programs.forEach((p) => {
          const matchesAI = matchedIds.size === 0 || matchedIds.has(p.id);
          const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
          const shouldShow = matchesAI && matchesCategory;

          p.element.style.display = shouldShow ? '' : 'none';
          if (shouldShow) visibleCount++;
        });
      }

      // If AI returned programs, show them; otherwise fall back to fuzzy search
      if (matchedIds.size > 0 && visibleCount > 0) {
        showAIIndicator(`AI found ${visibleCount}`);
        announceToScreenReader(
          `AI search found ${visibleCount} program${visibleCount !== 1 ? 's' : ''} for "${query}"`
        );
        if (!isHomepage) {
          updateResultsCount(visibleCount, query, true);
        }
      } else {
        // Fall back to fuzzy search
        hideAIIndicator();
        performFuzzySearch(query);
      }
    } catch (error) {
      console.error('AI search error:', error);
      // Fall back to fuzzy search on error
      hideAIIndicator();
      performFuzzySearch(query);
    } finally {
      isAISearching = false;
      showLoading(false);
    }
  }

  function performFuzzySearch(query) {
    // Check if we should suggest Smart Search for this query
    if (shouldSuggestSmartSearch(query)) {
      showSmartSearchSuggestion(query);
    } else {
      hideSmartSearchSuggestion();
    }

    if (isHomepage) {
      // Homepage: show/hide search results section
      if (!query) {
        // No query - hide results section
        homeResultsSection?.classList.add('hidden');
        programs.forEach((p) => {
          if (p.wrapper) p.wrapper.classList.add('hidden');
        });
        noResultsEl?.classList.add('hidden');
        hideSmartSearchSuggestion();
        return;
      }

      // Show results section
      homeResultsSection?.classList.remove('hidden');

      // Apply search enhancements
      const rewrittenQuery = rewriteQuery(query);
      const expandedTerms = expandWithSynonyms(rewrittenQuery);
      const bestBetIds = new Set(getBestBets(query));

      // Fuzzy search with Fuse.js - search for all expanded terms
      const allResults = new Map();
      for (const term of expandedTerms) {
        const results = fuse.search(term);
        results.forEach((r) => {
          const existing = allResults.get(r.item.index);
          if (!existing || r.score < existing.score) {
            allResults.set(r.item.index, r);
          }
        });
      }
      const matchedIndices = new Set(allResults.keys());

      let visibleCount = 0;
      const bestBetPrograms: typeof programs = [];
      const regularPrograms: typeof programs = [];

      programs.forEach((p) => {
        const matchesSearch = matchedIndices.has(p.index);
        const isBestBet = bestBetIds.has(p.id);

        if (matchesSearch || isBestBet) {
          if (isBestBet) {
            bestBetPrograms.push(p);
          } else {
            regularPrograms.push(p);
          }
          if (p.wrapper) {
            p.wrapper.classList.remove('hidden');
            // Mark best bets for styling
            if (isBestBet) {
              p.wrapper.classList.add('best-bet');
            } else {
              p.wrapper.classList.remove('best-bet');
            }
            visibleCount++;
          }
        } else {
          if (p.wrapper) {
            p.wrapper.classList.add('hidden');
            p.wrapper.classList.remove('best-bet');
          }
        }
      });

      // Update count and show/hide no results
      if (homeResultsCount) {
        homeResultsCount.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found`;
      }
      if (visibleCount === 0) {
        noResultsEl?.classList.remove('hidden');
        announceToScreenReader(`No programs found for "${query}". Try different search terms.`);
      } else {
        noResultsEl?.classList.add('hidden');
        announceToScreenReader(
          `Found ${visibleCount} program${visibleCount !== 1 ? 's' : ''} for "${query}"`
        );
      }
    } else {
      // Directory page: original behavior with enhancements
      if (!query) {
        // No search query - show all (respect category filter)
        programs.forEach((p) => {
          const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
          // Also respect location filter if active
          const locationHidden = p.element.hasAttribute('data-location-hidden');
          p.element.style.display = matchesCategory && !locationHidden ? '' : 'none';
          p.element.classList.remove('best-bet');
        });
        hideAIIndicator();
      } else {
        // Apply search enhancements
        const rewrittenQuery = rewriteQuery(query);
        const expandedTerms = expandWithSynonyms(rewrittenQuery);
        const bestBetIds = new Set(getBestBets(query));

        // Fuzzy search with Fuse.js - search for all expanded terms
        const allResults = new Map();
        for (const term of expandedTerms) {
          const results = fuse.search(term);
          results.forEach((r) => {
            const existing = allResults.get(r.item.index);
            if (!existing || r.score < existing.score) {
              allResults.set(r.item.index, r);
            }
          });
        }
        const matchedIndices = new Set(allResults.keys());

        programs.forEach((p) => {
          const matchesSearch = matchedIndices.has(p.index);
          const isBestBet = bestBetIds.has(p.id);
          const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
          const locationHidden = p.element.hasAttribute('data-location-hidden');
          const shouldShow = (matchesSearch || isBestBet) && matchesCategory && !locationHidden;

          p.element.style.display = shouldShow ? '' : 'none';

          // Mark best bets for styling
          if (isBestBet && shouldShow) {
            p.element.classList.add('best-bet');
          } else {
            p.element.classList.remove('best-bet');
          }
        });
      }

      // Update count
      const visibleCount = document.querySelectorAll(
        '[data-category]:not([style*="display: none"])'
      ).length;
      updateResultsCount(visibleCount, query, false);

      // Announce results to screen readers
      if (query) {
        if (visibleCount === 0) {
          announceToScreenReader(`No programs found for "${query}". Try different search terms.`);
        } else {
          announceToScreenReader(
            `Found ${visibleCount} program${visibleCount !== 1 ? 's' : ''} for "${query}"`
          );
        }
      }

      // Check if refinement bar should be shown
      checkAndShowRefinement(query, visibleCount);
    }
  }

  function updateResultsCount(count, query, isAI) {
    const counter = document.getElementById('results-count');
    if (counter) {
      const queryInfo = query ? ` for "${query}"` : '';
      const aiInfo = isAI ? ' (AI-powered)' : '';
      counter.textContent = `${count} program${count !== 1 ? 's' : ''} found${queryInfo}${aiInfo}`;
    }
  }

  // Crisis detection - show appropriate help resources
  // Only triggers on ACTIVE DANGER keywords, not general help-seeking queries
  function checkForCrisis(query) {
    const lowerQuery = query.toLowerCase();

    // Context words that indicate clearly academic/professional queries
    // where the crisis banner would be noise rather than helpful
    // Since our search shows program cards + banner (additive), we're generous
    // with showing the banner - it has a close button if not needed
    const academicProfessionalContext = [
      'statistics',
      'stats',
      'data about',
      'research on',
      'study on',
      'legislation',
      'policy',
      'policies',
      'donate to',
      'donation to',
      'volunteer at',
      'volunteering at',
      'definition of',
      'define ',
      'meaning of',
      'history of',
      'causes of',
      'write about',
      'essay on',
      'paper on',
      'jobs in',
      'career in',
      'work in',
      'degree in',
      'major in',
    ];

    // Only skip banner for clearly academic/professional queries
    for (const contextWord of academicProfessionalContext) {
      if (lowerQuery.includes(contextWord)) {
        return null;
      }
    }

    // For everything else, we show the banner if keywords match because:
    // 1. Banner is additive (doesn't replace search results)
    // 2. User can close it if not relevant
    // 3. Better to show help to someone who needs it than miss someone in crisis

    // Emergency keywords (911) - ONLY active danger situations
    // These indicate someone is in immediate physical danger right now
    const emergencyKeywords = [
      // Urgent help requests
      'need immediate help',
      'urgent help',
      'emergency help',
      'call 911',
      'call the police',
      'call an ambulance',
      'life threatening',
      'life-threatening',
      'in danger',
      'help me now',
      'need help now',
      'please help',
      // Active violence
      'being attacked',
      'attacking me',
      'someone is attacking',
      'being stabbed',
      'stabbing me',
      'knife attack',
      'with a knife',
      'being shot',
      'shooting at',
      'has a gun',
      'with a gun',
      'being beaten',
      'beating me',
      'hitting me',
      'hurting me',
      'someone is hurting',
      'abusing me',
      'being abused',
      // Domestic violence / abuse
      'domestic violence',
      'partner is hitting',
      'spouse is hitting',
      'husband is hitting',
      'wife is hitting',
      'boyfriend is hitting',
      'being raped',
      'sexual assault',
      'being assaulted',
      // Child/elder emergencies
      'child is hurt',
      'baby not breathing',
      'child not breathing',
      'child abuse',
      'elder abuse',
      'abusing my child',
      'hurting my child',
      // Life-threatening medical
      'cant breathe',
      "can't breathe",
      'not breathing',
      'stopped breathing',
      'choking',
      'having a heart attack',
      'having a stroke',
      'having a seizure',
      'severe bleeding',
      'wont stop bleeding',
      "won't stop bleeding",
      'unconscious',
      'passed out',
      'not waking up',
      'unresponsive',
      'allergic reaction',
      'anaphylaxis',
      'swelling up',
      'overdosing',
      'took too many pills',
      'drug overdose',
      // Active emergencies
      'house on fire',
      'building on fire',
      'theres a fire',
      "there's a fire",
      'apartment on fire',
      'smoke everywhere',
      'car accident',
      'bad accident',
      'someone is drowning',
      'fell in water',
      'trapped',
      'being kidnapped',
      'being held hostage',
      'taken hostage',
      'someone broke in',
      'intruder',
      'break in',
      'burglar',
      'robber',
      'being robbed',
      'mugged',
      'being mugged',
      // Imminent threats
      'threatening to kill',
      'going to kill',
      'wants to kill',
      'has a weapon',
      'threatening me',
      'stalking me',
      'following me',
      // Bystander/witness scenarios
      'i think i see',
      'i see someone',
      'someone is being',
      'witness domestic',
      'witnessing abuse',
      'witnessing violence',
      'neighbor is being',
      'hear screaming',
      'hearing screams',
      'sounds like fighting',
      'sounds like abuse',
      'suspicious person',
      'someone suspicious',
      'man with a gun',
      'woman with a gun',
      'person with a gun',
      'man with a knife',
      'woman with a knife',
      'person with a knife',
      'saw someone get',
      'just saw someone',
      'think someone is hurt',
      'someone might be hurt',
      'child left alone',
      'child in car',
      'baby in car',
      'report abuse',
      'report violence',
      'how to report',
    ];

    // Mental health crisis keywords (988)
    // 988 Suicide & Crisis Lifeline - for emotional distress, not just suicidal thoughts
    const mentalHealthKeywords = [
      // Suicidal ideation
      'suicide',
      'suicidal',
      'kill myself',
      'end my life',
      'want to die',
      'dont want to live',
      "don't want to live",
      'no reason to live',
      'better off dead',
      'wish i was dead',
      'wish i were dead',
      'thinking about suicide',
      'considering suicide',
      'planning suicide',
      'suicidal thoughts',
      'thoughts of suicide',
      'ending it all',
      'take my own life',
      'taking my own life',
      // Self-harm
      'self harm',
      'self-harm',
      'cutting myself',
      'hurt myself',
      'harming myself',
      'hurting myself',
      'want to cut',
      'started cutting',
      'burning myself',
      'hitting myself',
      // Depression / hopelessness
      'severely depressed',
      'deep depression',
      'hopeless',
      'no hope',
      'feel empty',
      'feeling empty',
      'worthless',
      'feel worthless',
      'nobody cares',
      'no one cares',
      'nobody loves me',
      'no one loves me',
      'world without me',
      'everyone hates me',
      // Crisis / breakdown
      'mental health crisis',
      'mental breakdown',
      'breaking down',
      'emotional crisis',
      'in crisis',
      'having a crisis',
      'cant go on',
      "can't go on",
      'give up',
      'giving up',
      'cant take it',
      "can't take it",
      'cant handle',
      "can't handle",
      'falling apart',
      'losing my mind',
      'going crazy',
      // Overdose intent
      'overdose myself',
      'take all my pills',
      'take too many pills',
      'swallow all my',
      'drink myself to death',
      // Anxiety / panic
      'panic attack',
      'having a panic attack',
      'severe anxiety',
      'cant stop crying',
      "can't stop crying",
      'crying for hours',
      // Bystander concerns for others
      'friend is suicidal',
      'worried about friend',
      'think my friend',
      'someone i know',
      'family member suicidal',
      'child is suicidal',
      'teen is suicidal',
      'worried someone will',
      'talking about suicide',
      'said they want to die',
      'threatening suicide',
      // Grief / trauma
      'lost someone to suicide',
      'someone died by suicide',
      'survivor of suicide',
      'grief overwhelmed',
      // Veterans specific (988 press 1)
      'veteran crisis',
      'veteran suicide',
      'military suicide',
      'ptsd crisis',
      'combat trauma',
      // LGBTQ+ specific (988 available)
      'lgbtq crisis',
      'coming out crisis',
      'rejected by family',
      'gender identity crisis',
      'trans crisis',
    ];

    for (const keyword of emergencyKeywords) {
      if (lowerQuery.includes(keyword)) {
        return 'emergency';
      }
    }

    for (const keyword of mentalHealthKeywords) {
      if (lowerQuery.includes(keyword)) {
        return 'mental-health';
      }
    }

    return null;
  }

  function showCrisisBanner(type) {
    // Remove existing banner if any
    const existingBanner = document.getElementById('crisis-banner');
    if (existingBanner) existingBanner.remove();

    const isEmergency = type === 'emergency';

    const banner = document.createElement('div');
    banner.id = 'crisis-banner';
    banner.className = `crisis-banner ${isEmergency ? 'emergency' : 'mental-health'}`;
    banner.innerHTML = `
      <div class="crisis-banner-content">
        ${
          isEmergency
            ? `
          <div class="crisis-banner-box">
            <div class="crisis-banner-icon">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div class="crisis-banner-text">
              <strong>Need immediate help?</strong>
              <span>If you or someone is in danger, call emergency services.</span>
            </div>
          </div>
          <a href="tel:911" class="crisis-banner-btn emergency">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            Call 911
          </a>
        `
            : `
          <div class="crisis-banner-box">
            <div class="crisis-banner-icon">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
            </div>
            <div class="crisis-banner-text">
              <strong>You're not alone.</strong>
              <span>Free, confidential 24/7 support. Veterans press 1, Spanish press 2.</span>
            </div>
          </div>
          <div class="crisis-banner-actions">
            <a href="tel:988" class="crisis-banner-btn mental-health">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              Call/Text 988
            </a>
            <a href="https://988lifeline.org/chat/" target="_blank" rel="noopener" class="crisis-banner-btn-secondary">
              Chat Online
            </a>
          </div>
        `
        }
        <button class="crisis-banner-close" aria-label="Dismiss">&times;</button>
      </div>
    `;

    // Insert directly inside the search container, after the input
    const searchContainer = document.querySelector('.search-container');
    if (searchContainer) {
      searchContainer.appendChild(banner);
    } else {
      // Fallback: insert after search input
      const searchInput = document.getElementById('search-input');
      searchInput?.parentElement?.appendChild(banner);
    }

    // Announce crisis resources to screen readers (urgent)
    const urgentMessage = isEmergency
      ? 'If you are in danger, call 911 for emergency services.'
      : 'Crisis support is available. Call or text 988 for the Suicide and Crisis Lifeline, available 24/7.';
    announceToScreenReader(urgentMessage, true);

    // Close handler
    const closeBtn = banner.querySelector('.crisis-banner-close');
    closeBtn?.addEventListener('click', () => banner.remove());
  }

  function performSearch() {
    const query = searchInput?.value.trim() || '';

    // Check for crisis keywords first - show banner but ALSO show relevant programs
    const crisisType = checkForCrisis(query);
    if (crisisType) {
      showCrisisBanner(crisisType);
      // Continue with fuzzy search to show relevant mental health resources
      // (like 988 Suicide & Crisis Lifeline)
      performFuzzySearch(query);
      return; // Skip AI search for crisis queries
    }

    // Clear AI state for new searches
    if (query !== lastAIQuery) {
      hideAIIndicator();
    }

    // Skip AI when offline or disabled - always use fuzzy search
    if (isOffline || !aiEnabled) {
      performFuzzySearch(query);
      return;
    }

    if (isComplexQuery(query)) {
      // Use AI for complex queries (only when online and enabled)
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => performAISearch(query), 500);
    } else {
      // Use fuzzy search for simple queries
      performFuzzySearch(query);
    }
  }

  // Handle Enter key - perform search only on Enter
  searchInput?.addEventListener('keydown', (e) => {
    // Handle type-ahead keyboard navigation
    if (typeaheadDropdown && !typeaheadDropdown.classList.contains('hidden')) {
      handleTypeaheadKeydown(e);
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') return;
      if (e.key === 'Tab' && selectedSuggestionIndex >= 0) return;
    }

    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(debounceTimer);
      searchHints?.classList.add('hidden');
      hideTypeahead();

      // If a suggestion is selected, use it
      if (selectedSuggestionIndex >= 0) {
        const items = typeaheadList?.querySelectorAll('.typeahead-item') || [];
        const selected = items[selectedSuggestionIndex] as HTMLElement;
        if (selected?.dataset?.suggestion) {
          (searchInput as HTMLInputElement).value = selected.dataset.suggestion;
        }
      }

      performSearch();
    } else if (e.key === 'Escape') {
      hideTypeahead();
    }
  });

  // Show type-ahead as user types
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;
    showTypeahead(query);
  });

  // Hide type-ahead when clicking outside
  document.addEventListener('click', (e) => {
    if (
      !searchInput?.contains(e.target as Node) &&
      !typeaheadDropdown?.contains(e.target as Node)
    ) {
      hideTypeahead();
    }
  });

  // Handle hint button clicks
  hintButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      searchInput.value = btn.textContent || '';
      searchHints?.classList.add('hidden');
      hideTypeahead();
      performSearch();
      searchInput.focus();
    });
  });

  // Listen for location changes to re-apply search
  window.addEventListener('locationChanged', () => {
    if (searchInput.value) {
      performSearch();
    }
  });

  // Clear search button (homepage only)
  clearSearchBtn?.addEventListener('click', () => {
    if (searchInput) {
      searchInput.value = '';
      performFuzzySearch('');
      hideQuickAnswer();
      searchInput.focus();
    }
  });

  // ==========================================
  // Refinement Bar Functions
  // ==========================================

  // Check if refinement should be shown and display it
  function checkAndShowRefinement(query: string, resultCount: number) {
    const bar = document.getElementById('refinement-bar');
    if (!bar) return;

    if (!query) {
      bar.classList.add('hidden');
      return;
    }

    const isVague = REFINEMENT_TRIGGER.vague_terms.some((term) =>
      query.toLowerCase().includes(term)
    );
    const isShort = query.length <= REFINEMENT_TRIGGER.max_query_length;
    const hasManyResults = resultCount >= REFINEMENT_TRIGGER.min_results;

    if ((isVague || isShort) && hasManyResults) {
      // Show refinement bar - trigger the full showRefinementBar function
      showRefinementBarFull();
    } else {
      bar.classList.add('hidden');
    }
  }

  const refinementBar = document.getElementById('refinement-bar');
  const locationDisplay = document.getElementById('location-display');
  const locationPrompt = document.getElementById('location-prompt');
  const locationValue = document.getElementById('location-value');
  const locationSource = document.getElementById('location-source');
  const categoryButtons = document.getElementById('category-buttons');
  const categoryRefinement = document.getElementById('category-refinement');
  const suboptionRefinement = document.getElementById('suboption-refinement');
  const suboptionPrompt = document.getElementById('suboption-prompt');
  const suboptionButtons = document.getElementById('suboption-buttons');
  const backToCategories = document.getElementById('back-to-categories');
  const useGpsBtn = document.getElementById('use-gps-btn');
  const zipCityInput = document.getElementById('zip-city-input') as HTMLInputElement | null;
  const submitLocationBtn = document.getElementById('submit-location-btn');
  const changeLocationBtn = document.getElementById('change-location-btn');

  // Check if refinement should be shown based on query and result count
  function shouldShowRefinement(query: string, resultCount: number): boolean {
    const isVague = REFINEMENT_TRIGGER.vague_terms.some((term) =>
      query.toLowerCase().includes(term)
    );
    const isShort = query.length <= REFINEMENT_TRIGGER.max_query_length;
    const hasManyResults = resultCount >= REFINEMENT_TRIGGER.min_results;

    return (isVague || isShort) && hasManyResults && query.length > 0;
  }

  // Show the refinement bar with full category buttons
  function showRefinementBarFull() {
    if (!refinementBar) return;

    // Update location display
    updateLocationDisplay();

    // Build category buttons
    if (categoryButtons) {
      // Clear safely using textContent
      categoryButtons.textContent = '';

      REFINEMENT_CATEGORIES.forEach((cat) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className =
          'inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-200 hover:bg-primary-50 dark:hover:bg-primary-900/30 hover:border-primary-300 dark:hover:border-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 transition-colors';
        btn.setAttribute('role', 'listitem');
        btn.setAttribute('data-category-id', cat.id);

        const icon = document.createElement('span');
        icon.setAttribute('aria-hidden', 'true');
        icon.textContent = cat.icon;
        btn.appendChild(icon);

        const label = document.createElement('span');
        label.textContent = cat.label;
        btn.appendChild(label);

        btn.addEventListener('click', () => selectCategory(cat));
        categoryButtons.appendChild(btn);
      });
    }

    // Reset to category view
    if (categoryRefinement) categoryRefinement.classList.remove('hidden');
    if (suboptionRefinement) suboptionRefinement.classList.add('hidden');
    selectedCategory = null;

    refinementBar.classList.remove('hidden');
    announceToScreenReader(
      'Refinement options are now available. Select a category to narrow your search.'
    );
  }

  // Hide the refinement bar
  function hideRefinementBar() {
    if (refinementBar) {
      refinementBar.classList.add('hidden');
    }
  }

  // Handle category selection
  function selectCategory(category: RefinementCategory) {
    selectedCategory = category;

    // Perform preliminary search with category terms
    const query = category.search_terms.join(' ');
    performRefinedSearch(query, category.best_bets);

    // Show sub-options
    if (categoryRefinement) categoryRefinement.classList.add('hidden');
    if (suboptionRefinement) suboptionRefinement.classList.remove('hidden');

    if (suboptionPrompt) {
      suboptionPrompt.textContent = `${category.label} - What's your situation?`;
    }

    if (suboptionButtons) {
      // Clear safely
      suboptionButtons.textContent = '';

      category.sub_options.forEach((opt) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className =
          'px-3 py-2 text-sm font-medium rounded-lg bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-200 hover:bg-primary-50 dark:hover:bg-primary-900/30 hover:border-primary-300 dark:hover:border-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 transition-colors';
        btn.setAttribute('role', 'listitem');
        btn.textContent = opt.label;
        btn.addEventListener('click', () => selectSubOption(opt));
        suboptionButtons.appendChild(btn);
      });
    }

    announceToScreenReader(
      `Selected ${category.label}. Choose your specific situation to see relevant programs.`
    );
  }

  // Handle sub-option selection
  function selectSubOption(option: { label: string; search_terms: string[]; best_bets: string[] }) {
    // Perform final refined search
    const query = option.search_terms.join(' ');
    performRefinedSearch(query, option.best_bets);

    // Hide refinement bar after selection
    hideRefinementBar();

    announceToScreenReader(`Showing results for "${option.label}".`);
  }

  // Perform search with refinement terms and best bets
  function performRefinedSearch(query: string, bestBetIds: string[]) {
    // Update the search input
    if (searchInput) {
      (searchInput as HTMLInputElement).value = query;
    }

    // Use existing fuzzy search with best bets prioritized
    const allResults = new Map();
    const results = fuse.search(query);
    results.forEach((r) => {
      allResults.set(r.item.index, r);
    });

    const matchedIndices = new Set(allResults.keys());
    const bestBetSet = new Set(bestBetIds);

    if (isHomepage) {
      homeResultsSection?.classList.remove('hidden');

      let visibleCount = 0;
      programs.forEach((p) => {
        const matchesSearch = matchedIndices.has(p.index);
        const isBestBet = bestBetSet.has(p.id);

        if (matchesSearch || isBestBet) {
          if (p.wrapper) {
            p.wrapper.classList.remove('hidden');
            if (isBestBet) {
              p.wrapper.classList.add('best-bet');
            } else {
              p.wrapper.classList.remove('best-bet');
            }
            visibleCount++;
          }
        } else {
          if (p.wrapper) {
            p.wrapper.classList.add('hidden');
            p.wrapper.classList.remove('best-bet');
          }
        }
      });

      if (homeResultsCount) {
        homeResultsCount.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found`;
      }
      if (visibleCount === 0) {
        noResultsEl?.classList.remove('hidden');
      } else {
        noResultsEl?.classList.add('hidden');
      }
    } else {
      // Directory page
      let visibleCount = 0;
      programs.forEach((p) => {
        const matchesSearch = matchedIndices.has(p.index);
        const isBestBet = bestBetSet.has(p.id);
        const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
        const locationHidden = p.element.hasAttribute('data-location-hidden');
        const shouldShow = (matchesSearch || isBestBet) && matchesCategory && !locationHidden;

        p.element.style.display = shouldShow ? '' : 'none';

        if (isBestBet && shouldShow) {
          p.element.classList.add('best-bet');
        } else {
          p.element.classList.remove('best-bet');
        }

        if (shouldShow) visibleCount++;
      });

      updateResultsCount(visibleCount, query, false);
      announceToScreenReader(`Found ${visibleCount} program${visibleCount !== 1 ? 's' : ''}.`);
    }
  }

  // Back button handler
  backToCategories?.addEventListener('click', () => {
    if (suboptionRefinement) suboptionRefinement.classList.add('hidden');
    if (categoryRefinement) categoryRefinement.classList.remove('hidden');
    selectedCategory = null;
    announceToScreenReader('Returned to category selection.');
  });

  // Capitalize city name for display (moved here for use in updateLocationDisplay)
  function capitalizeCityName(city: string): string {
    return city
      .split(' ')
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  // Update location display
  function updateLocationDisplay() {
    if (currentLocation) {
      // Show city name if available, otherwise show county
      if (locationValue) {
        const displayName = currentLocation.city
          ? capitalizeCityName(currentLocation.city)
          : currentLocation.county;
        locationValue.textContent = displayName;
      }
      if (locationSource) {
        locationSource.textContent =
          currentLocation.source === 'gps'
            ? '(GPS)'
            : currentLocation.source === 'profile'
              ? '(from profile)'
              : '';
      }
      if (locationDisplay) locationDisplay.classList.remove('hidden');
      if (locationPrompt) locationPrompt.classList.add('hidden');
    } else {
      if (locationDisplay) locationDisplay.classList.add('hidden');
      if (locationPrompt) locationPrompt.classList.remove('hidden');
    }
  }

  // GPS location handler
  useGpsBtn?.addEventListener('click', async () => {
    if (!navigator.geolocation) {
      announceToScreenReader('Geolocation is not supported by your browser.');
      return;
    }

    const originalText = useGpsBtn.textContent;
    useGpsBtn.textContent = 'Getting location...';
    (useGpsBtn as HTMLButtonElement).disabled = true;

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const county = findNearestCounty(latitude, longitude);

        currentLocation = {
          source: 'gps',
          county: county,
        };

        updateLocationDisplay();
        localStorage.setItem('baynavigator_location', JSON.stringify(currentLocation));

        useGpsBtn.textContent = originalText;
        (useGpsBtn as HTMLButtonElement).disabled = false;

        announceToScreenReader(`Location set to ${county}.`);
      },
      () => {
        announceToScreenReader('Could not get your location. Please enter a ZIP code or city.');
        useGpsBtn.textContent = originalText;
        (useGpsBtn as HTMLButtonElement).disabled = false;
      },
      { enableHighAccuracy: false, timeout: 10000 }
    );
  });

  // Handle location submission from ZIP/city input
  function handleLocationSubmit() {
    if (!zipCityInput) return;
    const value = zipCityInput.value.trim();
    if (!value) return;

    const result = lookupCountyAndCity(value);
    if (result) {
      currentLocation = {
        source: 'manual',
        input: value,
        county: result.county,
        city: result.city,
      };
      updateLocationDisplay();
      localStorage.setItem('baynavigator_location', JSON.stringify(currentLocation));
      // Announce the city if we know it, otherwise announce county
      const locationName = result.city ? capitalizeCityName(result.city) : result.county;
      announceToScreenReader(`Location set to ${locationName}.`);
    } else {
      announceToScreenReader('Location not found. Please try a different ZIP code or city.');
    }
  }

  // Submit button click handler
  submitLocationBtn?.addEventListener('click', handleLocationSubmit);

  // Enter key handler for ZIP/city input
  zipCityInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleLocationSubmit();
    }
  });

  // Change location handler
  changeLocationBtn?.addEventListener('click', () => {
    if (locationDisplay) locationDisplay.classList.add('hidden');
    if (locationPrompt) locationPrompt.classList.remove('hidden');
    if (zipCityInput) {
      zipCityInput.value = '';
      zipCityInput.focus();
    }
  });

  // Find nearest county from GPS coordinates using Haversine formula
  function findNearestCounty(lat: number, lng: number): string {
    let nearest = 'Bay Area';
    let minDist = Infinity;

    for (const [county, coords] of Object.entries(COUNTY_COORDINATES)) {
      const dist = haversineDistance(lat, lng, coords.lat, coords.lng);
      if (dist < minDist) {
        minDist = dist;
        nearest = county;
      }
    }

    return nearest;
  }

  // Haversine distance calculation
  function haversineDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {
    const R = 3959; // Earth radius in miles
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLng = ((lng2 - lng1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLng / 2) *
        Math.sin(dLng / 2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // Lookup county and city from ZIP or city name
  function lookupCountyAndCity(input: string): { county: string; city?: string } | null {
    // Check if ZIP code (basic validation)
    if (/^\d{5}$/.test(input)) {
      // Map common Bay Area ZIPs to city names
      const zipToCity: Record<string, string> = {
        '94102': 'san francisco',
        '94103': 'san francisco',
        '94104': 'san francisco',
        '94105': 'san francisco',
        '94107': 'san francisco',
        '94108': 'san francisco',
        '94109': 'san francisco',
        '94110': 'san francisco',
        '94111': 'san francisco',
        '94112': 'san francisco',
        '94114': 'san francisco',
        '94115': 'san francisco',
        '94116': 'san francisco',
        '94117': 'san francisco',
        '94118': 'san francisco',
        '94121': 'san francisco',
        '94122': 'san francisco',
        '94123': 'san francisco',
        '94124': 'san francisco',
        '94127': 'san francisco',
        '94131': 'san francisco',
        '94132': 'san francisco',
        '94133': 'san francisco',
        '94134': 'san francisco',
        '94577': 'san leandro',
        '94578': 'san leandro',
        '94579': 'san leandro',
        '94601': 'oakland',
        '94602': 'oakland',
        '94603': 'oakland',
        '94604': 'oakland',
        '94605': 'oakland',
        '94606': 'oakland',
        '94607': 'oakland',
        '94608': 'oakland',
        '94609': 'oakland',
        '94610': 'oakland',
        '94611': 'oakland',
        '94612': 'oakland',
        '94618': 'oakland',
        '94619': 'oakland',
        '94621': 'oakland',
        '94702': 'berkeley',
        '94703': 'berkeley',
        '94704': 'berkeley',
        '94705': 'berkeley',
        '94706': 'albany',
        '94707': 'berkeley',
        '94708': 'berkeley',
        '94709': 'berkeley',
        '94710': 'berkeley',
        '95110': 'san jose',
        '95111': 'san jose',
        '95112': 'san jose',
        '95113': 'san jose',
        '95116': 'san jose',
        '95117': 'san jose',
        '95118': 'san jose',
        '95119': 'san jose',
        '95120': 'san jose',
        '95121': 'san jose',
        '95122': 'san jose',
        '95123': 'san jose',
        '95124': 'san jose',
        '95125': 'san jose',
        '95126': 'san jose',
        '95127': 'san jose',
        '95128': 'san jose',
        '95129': 'san jose',
        '95130': 'san jose',
        '95131': 'san jose',
        '95132': 'san jose',
        '95133': 'san jose',
        '95134': 'san jose',
        '95135': 'san jose',
        '95136': 'san jose',
        '95138': 'san jose',
        '95139': 'san jose',
        '95140': 'san jose',
        '95148': 'san jose',
        '94010': 'san mateo',
        '94014': 'daly city',
        '94015': 'daly city',
        '94061': 'redwood city',
        '94062': 'redwood city',
        '94063': 'redwood city',
        '94401': 'san mateo',
        '94402': 'san mateo',
        '94403': 'san mateo',
        '94404': 'san mateo',
        '94501': 'alameda',
        '94502': 'alameda',
        '94536': 'fremont',
        '94537': 'fremont',
        '94538': 'fremont',
        '94539': 'fremont',
        '94540': 'hayward',
        '94541': 'hayward',
        '94542': 'hayward',
        '94544': 'hayward',
        '94545': 'hayward',
        '94546': 'hayward',
        '94550': 'livermore',
        '94551': 'livermore',
        '94560': 'newark',
        '94566': 'pleasanton',
        '94568': 'dublin',
        '94587': 'union city',
        '94588': 'pleasanton',
        '94596': 'walnut creek',
        '94597': 'walnut creek',
        '94598': 'walnut creek',
        '94801': 'richmond',
        '94804': 'richmond',
        '94805': 'richmond',
        '94520': 'concord',
        '94521': 'concord',
        '94903': 'san rafael',
        '94901': 'san rafael',
        '95050': 'santa clara',
        '95051': 'santa clara',
        '95054': 'santa clara',
        '94086': 'sunnyvale',
        '94087': 'sunnyvale',
        '94089': 'sunnyvale',
        '94301': 'palo alto',
        '94303': 'palo alto',
        '94304': 'palo alto',
        '94306': 'palo alto',
        '94040': 'mountain view',
        '94041': 'mountain view',
        '94043': 'mountain view',
        '95035': 'milpitas',
        '94590': 'vallejo',
        '94591': 'vallejo',
        '94589': 'vallejo',
      };
      const city = zipToCity[input];
      if (city) {
        const county = CITY_TO_COUNTY[city];
        if (county) {
          return { county, city };
        }
      }
      return null;
    }

    // Check city name (typed directly)
    const normalizedInput = input.toLowerCase();
    const county = CITY_TO_COUNTY[normalizedInput];
    if (county) {
      return { county, city: normalizedInput };
    }
    return null;
  }

  // Load saved location from localStorage
  function loadSavedLocation() {
    const saved = localStorage.getItem('baynavigator_location');
    if (saved) {
      try {
        currentLocation = JSON.parse(saved);
      } catch {
        currentLocation = null;
      }
    }
  }

  // Initialize refinement
  loadSavedLocation();

  // Connect to the existing performSearch flow
  // Override the fuzzy search results handler to check for refinement
  const originalPerformFuzzySearch = performFuzzySearch;

  // We need to track result count for refinement detection
  // This is done by modifying the performSearch function behavior
  // The refinement bar will show based on the search results

  // =========================================================================
  // LOCATION POPOVER HANDLERS
  // =========================================================================
  const locationQuickBtn = document.getElementById('location-quick-btn');
  const locationQuickText = document.getElementById('location-quick-text');
  const locationPopover = document.getElementById('location-popover');
  const popoverGpsBtn = document.getElementById('popover-gps-btn');
  const popoverZipInput = document.getElementById('popover-zip-input') as HTMLInputElement | null;
  const popoverSubmitBtn = document.getElementById('popover-submit-btn');

  // Update the location quick button text based on current location
  function updateLocationQuickButton() {
    if (!locationQuickText) return;
    if (currentLocation) {
      const displayName = currentLocation.city
        ? capitalizeCityName(currentLocation.city)
        : currentLocation.county;
      locationQuickText.textContent = displayName;
      // Also store for API calls
      localStorage.setItem('userLocation', currentLocation.city || '');
      localStorage.setItem('userCounty', currentLocation.county || '');
    } else {
      locationQuickText.textContent = 'Set location';
      localStorage.removeItem('userLocation');
      localStorage.removeItem('userCounty');
    }
  }

  // Show/hide popover
  function toggleLocationPopover() {
    if (!locationPopover) return;
    locationPopover.classList.toggle('hidden');
    if (!locationPopover.classList.contains('hidden') && popoverZipInput) {
      popoverZipInput.focus();
    }
  }

  // Close popover
  function closeLocationPopover() {
    if (locationPopover) {
      locationPopover.classList.add('hidden');
    }
  }

  // Toggle on button click
  locationQuickBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleLocationPopover();
  });

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    if (
      locationPopover &&
      !locationPopover.contains(e.target as Node) &&
      locationQuickBtn &&
      !locationQuickBtn.contains(e.target as Node)
    ) {
      closeLocationPopover();
    }
  });

  // GPS button in popover
  popoverGpsBtn?.addEventListener('click', async () => {
    if (!navigator.geolocation) {
      announceToScreenReader('Geolocation is not supported by your browser.');
      return;
    }

    const originalText = popoverGpsBtn.textContent;
    popoverGpsBtn.textContent = 'Getting location...';
    (popoverGpsBtn as HTMLButtonElement).disabled = true;

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const county = findNearestCounty(latitude, longitude);

        currentLocation = {
          source: 'gps',
          county: county,
        };

        updateLocationDisplay();
        updateLocationQuickButton();
        localStorage.setItem('baynavigator_location', JSON.stringify(currentLocation));

        popoverGpsBtn.textContent = originalText;
        (popoverGpsBtn as HTMLButtonElement).disabled = false;
        closeLocationPopover();

        announceToScreenReader(`Location set to ${county}.`);
      },
      () => {
        announceToScreenReader('Could not get your location. Please enter a ZIP code or city.');
        popoverGpsBtn.textContent = originalText;
        (popoverGpsBtn as HTMLButtonElement).disabled = false;
      },
      { enableHighAccuracy: false, timeout: 10000 }
    );
  });

  // ZIP/city input in popover
  function handlePopoverLocationSubmit() {
    if (!popoverZipInput) return;
    const value = popoverZipInput.value.trim();
    if (!value) return;

    const result = lookupCountyAndCity(value);
    if (result) {
      currentLocation = {
        source: 'manual',
        input: value,
        county: result.county,
        city: result.city,
      };
      updateLocationDisplay();
      updateLocationQuickButton();
      localStorage.setItem('baynavigator_location', JSON.stringify(currentLocation));
      closeLocationPopover();
      const locationName = result.city ? capitalizeCityName(result.city) : result.county;
      announceToScreenReader(`Location set to ${locationName}.`);
    } else {
      announceToScreenReader('Location not found. Please try a different ZIP code or city.');
    }
  }

  popoverSubmitBtn?.addEventListener('click', handlePopoverLocationSubmit);
  popoverZipInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handlePopoverLocationSubmit();
    }
    if (e.key === 'Escape') {
      closeLocationPopover();
    }
  });

  // Initialize location quick button on load
  updateLocationQuickButton();
</script>

<style>
  .search-hint-btn {
    @apply text-xs px-2 py-1 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-800 transition-colors;
  }

  .search-hint-btn.ai-hint {
    @apply bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 border border-dashed border-neutral-300 dark:border-neutral-600;
  }

  .search-hint-btn.ai-hint:hover {
    @apply bg-primary-50 dark:bg-primary-900/50 border-primary-300 dark:border-primary-600 text-primary-700 dark:text-primary-300;
  }

  /* AI Toggle Pill Styles */
  .ai-toggle-btn {
    @apply relative inline-flex items-center cursor-pointer;
  }

  .ai-toggle-track {
    @apply relative w-9 h-5 bg-neutral-300 dark:bg-neutral-600 rounded-full transition-colors duration-200;
  }

  .ai-toggle-on .ai-toggle-track {
    @apply bg-primary-600 dark:bg-primary-500;
  }

  .ai-toggle-off .ai-toggle-track {
    @apply bg-neutral-300 dark:bg-neutral-600;
  }

  .ai-toggle-thumb {
    @apply absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-200;
  }

  .ai-toggle-on .ai-toggle-thumb {
    @apply translate-x-4;
  }

  .ai-toggle-off .ai-toggle-thumb {
    @apply translate-x-0;
  }

  .ai-toggle-btn:focus-visible .ai-toggle-track {
    @apply ring-2 ring-primary-500 ring-offset-2 ring-offset-white dark:ring-offset-neutral-900;
  }

  .ai-toggle-disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .ai-toggle-disabled .ai-toggle-track {
    @apply bg-neutral-200 dark:bg-neutral-700;
  }

  .offline-notice {
    @apply absolute right-0 top-full mt-1 flex items-center gap-1.5 text-xs text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg px-3 py-2 shadow-sm z-50 whitespace-nowrap;
    animation: fadeInOut 3s ease-in-out forwards;
  }

  @keyframes fadeInOut {
    0% {
      opacity: 0;
      transform: translateY(-4px);
    }
    10% {
      opacity: 1;
      transform: translateY(0);
    }
    80% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(-4px);
    }
  }

  /* Crisis Banner Styles */
  .crisis-banner {
    @apply w-full mt-4 rounded-xl shadow-lg border-2;
    animation: slideDown 0.3s ease-out;
  }

  .crisis-banner.emergency {
    @apply bg-red-50 dark:bg-red-950 border-red-500;
  }

  .crisis-banner.mental-health {
    @apply bg-blue-50 dark:bg-blue-950 border-blue-500;
  }

  .crisis-banner-content {
    @apply flex flex-wrap items-center justify-between gap-3 p-4;
  }

  .crisis-banner-box {
    @apply flex items-center gap-3;
  }

  .crisis-banner-icon {
    @apply flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center;
  }

  .crisis-banner.emergency .crisis-banner-icon {
    @apply bg-red-500 text-white;
  }

  .crisis-banner.mental-health .crisis-banner-icon {
    @apply bg-blue-500 text-white;
  }

  .crisis-banner-text {
    @apply flex flex-col;
  }

  .crisis-banner-text strong {
    @apply text-base font-bold;
  }

  .crisis-banner.emergency .crisis-banner-text strong {
    @apply text-red-800 dark:text-red-200;
  }

  .crisis-banner.mental-health .crisis-banner-text strong {
    @apply text-blue-800 dark:text-blue-200;
  }

  .crisis-banner-text span {
    @apply text-sm;
  }

  .crisis-banner.emergency .crisis-banner-text span {
    @apply text-red-700 dark:text-red-300;
  }

  .crisis-banner.mental-health .crisis-banner-text span {
    @apply text-blue-700 dark:text-blue-300;
  }

  .crisis-banner-actions {
    @apply flex items-center gap-2;
  }

  .crisis-banner-btn {
    @apply inline-flex items-center gap-2 px-5 py-2.5 rounded-lg font-bold text-base no-underline transition-all hover:scale-105 shadow-md;
  }

  .crisis-banner-btn.emergency {
    @apply bg-red-600 text-white hover:bg-red-700;
  }

  .crisis-banner-btn.mental-health {
    @apply bg-blue-600 text-white hover:bg-blue-700;
  }

  .crisis-banner-btn-secondary {
    @apply inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm no-underline transition-all border-2;
    @apply bg-transparent text-blue-700 dark:text-blue-300 border-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900;
  }

  .crisis-banner-close {
    @apply w-8 h-8 flex items-center justify-center text-2xl leading-none rounded-full transition-colors bg-transparent border-none cursor-pointer;
  }

  .crisis-banner.emergency .crisis-banner-close {
    @apply text-red-400 hover:text-red-600 hover:bg-red-100 dark:hover:bg-red-900;
  }

  .crisis-banner.mental-health .crisis-banner-close {
    @apply text-blue-400 hover:text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Type-ahead Dropdown Styles */
  .typeahead-dropdown {
    @apply absolute top-full left-0 right-0 mt-1 bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 z-50 overflow-hidden;
  }

  .typeahead-item {
    @apply flex items-center gap-2 px-4 py-2.5 cursor-pointer transition-colors;
  }

  .typeahead-item:hover,
  .typeahead-item.selected {
    @apply bg-primary-50 dark:bg-primary-900/30;
  }

  .typeahead-item span {
    @apply text-sm text-neutral-700 dark:text-neutral-200;
  }

  .typeahead-item strong {
    @apply text-primary-600 dark:text-primary-400 font-semibold;
  }

  /* Best Bet Highlighting */
  .best-bet {
    @apply ring-2 ring-primary-400 dark:ring-primary-500 ring-offset-2 dark:ring-offset-neutral-900;
  }

  .best-bet::before {
    content: '‚òÖ Top Result';
    @apply absolute -top-2 left-4 text-xs font-semibold text-white bg-primary-500 px-2 py-0.5 rounded-full;
  }

  /* Ensure cards have relative positioning for the best-bet badge */
  [data-category].best-bet,
  .home-program-card.best-bet {
    @apply relative;
  }

  /* Quick Answer Card Styles - WCAG 2.2 AAA compliant */
  #quick-answer-container {
    @apply mt-4 mb-4;
  }

  .quick-answer-card {
    @apply relative p-5 rounded-xl shadow-lg border-2;
    animation: slideDown 0.3s ease-out;
  }

  .quick-answer-crisis {
    @apply bg-red-50 dark:bg-red-950 border-red-500;
  }

  .quick-answer-clarify {
    @apply bg-primary-50 dark:bg-primary-900 border-primary-300 dark:border-primary-700;
  }

  .quick-answer-guide {
    @apply bg-white dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700;
  }

  .quick-answer-title {
    @apply text-lg font-semibold mb-3 text-neutral-900 dark:text-white;
  }

  .quick-answer-crisis .quick-answer-title {
    @apply text-red-800 dark:text-red-200;
  }

  .quick-answer-message {
    @apply text-base text-neutral-700 dark:text-neutral-200 mb-4;
  }

  .quick-answer-resource {
    @apply mb-4;
  }

  .quick-answer-resource-name {
    @apply text-lg font-semibold text-neutral-900 dark:text-white mb-1;
  }

  .quick-answer-crisis .quick-answer-resource-name {
    @apply text-red-800 dark:text-red-200;
  }

  .quick-answer-resource-desc {
    @apply text-sm text-neutral-600 dark:text-neutral-300 mb-2;
  }

  /* Phone links - WCAG AAA 44px touch targets */
  .quick-answer-phone {
    @apply inline-flex items-center justify-center min-h-[44px] min-w-[44px] px-5 py-3 text-base font-semibold rounded-lg transition-colors;
    @apply bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
  }

  .quick-answer-guide .quick-answer-phone {
    @apply bg-primary-600 hover:bg-primary-700 focus:ring-primary-500;
  }

  .quick-answer-secondary {
    @apply text-sm text-neutral-600 dark:text-neutral-300 mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-700;
  }

  .quick-answer-crisis .quick-answer-secondary {
    @apply border-red-200 dark:border-red-800;
  }

  /* Category buttons for clarify responses */
  .quick-answer-categories {
    @apply flex flex-wrap gap-3;
  }

  .quick-answer-category-btn {
    @apply inline-flex items-center gap-2 min-h-[44px] min-w-[44px] px-4 py-2 text-sm font-medium rounded-lg transition-colors;
    @apply bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600;
    @apply text-neutral-700 dark:text-neutral-200;
    @apply hover:bg-primary-50 hover:border-primary-300 hover:text-primary-700;
    @apply dark:hover:bg-primary-900/30 dark:hover:border-primary-600 dark:hover:text-primary-300;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900;
  }

  .quick-answer-category-icon {
    @apply text-lg;
  }

  /* Guide/program links */
  .quick-answer-summary {
    @apply text-base text-neutral-600 dark:text-neutral-300 mb-4 leading-relaxed;
  }

  .quick-answer-contact {
    @apply mb-4 p-4 bg-neutral-50 dark:bg-neutral-900 rounded-lg;
  }

  .quick-answer-agency {
    @apply text-sm font-medium text-neutral-700 dark:text-neutral-200 mb-2;
  }

  .quick-answer-link {
    @apply inline-flex items-center justify-center min-h-[44px] min-w-[44px] px-4 py-2 text-sm font-medium rounded-lg transition-colors mr-3 mb-2;
    @apply bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300;
    @apply hover:bg-primary-200 dark:hover:bg-primary-800;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900;
  }

  .quick-answer-apply-link {
    @apply inline-flex items-center justify-center min-h-[44px] min-w-[44px] px-4 py-2 text-sm font-medium rounded-lg transition-colors mb-2;
    @apply bg-primary-600 text-white;
    @apply hover:bg-primary-700;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900;
  }

  /* Dismiss button */
  .quick-answer-dismiss {
    @apply absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-lg text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-200;
    @apply rounded-full hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .quick-answer-card {
      animation: none;
    }
  }

  /* Smart Chat Typing Indicator */
  .typing-indicator {
    @apply flex items-center gap-1;
  }

  .typing-indicator span {
    @apply w-2 h-2 bg-neutral-400 dark:bg-neutral-500 rounded-full;
    animation: typingBounce 1.4s infinite ease-in-out both;
  }

  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s;
  }

  .typing-indicator span:nth-child(3) {
    animation-delay: 0s;
  }

  @keyframes typingBounce {
    0%,
    80%,
    100% {
      transform: scale(0.6);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Smart Chat Message Animation */
  #smart-chat-messages > div {
    animation: chatMessageSlide 0.2s ease-out;
  }

  @keyframes chatMessageSlide {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .typing-indicator span {
      animation: none;
    }
    #smart-chat-messages > div {
      animation: none;
    }
  }
</style>
