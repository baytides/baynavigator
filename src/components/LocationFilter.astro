---
/**
 * LocationFilter component
 * Allows users to filter programs by ZIP code or city
 * Shows programs for their county + Bay Area + Statewide + Nationwide
 */
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load ZIP codes mapping
const zipcodesPath = path.join(process.cwd(), 'src/data/zipcodes.yml');
const zipcodesContent = fs.readFileSync(zipcodesPath, 'utf-8');
const zipcodes = yaml.load(zipcodesContent) as Record<string, string>;

// Load cities mapping
const citiesPath = path.join(process.cwd(), 'src/data/cities.yml');
const citiesContent = fs.readFileSync(citiesPath, 'utf-8');
const cities = yaml.load(citiesContent) as Array<{ name: string; county: string; type: string }>;

// Create city to county lookup
const cityToCounty: Record<string, string> = {};
cities.forEach(city => {
  cityToCounty[city.name.toLowerCase()] = city.county;
});

// Get unique city names for autocomplete
const cityNames = cities.map(c => c.name).sort();
---

<div class="location-filter">
  <div class="flex items-center gap-2">
    <label for="location-input" class="sr-only">Enter ZIP code or city</label>
    <div class="relative flex-1">
      <svg
        class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
        />
      </svg>
      <input
        type="text"
        id="location-input"
        class="w-full py-2 pl-9 pr-20 text-sm rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white placeholder-neutral-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        placeholder="ZIP code or city..."
        autocomplete="off"
        list="city-suggestions"
      />
      <!-- GPS button -->
      <button
        type="button"
        id="gps-location-btn"
        class="absolute right-8 top-1/2 -translate-y-1/2 p-1 text-neutral-400 hover:text-primary-500 dark:hover:text-primary-400 transition-colors"
        aria-label="Use my location"
        title="Use my location (stays on your device)"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
        </svg>
      </button>
      <button
        type="button"
        id="clear-location"
        class="hidden absolute right-2 top-1/2 -translate-y-1/2 p-1 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300"
        aria-label="Clear location"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Location status -->
  <div id="location-status" class="hidden mt-2 text-sm">
    <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
      <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
      </svg>
      <span id="location-county"></span>
      <span id="location-distance" class="text-xs opacity-75"></span>
    </span>
  </div>

  <!-- GPS Privacy Notice (shown once) -->
  <div id="gps-privacy-notice" class="hidden mt-2 p-3 text-xs rounded-lg bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-800">
    <div class="flex items-start gap-2">
      <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
      </svg>
      <div>
        <strong>Privacy-first location:</strong> Your coordinates stay on your device. We calculate distances in your browser—nothing is sent to our servers.
      </div>
    </div>
    <button type="button" id="gps-privacy-dismiss" class="mt-2 text-green-600 dark:text-green-400 underline hover:no-underline">Got it</button>
  </div>

  <!-- City suggestions datalist -->
  <datalist id="city-suggestions">
    {cityNames.map(city => (
      <option value={city} />
    ))}
  </datalist>
</div>

<!-- Pass data to client -->
<script type="application/json" id="location-data">
  {JSON.stringify({ zipcodes, cityToCounty })}
</script>

<script type="module">
  // Load data
  const dataEl = document.getElementById('location-data');
  const { zipcodes, cityToCounty } = JSON.parse(dataEl?.textContent || '{}');

  const locationInput = document.getElementById('location-input') as HTMLInputElement;
  const clearBtn = document.getElementById('clear-location');
  const statusEl = document.getElementById('location-status');
  const countyEl = document.getElementById('location-county');
  const distanceEl = document.getElementById('location-distance');
  const gpsBtn = document.getElementById('gps-location-btn');
  const privacyNotice = document.getElementById('gps-privacy-notice');
  const privacyDismiss = document.getElementById('gps-privacy-dismiss');

  // Bay Area counties with approximate center coordinates for county detection
  const BAY_AREA_COUNTIES_GEO = {
    'Alameda County': { lat: 37.6017, lng: -121.7195 },
    'Contra Costa County': { lat: 37.9193, lng: -121.9277 },
    'Marin County': { lat: 38.0834, lng: -122.7633 },
    'Napa County': { lat: 38.5025, lng: -122.2654 },
    'San Francisco': { lat: 37.7749, lng: -122.4194 },
    'San Mateo County': { lat: 37.4969, lng: -122.3331 },
    'Santa Clara County': { lat: 37.3541, lng: -121.9552 },
    'Solano County': { lat: 38.2721, lng: -121.9399 },
    'Sonoma County': { lat: 38.5780, lng: -122.9888 }
  };

  // Bay Area counties for matching
  const BAY_AREA_COUNTIES = Object.keys(BAY_AREA_COUNTIES_GEO);

  // Geographic areas that always show (in addition to local county)
  const ALWAYS_SHOW_AREAS = ['Bay Area', 'Statewide', 'Nationwide'];

  let currentCounty: string | null = null;
  let currentUserCoords: { lat: number; lng: number } | null = null;
  let debounceTimer: ReturnType<typeof setTimeout>;

  // Haversine formula for distance calculation (all on-device)
  function calculateDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {
    const R = 3959; // Earth's radius in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Find the nearest county to given coordinates (all on-device)
  function findNearestCounty(lat: number, lng: number): string {
    let nearestCounty = 'Bay Area';
    let minDistance = Infinity;

    for (const [county, coords] of Object.entries(BAY_AREA_COUNTIES_GEO)) {
      const distance = calculateDistance(lat, lng, coords.lat, coords.lng);
      if (distance < minDistance) {
        minDistance = distance;
        nearestCounty = county;
      }
    }

    return nearestCounty;
  }

  // Check if privacy notice was dismissed
  const privacyDismissed = localStorage.getItem('gps-privacy-dismissed') === 'true';

  // Handle GPS button click
  async function handleGpsClick() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser');
      return;
    }

    // Show privacy notice if not dismissed
    if (!privacyDismissed && privacyNotice) {
      privacyNotice.classList.remove('hidden');
    }

    // Update button to show loading
    if (gpsBtn) {
      gpsBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        // SUCCESS - coordinates stay on device!
        const { latitude, longitude } = position.coords;
        currentUserCoords = { lat: latitude, lng: longitude };

        // Find county (calculated on-device)
        const county = findNearestCounty(latitude, longitude);
        currentCounty = county;

        // Update UI
        if (countyEl) countyEl.textContent = county;
        if (distanceEl) distanceEl.textContent = '(GPS)';
        statusEl?.classList.remove('hidden');
        clearBtn?.classList.remove('hidden');
        locationInput.value = '';
        locationInput.placeholder = `Using GPS · ${county}`;

        // Filter and sort by distance
        filterByLocation(county);
        sortByDistance();

        // Restore GPS button
        if (gpsBtn) {
          gpsBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" /></svg>';
          gpsBtn.classList.add('text-primary-500');
        }

        // Dispatch event for map and other components
        window.dispatchEvent(new CustomEvent('userLocationChanged', {
          detail: { lat: latitude, lng: longitude, county }
        }));
      },
      (error) => {
        // ERROR
        console.error('Geolocation error:', error.message);
        alert('Could not get your location. Please enter a ZIP code or city instead.');

        // Restore GPS button
        if (gpsBtn) {
          gpsBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" /></svg>';
        }
      },
      {
        enableHighAccuracy: false, // Don't need precise location
        timeout: 10000,
        maximumAge: 300000 // Cache for 5 minutes
      }
    );
  }

  // Sort cards by distance from user (all on-device calculation)
  function sortByDistance() {
    if (!currentUserCoords) return;

    const container = document.querySelector('.program-grid, [data-program-container]');
    if (!container) return;

    const cards = Array.from(container.querySelectorAll('[data-category]')) as HTMLElement[];

    // Get coordinates from data attributes (set by map integration)
    cards.forEach(card => {
      const lat = parseFloat(card.dataset.lat || '0');
      const lng = parseFloat(card.dataset.lng || '0');

      if (lat && lng && currentUserCoords) {
        const distance = calculateDistance(
          currentUserCoords.lat, currentUserCoords.lng,
          lat, lng
        );
        card.dataset.distance = distance.toFixed(1);

        // Add distance badge
        let badge = card.querySelector('.distance-badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'distance-badge text-xs bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 px-1.5 py-0.5 rounded ml-2';
          const titleEl = card.querySelector('h3, .program-title');
          if (titleEl) titleEl.appendChild(badge);
        }
        badge.textContent = distance < 1 ? `${(distance * 5280).toFixed(0)} ft` : `${distance.toFixed(1)} mi`;
      }
    });

    // Sort by distance (only visible cards)
    const sortedCards = cards
      .filter(card => card.style.display !== 'none')
      .sort((a, b) => {
        const distA = parseFloat(a.dataset.distance || '9999');
        const distB = parseFloat(b.dataset.distance || '9999');
        return distA - distB;
      });

    // Re-append in sorted order
    sortedCards.forEach(card => container.appendChild(card));
  }

  // Dismiss privacy notice
  privacyDismiss?.addEventListener('click', () => {
    privacyNotice?.classList.add('hidden');
    localStorage.setItem('gps-privacy-dismissed', 'true');
  });

  // GPS button click
  gpsBtn?.addEventListener('click', handleGpsClick);

  function lookupLocation(input: string): string | null {
    const normalized = input.trim();

    if (!normalized) return null;

    // Check if it's a ZIP code (5 digits)
    if (/^\d{5}$/.test(normalized)) {
      const city = zipcodes[normalized];
      if (city) {
        return cityToCounty[city.toLowerCase()] || null;
      }
      return null;
    }

    // Check if it's a city name
    const lowerInput = normalized.toLowerCase();
    return cityToCounty[lowerInput] || null;
  }

  function filterByLocation(county: string | null) {
    const cards = document.querySelectorAll('[data-category]');

    cards.forEach(card => {
      const areaEl = card.querySelector('.text-neutral-600, [class*="text-neutral-600"], .text-neutral-500, [class*="text-neutral-500"]');
      const area = areaEl?.textContent?.trim() || '';

      // Determine visibility
      let show = true;

      if (county) {
        // If location is set, show:
        // 1. Programs in the user's county
        // 2. Programs marked as "Bay Area" (regional)
        // 3. Programs marked as "Statewide"
        // 4. Programs marked as "Nationwide"
        const matchesCounty = area === county;
        const matchesRegionalOrWider = ALWAYS_SHOW_AREAS.some(a => area.includes(a));
        show = matchesCounty || matchesRegionalOrWider;
      }

      // Get current display state (might be hidden by search/category filter)
      const currentDisplay = (card as HTMLElement).style.display;
      const wasHiddenByOtherFilter = currentDisplay === 'none' && !card.hasAttribute('data-location-hidden');

      if (show) {
        card.removeAttribute('data-location-hidden');
        // Only show if not hidden by other filters
        if (!wasHiddenByOtherFilter) {
          (card as HTMLElement).style.display = '';
        }
      } else {
        card.setAttribute('data-location-hidden', 'true');
        (card as HTMLElement).style.display = 'none';
      }
    });

    // Update count
    updateResultsCount();

    // Dispatch event for other components
    window.dispatchEvent(new CustomEvent('locationChanged', {
      detail: { county }
    }));
  }

  function updateResultsCount() {
    const visibleCount = document.querySelectorAll('[data-category]:not([style*="display: none"])').length;
    const counter = document.getElementById('results-count');
    if (counter) {
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      const query = searchInput?.value?.trim() || '';
      const queryInfo = query ? ` for "${query}"` : '';
      const locationInfo = currentCounty ? ` in ${currentCounty}` : '';
      counter.textContent = `${visibleCount} program${visibleCount !== 1 ? 's' : ''} found${queryInfo}${locationInfo}`;
    }
  }

  function handleInput() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const value = locationInput.value.trim();

      // Show/hide clear button
      if (value) {
        clearBtn?.classList.remove('hidden');
      } else {
        clearBtn?.classList.add('hidden');
        statusEl?.classList.add('hidden');
        currentCounty = null;
        filterByLocation(null);
        return;
      }

      const county = lookupLocation(value);

      if (county) {
        currentCounty = county;
        if (countyEl) countyEl.textContent = county;
        statusEl?.classList.remove('hidden');
        filterByLocation(county);
      } else {
        // Input doesn't match - keep showing status if we had a match before
        if (currentCounty) {
          // User might be editing, don't clear yet
        } else {
          statusEl?.classList.add('hidden');
        }
      }
    }, 300);
  }

  function clearLocation() {
    locationInput.value = '';
    locationInput.placeholder = 'ZIP code or city...';
    clearBtn?.classList.add('hidden');
    statusEl?.classList.add('hidden');
    currentCounty = null;
    currentUserCoords = null;
    filterByLocation(null);
    locationInput.focus();

    // Reset GPS button color
    if (gpsBtn) {
      gpsBtn.classList.remove('text-primary-500');
    }

    // Remove distance badges
    document.querySelectorAll('.distance-badge').forEach(el => el.remove());

    // Dispatch clear event
    window.dispatchEvent(new CustomEvent('userLocationChanged', {
      detail: { lat: null, lng: null, county: null }
    }));
  }

  // Event listeners
  locationInput?.addEventListener('input', handleInput);
  clearBtn?.addEventListener('click', clearLocation);

  // Handle keyboard
  locationInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearLocation();
    }
  });

  // Coordinate with search filter - listen for search events
  const searchInput = document.getElementById('search-input');
  searchInput?.addEventListener('input', () => {
    // Re-apply location filter after search updates
    setTimeout(() => {
      if (currentCounty) {
        filterByLocation(currentCounty);
      }
    }, 200);
  });
</script>

<style>
  .location-filter {
    @apply min-w-[200px];
  }
</style>
