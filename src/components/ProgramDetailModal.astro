---
/**
 * Program Detail Modal Component
 * Displays full program details in an accessible modal dialog
 * WCAG 2.2 AAA compliant with focus management and scroll preservation
 */
---

<dialog
  id="program-detail-modal"
  class="program-detail-modal"
  aria-labelledby="modal-program-name"
  aria-describedby="modal-program-description"
>
  <div class="modal-content">
    <!-- Modal header with close button -->
    <div class="modal-header">
      <div class="flex-1">
        <span id="modal-category-badge" class="badge mb-2"></span>
        <h2 id="modal-program-name" class="text-2xl font-bold text-neutral-900 dark:text-white">
        </h2>
        <p id="modal-program-location" class="text-sm text-neutral-600 dark:text-neutral-300 mt-1">
        </p>
      </div>
      <button type="button" id="modal-close-btn" class="modal-close-btn" aria-label="Close modal">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal body -->
    <div class="modal-body">
      <!-- Description -->
      <div id="modal-description-section" class="mb-6">
        <p id="modal-program-description" class="text-neutral-700 dark:text-neutral-200"></p>
      </div>

      <!-- What They Offer -->
      <div id="modal-offer-section" class="mb-6 hidden">
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-2">What They Offer</h3>
        <p id="modal-what-they-offer" class="text-neutral-700 dark:text-neutral-200"></p>
      </div>

      <!-- How to Get It -->
      <div id="modal-howto-section" class="mb-6 hidden">
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-2">How to Get It</h3>
        <p id="modal-how-to-get-it" class="text-neutral-700 dark:text-neutral-200"></p>
      </div>

      <!-- Fee Info -->
      <div id="modal-fee-section" class="mb-6 hidden">
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-2">Fees</h3>
        <p id="modal-fee-info" class="text-neutral-700 dark:text-neutral-200"></p>
      </div>

      <!-- Amenities -->
      <div id="modal-amenities-section" class="mb-6 hidden">
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-2">Amenities</h3>
        <div id="modal-amenities" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Contact Info -->
      <div
        id="modal-contact-section"
        class="border-t border-neutral-200 dark:border-neutral-700 pt-4"
      >
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-3">Contact</h3>

        <div class="space-y-3">
          <!-- Phone -->
          <div id="modal-phone-row" class="hidden flex items-center gap-3">
            <svg
              class="w-5 h-5 text-neutral-500 dark:text-neutral-400 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
              ></path>
            </svg>
            <a
              id="modal-phone"
              href=""
              class="text-primary-700 dark:text-primary-300 hover:underline"></a>
          </div>

          <!-- Address -->
          <div id="modal-address-row" class="hidden flex items-start gap-3">
            <svg
              class="w-5 h-5 text-neutral-500 dark:text-neutral-400 flex-shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <a
              id="modal-address"
              href=""
              target="_blank"
              rel="noopener noreferrer"
              class="text-primary-700 dark:text-primary-300 hover:underline"></a>
          </div>

          <!-- Website -->
          <div id="modal-website-row" class="hidden flex items-center gap-3">
            <svg
              class="w-5 h-5 text-neutral-500 dark:text-neutral-400 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
              ></path>
            </svg>
            <a
              id="modal-website"
              href=""
              target="_blank"
              rel="noopener noreferrer"
              class="text-primary-700 dark:text-primary-300 hover:underline"></a>
          </div>
        </div>
      </div>

      <!-- Verification info -->
      <div
        id="modal-verified-section"
        class="hidden mt-6 pt-4 border-t border-neutral-200 dark:border-neutral-700"
      >
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
          <span>Verified by </span>
          <span id="modal-verified-by" class="font-medium"></span>
          <span> on </span>
          <span id="modal-verified-date"></span>
        </p>
      </div>
    </div>

    <!-- Modal footer -->
    <div class="modal-footer">
      <button type="button" id="modal-share-btn" class="btn-secondary">
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
          ></path>
        </svg>
        Share
      </button>
      <a
        id="modal-learn-more-btn"
        href=""
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary"
      >
        Visit Website
        <svg
          class="w-5 h-5 ml-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      </a>
    </div>
  </div>
</dialog>

<style>
  .program-detail-modal {
    position: fixed;
    inset: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    margin: 0;
    padding: 0;
    border: none;
    background: transparent;
    overflow: hidden;
  }

  .program-detail-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .program-detail-modal[open] {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-content {
    background: white;
    border-radius: 1rem;
    max-width: 40rem;
    width: 100%;
    max-height: calc(100vh - 2rem);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 0 1px rgba(0, 0, 0, 0.05);
  }

  :global(.dark) .modal-content {
    background: #1f2937;
  }

  .modal-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  :global(.dark) .modal-header {
    border-bottom-color: #374151;
  }

  .modal-close-btn {
    flex-shrink: 0;
    padding: 0.5rem;
    border-radius: 0.5rem;
    color: #6b7280;
    transition: all 0.15s ease;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close-btn:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .modal-close-btn:focus-visible {
    outline: 2px solid #005a5f;
    outline-offset: 2px;
  }

  :global(.dark) .modal-close-btn {
    color: #9ca3af;
  }

  :global(.dark) .modal-close-btn:hover {
    background: #374151;
    color: #f3f4f6;
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    overscroll-behavior: contain;
  }

  .modal-footer {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    justify-content: flex-end;
  }

  :global(.dark) .modal-footer {
    border-top-color: #374151;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 0.5rem;
    background: #005a5f;
    color: white;
    transition: all 0.15s ease;
    min-height: 44px;
  }

  .btn-primary:hover {
    background: #004448;
  }

  .btn-primary:focus-visible {
    outline: 2px solid #005a5f;
    outline-offset: 2px;
  }

  .btn-secondary {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 0.5rem;
    background: #f3f4f6;
    color: #374151;
    transition: all 0.15s ease;
    min-height: 44px;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .btn-secondary:focus-visible {
    outline: 2px solid #005a5f;
    outline-offset: 2px;
  }

  :global(.dark) .btn-secondary {
    background: #374151;
    color: #f3f4f6;
  }

  :global(.dark) .btn-secondary:hover {
    background: #4b5563;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .program-detail-modal::backdrop {
      backdrop-filter: none;
    }
  }
</style>

<script>
  interface AmenityData {
    name: string;
    link?: string;
    ssid?: string;
    password?: string;
  }

  interface ProgramData {
    id: string;
    name: string;
    category: string;
    location: string;
    description?: string;
    whatTheyOffer?: string;
    howToGetIt?: string;
    phone?: string;
    address?: string;
    mapLink?: string;
    link?: string;
    linkText?: string;
    feeInfo?: string;
    amenities?: AmenityData[];
    verifiedBy?: string;
    verifiedDate?: string;
  }

  // Generate WiFi URL from SSID and optional password
  function generateWifiUrl(ssid: string, password?: string): string {
    const encodedSsid = encodeURIComponent(ssid);
    if (password) {
      const encodedPassword = encodeURIComponent(password);
      return `wifi://:${encodedPassword}@${encodedSsid}`;
    }
    return `wifi://${encodedSsid}`;
  }

  // Check if amenity is a WiFi amenity
  function isWifiAmenity(amenity: AmenityData): boolean {
    return (
      !!amenity.ssid ||
      amenity.name.toLowerCase().includes('wifi') ||
      amenity.name.toLowerCase().includes('wi-fi')
    );
  }

  const modal = document.getElementById('program-detail-modal') as HTMLDialogElement | null;
  const closeBtn = document.getElementById('modal-close-btn');
  const shareBtn = document.getElementById('modal-share-btn');
  const learnMoreBtn = document.getElementById('modal-learn-more-btn');

  let savedScrollPosition = 0;
  let triggerElement: HTMLElement | null = null;
  let currentProgram: ProgramData | null = null;

  // Category badge colors - matching ProgramCard.astro
  const categoryColors: Record<string, string> = {
    Food: 'bg-green-100 text-green-900 dark:bg-green-900 dark:text-green-100',
    Health: 'bg-red-100 text-red-900 dark:bg-red-900 dark:text-red-100',
    Housing: 'bg-blue-100 text-blue-900 dark:bg-blue-900 dark:text-blue-100',
    Utilities: 'bg-yellow-100 text-yellow-900 dark:bg-yellow-900 dark:text-yellow-100',
    Transportation: 'bg-purple-100 text-purple-900 dark:bg-purple-900 dark:text-purple-100',
    Education: 'bg-indigo-100 text-indigo-900 dark:bg-indigo-900 dark:text-indigo-100',
    'Legal Services': 'bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-100',
    Finance: 'bg-emerald-100 text-emerald-900 dark:bg-emerald-900 dark:text-emerald-100',
    Technology: 'bg-cyan-100 text-cyan-900 dark:bg-cyan-900 dark:text-cyan-100',
    Recreation: 'bg-orange-100 text-orange-900 dark:bg-orange-900 dark:text-orange-100',
    'Community Services': 'bg-pink-100 text-pink-900 dark:bg-pink-900 dark:text-pink-100',
    'Parks & Open Space': 'bg-lime-100 text-lime-900 dark:bg-lime-900 dark:text-lime-100',
    Museums: 'bg-violet-100 text-violet-900 dark:bg-violet-900 dark:text-violet-100',
    'Library Resources': 'bg-amber-100 text-amber-900 dark:bg-amber-900 dark:text-amber-100',
    'Tax Preparation': 'bg-teal-100 text-teal-900 dark:bg-teal-900 dark:text-teal-100',
    Childcare: 'bg-rose-100 text-rose-900 dark:bg-rose-900 dark:text-rose-100',
    'Pet Resources': 'bg-fuchsia-100 text-fuchsia-900 dark:bg-fuchsia-900 dark:text-fuchsia-100',
    Equipment: 'bg-slate-100 text-slate-900 dark:bg-slate-800 dark:text-slate-100',
    'Public Transit': 'bg-sky-100 text-sky-900 dark:bg-sky-900 dark:text-sky-100',
  };

  function openModal(program: ProgramData, trigger: HTMLElement) {
    if (!modal) return;

    // Save scroll position
    savedScrollPosition = window.scrollY;
    triggerElement = trigger;
    currentProgram = program;

    // Populate modal
    const categoryBadge = document.getElementById('modal-category-badge');
    const programName = document.getElementById('modal-program-name');
    const programLocation = document.getElementById('modal-program-location');
    const programDescription = document.getElementById('modal-program-description');
    const descriptionSection = document.getElementById('modal-description-section');

    if (categoryBadge) {
      categoryBadge.textContent = program.category;
      categoryBadge.className =
        'badge ' +
        (categoryColors[program.category] ||
          'bg-neutral-100 text-neutral-800 dark:bg-neutral-800 dark:text-neutral-200');
    }

    if (programName) programName.textContent = program.name;
    if (programLocation) programLocation.textContent = program.location;

    if (programDescription && program.description) {
      programDescription.textContent = program.description;
      descriptionSection?.classList.remove('hidden');
    } else {
      descriptionSection?.classList.add('hidden');
    }

    // What They Offer
    const offerSection = document.getElementById('modal-offer-section');
    const whatTheyOffer = document.getElementById('modal-what-they-offer');
    if (program.whatTheyOffer && whatTheyOffer) {
      whatTheyOffer.textContent = program.whatTheyOffer;
      offerSection?.classList.remove('hidden');
    } else {
      offerSection?.classList.add('hidden');
    }

    // How to Get It
    const howtoSection = document.getElementById('modal-howto-section');
    const howToGetIt = document.getElementById('modal-how-to-get-it');
    if (program.howToGetIt && howToGetIt) {
      howToGetIt.textContent = program.howToGetIt;
      howtoSection?.classList.remove('hidden');
    } else {
      howtoSection?.classList.add('hidden');
    }

    // Fee Info
    const feeSection = document.getElementById('modal-fee-section');
    const feeInfo = document.getElementById('modal-fee-info');
    if (program.feeInfo && feeInfo) {
      feeInfo.textContent = program.feeInfo;
      feeSection?.classList.remove('hidden');
    } else {
      feeSection?.classList.add('hidden');
    }

    // Amenities
    const amenitiesSection = document.getElementById('modal-amenities-section');
    const amenitiesContainer = document.getElementById('modal-amenities');
    if (program.amenities && program.amenities.length > 0 && amenitiesContainer) {
      // Clear container safely
      while (amenitiesContainer.firstChild) {
        amenitiesContainer.removeChild(amenitiesContainer.firstChild);
      }
      program.amenities.forEach((amenity) => {
        const hasWifi = isWifiAmenity(amenity);
        const wifiUrl = amenity.ssid ? generateWifiUrl(amenity.ssid, amenity.password) : null;
        const href = wifiUrl || amenity.link;

        // Create WiFi icon SVG element
        const createWifiIcon = (): SVGSVGElement => {
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('class', 'w-3.5 h-3.5');
          svg.setAttribute('fill', 'currentColor');
          svg.setAttribute('viewBox', '0 0 24 24');
          svg.setAttribute('aria-hidden', 'true');
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute(
            'd',
            'M12 18c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm-4.9-2.3c2.7-2.7 7.1-2.7 9.8 0l1.4-1.4c-3.5-3.5-9.1-3.5-12.6 0l1.4 1.4zm-2.8-2.8c4.3-4.3 11.2-4.3 15.4 0l1.4-1.4c-5-5-13.2-5-18.2 0l1.4 1.4zM1.5 10c5.8-5.8 15.2-5.8 21 0l1.4-1.4c-6.6-6.6-17.2-6.6-23.8 0L1.5 10z'
          );
          svg.appendChild(path);
          return svg;
        };

        if (href) {
          const link = document.createElement('a');
          link.href = href;
          if (!wifiUrl) {
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
          }
          link.className =
            'inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-neutral-100 text-neutral-800 dark:bg-neutral-700 dark:text-neutral-200 hover:bg-neutral-200 dark:hover:bg-neutral-600';
          link.title = wifiUrl ? `Connect to WiFi: ${amenity.ssid}` : amenity.name;

          if (hasWifi) {
            link.appendChild(createWifiIcon());
          }
          link.appendChild(document.createTextNode(amenity.name));
          amenitiesContainer.appendChild(link);
        } else {
          const span = document.createElement('span');
          span.className =
            'inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-neutral-100 text-neutral-800 dark:bg-neutral-700 dark:text-neutral-200';

          if (hasWifi) {
            span.appendChild(createWifiIcon());
          }
          span.appendChild(document.createTextNode(amenity.name));
          amenitiesContainer.appendChild(span);
        }
      });
      amenitiesSection?.classList.remove('hidden');
    } else {
      amenitiesSection?.classList.add('hidden');
    }

    // Contact - Phone
    const phoneRow = document.getElementById('modal-phone-row');
    const phoneLink = document.getElementById('modal-phone') as HTMLAnchorElement | null;
    if (program.phone && phoneLink) {
      phoneLink.textContent = program.phone;
      phoneLink.href = `tel:${program.phone.replace(/[^0-9+]/g, '')}`;
      phoneRow?.classList.remove('hidden');
    } else {
      phoneRow?.classList.add('hidden');
    }

    // Contact - Address
    const addressRow = document.getElementById('modal-address-row');
    const addressLink = document.getElementById('modal-address') as HTMLAnchorElement | null;
    if (program.address && addressLink) {
      addressLink.textContent = program.address;
      addressLink.href =
        program.mapLink ||
        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(program.address)}`;
      addressRow?.classList.remove('hidden');
    } else {
      addressRow?.classList.add('hidden');
    }

    // Contact - Website
    const websiteRow = document.getElementById('modal-website-row');
    const websiteLink = document.getElementById('modal-website') as HTMLAnchorElement | null;
    if (program.link && websiteLink) {
      const url = new URL(program.link);
      websiteLink.textContent = url.hostname;
      websiteLink.href = program.link;
      websiteRow?.classList.remove('hidden');
    } else {
      websiteRow?.classList.add('hidden');
    }

    // Verification
    const verifiedSection = document.getElementById('modal-verified-section');
    const verifiedBy = document.getElementById('modal-verified-by');
    const verifiedDate = document.getElementById('modal-verified-date');
    if (program.verifiedBy && verifiedBy && verifiedDate) {
      verifiedBy.textContent = program.verifiedBy;
      if (program.verifiedDate) {
        const date = new Date(program.verifiedDate);
        verifiedDate.textContent = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
        });
      }
      verifiedSection?.classList.remove('hidden');
    } else {
      verifiedSection?.classList.add('hidden');
    }

    // Learn More button
    if (learnMoreBtn && program.link) {
      (learnMoreBtn as HTMLAnchorElement).href = program.link;
      learnMoreBtn.classList.remove('hidden');
    } else if (learnMoreBtn) {
      learnMoreBtn.classList.add('hidden');
    }

    // Show modal
    modal.showModal();

    // Announce to screen readers
    const announcer = document.getElementById('search-announcer');
    if (announcer) {
      announcer.textContent = `Viewing details for ${program.name}`;
    }
  }

  function closeModal() {
    if (!modal) return;

    modal.close();

    // Restore scroll position
    window.scrollTo(0, savedScrollPosition);

    // Return focus to trigger element
    if (triggerElement) {
      triggerElement.focus();
    }
  }

  // Close button handler
  closeBtn?.addEventListener('click', closeModal);

  // Close on backdrop click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Close on Escape key (handled automatically by dialog element)
  modal?.addEventListener('close', () => {
    window.scrollTo(0, savedScrollPosition);
    if (triggerElement) {
      triggerElement.focus();
    }
  });

  // Share button handler
  shareBtn?.addEventListener('click', async () => {
    if (!currentProgram) return;

    const url = `${window.location.origin}/directory#${currentProgram.id}`;
    const title = currentProgram.name;
    const text = `Check out ${currentProgram.name} on Bay Navigator`;

    if (navigator.share) {
      try {
        await navigator.share({ title, text, url });
        return;
      } catch (err) {
        if ((err as Error).name === 'AbortError') return;
      }
    }

    // Fallback: copy URL to clipboard
    try {
      await navigator.clipboard.writeText(url);
      const toast = (window as any).toast;
      if (toast) {
        toast.success('Link copied to clipboard');
      }
    } catch {
      prompt('Copy this link:', url);
    }
  });

  // Export for external use
  (window as any).openProgramDetailModal = openModal;
</script>
