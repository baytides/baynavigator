---
/**
 * Smart Assistant Component - "Carl"
 * AI-powered chat interface to help users find relevant programs
 * Uses self-hosted Ollama (Llama 3.1) at ai.baytides.org
 * Features: Streaming responses, RAG search, interactive program cards
 *
 * Note: Location data is loaded via fetch from /api/location-data.json
 * to avoid YAML import issues when component is used in layouts.
 */
import { SYSTEM_PROMPT, OLLAMA_CONFIG } from '../data/assistant-system-prompt';
import libraryResources from '../data/library-digital-resources.json';
import publicServices from '../data/public-services.json';

interface Props {
  apiEndpoint?: string;
  apiKey?: string;
  useDomainFronting?: boolean;
  cdnProvider?: 'cloudflare' | 'fastly' | 'azure';
}

// Export library resources for client-side use
const libraryData = libraryResources;

// Export public services data for client-side use
const publicServicesData = publicServices;

const {
  apiEndpoint = OLLAMA_CONFIG.endpoint,
  apiKey = import.meta.env.PUBLIC_OLLAMA_API_KEY || '',
  useDomainFronting = false,
  cdnProvider = 'cloudflare',
} = Astro.props;

// Use CDN endpoint when domain fronting is enabled
const effectiveEndpoint = useDomainFronting ? OLLAMA_CONFIG.cdnEndpoints[cdnProvider] : apiEndpoint;

// Tor hidden service endpoint (for Tor Browser users - no API key needed)
const torEndpoint = OLLAMA_CONFIG.torEndpoint;

// Model to use for Carl
const modelName = OLLAMA_CONFIG.model;
---

<!-- Floating Assistant Button (Draggable) -->
<button
  id="assistant-toggle"
  type="button"
  class="fixed w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-105 z-50 cursor-grab active:cursor-grabbing select-none"
  style="bottom: 24px; right: 24px;"
  aria-label="Open smart assistant (drag to move)"
  aria-expanded="false"
  aria-controls="assistant-panel"
>
  <svg
    class="w-6 h-6 pointer-events-none"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
    aria-hidden="true"
  >
    <!-- Cloud icon for Karl the Fog / cloud computing -->
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
    ></path>
  </svg>
  <!-- Notification dot for first-time users -->
  <span
    id="assistant-dot"
    class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full animate-pulse pointer-events-none"
  ></span>
</button>

<!-- Assistant Panel -->
<div
  id="assistant-panel"
  class="fixed w-96 max-w-[calc(100vw-3rem)] bg-white dark:bg-neutral-800 rounded-2xl shadow-2xl border border-neutral-200 dark:border-neutral-700 hidden z-50 flex flex-col overflow-hidden"
  style="height: 500px; max-height: calc(100vh - 8rem); bottom: 96px; right: 24px;"
  role="dialog"
  aria-labelledby="assistant-title"
>
  <!-- Header -->
  <div
    class="flex items-center justify-between p-4 border-b border-neutral-200 dark:border-neutral-700 bg-gradient-to-r from-amber-500 to-orange-600 text-white"
  >
    <div class="flex items-center gap-3">
      <div
        id="carl-cloud-icon"
        class="carl-cloud carl-cloud--idle w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"
      >
        <!-- Cloud icon for Karl the Fog / cloud computing -->
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
          ></path>
        </svg>
      </div>
      <div>
        <h2 id="assistant-title" class="font-semibold flex items-center gap-2">
          Ask Carl
          <span class="text-[10px] font-medium bg-white/20 px-1.5 py-0.5 rounded-full leading-none"
            >Beta</span
          >
        </h2>
        <p class="text-xs text-primary-100">Your Bay Area resource guide</p>
      </div>
    </div>
    <div class="flex items-center gap-1">
      <!-- History button -->
      <button
        id="assistant-history-btn"
        type="button"
        class="p-1.5 hover:bg-white/20 rounded-lg transition-colors hidden"
        aria-label="View conversation history"
        title="History"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </button>
      <!-- Clear chat button (trash icon) -->
      <button
        id="assistant-new-chat"
        type="button"
        class="p-1.5 hover:bg-white/20 rounded-lg transition-colors"
        aria-label="Clear conversation"
        title="Clear chat"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
          ></path>
        </svg>
      </button>
      <!-- Fullscreen toggle (desktop only) -->
      <button
        id="assistant-fullscreen"
        type="button"
        class="p-1.5 hover:bg-white/20 rounded-lg transition-colors hidden md:block"
        aria-label="Toggle fullscreen"
        title="Fullscreen"
      >
        <svg
          id="fullscreen-expand-icon"
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
          ></path>
        </svg>
        <svg
          id="fullscreen-collapse-icon"
          class="w-5 h-5 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 9V4m0 5H4m0 0l5-5m11 5h-5m5 0V4m0 0l-5 5m-5 11v-5m0 5H4m0 0l5-5m11 5l-5-5m5 5v-5m0 5h-5"
          ></path>
        </svg>
      </button>
      <!-- Close button -->
      <button
        id="assistant-close"
        type="button"
        class="p-1.5 hover:bg-white/20 rounded-lg transition-colors"
        aria-label="Close assistant"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- History Panel (hidden by default) -->
  <div
    id="assistant-history-panel"
    class="absolute inset-0 bg-white dark:bg-neutral-800 z-10 hidden flex-col"
  >
    <div
      class="flex items-center justify-between p-4 border-b border-neutral-200 dark:border-neutral-700"
    >
      <h3 class="font-semibold text-neutral-900 dark:text-white">Conversation History</h3>
      <button
        id="history-back-btn"
        type="button"
        class="p-1 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition-colors"
        aria-label="Back to chat"
      >
        <svg
          class="w-5 h-5 text-neutral-600 dark:text-neutral-300"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-2">
      <!-- History items populated by JS -->
    </div>
    <div class="p-4 border-t border-neutral-200 dark:border-neutral-700">
      <button
        id="clear-history-btn"
        type="button"
        class="w-full py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
      >
        Clear all history
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div id="assistant-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
    <!-- Welcome message -->
    <div class="assistant-message">
      <div class="bg-neutral-100 dark:bg-neutral-700 rounded-2xl rounded-tl-sm p-3 max-w-[85%]">
        <p class="text-sm text-neutral-800 dark:text-neutral-200">
          Hi! I'm Carl, your Bay Area assistant. I can help you find programs, services, and local
          government info. What can I help you with?
        </p>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="p-4 border-t border-neutral-200 dark:border-neutral-700">
    <form id="assistant-form" class="flex gap-2">
      <label for="assistant-input" class="sr-only">Type your message</label>
      <input
        type="text"
        id="assistant-input"
        class="flex-1 px-4 py-2 bg-neutral-100 dark:bg-neutral-700 border-0 rounded-full text-sm focus:ring-2 focus:ring-primary-500 dark:text-white"
        placeholder="Ask about programs..."
        autocomplete="off"
      />
      <button
        type="submit"
        id="assistant-send"
        class="w-10 h-10 bg-primary-600 hover:bg-primary-700 disabled:bg-neutral-400 text-white rounded-full flex items-center justify-center transition-colors"
        aria-label="Send message"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </button>
    </form>
    <p class="text-xs text-neutral-600 dark:text-neutral-300 mt-2 text-center">
      AI responses are suggestions only. Verify program details.
    </p>
  </div>
</div>

<script is:inline src="/assets/js/carl-storage.js"></script>
<script
  define:vars={{
    effectiveEndpoint,
    torEndpoint,
    apiKey,
    modelName,
    SYSTEM_PROMPT,
    libraryData,
    publicServicesData,
  }}
>
  // DOM Elements
  const toggle = document.getElementById('assistant-toggle');
  const panel = document.getElementById('assistant-panel');
  const closeBtn = document.getElementById('assistant-close');
  const form = document.getElementById('assistant-form');
  const input = document.getElementById('assistant-input');
  const sendBtn = document.getElementById('assistant-send');
  const messagesContainer = document.getElementById('assistant-messages');
  const notificationDot = document.getElementById('assistant-dot');
  const historyBtn = document.getElementById('assistant-history-btn');
  const historyPanel = document.getElementById('assistant-history-panel');
  const historyBackBtn = document.getElementById('history-back-btn');
  const historyList = document.getElementById('history-list');
  const clearHistoryBtn = document.getElementById('clear-history-btn');
  const newChatBtn = document.getElementById('assistant-new-chat');
  const cloudIcon = document.getElementById('carl-cloud-icon');
  const fullscreenBtn = document.getElementById('assistant-fullscreen');
  const fullscreenExpandIcon = document.getElementById('fullscreen-expand-icon');
  const fullscreenCollapseIcon = document.getElementById('fullscreen-collapse-icon');
  let isFullscreen = false;

  // Carl emotive state management
  function setCarlState(state) {
    if (!cloudIcon) return;
    // Remove all state classes
    cloudIcon.classList.remove(
      'carl-cloud--idle',
      'carl-cloud--thinking',
      'carl-cloud--responding',
      'carl-cloud--error',
      'carl-cloud--happy'
    );
    // Add new state class
    cloudIcon.classList.add(`carl-cloud--${state}`);
  }

  // Tor Browser detection and endpoint selection
  // Tor Browser has specific characteristics we can detect
  const isTorBrowser = (() => {
    // Check if accessing via .onion domain
    if (window.location.hostname.endsWith('.onion')) return true;
    // Check for Tor Browser fingerprint (disabled features)
    try {
      // Tor Browser disables certain APIs for privacy
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      if (!ctx) return false;
      ctx.fillText('test', 0, 0);
      // Tor Browser returns consistent canvas data
      const data = canvas.toDataURL();
      // Additional check: Tor Browser has specific screen dimensions
      if (window.screen.width === 1000 && window.screen.height === 900) return true;
    } catch {
      // Canvas blocked = likely Tor
      return true;
    }
    return false;
  })();

  // Use Tor endpoint if detected, otherwise use configured endpoint
  const activeEndpoint = isTorBrowser && torEndpoint ? torEndpoint : effectiveEndpoint;
  // No API key needed for Tor (direct Ollama access)
  const activeApiKey = isTorBrowser ? '' : apiKey;

  // Language/locale detection - read from site's i18n setting
  const I18N_STORAGE_KEY = 'baynavigator_locale';
  const LANGUAGE_NAMES = {
    en: 'English',
    es: 'Spanish',
    'zh-Hans': 'Simplified Chinese',
    'zh-Hant': 'Traditional Chinese',
    vi: 'Vietnamese',
    fil: 'Filipino/Tagalog',
    ko: 'Korean',
    ru: 'Russian',
    fr: 'French',
    ar: 'Arabic',
  };

  function getCurrentLanguage() {
    try {
      return localStorage.getItem(I18N_STORAGE_KEY) || 'en';
    } catch {
      return 'en';
    }
  }

  let currentLocale = getCurrentLanguage();

  // Listen for language changes from the i18n system
  window.addEventListener('locale-changed', (e) => {
    const customEvent = e;
    if (customEvent.detail?.locale) {
      currentLocale = customEvent.detail.locale;
    }
  });

  // State
  let conversationHistory = [];
  let isLoading = false;
  let programsCache = null;
  let cityContactsCache = null;
  let municipalCodesCache = null;
  let californiaCodesCache = null;
  let californiaResourcesCache = null;
  let locationDataCache = null;
  let programsGeoCache = null; // GeoJSON with program coordinates
  let userLocation = null;
  let userProfile = null; // From preferences (groups, county)
  let currentConversationId = null; // For history tracking
  let historyEnabled = false; // Will be set from CarlStorage
  let shownProgramIds = new Set(); // Track programs already shown in this conversation

  // Load location data (ZIP codes, cities, neighborhoods) for location parsing
  async function loadLocationData() {
    if (locationDataCache) return locationDataCache;
    try {
      const response = await fetch('/api/location-data.json');
      if (response.ok) {
        locationDataCache = await response.json();
        return locationDataCache;
      }
    } catch (e) {
      console.error('Failed to load location data:', e);
    }
    // Return minimal fallback
    return { zipToCity: {}, cityToCounty: {}, neighborhoodAliases: {} };
  }

  // Initialize location data on page load
  loadLocationData();

  // Load programs GeoJSON for distance calculations
  async function loadProgramsGeo() {
    if (programsGeoCache) return programsGeoCache;
    try {
      const response = await fetch('/api/programs.geojson');
      if (response.ok) {
        const geojson = await response.json();
        // Build a map of program ID -> coordinates for fast lookup
        const coordMap = {};
        for (const feature of geojson.features || []) {
          const id = feature.properties?.id;
          const coords = feature.geometry?.coordinates;
          if (id && coords && coords.length === 2) {
            // GeoJSON is [lng, lat], store as { lat, lng }
            coordMap[id] = { lat: coords[1], lng: coords[0] };
          }
        }
        programsGeoCache = coordMap;
        return programsGeoCache;
      }
    } catch (e) {
      console.error('Failed to load programs GeoJSON:', e);
    }
    return {};
  }

  // Haversine formula to calculate distance between two points in miles
  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 3959; // Earth's radius in miles
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLng = ((lng2 - lng1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLng / 2) *
        Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // City center coordinates for distance calculations (approximate)
  const cityCoordinates = {
    // San Mateo County
    atherton: { lat: 37.4613, lng: -122.1979 },
    belmont: { lat: 37.5202, lng: -122.2758 },
    brisbane: { lat: 37.6808, lng: -122.3999 },
    burlingame: { lat: 37.5841, lng: -122.3661 },
    colma: { lat: 37.6769, lng: -122.455 },
    'daly city': { lat: 37.6879, lng: -122.4702 },
    'east palo alto': { lat: 37.4689, lng: -122.1411 },
    'foster city': { lat: 37.5585, lng: -122.2711 },
    'half moon bay': { lat: 37.4636, lng: -122.4286 },
    hillsborough: { lat: 37.5741, lng: -122.3794 },
    'menlo park': { lat: 37.453, lng: -122.1817 },
    millbrae: { lat: 37.5985, lng: -122.3872 },
    pacifica: { lat: 37.6138, lng: -122.4869 },
    'portola valley': { lat: 37.3841, lng: -122.2352 },
    'redwood city': { lat: 37.4852, lng: -122.2364 },
    'san bruno': { lat: 37.6305, lng: -122.4111 },
    'san carlos': { lat: 37.5072, lng: -122.2608 },
    'san mateo': { lat: 37.563, lng: -122.3255 },
    'south san francisco': { lat: 37.6547, lng: -122.4077 },
    woodside: { lat: 37.4299, lng: -122.2539 },
    // San Francisco
    'san francisco': { lat: 37.7749, lng: -122.4194 },
    // Alameda County
    oakland: { lat: 37.8044, lng: -122.2712 },
    berkeley: { lat: 37.8716, lng: -122.2727 },
    fremont: { lat: 37.5485, lng: -121.9886 },
    hayward: { lat: 37.6688, lng: -122.0808 },
    alameda: { lat: 37.7652, lng: -122.2416 },
    'san leandro': { lat: 37.7249, lng: -122.1561 },
    livermore: { lat: 37.6819, lng: -121.768 },
    pleasanton: { lat: 37.6624, lng: -121.8747 },
    'union city': { lat: 37.5934, lng: -122.0439 },
    newark: { lat: 37.5297, lng: -122.0402 },
    dublin: { lat: 37.7022, lng: -121.9358 },
    emeryville: { lat: 37.8313, lng: -122.2852 },
    // Santa Clara County
    'san jose': { lat: 37.3382, lng: -121.8863 },
    sunnyvale: { lat: 37.3688, lng: -122.0363 },
    'santa clara': { lat: 37.3541, lng: -121.9552 },
    'mountain view': { lat: 37.3861, lng: -122.0839 },
    'palo alto': { lat: 37.4419, lng: -122.143 },
    milpitas: { lat: 37.4323, lng: -121.8996 },
    cupertino: { lat: 37.323, lng: -122.0322 },
    campbell: { lat: 37.2872, lng: -121.95 },
    'los gatos': { lat: 37.2358, lng: -121.9624 },
    saratoga: { lat: 37.2638, lng: -122.023 },
    'los altos': { lat: 37.3852, lng: -122.1141 },
    // Contra Costa County
    concord: { lat: 37.978, lng: -122.0311 },
    'walnut creek': { lat: 37.9101, lng: -122.0652 },
    richmond: { lat: 37.9358, lng: -122.3477 },
    antioch: { lat: 38.0049, lng: -121.8058 },
    pittsburg: { lat: 38.028, lng: -121.8847 },
    'san ramon': { lat: 37.7799, lng: -121.978 },
    brentwood: { lat: 37.9317, lng: -121.6958 },
    danville: { lat: 37.8216, lng: -121.9999 },
    martinez: { lat: 38.0194, lng: -122.1341 },
    // Marin County
    'san rafael': { lat: 37.9735, lng: -122.5311 },
    novato: { lat: 38.1074, lng: -122.5697 },
    'mill valley': { lat: 37.906, lng: -122.5449 },
    sausalito: { lat: 37.8591, lng: -122.4852 },
    larkspur: { lat: 37.9341, lng: -122.535 },
    // Solano County
    vallejo: { lat: 38.1041, lng: -122.2566 },
    fairfield: { lat: 38.2494, lng: -122.04 },
    vacaville: { lat: 38.3566, lng: -121.9877 },
    benicia: { lat: 38.0494, lng: -122.158 },
    'suisun city': { lat: 38.2383, lng: -122.04 },
    // Sonoma County
    'santa rosa': { lat: 38.4404, lng: -122.7141 },
    petaluma: { lat: 38.2324, lng: -122.6367 },
    'rohnert park': { lat: 38.3396, lng: -122.7011 },
    windsor: { lat: 38.5469, lng: -122.8166 },
    healdsburg: { lat: 38.6105, lng: -122.8694 },
    // Napa County
    napa: { lat: 38.2975, lng: -122.2869 },
    'american canyon': { lat: 38.1749, lng: -122.2608 },
    'st. helena': { lat: 38.5052, lng: -122.4702 },
    calistoga: { lat: 38.5788, lng: -122.5797 },
  };

  // Get user coordinates from location (ZIP, city, or browser geolocation)
  async function getUserCoordinates(location) {
    // First priority: exact coordinates from browser geolocation
    if (location?.lat && location?.lng) {
      return { lat: location.lat, lng: location.lng };
    }

    // Second priority: ZIP code coordinates (most accurate for user-provided location)
    if (location?.zip) {
      const locationData = await loadLocationData();
      const zipCoords = locationData.zipCoordinates?.[location.zip];
      if (zipCoords) {
        return zipCoords;
      }
    }

    // Third priority: city center coordinates
    if (location?.city) {
      const cityLower = location.city.toLowerCase();
      return cityCoordinates[cityLower] || null;
    }

    return null;
  }

  // Store browser geolocation if user granted permission
  let browserGeolocation = null;

  // Try to get cached geolocation (from previous permission grant)
  function tryGetCachedGeolocation() {
    if (!navigator.geolocation) return;

    // Check if we already have permission (won't prompt)
    if (navigator.permissions) {
      navigator.permissions.query({ name: 'geolocation' }).then((result) => {
        if (result.state === 'granted') {
          // Permission already granted, get location without prompting
          navigator.geolocation.getCurrentPosition(
            (position) => {
              browserGeolocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
            },
            () => {
              // Silently fail - user may have blocked
            },
            { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 }
          );
        }
      });
    }
  }

  // Initialize geolocation check on load
  tryGetCachedGeolocation();

  // County to major city mapping (for user-friendly display)
  // Users see cities, counties are internal for program filtering only
  const countyToCity = {
    alameda: 'Oakland',
    'contra costa': 'Concord',
    marin: 'San Rafael',
    napa: 'Napa',
    'san francisco': 'San Francisco',
    'san mateo': 'San Mateo',
    'santa clara': 'San Jose',
    solano: 'Vallejo',
    sonoma: 'Santa Rosa',
  };

  // Load user profile from Preferences (privacy-respecting: stays local)
  function loadUserProfile() {
    try {
      // Check if Preferences API is available
      if (typeof window.Preferences !== 'undefined' && window.Preferences.get) {
        const prefs = window.Preferences.get();
        if (prefs && (prefs.groups?.length > 0 || prefs.county)) {
          const county = prefs.county || null;
          // Map county to a friendly city name for user-facing display
          // County is stored internally only for program filtering
          const city = county ? countyToCity[county.toLowerCase()] || null : null;
          userProfile = {
            groups: prefs.groups || [],
            county: county, // Internal use only - for filtering programs
            city: city, // User-facing - what Carl says
          };
          // Set initial location from preferences (city for display, county for filtering)
          if (city && !userLocation) {
            userLocation = { city: city, county: county };
          }
          return userProfile;
        }
      }
    } catch (e) {
      console.warn('Could not load user preferences:', e);
    }
    return null;
  }

  // Detect if running in app - check multiple signals for robust detection
  const isApp = (() => {
    // Check user agent (set by native apps)
    if (navigator.userAgent.includes('BayNavigator')) return true;
    // Check if loaded in localhost (development or app WebView)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
      return true;
    // Check referrer from deep link
    if (document.referrer.includes('baynavigator://')) return true;
    // Check if window.webkit exists (iOS WKWebView)
    if (window.webkit?.messageHandlers?.baynavigator) return true;
    // Check for Flutter/Capacitor bridge
    if (window.flutter_inappwebview || window.Capacitor) return true;
    return false;
  })();

  // Crisis detection keywords
  const EMERGENCY_KEYWORDS = [
    'emergency',
    'danger',
    'hurt',
    'attack',
    'abuse',
    'violence',
    'domestic violence',
    'unsafe',
    'threatened',
  ];
  const MENTAL_HEALTH_KEYWORDS = [
    'suicide',
    'suicidal',
    'kill myself',
    'end my life',
    "don't want to live",
    'want to die',
    'self-harm',
    'crisis',
  ];

  // ============================================
  // LIVE DATA APIs - Transit, Traffic, etc.
  // ============================================

  // Transit agency names for natural language
  const TRANSIT_AGENCIES = {
    BA: 'BART',
    CT: 'Caltrain',
    SF: 'Muni',
    AC: 'AC Transit',
    SC: 'VTA',
    SM: 'SamTrans',
    GG: 'Golden Gate Transit',
    SA: 'SMART',
    GF: 'Golden Gate Ferry',
    SB: 'SF Bay Ferry',
    CC: 'County Connection',
    WH: 'Wheels',
    MA: 'Marin Transit',
    '3D': 'Tri Delta Transit',
    WC: 'WestCAT',
    CE: 'ACE Rail',
    AM: 'Capitol Corridor',
  };

  // Keywords that trigger live transit data lookup
  const TRANSIT_KEYWORDS = [
    'bart',
    'caltrain',
    'muni',
    'bus',
    'train',
    'transit',
    'delay',
    'delayed',
    'late',
    'running',
    'service',
    'alert',
    'vta',
    'samtrans',
    'ac transit',
    'ferry',
    'smart train',
    'commute',
    'station',
    'schedule',
  ];

  // Keywords that trigger traffic data lookup
  const TRAFFIC_KEYWORDS = [
    'traffic',
    'accident',
    'crash',
    'closure',
    'closed',
    'road',
    'highway',
    'freeway',
    'bridge',
    'i-80',
    'i-280',
    'i-580',
    'i-880',
    'i-680',
    '101',
    '280',
    'bay bridge',
    'golden gate',
    'san mateo bridge',
    'dumbarton',
    'richmond bridge',
  ];

  // Keywords that trigger library digital resources lookup
  const LIBRARY_KEYWORDS = [
    'library',
    'libraries',
    'ebook',
    'audiobook',
    'free books',
    'digital books',
    'libby',
    'hoopla',
    'kanopy',
    'streaming movies',
    'free movies',
    'linkedin learning',
    'free courses',
    'online learning',
    'language learning',
    'mango languages',
    'tutoring',
    'homework help',
    'museum pass',
    'discover and go',
    'library card',
    'learn to code',
    'coding classes',
    'rosetta stone',
    'ancestry',
    'genealogy',
    'free wifi',
    'internet access',
  ];

  // Keywords that trigger community facilities lookup
  const FACILITIES_KEYWORDS = [
    'community center',
    'rec center',
    'recreation center',
    'senior center',
    'public pool',
    'swimming pool',
    'gym',
    'fitness center',
    'city facility',
    'public facility',
    'community space',
    'meeting room',
    'playground',
    'park',
  ];

  // Keywords that trigger food truck data lookup
  const FOOD_TRUCK_KEYWORDS = [
    'food truck',
    'food cart',
    'street food',
    'cheap food',
    'affordable food',
    'food vendor',
    'mobile food',
    'lunch truck',
  ];

  // Keywords for 211/community resources
  const COMMUNITY_RESOURCE_KEYWORDS = [
    'food pantry',
    'food bank',
    'free food',
    'free meals',
    'soup kitchen',
    'hot meals',
    'clothing',
    'free clothes',
    'shelter',
    'homeless services',
    'emergency assistance',
    'community resources',
    '211',
    'help near me',
    'where can i get',
  ];

  // Keywords for public services (police, fire, hospitals)
  const PUBLIC_SERVICES_KEYWORDS = [
    'police station',
    'police department',
    'sheriff',
    'fire station',
    'fire department',
    'hospital',
    'emergency room',
    'er',
    'urgent care',
    'medical center',
    'library branch',
    'nearest library',
    'closest hospital',
    'report crime',
    'file report',
  ];

  // Detect if query is about transit
  function isTransitQuery(text) {
    const lower = text.toLowerCase();
    return TRANSIT_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect if query is about traffic
  function isTrafficQuery(text) {
    const lower = text.toLowerCase();
    return TRAFFIC_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect if query is about library resources
  function isLibraryQuery(text) {
    const lower = text.toLowerCase();
    return LIBRARY_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect if query is about community facilities
  function isFacilitiesQuery(text) {
    const lower = text.toLowerCase();
    return FACILITIES_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect if query is about food trucks
  function isFoodTruckQuery(text) {
    const lower = text.toLowerCase();
    return FOOD_TRUCK_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect if query is about community resources (211/food pantries/etc)
  function isCommunityResourceQuery(text) {
    const lower = text.toLowerCase();
    return COMMUNITY_RESOURCE_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect if query is about public services (police, fire, hospitals)
  function isPublicServicesQuery(text) {
    const lower = text.toLowerCase();
    return PUBLIC_SERVICES_KEYWORDS.some((kw) => lower.includes(kw));
  }

  // Detect specific transit agency from query
  function detectTransitAgency(text) {
    const lower = text.toLowerCase();
    if (lower.includes('bart')) return 'BA';
    if (lower.includes('caltrain')) return 'CT';
    if (lower.includes('muni')) return 'SF';
    if (lower.includes('vta')) return 'SC';
    if (lower.includes('samtrans')) return 'SM';
    if (lower.includes('ac transit') || lower.includes('actransit')) return 'AC';
    if (lower.includes('golden gate ferry')) return 'GF';
    if (lower.includes('golden gate') && !lower.includes('bridge')) return 'GG';
    if (lower.includes('sf bay ferry') || lower.includes('bay ferry')) return 'SB';
    if (lower.includes('smart train') || lower.includes('smart rail')) return 'SA';
    if (lower.includes('ace') && lower.includes('train')) return 'CE';
    if (lower.includes('capitol corridor')) return 'AM';
    if (lower.includes('county connection')) return 'CC';
    if (lower.includes('wheels') && lower.includes('bus')) return 'WH';
    if (lower.includes('marin transit')) return 'MA';
    if (lower.includes('tri delta') || lower.includes('tridelta')) return '3D';
    if (lower.includes('westcat')) return 'WC';
    return null; // No specific agency, get all alerts
  }

  // Fetch live transit alerts from 511.org via Azure Function
  let transitAlertsCache = null;
  let transitAlertsCacheTime = 0;
  const TRANSIT_CACHE_TTL = 2 * 60 * 1000; // 2 minutes

  async function fetchTransitAlerts(agencyFilter = null) {
    try {
      // Check cache first
      const now = Date.now();
      if (transitAlertsCache && now - transitAlertsCacheTime < TRANSIT_CACHE_TTL) {
        const alerts = agencyFilter
          ? transitAlertsCache.filter((a) => a.agencyId === agencyFilter)
          : transitAlertsCache;
        return alerts;
      }

      const response = await fetch(
        'https://baytides-integrity.azurewebsites.net/api/transit-alerts',
        {
          signal: AbortSignal.timeout(5000), // 5 second timeout
        }
      );

      if (!response.ok) {
        console.warn('Transit alerts API returned', response.status);
        return [];
      }

      const data = await response.json();
      transitAlertsCache = data.alerts || [];
      transitAlertsCacheTime = now;

      // Filter by agency if specified
      if (agencyFilter) {
        return transitAlertsCache.filter((a) => a.agencyId === agencyFilter);
      }
      return transitAlertsCache;
    } catch (error) {
      console.warn('Failed to fetch transit alerts:', error);
      return [];
    }
  }

  // Fetch traffic events/incidents
  let trafficEventsCache = null;
  let trafficEventsCacheTime = 0;
  const TRAFFIC_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

  async function fetchTrafficEvents() {
    try {
      // Check cache first
      const now = Date.now();
      if (trafficEventsCache && now - trafficEventsCacheTime < TRAFFIC_CACHE_TTL) {
        return trafficEventsCache;
      }

      const response = await fetch('/api/traffic-events.json', {
        signal: AbortSignal.timeout(5000),
      });

      if (!response.ok) {
        console.warn('Traffic events API returned', response.status);
        return [];
      }

      const data = await response.json();
      trafficEventsCache = data.features || [];
      trafficEventsCacheTime = now;
      return trafficEventsCache;
    } catch (error) {
      console.warn('Failed to fetch traffic events:', error);
      return [];
    }
  }

  // ============================================
  // SF CITY FACILITIES API (DataSF/Socrata)
  // ============================================
  let sfFacilitiesCache = null;
  let sfFacilitiesCacheTime = 0;
  const SF_FACILITIES_CACHE_TTL = 60 * 60 * 1000; // 1 hour

  async function fetchSFCityFacilities(facilityType = null) {
    try {
      const now = Date.now();
      if (sfFacilitiesCache && now - sfFacilitiesCacheTime < SF_FACILITIES_CACHE_TTL) {
        return filterFacilities(sfFacilitiesCache, facilityType);
      }

      // SF City Facilities API endpoint
      const response = await fetch('https://data.sfgov.org/resource/nc68-ngbr.json?$limit=200', {
        signal: AbortSignal.timeout(8000),
      });

      if (!response.ok) {
        console.warn('SF Facilities API returned', response.status);
        return [];
      }

      sfFacilitiesCache = await response.json();
      sfFacilitiesCacheTime = now;
      return filterFacilities(sfFacilitiesCache, facilityType);
    } catch (error) {
      console.warn('Failed to fetch SF facilities:', error);
      return [];
    }
  }

  function filterFacilities(facilities, type) {
    if (!type) return facilities.slice(0, 10);
    const lower = type.toLowerCase();
    return facilities
      .filter((f) => {
        const name = (f.common_name || '').toLowerCase();
        const dept = (f.dept || '').toLowerCase();
        return name.includes(lower) || dept.includes(lower);
      })
      .slice(0, 10);
  }

  function formatFacilitiesForContext(facilities) {
    if (!facilities || facilities.length === 0) {
      return '';
    }

    let context = '\n\n[SF CITY FACILITIES - LIVE DATA]:\n';
    context += 'Public facilities the user can visit:\n\n';

    facilities.slice(0, 6).forEach((f) => {
      context += `- **${f.common_name || f.owned_leased}**`;
      if (f.address) context += ` - ${f.address}`;
      if (f.dept) context += ` (${f.dept})`;
      context += '\n';
    });

    context += '\nMention relevant facilities by name. These are free public spaces.';
    return context;
  }

  // ============================================
  // SF FOOD TRUCKS API (DataSF/Socrata)
  // ============================================
  let foodTrucksCache = null;
  let foodTrucksCacheTime = 0;
  const FOOD_TRUCKS_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours (permits don't change often)

  async function fetchFoodTrucks(location = null) {
    try {
      const now = Date.now();
      if (foodTrucksCache && now - foodTrucksCacheTime < FOOD_TRUCKS_CACHE_TTL) {
        return filterFoodTrucks(foodTrucksCache, location);
      }

      // SF Mobile Food Facility Permits API
      const response = await fetch(
        'https://data.sfgov.org/resource/rqzj-sfat.json?status=APPROVED&$limit=300',
        { signal: AbortSignal.timeout(8000) }
      );

      if (!response.ok) {
        console.warn('Food Trucks API returned', response.status);
        return [];
      }

      foodTrucksCache = await response.json();
      foodTrucksCacheTime = now;
      return filterFoodTrucks(foodTrucksCache, location);
    } catch (error) {
      console.warn('Failed to fetch food trucks:', error);
      return [];
    }
  }

  function filterFoodTrucks(trucks, location) {
    if (!location) return trucks.slice(0, 12);
    const lower = location.toLowerCase();
    // Filter by location description or address
    const filtered = trucks.filter((t) => {
      const loc = (t.locationdescription || '').toLowerCase();
      const addr = (t.address || '').toLowerCase();
      return loc.includes(lower) || addr.includes(lower);
    });
    return filtered.length > 0 ? filtered.slice(0, 12) : trucks.slice(0, 12);
  }

  function formatFoodTrucksForContext(trucks) {
    if (!trucks || trucks.length === 0) {
      return '';
    }

    let context = '\n\n[SF FOOD TRUCKS - LIVE DATA]:\n';
    context += 'Active food vendors in San Francisco:\n\n';

    trucks.slice(0, 8).forEach((t) => {
      context += `- **${t.applicant}**`;
      if (t.fooditems) context += `: ${t.fooditems.substring(0, 80)}`;
      if (t.locationdescription) context += ` (${t.locationdescription})`;
      context += '\n';
    });

    context +=
      '\nThese are permitted food vendors. Food trucks often have affordable options. Note: Data is for SF only.';
    return context;
  }

  // ============================================
  // LIBRARY DIGITAL RESOURCES (from static JSON)
  // ============================================
  function getLibraryResourcesForContext(query, county = null) {
    if (!libraryData) return '';

    const lower = query.toLowerCase();
    let context = '\n\n[FREE LIBRARY DIGITAL RESOURCES]:\n';
    context += 'These are FREE with a library card (also free to get):\n\n';

    // Check for specific resource category queries
    const categories = libraryData.resourcesByCategory || {};
    let matchedResources = [];

    // Match query to categories
    if (lower.includes('movie') || lower.includes('film') || lower.includes('streaming')) {
      matchedResources = categories['Movie & TV Streaming'] || [];
      context += '**Free Movies & TV:**\n';
    } else if (lower.includes('music')) {
      matchedResources = categories['Music Streaming'] || [];
      context += '**Free Music:**\n';
    } else if (lower.includes('learn') || lower.includes('course') || lower.includes('class')) {
      matchedResources = categories['Online Learning'] || [];
      context += '**Free Online Learning:**\n';
    } else if (lower.includes('language')) {
      matchedResources = categories['Language Learning'] || [];
      context += '**Free Language Learning:**\n';
    } else if (lower.includes('tutor') || lower.includes('homework')) {
      matchedResources = categories['Tutoring & Homework Help'] || [];
      context += '**Free Tutoring:**\n';
    } else if (lower.includes('job') || lower.includes('career') || lower.includes('resume')) {
      matchedResources = categories['Career & Job Search'] || [];
      context += '**Free Career Help:**\n';
    } else if (lower.includes('kid') || lower.includes('child') || lower.includes('abcmouse')) {
      matchedResources = categories['Kids & Early Learning'] || [];
      context += '**Free Kids Learning:**\n';
    } else if (lower.includes('museum') || lower.includes('zoo') || lower.includes('pass')) {
      matchedResources = categories['Museum & Cultural Passes'] || [];
      context += '**Free Museum Passes:**\n';
    } else if (lower.includes('code') || lower.includes('programming') || lower.includes('tech')) {
      matchedResources = [
        "O'Reilly for Public Libraries",
        'Treehouse',
        'CodeCombat',
        'LinkedIn Learning',
      ];
      context += '**Free Coding & Tech Learning:**\n';
    } else {
      // General library query - show popular resources
      const common = libraryData.commonResources?.resources || [];
      common.slice(0, 6).forEach((r) => {
        context += `- **${r.name}**: ${r.description}\n`;
      });
      context += '\nThese work at MOST Bay Area libraries. Just need a library card (free)!';
      context +=
        '\n\nTo get a library card: Visit any branch with ID showing your address, or apply online at your county library website.';
      return context;
    }

    // Format matched resources
    if (matchedResources.length > 0) {
      matchedResources.slice(0, 5).forEach((r) => {
        if (typeof r === 'string') {
          context += `- ${r}\n`;
        } else {
          context += `- **${r.name}**: ${r.description || ''}\n`;
        }
      });
    }

    // Add library card info
    context +=
      '\n**How to access:** Get a FREE library card at any branch (just need ID with address) or apply online.';

    // Add county-specific library if known
    if (county) {
      const countyLibraries = {
        'san francisco': 'sfpl.org',
        alameda: 'aclibrary.org',
        'contra costa': 'ccclib.org',
        'san mateo': 'smcl.org',
        'santa clara': 'sccld.org or sjpl.org',
        marin: 'marinlibrary.org',
        sonoma: 'sonomalibrary.org',
        solano: 'solanolibrary.com',
        napa: 'countyofnapa.org/library',
      };
      const libSite = countyLibraries[county.toLowerCase()];
      if (libSite) {
        context += `\nYour library: **${libSite}**`;
      }
    }

    return context;
  }

  // ============================================
  // 211 BAY AREA / COMMUNITY RESOURCES
  // ============================================
  function getCommunityResourcesContext(query) {
    const lower = query.toLowerCase();
    let context = '\n\n[COMMUNITY RESOURCES - 211 BAY AREA]:\n';

    // Food resources
    if (
      lower.includes('food') ||
      lower.includes('pantry') ||
      lower.includes('hungry') ||
      lower.includes('meal')
    ) {
      context += '**Food Resources (call 211 for nearest locations):**\n';
      context += '- **SF-Marin Food Bank**: Serves 140,000+ weekly. Call 415-282-1900\n';
      context +=
        '- **Second Harvest of Silicon Valley**: Free groceries, no ID needed. 1-800-984-3663\n';
      context += '- **Alameda County Community Food Bank**: 510-635-3663\n';
      context += '- **Project Open Hand**: Delivers meals to seniors/disabled. 415-447-2300\n';
      context += '- **Glide**: Free meals daily in SF Tenderloin. 330 Ellis St\n';
      context +=
        '\n**For nearest location:** Call **211** (free, 24/7) or visit **211bayarea.org**\n';
    }
    // Shelter/housing
    else if (lower.includes('shelter') || lower.includes('homeless') || lower.includes('sleep')) {
      context += '**Emergency Shelter Resources:**\n';
      context += '- **SF**: Call 311 for shelter availability or visit sf.gov/shelter\n';
      context += '- **Oakland/Alameda**: Call 211 for shelter referrals\n';
      context += '- **San Jose**: Call 408-510-7600 (Homelessness Prevention)\n';
      context += '- **BACS (Bay Area Community Services)**: 510-613-0330\n';
      context += '\n**For immediate help:** Call **211** (free, 24/7)\n';
    }
    // General 211 info
    else {
      context += '**211 Bay Area** connects people to essential services:\n';
      context += '- Food assistance and pantries\n';
      context += '- Emergency shelter and housing help\n';
      context += '- Utility assistance (PG&E, water)\n';
      context += '- Healthcare and mental health\n';
      context += '- Job training and childcare\n';
      context +=
        '\n**Call 211** (free, 24/7) or visit **211bayarea.org** to find resources near you.\n';
    }

    return context;
  }

  // Format transit alerts for Carl's context
  function formatTransitAlertsForContext(alerts, agencyFilter = null) {
    if (!alerts || alerts.length === 0) {
      if (agencyFilter) {
        const agencyName = TRANSIT_AGENCIES[agencyFilter] || agencyFilter;
        return `\n\n[LIVE TRANSIT DATA]: Good news! ${agencyName} has no active service alerts right now. Service is running normally.`;
      }
      return '\n\n[LIVE TRANSIT DATA]: All Bay Area transit systems are running normally. No active service alerts.';
    }

    let context = '\n\n[LIVE TRANSIT DATA - CURRENT ALERTS]:\n';
    context += 'Here are the active service alerts you should mention:\n\n';

    // Group by agency for cleaner display
    const byAgency = {};
    alerts.slice(0, 8).forEach((alert) => {
      const agency = alert.agency || TRANSIT_AGENCIES[alert.agencyId] || 'Unknown';
      if (!byAgency[agency]) byAgency[agency] = [];
      byAgency[agency].push(alert);
    });

    for (const [agency, agencyAlerts] of Object.entries(byAgency)) {
      context += `**${agency}**:\n`;
      agencyAlerts.forEach((alert) => {
        context += `  - ${alert.title}`;
        if (alert.timeAgo) context += ` (${alert.timeAgo})`;
        context += '\n';
      });
      context += '\n';
    }

    context +=
      'IMPORTANT: Share this information naturally in your response. Direct users to baynavigator.org/transit for live updates.';
    return context;
  }

  // Format traffic events for Carl's context
  function formatTrafficForContext(events, query = '') {
    if (!events || events.length === 0) {
      return '\n\n[LIVE TRAFFIC DATA]: No major traffic incidents reported right now. Roads are generally clear.';
    }

    // Filter for active events and prioritize by type
    const activeEvents = events.filter((e) => e.properties?.status === 'ACTIVE').slice(0, 6);

    if (activeEvents.length === 0) {
      return '\n\n[LIVE TRAFFIC DATA]: No major traffic incidents reported right now.';
    }

    let context = '\n\n[LIVE TRAFFIC DATA - CURRENT INCIDENTS]:\n';
    context += 'Here are current traffic conditions to mention:\n\n';

    activeEvents.forEach((event) => {
      const props = event.properties;
      const type = props.type || 'INCIDENT';
      const headline = props.headline || 'Traffic incident reported';
      context += `- **${type}**: ${headline.substring(0, 150)}\n`;
    });

    context +=
      '\nIMPORTANT: Summarize this naturally. For full details, direct users to 511.org or their navigation app.';
    return context;
  }

  // ============================================
  // PUBLIC SERVICES (Libraries, Police, Fire, Hospitals)
  // ============================================
  function getPublicServicesContext(query, county = null) {
    if (!publicServicesData || !publicServicesData.counties) return '';

    const lower = query.toLowerCase();
    let context = '\n\n[PUBLIC SERVICES DIRECTORY]:\n';

    // Map county names to keys
    const countyKeyMap = {
      'san francisco': 'sanFrancisco',
      alameda: 'alameda',
      'contra costa': 'contraCostaCounty',
      marin: 'marin',
      napa: 'napa',
      'san mateo': 'sanMateo',
      'santa clara': 'santaClara',
      solano: 'solano',
      sonoma: 'sonoma',
    };

    const countyKey = county ? countyKeyMap[county.toLowerCase()] : null;
    const countyData = countyKey ? publicServicesData.counties[countyKey] : null;

    // Hospital query
    if (
      lower.includes('hospital') ||
      lower.includes('emergency room') ||
      lower.includes('er') ||
      lower.includes('medical center')
    ) {
      context += '**Hospitals & Emergency Rooms:**\n';
      if (countyData && countyData.hospitals) {
        countyData.hospitals.slice(0, 5).forEach((h) => {
          context += `- **${h.name}** - ${h.address}`;
          if (h.type) context += ` (${h.type})`;
          context += '\n';
        });
      } else {
        // Show major hospitals from multiple counties
        context += '- **Zuckerberg SF General** - 1001 Potrero Ave, SF (Trauma Center)\n';
        context += '- **Highland Hospital** - 1411 E 31st St, Oakland (County Trauma)\n';
        context += '- **Valley Medical Center** - 751 S Bascom Ave, San Jose (Trauma)\n';
        context += '- **John Muir Walnut Creek** - 1601 Ygnacio Valley Rd (Trauma)\n';
      }
      context += '\n**Emergency?** Call **911**\n';
    }
    // Police query
    else if (
      lower.includes('police') ||
      lower.includes('sheriff') ||
      lower.includes('report') ||
      lower.includes('crime')
    ) {
      context += '**Police Stations:**\n';
      if (countyData && countyData.police) {
        if (countyData.police.sheriff) {
          context += `- **${countyData.police.sheriff.name}** - ${countyData.police.sheriff.headquarters}\n`;
        }
        if (countyData.police.stations) {
          countyData.police.stations.slice(0, 4).forEach((s) => {
            context += `- **${s.name}** - ${s.address}\n`;
          });
        } else if (countyData.police.majorCities) {
          countyData.police.majorCities.slice(0, 4).forEach((c) => {
            context += `- **${c.city} PD** - ${c.address}\n`;
          });
        }
      }
      context += '\n**Emergency?** Call **911**. Non-emergency: call local station or 311 in SF.\n';
    }
    // Fire station query
    else if (lower.includes('fire station') || lower.includes('fire department')) {
      context += '**Fire Departments:**\n';
      if (countyData && countyData.fire) {
        context += `- **${countyData.fire.department}**`;
        if (countyData.fire.headquarters) context += ` - HQ: ${countyData.fire.headquarters}`;
        if (countyData.fire.stationCount) context += ` (${countyData.fire.stationCount} stations)`;
        context += '\n';
      }
      context += '\n**Fire Emergency?** Call **911**\n';
    }
    // Library branch query
    else if (lower.includes('library')) {
      context += '**Library Branches:**\n';
      if (countyData && countyData.libraries) {
        if (countyData.libraries.system) {
          context += `**${countyData.libraries.system}** - ${countyData.libraries.website || ''}\n`;
        }
        if (countyData.libraries.branches) {
          countyData.libraries.branches.slice(0, 5).forEach((b) => {
            context += `- ${b.name} - ${b.address}\n`;
          });
        } else if (countyData.libraries.systems) {
          countyData.libraries.systems.slice(0, 2).forEach((sys) => {
            context += `**${sys.name}** - ${sys.website || ''}\n`;
            if (sys.branches) {
              sys.branches.slice(0, 3).forEach((b) => {
                context += `  - ${b.name} - ${b.address}\n`;
              });
            }
          });
        }
      }
      context += '\nLibrary cards are FREE! Just bring ID with your address.\n';
    }

    return context;
  }

  // Location parsing (uses fetched location data)
  async function parseLocation(text) {
    const locationData = await loadLocationData();
    const lowerText = text.toLowerCase();

    // Check for ZIP code (5 digits)
    const zipMatch = text.match(/\b(\d{5})\b/);
    if (zipMatch) {
      const zip = zipMatch[1];
      const city = locationData.zipToCity?.[zip];
      if (city) {
        const county = locationData.cityToCounty?.[city.toLowerCase()];
        return { zip, city, county, original: zip };
      }
    }

    // Check for neighborhood aliases
    if (locationData.neighborhoodAliases) {
      for (const [neighborhood, city] of Object.entries(locationData.neighborhoodAliases)) {
        if (lowerText.includes(neighborhood)) {
          const county = locationData.cityToCounty?.[city.toLowerCase()];
          return { city, county, neighborhood, original: neighborhood };
        }
      }
    }

    // Check for city names
    if (locationData.cityToCounty) {
      for (const [cityName, county] of Object.entries(locationData.cityToCounty)) {
        if (lowerText.includes(cityName)) {
          return { city: cityName, county, original: cityName };
        }
      }
    }

    return null;
  }

  // Load programs for RAG search
  async function loadPrograms() {
    if (programsCache) return programsCache;
    try {
      const response = await fetch('/api/programs.json');
      if (response.ok) {
        const data = await response.json();
        // API returns {total, count, offset, programs: [...]}
        programsCache = data.programs || [];
        return programsCache;
      }
    } catch (e) {
      console.error('Failed to load programs:', e);
    }
    return [];
  }

  // Load city contacts for government department lookups
  async function loadCityContacts() {
    if (cityContactsCache) return cityContactsCache;
    try {
      const response = await fetch('/api/city-contacts.json');
      if (response.ok) {
        const data = await response.json();
        cityContactsCache = data.contacts || [];
        return cityContactsCache;
      }
    } catch (e) {
      console.error('Failed to load city contacts:', e);
    }
    return [];
  }

  // Search city contacts when user asks about specific city departments
  async function searchCityContacts(query, location = null) {
    const contacts = await loadCityContacts();
    if (!contacts.length) return null;

    const queryLower = query.toLowerCase();

    // Keywords that suggest user wants government/city contact info
    const cityQueryKeywords = [
      'city hall',
      'city council',
      'mayor',
      'clerk',
      'police',
      'fire department',
      'public works',
      'planning',
      'building',
      'permit',
      'zoning',
      'parks',
      'recreation',
      'library',
      'phone number',
      'contact',
      'email',
      'call',
      'department',
      'office',
      'government',
    ];

    const isCityQuery = cityQueryKeywords.some((kw) => queryLower.includes(kw));
    if (!isCityQuery) return null;

    // Find matching city
    let matchedCity = null;

    // First try to match by city name in query
    for (const city of contacts) {
      if (queryLower.includes(city.name.toLowerCase())) {
        matchedCity = city;
        break;
      }
    }

    // If no city in query but user has location, use that
    if (!matchedCity && location?.city) {
      matchedCity = contacts.find((c) => c.name.toLowerCase() === location.city.toLowerCase());
    }

    if (!matchedCity) return null;

    // Find relevant departments based on query
    const deptKeywords = {
      police: ['Police'],
      fire: ['Fire'],
      parks: ['Parks', 'Recreation'],
      recreation: ['Parks', 'Recreation'],
      planning: ['Planning', 'Building', 'Development'],
      building: ['Planning', 'Building'],
      permit: ['Planning', 'Building'],
      'public works': ['Public Works'],
      library: ['Library'],
      'city hall': ['City Hall', 'General', 'Directory'],
      council: ['City Hall', 'General'],
      clerk: ['City Hall', 'General', 'Clerk'],
      finance: ['Finance'],
      housing: ['Housing'],
      transportation: ['Transportation'],
    };

    let relevantDepts = [];
    for (const [keyword, deptNames] of Object.entries(deptKeywords)) {
      if (queryLower.includes(keyword)) {
        relevantDepts.push(...deptNames);
      }
    }

    // If no specific department, show general/directory
    if (relevantDepts.length === 0) {
      relevantDepts = ['General', 'Directory', 'City Hall'];
    }

    // Filter departments
    const matchedDepts = matchedCity.departments.filter((d) =>
      relevantDepts.some((rd) => d.name.toLowerCase().includes(rd.toLowerCase()))
    );

    // If no specific match, show first few departments
    const deptsToShow =
      matchedDepts.length > 0 ? matchedDepts : matchedCity.departments.slice(0, 3);

    return {
      city: matchedCity.name,
      county: matchedCity.county,
      website: matchedCity.website,
      departments: deptsToShow,
    };
  }

  // Load municipal codes for code/ordinance lookups
  async function loadMunicipalCodes() {
    if (municipalCodesCache) return municipalCodesCache;
    try {
      const response = await fetch('/api/municipal-codes.json');
      if (response.ok) {
        municipalCodesCache = await response.json();
        return municipalCodesCache;
      }
    } catch (e) {
      console.error('Failed to load municipal codes:', e);
    }
    return [];
  }

  // Search for municipal code when user asks about local laws/ordinances
  async function searchMunicipalCode(query, location = null) {
    const data = await loadMunicipalCodes();
    const codes = data?.codes || [];
    if (!codes.length) return null;

    const queryLower = query.toLowerCase();

    // Keywords that suggest user wants municipal code/ordinance info
    const codeQueryKeywords = [
      'code',
      'ordinance',
      'law',
      'regulation',
      'rule',
      'legal',
      'permit',
      'license',
      'zoning',
      'building code',
      'noise',
      'parking',
      'adu',
      'granny unit',
      'accessory dwelling',
      'rental',
      'rent control',
      'tenant',
      'landlord',
      'eviction',
      'business license',
      'home business',
      'food truck',
      'fence',
      'tree',
      'setback',
      'height limit',
      'short-term rental',
      'airbnb',
      'vrbo',
      'pet',
      'dog',
      'chicken',
      'animal',
      'sign',
      'signage',
      'billboard',
      'allowed',
      'prohibited',
      'illegal',
      'legal',
      'how many',
      'can i',
      'am i allowed',
      'is it legal',
    ];

    const isCodeQuery = codeQueryKeywords.some((kw) => queryLower.includes(kw));
    if (!isCodeQuery) return null;

    // Find matching city/county
    let matchedCode = null;

    // First try to match by city/county name in query
    for (const code of codes) {
      const nameLower = code.name.toLowerCase();
      if (
        queryLower.includes(nameLower) ||
        (code.type === 'County' && queryLower.includes(code.county.toLowerCase() + ' county'))
      ) {
        matchedCode = code;
        break;
      }
    }

    // If no city in query but user has location, use that
    if (!matchedCode && location) {
      // Try city first
      if (location.city) {
        matchedCode = codes.find(
          (c) => c.name.toLowerCase() === location.city.toLowerCase() && c.type === 'City'
        );
      }
      // Fall back to county
      if (!matchedCode && location.county) {
        matchedCode = codes.find(
          (c) => c.county.toLowerCase() === location.county.toLowerCase() && c.type === 'County'
        );
      }
    }

    if (!matchedCode) return null;

    // Detect the specific topic being asked about
    const topics = [];
    if (/noise|loud|party|music|quiet hours/i.test(queryLower)) topics.push('noise ordinances');
    if (/parking|rv|vehicle|street parking/i.test(queryLower)) topics.push('parking regulations');
    if (/adu|granny|accessory dwelling|in-law/i.test(queryLower))
      topics.push('ADU/accessory dwelling units');
    if (/rent|tenant|landlord|eviction|lease/i.test(queryLower))
      topics.push('rental/tenant protections');
    if (/business|license|home occupation/i.test(queryLower)) topics.push('business regulations');
    if (/pet|dog|cat|chicken|animal/i.test(queryLower)) topics.push('animal regulations');
    if (/fence|wall|hedge|height/i.test(queryLower)) topics.push('fence/wall height limits');
    if (/tree|removal|protected/i.test(queryLower)) topics.push('tree regulations');
    if (/airbnb|vrbo|short.?term|vacation rental/i.test(queryLower))
      topics.push('short-term rentals');
    if (/sign|signage|billboard/i.test(queryLower)) topics.push('sign regulations');
    if (/building|permit|construction/i.test(queryLower)) topics.push('building permits');
    if (/zoning|land use|residential|commercial/i.test(queryLower)) topics.push('zoning');

    return {
      name: matchedCode.name,
      type: matchedCode.type,
      county: matchedCode.county,
      codeUrl: matchedCode.municipalCodeUrl,
      platform: matchedCode.platform,
      topics: topics.length > 0 ? topics : null,
    };
  }

  // Load California state codes for state law lookups
  async function loadCaliforniaCodes() {
    if (californiaCodesCache) return californiaCodesCache;
    try {
      const response = await fetch('/api/california-codes.json');
      if (response.ok) {
        californiaCodesCache = await response.json();
        return californiaCodesCache;
      }
    } catch (e) {
      console.error('Failed to load California codes:', e);
    }
    return null;
  }

  // Search for California state law when user asks about state-level regulations
  async function searchCaliforniaCode(query) {
    const data = await loadCaliforniaCodes();
    if (!data) return null;

    const queryLower = query.toLowerCase();

    // Keywords that suggest user wants California state law info
    const stateKeywords = [
      'california law',
      'state law',
      'ca law',
      'labor law',
      'employment law',
      'worker rights',
      'tenant rights',
      'landlord tenant',
      'rent control state',
      'vehicle code',
      'dmv',
      'driver license',
      'unemployment',
      'edd',
      'disability insurance',
      'paid family leave',
      'calfresh',
      'calworks',
      'medi-cal eligibility',
      'minimum wage california',
      'overtime law',
      'meal break',
      'rest break',
      'small claims',
      'eviction law california',
      'child custody',
      'child support',
      'divorce california',
      'workers comp',
      'workplace safety',
      'california constitution',
    ];

    const isStateQuery = stateKeywords.some((kw) => queryLower.includes(kw));
    if (!isStateQuery) return null;

    // Find relevant codes based on query
    const relevantCodes = [];

    for (const code of data.codes) {
      const topics = code.topics || [];
      if (topics.some((topic) => queryLower.includes(topic.toLowerCase()))) {
        relevantCodes.push(code);
      }
    }

    // Special keyword matching
    if (/tenant|landlord|rent|lease|security deposit|eviction/.test(queryLower)) {
      const civCode = data.codes.find((c) => c.code === 'CIV');
      if (civCode && !relevantCodes.includes(civCode)) relevantCodes.push(civCode);
    }
    if (/wage|overtime|break|paycheck|fired|workplace|employee|employer/.test(queryLower)) {
      const labCode = data.codes.find((c) => c.code === 'LAB');
      if (labCode && !relevantCodes.includes(labCode)) relevantCodes.push(labCode);
    }
    if (/unemploy|edd|disability|paid.?family.?leave|pfl/.test(queryLower)) {
      const uicCode = data.codes.find((c) => c.code === 'UIC');
      if (uicCode && !relevantCodes.includes(uicCode)) relevantCodes.push(uicCode);
    }
    if (/dmv|license|registration|traffic|parking ticket|dui/.test(queryLower)) {
      const vehCode = data.codes.find((c) => c.code === 'VEH');
      if (vehCode && !relevantCodes.includes(vehCode)) relevantCodes.push(vehCode);
    }
    if (/divorce|custody|child support|marriage|domestic partner/.test(queryLower)) {
      const famCode = data.codes.find((c) => c.code === 'FAM');
      if (famCode && !relevantCodes.includes(famCode)) relevantCodes.push(famCode);
    }
    if (/calfresh|calworks|foster|welfare|food stamps/.test(queryLower)) {
      const wicCode = data.codes.find((c) => c.code === 'WIC');
      if (wicCode && !relevantCodes.includes(wicCode)) relevantCodes.push(wicCode);
    }
    if (/constitution/.test(queryLower)) {
      relevantCodes.unshift({
        code: 'CONS',
        name: data.constitution.name,
        url: data.constitution.url,
      });
    }

    if (relevantCodes.length === 0) return null;

    return {
      searchUrl: data.searchUrl,
      codes: relevantCodes.slice(0, 3), // Limit to 3 most relevant
    };
  }

  // Load California state resources
  async function loadCaliforniaResources() {
    if (californiaResourcesCache) return californiaResourcesCache;
    try {
      const response = await fetch('/api/california-resources.json');
      if (response.ok) {
        californiaResourcesCache = await response.json();
        return californiaResourcesCache;
      }
    } catch (e) {
      console.error('Failed to load California resources:', e);
    }
    return null;
  }

  // Search California state resources when user asks about state services
  async function searchCaliforniaResources(query) {
    const data = await loadCaliforniaResources();
    if (!data) return null;

    const queryLower = query.toLowerCase();

    // Keywords that suggest user wants state agency/service info
    const stateServiceKeywords = [
      'edd',
      'unemployment',
      'disability insurance',
      'paid family leave',
      'dmv',
      'driver license',
      'real id',
      'vehicle registration',
      'ftb',
      'state tax',
      'california tax',
      'medi-cal',
      'covered california',
      'health insurance',
      'calfresh',
      'food stamps',
      'calworks',
      'welfare',
      'birth certificate',
      'vital records',
      'wage claim',
      'labor board',
      'unpaid wages',
      'discrimination',
      'civil rights',
      'dfeh',
      'consumer complaint',
      'attorney general',
      'state agency',
      'california department',
    ];

    const isStateServiceQuery = stateServiceKeywords.some((kw) => queryLower.includes(kw));
    if (!isStateServiceQuery) return null;

    // Find matching agencies
    const matchedAgencies = [];
    for (const agency of data.keyAgencies) {
      const abbrevMatch = queryLower.includes(agency.abbrev.toLowerCase());
      const nameMatch = queryLower.includes(agency.name.toLowerCase());
      const serviceMatch = agency.services?.some((s) => queryLower.includes(s.toLowerCase()));

      if (abbrevMatch || nameMatch || serviceMatch) {
        matchedAgencies.push(agency);
      }
    }

    // Find matching services
    const matchedServices = [];
    for (const service of data.popularServices) {
      const nameMatch = service.name
        .toLowerCase()
        .split(' ')
        .some((word) => word.length > 3 && queryLower.includes(word));
      if (nameMatch) {
        matchedServices.push(service);
      }
    }

    // Find matching helplines
    const matchedHelplines = [];
    for (const helpline of data.helplines) {
      const nameMatch = helpline.name
        .toLowerCase()
        .split(' ')
        .some((word) => word.length > 3 && queryLower.includes(word));
      if (nameMatch) {
        matchedHelplines.push(helpline);
      }
    }

    if (
      matchedAgencies.length === 0 &&
      matchedServices.length === 0 &&
      matchedHelplines.length === 0
    ) {
      return null;
    }

    return {
      agencies: matchedAgencies.slice(0, 2),
      services: matchedServices.slice(0, 3),
      helplines: matchedHelplines.slice(0, 2),
      portal: data.portals.main,
    };
  }

  // Detect if a message is primarily just a location response (not a help request)
  // Returns true if we should skip showing program cards
  function isLocationOnlyMessage(text, hadLocationBefore) {
    const lower = text.toLowerCase().trim();
    const words = lower.split(/\s+/).filter((w) => w.length > 0);

    // Very short messages that are just locations
    if (words.length <= 3) {
      // ZIP code only
      if (/^\d{5}$/.test(lower.replace(/\s/g, ''))) return true;
      // City name only (check if it matches known cities)
      const cityPatterns = [
        'oakland',
        'berkeley',
        'fremont',
        'hayward',
        'san jose',
        'sunnyvale',
        'sf',
        'san francisco',
        'daly city',
        'richmond',
        'concord',
        'vallejo',
        'santa rosa',
        'palo alto',
        'mountain view',
        'redwood city',
        'san mateo',
        'walnut creek',
        'pleasanton',
        'livermore',
        'san rafael',
        'napa',
        'petaluma',
      ];
      if (cityPatterns.some((city) => lower === city || lower === city.replace(' ', '')))
        return true;
    }

    // Messages like "I'm in Oakland" or "Oakland 94612" - location + filler only
    const locationFillers = [
      'i am in',
      "i'm in",
      'im in',
      'i live in',
      'my zip is',
      'zip code is',
      'in',
    ];
    const stripped = locationFillers.reduce((s, f) => s.replace(f, ''), lower).trim();
    if (/^[\w\s]+\s*\d{0,5}$/.test(stripped) && stripped.length < 25) return true;

    // Check for actual help request keywords (if present, show programs)
    const helpKeywords = [
      'help',
      'need',
      'looking for',
      'find',
      'where',
      'how',
      'what',
      'can i',
      'food',
      'housing',
      'rent',
      'medical',
      'health',
      'bill',
      'utility',
      'job',
      'assistance',
      'program',
      'benefit',
      'apply',
      'qualify',
      'eligible',
    ];
    const hasHelpIntent = helpKeywords.some((kw) => lower.includes(kw));

    // If they had no location before and this message has a location,
    // it's likely just answering Carl's location question
    if (!hadLocationBefore && !hasHelpIntent) {
      return true;
    }

    return false;
  }

  // Search programs for RAG - enhanced keyword matching with better relevance
  // excludeShown: if true, exclude programs already shown in this conversation
  async function searchPrograms(query, location = null, excludeShown = false) {
    const programs = await loadPrograms();
    if (!programs.length) return [];

    // Ensure we have latest profile
    if (!userProfile) loadUserProfile();

    const queryLower = query.toLowerCase();
    const queryTerms = queryLower.split(/\s+/).filter((t) => t.length > 2);

    // Detect if user wants alternatives (already tried, other options, more, etc.)
    const wantsAlternatives =
      /already|tried|other|more|else|different|alternative|another|besides/.test(queryLower);
    const shouldExclude = excludeShown || wantsAlternatives;

    // Expanded keyword mapping for better intent detection
    const intentKeywords = {
      food: [
        'food',
        'hungry',
        'eat',
        'meal',
        'grocery',
        'snap',
        'calfresh',
        'wic',
        'pantry',
        'ebt',
        'stamps',
        'nutrition',
        'feeding',
        'lunch',
        'dinner',
        'breakfast',
      ],
      healthcare: [
        'health',
        'medical',
        'doctor',
        'insurance',
        'medi-cal',
        'medicaid',
        'clinic',
        'dental',
        'vision',
        'hospital',
        'prescription',
        'medicine',
        'sick',
        'mental health',
        'therapy',
        'counseling',
        'covered california',
      ],
      housing: [
        'housing',
        'rent',
        'home',
        'shelter',
        'homeless',
        'section 8',
        'apartment',
        'eviction',
        'landlord',
        'tenant',
        'voucher',
        'hud',
        'unhoused',
        'sleeping',
      ],
      utilities: [
        'utility',
        'utilities',
        'electric',
        'electricity',
        'gas',
        'pge',
        'pg&e',
        'water',
        'bill',
        'care program',
        'liheap',
        'fera',
        'energy',
        'internet',
        'phone',
        'lifeline',
        'wifi',
        'broadband',
      ],
      cash: [
        'cash',
        'money',
        'income',
        'calworks',
        'ssi',
        'ssdi',
        'welfare',
        'general assistance',
        'disability',
        'unemployed',
        'unemployment',
        'edd',
        'benefits',
      ],
      seniors: [
        'senior',
        'seniors',
        'elderly',
        'older',
        'aging',
        '65',
        'medicare',
        'retirement',
        'retired',
        'aarp',
      ],
      veterans: [
        'veteran',
        'veterans',
        'military',
        'va ',
        'army',
        'navy',
        'marine',
        'air force',
        'service member',
        'vet',
      ],
      families: [
        'family',
        'families',
        'child',
        'children',
        'kids',
        'baby',
        'infant',
        'parent',
        'pregnant',
        'childcare',
        'daycare',
        'mother',
        'father',
        'mom',
        'dad',
      ],
      legal: [
        'legal',
        'lawyer',
        'attorney',
        'court',
        'immigration',
        'eviction defense',
        'rights',
        'citizenship',
        'visa',
        'asylum',
      ],
      jobs: [
        'job',
        'jobs',
        'work',
        'employment',
        'career',
        'training',
        'workforce',
        'resume',
        'hire',
        'hiring',
      ],
      transportation: [
        'transit',
        'bus',
        'bart',
        'muni',
        'clipper',
        'ride',
        'transportation',
        'paratransit',
        'car',
      ],
    };

    // Common program name mappings (what users might say -> program keywords)
    const programAliases = {
      'food stamps': 'calfresh',
      snap: 'calfresh',
      ebt: 'calfresh',
      welfare: 'calworks',
      tanf: 'calworks',
      'free healthcare': 'medi-cal',
      medicaid: 'medi-cal',
      aca: 'covered california',
      obamacare: 'covered california',
      'utility discount': 'care program',
      'pge discount': 'care program',
      'free phone': 'lifeline',
      'obama phone': 'lifeline',
    };

    // Score programs based on relevance
    const scored = programs.map((program) => {
      let score = 0;
      const name = (program.name || '').toLowerCase();
      const desc = (program.description || '').toLowerCase();
      const fullDesc = (program.fullDescription || '').toLowerCase();
      const category = (program.category || '').toLowerCase();
      const keywords = (
        Array.isArray(program.keywords) ? program.keywords.join(' ') : program.keywords || ''
      ).toLowerCase();
      const areas = (program.areas || []).map((a) => a.toLowerCase());

      // Check for exact phrase match (highest priority)
      if (name.includes(queryLower)) score += 25;
      if (queryLower.length > 5 && desc.includes(queryLower)) score += 15;

      // Check program aliases
      for (const [alias, programName] of Object.entries(programAliases)) {
        if (queryLower.includes(alias)) {
          if (name.includes(programName) || keywords.includes(programName)) {
            score += 20;
          }
        }
      }

      // Direct term matches
      for (const term of queryTerms) {
        if (name.includes(term)) score += 12; // Name match is strongest
        if (keywords.includes(term)) score += 8; // Keywords are important
        if (category.includes(term)) score += 6;
        if (desc.includes(term)) score += 3;
      }

      // Intent-based matching
      for (const [intent, intentWords] of Object.entries(intentKeywords)) {
        const matchedKeyword = intentWords.find((kw) => queryLower.includes(kw));
        if (matchedKeyword) {
          // Check if program matches this intent via category
          if (category.includes(intent)) {
            score += 10;
          }
          // Also check if program name/desc/keywords contains the keyword
          if (name.includes(matchedKeyword)) score += 8;
          if (keywords.includes(matchedKeyword)) score += 5;
          if (desc.includes(matchedKeyword)) score += 3;
        }
      }

      // Location filtering - strongly prefer matching, penalize non-matching
      if (location && location.county) {
        const countyLower = location.county.toLowerCase();
        const isLocalMatch = areas.some((a) => a.includes(countyLower));
        const isBroadMatch = areas.some(
          (a) =>
            a.includes('bay area') ||
            a.includes('statewide') ||
            a.includes('nationwide') ||
            a.includes('all counties') ||
            a.includes('california')
        );

        if (isLocalMatch) {
          score += 15; // Strong boost for programs specifically in user's county
        } else if (isBroadMatch) {
          score += 5; // Smaller boost for regional/statewide programs
        } else if (areas.length > 0) {
          score -= 20; // Strong penalty for programs clearly not in user's area
        }
      }

      // User profile boosting - prioritize programs matching user's groups
      if (userProfile?.groups?.length > 0) {
        const eligibility = (program.eligibility || '').toLowerCase();
        const tags = (program.tags || []).map((t) => t.toLowerCase());
        const allText = `${name} ${desc} ${keywords} ${eligibility} ${tags.join(' ')}`;

        // Map group IDs to keywords that indicate relevance
        const groupKeywords = {
          senior: ['senior', 'elderly', 'older adult', '65+', '60+', 'aging', 'medicare'],
          veteran: ['veteran', 'military', 'va ', 'armed forces', 'service member'],
          disabled: ['disability', 'disabled', 'ssdi', 'ssi', 'accessible', 'ada'],
          family: ['family', 'families', 'children', 'child', 'parent', 'wic', 'childcare'],
          'low-income': [
            'low-income',
            'low income',
            'poverty',
            'assistance',
            'calfresh',
            'calworks',
          ],
          homeless: ['homeless', 'unhoused', 'shelter', 'housing', 'unsheltered'],
          immigrant: ['immigrant', 'immigration', 'refugee', 'asylum', 'citizenship'],
          student: ['student', 'education', 'school', 'college', 'university', 'financial aid'],
        };

        for (const group of userProfile.groups) {
          const keywords = groupKeywords[group] || [];
          const matchFound = keywords.some((kw) => allText.includes(kw));
          if (matchFound) {
            score += 8; // Significant boost for programs matching user's groups
          }
        }
      }

      // Penalize programs already shown if user wants alternatives
      if (shouldExclude && program.id && shownProgramIds.has(program.id)) {
        score -= 50; // Heavy penalty to push to bottom
      }

      return { program, score };
    });

    // Return top 5 relevant programs with score > 15 (filter out weak matches)
    // Higher threshold (was 5) to prevent showing irrelevant programs like "Pet Help Finder" for job queries
    // If excluding shown programs, we may need more results to backfill
    const minResults = shouldExclude ? 8 : 5;
    let results = scored
      .filter((s) => s.score > 15)
      .sort((a, b) => b.score - a.score)
      .slice(0, minResults)
      .filter((s) => !shouldExclude || !shownProgramIds.has(s.program.id)) // Final filter for excluded
      .slice(0, 5);

    // Calculate distances if user has location
    // Priority: browser geolocation > ZIP coordinates > city center
    const locationWithGeo = browserGeolocation
      ? { ...location, lat: browserGeolocation.lat, lng: browserGeolocation.lng }
      : location;
    const userCoords = await getUserCoordinates(locationWithGeo);
    if (userCoords) {
      const geoData = await loadProgramsGeo();
      results = results.map((item) => {
        const programCoords = geoData[item.program.id];
        if (programCoords) {
          const dist = calculateDistance(
            userCoords.lat,
            userCoords.lng,
            programCoords.lat,
            programCoords.lng
          );
          return { ...item, distance: dist };
        }
        return { ...item, distance: null };
      });

      // Sort by distance for programs with similar scores (within 10 points)
      // This keeps highly relevant programs at the top but orders similar ones by proximity
      results.sort((a, b) => {
        const scoreDiff = b.score - a.score;
        // If scores are significantly different (>10), keep score-based order
        if (Math.abs(scoreDiff) > 10) return scoreDiff;
        // For similar scores, sort by distance (closer first)
        if (a.distance !== null && b.distance !== null) {
          return a.distance - b.distance;
        }
        // Programs without coordinates go last among similar-scored programs
        if (a.distance === null && b.distance !== null) return 1;
        if (a.distance !== null && b.distance === null) return -1;
        return scoreDiff;
      });
    }

    return results.map((s) => s.program);
  }

  // Generate program link based on platform
  // Uses program.id which matches what the apps expect (e.g., "211-bay-area")
  function getProgramLink(program) {
    const programId = program.id;
    if (isApp) {
      // Deep link format: baynavigator://program/program-id
      return `baynavigator://program/${programId}`;
    }
    // Web: search by exact program name for best match
    return `/directory?q=${encodeURIComponent(program.name)}`;
  }

  // Detect crisis situation
  function detectCrisis(message) {
    const lowerMessage = message.toLowerCase();
    for (const keyword of EMERGENCY_KEYWORDS) {
      if (lowerMessage.includes(keyword)) return 'emergency';
    }
    for (const keyword of MENTAL_HEALTH_KEYWORDS) {
      if (lowerMessage.includes(keyword)) return 'mentalHealth';
    }
    return null;
  }

  // Initialize
  if (localStorage.getItem('assistantUsed')) {
    notificationDot?.remove();
  }

  // Initialize history feature
  async function initHistory() {
    if (typeof window.CarlStorage !== 'undefined') {
      historyEnabled = await window.CarlStorage.isHistoryEnabled();
      if (historyEnabled) {
        historyBtn?.classList.remove('hidden');
      }
    }
  }

  // Call init after a short delay to ensure CarlStorage is loaded
  setTimeout(initHistory, 100);

  // Listen for history setting changes
  document.addEventListener('carlHistorySettingChanged', async (e) => {
    historyEnabled = e.detail.enabled;
    if (historyEnabled) {
      historyBtn?.classList.remove('hidden');
    } else {
      historyBtn?.classList.add('hidden');
    }
  });

  // Show history panel
  function showHistoryPanel() {
    historyPanel?.classList.remove('hidden');
    historyPanel?.classList.add('flex');
    loadHistoryList();
  }

  // Hide history panel
  function hideHistoryPanel() {
    historyPanel?.classList.add('hidden');
    historyPanel?.classList.remove('flex');
  }

  // Load and display history list
  async function loadHistoryList() {
    if (!historyList || typeof window.CarlStorage === 'undefined') return;

    const conversations = await window.CarlStorage.getRecentConversations(20);

    if (conversations.length === 0) {
      historyList.innerHTML = `
        <div class="text-center py-8 text-neutral-500 dark:text-neutral-400">
          <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          <p class="text-sm">No conversations yet</p>
          <p class="text-xs mt-1">Your chat history will appear here</p>
        </div>
      `;
      return;
    }

    historyList.innerHTML = '';

    conversations.forEach((conv) => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className =
        'w-full text-left p-3 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors group';

      const date = new Date(conv.timestamp);
      const dateStr = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      const timeStr = date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });

      item.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-neutral-900 dark:text-white truncate">${escapeHtml(conv.summary)}</p>
            <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">${dateStr} at ${timeStr}</p>
          </div>
          <button type="button" class="delete-conv p-1 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all" data-id="${conv.id}" aria-label="Delete conversation">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      `;

      // Load conversation on click
      item.addEventListener('click', (e) => {
        if (e.target.closest('.delete-conv')) return;
        loadConversation(conv);
      });

      // Delete button
      const deleteBtn = item.querySelector('.delete-conv');
      deleteBtn?.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (confirm('Delete this conversation?')) {
          await window.CarlStorage.deleteConversation(conv.id);
          loadHistoryList();
        }
      });

      historyList.appendChild(item);
    });
  }

  // Load a conversation from history
  function loadConversation(conv) {
    // Reset current state
    conversationHistory = conv.messages || [];
    currentConversationId = conv.id;

    // Clear messages container except welcome
    if (messagesContainer) {
      messagesContainer.innerHTML = '';

      // Add all messages
      conv.messages.forEach((msg) => {
        if (msg.role === 'user') {
          addMessage(msg.content, 'user');
        } else if (msg.role === 'assistant') {
          addMessage(msg.content, 'assistant');
        }
      });
    }

    // Close history panel
    hideHistoryPanel();
  }

  // Start a new conversation
  function startNewConversation() {
    // Save current conversation if it has messages
    saveCurrentConversation();

    // Reset state
    conversationHistory = [];
    currentConversationId = null;
    shownProgramIds.clear(); // Clear shown programs for fresh recommendations

    // Reset UI
    if (messagesContainer) {
      messagesContainer.innerHTML = `
        <div class="assistant-message">
          <div class="bg-neutral-100 dark:bg-neutral-700 rounded-2xl rounded-tl-sm p-3 max-w-[85%]">
            <p class="text-sm text-neutral-800 dark:text-neutral-200">
              Hi! I'm Carl, your Bay Area assistant. I can help you find programs, services, and local government info. What can I help you with?
            </p>
          </div>
        </div>
      `;
    }

    // Update welcome message with personalization
    updateWelcomeMessage();

    // Close history panel if open
    hideHistoryPanel();
  }

  // Save current conversation to history
  async function saveCurrentConversation() {
    if (!historyEnabled || conversationHistory.length === 0) return;
    if (typeof window.CarlStorage === 'undefined') return;

    const metadata = {
      userCity: userProfile?.city || userLocation?.city || null,
      programsDiscussed: [], // Could track this if needed
    };

    if (currentConversationId) {
      await window.CarlStorage.updateConversation(
        currentConversationId,
        conversationHistory,
        metadata
      );
    } else {
      currentConversationId = await window.CarlStorage.saveConversation(
        conversationHistory,
        metadata
      );
    }
  }

  // Escape HTML for safe display
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // History button click
  historyBtn?.addEventListener('click', showHistoryPanel);

  // History back button
  historyBackBtn?.addEventListener('click', hideHistoryPanel);

  // New chat button
  newChatBtn?.addEventListener('click', startNewConversation);

  // Clear all history
  clearHistoryBtn?.addEventListener('click', async () => {
    if (confirm('Clear all conversation history? This cannot be undone.')) {
      await window.CarlStorage?.clearAllHistory();
      loadHistoryList();
    }
  });

  // Generate personalized welcome message based on user profile
  function getPersonalizedWelcome() {
    const profile = loadUserProfile();

    if (!profile || (!profile.groups?.length && !profile.city)) {
      // Default welcome for new users
      return null;
    }

    // Build personalized greeting
    const greetings = ['Hi there!', 'Hello!', 'Hey there!'];
    const greeting = greetings[Math.floor(Math.random() * greetings.length)];

    // Map group IDs to friendly names
    const groupNames = {
      senior: 'seniors',
      veteran: 'veterans',
      disabled: 'people with disabilities',
      family: 'families',
      'low-income': 'low-income households',
      homeless: 'people experiencing homelessness',
      immigrant: 'immigrants',
      student: 'students',
    };

    let message = greeting;

    // Add location context (always city, never county)
    if (profile.city) {
      message += ` I see you're in ${profile.city}.`;
    }

    // Add group context (only mention 1-2 for brevity)
    if (profile.groups?.length > 0) {
      const friendlyGroups = profile.groups
        .slice(0, 2)
        .map((g) => groupNames[g] || g)
        .filter(Boolean);

      if (friendlyGroups.length > 0) {
        message += ` I can help you find programs for ${friendlyGroups.join(' and ')}.`;
      }
    }

    message += '\n\nWhat can I help you with today?';

    return message;
  }

  // Update welcome message if user has profile
  function updateWelcomeMessage() {
    const personalizedMsg = getPersonalizedWelcome();
    if (personalizedMsg && messagesContainer) {
      const welcomeBubble = messagesContainer.querySelector('.assistant-message p');
      if (welcomeBubble) {
        // Replace default welcome with personalized one
        const parent = welcomeBubble.parentElement;
        parent.innerHTML = '';
        const p = document.createElement('p');
        p.className = 'text-sm text-neutral-800 dark:text-neutral-200 whitespace-pre-wrap';
        p.textContent = personalizedMsg;
        parent.appendChild(p);
      }
    }
  }

  // Make toggle button draggable
  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let buttonStartX = 0;
  let buttonStartY = 0;
  let hasMoved = false;

  function getButtonPosition() {
    const rect = toggle.getBoundingClientRect();
    return { x: rect.left, y: rect.top };
  }

  function setButtonPosition(x, y) {
    // Keep button within viewport bounds
    const buttonSize = 56; // w-14 = 56px
    const padding = 8;
    const maxX = window.innerWidth - buttonSize - padding;
    const maxY = window.innerHeight - buttonSize - padding;
    x = Math.max(padding, Math.min(x, maxX));
    y = Math.max(padding, Math.min(y, maxY));

    toggle.style.left = `${x}px`;
    toggle.style.top = `${y}px`;
    toggle.style.right = 'auto';
    toggle.style.bottom = 'auto';

    // Save position to localStorage
    localStorage.setItem('carlButtonPosition', JSON.stringify({ x, y }));

    // Update panel position to follow button
    updatePanelPosition(x, y);
  }

  function updatePanelPosition(buttonX, buttonY) {
    if (!panel) return;
    const buttonSize = 56;
    const panelWidth = 384; // w-96 = 384px
    const panelHeight = 500;
    const gap = 16;

    // Position panel above or below button, left or right
    let panelX = buttonX + buttonSize / 2 - panelWidth / 2;
    let panelY = buttonY - panelHeight - gap;

    // If panel would go off top, put it below button
    if (panelY < 8) {
      panelY = buttonY + buttonSize + gap;
    }

    // Keep panel within horizontal bounds
    panelX = Math.max(8, Math.min(panelX, window.innerWidth - panelWidth - 8));

    panel.style.left = `${panelX}px`;
    panel.style.top = `${panelY}px`;
    panel.style.right = 'auto';
    panel.style.bottom = 'auto';
  }

  // Load saved position
  const savedPosition = localStorage.getItem('carlButtonPosition');
  if (savedPosition && toggle) {
    try {
      const { x, y } = JSON.parse(savedPosition);
      setButtonPosition(x, y);
    } catch (e) {
      // Use default position
    }
  }

  function handleDragStart(e) {
    if (!toggle) return;
    isDragging = true;
    hasMoved = false;

    const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
    const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;

    dragStartX = clientX;
    dragStartY = clientY;

    const pos = getButtonPosition();
    buttonStartX = pos.x;
    buttonStartY = pos.y;

    toggle.style.transition = 'none';
  }

  function handleDragMove(e) {
    if (!isDragging || !toggle) return;

    const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
    const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;

    const deltaX = clientX - dragStartX;
    const deltaY = clientY - dragStartY;

    // Only consider it a move if dragged more than 5px
    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
      hasMoved = true;
    }

    if (hasMoved) {
      e.preventDefault();
      setButtonPosition(buttonStartX + deltaX, buttonStartY + deltaY);
    }
  }

  function handleDragEnd() {
    if (!toggle) return;
    isDragging = false;
    toggle.style.transition = '';
  }

  // Mouse events
  toggle?.addEventListener('mousedown', handleDragStart);
  document.addEventListener('mousemove', handleDragMove);
  document.addEventListener('mouseup', handleDragEnd);

  // Touch events
  toggle?.addEventListener('touchstart', handleDragStart, { passive: false });
  document.addEventListener('touchmove', handleDragMove, { passive: false });
  document.addEventListener('touchend', handleDragEnd);

  // Toggle panel (only if not dragged)
  toggle?.addEventListener('click', (e) => {
    if (hasMoved) {
      hasMoved = false;
      return; // Don't toggle if we just finished dragging
    }
    const isOpen = !panel?.classList.contains('hidden');
    panel?.classList.toggle('hidden');
    toggle.setAttribute('aria-expanded', String(!isOpen));
    if (!isOpen) {
      // Update panel position based on current button position
      const pos = getButtonPosition();
      updatePanelPosition(pos.x, pos.y);
      input?.focus();
      localStorage.setItem('assistantUsed', 'true');
      notificationDot?.remove();
      // Load profile and update welcome message
      updateWelcomeMessage();
      // Preload programs for RAG
      loadPrograms();
    }
  });

  // Close panel
  closeBtn?.addEventListener('click', () => {
    // Exit fullscreen first if active
    if (isFullscreen) {
      toggleFullscreen();
    }
    panel?.classList.add('hidden');
    toggle?.setAttribute('aria-expanded', 'false');
  });

  // Fullscreen toggle (desktop only)
  function toggleFullscreen() {
    if (!panel) return;
    isFullscreen = !isFullscreen;

    if (isFullscreen) {
      // Save original styles
      panel.dataset.originalStyle = panel.getAttribute('style') || '';
      // Go fullscreen
      panel.style.cssText = `
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
        width: auto;
        max-width: none;
        height: auto;
        max-height: none;
        z-index: 100;
      `;
      fullscreenExpandIcon?.classList.add('hidden');
      fullscreenCollapseIcon?.classList.remove('hidden');
      fullscreenBtn?.setAttribute('title', 'Exit fullscreen');
    } else {
      // Restore original styles
      panel.style.cssText = panel.dataset.originalStyle || '';
      fullscreenExpandIcon?.classList.remove('hidden');
      fullscreenCollapseIcon?.classList.add('hidden');
      fullscreenBtn?.setAttribute('title', 'Fullscreen');
    }
  }

  fullscreenBtn?.addEventListener('click', toggleFullscreen);

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !panel?.classList.contains('hidden')) {
      // Exit fullscreen first, then close on second press
      if (isFullscreen) {
        toggleFullscreen();
      } else {
        panel?.classList.add('hidden');
        toggle?.setAttribute('aria-expanded', 'false');
      }
    }
  });

  // Form submit
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage();
  });

  async function sendMessage() {
    const message = input?.value.trim();
    if (!message || isLoading) return;

    // Check for crisis keywords first
    const crisisType = detectCrisis(message);
    if (crisisType) {
      showCrisisDialog(crisisType);
    }

    // Add user message to UI
    addMessage(message, 'user');
    input.value = '';

    // Track if we already had a location before this message
    const hadLocationBefore = !!userLocation;

    // Parse location from message
    const parsedLocation = await parseLocation(message);
    if (parsedLocation) {
      userLocation = parsedLocation;
    }

    // Determine if this message is just a location response (skip showing programs)
    const isJustLocation = isLocationOnlyMessage(message, hadLocationBefore);

    // Show loading
    isLoading = true;
    sendBtn?.setAttribute('disabled', 'true');
    const loadingEl = addLoadingIndicator();
    setCarlState('thinking');

    // Declare outside try so it's accessible in catch block
    let relevantPrograms = [];

    try {
      // Search for relevant programs (RAG)
      relevantPrograms = await searchPrograms(message, userLocation);

      // Build context for the AI with rich program details
      let ragContext = '';
      if (relevantPrograms.length > 0) {
        ragContext = `\n\n[LOCAL PROGRAMS FOR THIS USER - MENTION THESE BY NAME!]\n`;
        ragContext += `These programs match the user's location and needs. Reference them specifically:\n\n`;
        relevantPrograms.forEach((p, i) => {
          ragContext += `${i + 1}. **${p.name}**`;
          if (p.areas && p.areas.length > 0)
            ragContext += ` (serves: ${p.areas.slice(0, 2).join(', ')})`;
          ragContext += '\n';
          if (p.description) ragContext += `    ${p.description.substring(0, 150)}\n`;
          if (p.phone) ragContext += `    Phone: ${p.phone}\n`;
          if (p.whatTheyOffer)
            ragContext += `    ${p.whatTheyOffer.split('\n')[0].substring(0, 100)}\n`;
        });
        ragContext += `\nIMPORTANT: Mention 2-3 of these programs BY NAME in your response. The user will see clickable cards for each program after your message.`;
      }

      // Add location context (always use city/zip for user-facing, county is internal only)
      let locationContext = '';
      if (userLocation) {
        // Always prefer city or neighborhood for user-facing context
        const displayLocation = userLocation.city || userLocation.neighborhood;
        if (displayLocation) {
          locationContext = `\n\n[USER LOCATION]: ${displayLocation}`;
          if (userLocation.zip) {
            locationContext += ` (${userLocation.zip})`;
          }
          // Internal note for filtering - never shown to user
          locationContext += `. IMPORTANT: Always refer to the user's location by city name, never by county.`;
        }
      }

      // Add user profile context for personalization (stays local, helps AI give relevant answers)
      let profileContext = '';
      if (userProfile) {
        const groupDescriptions = {
          senior: 'a senior (65+)',
          veteran: 'a veteran',
          disabled: 'a person with a disability',
          family: 'part of a family with children',
          'low-income': 'from a low-income household',
          homeless: 'experiencing housing instability',
          immigrant: 'an immigrant',
          student: 'a student',
        };

        if (userProfile.groups?.length > 0) {
          const descriptions = userProfile.groups.map((g) => groupDescriptions[g]).filter(Boolean);
          if (descriptions.length > 0) {
            profileContext = `\n\n[USER PROFILE]: User is ${descriptions.join(', ')}. Prioritize programs that serve these groups. Use natural language, not bureaucratic terms.`;
          }
        }
      }

      // Check for city/government contact queries
      let cityContactContext = '';
      const cityContactResult = await searchCityContacts(message, userLocation);
      if (cityContactResult) {
        cityContactContext = `\n\n[CITY GOVERNMENT CONTACTS]\n`;
        cityContactContext += `**${cityContactResult.city}** (${cityContactResult.county} County)\n`;
        cityContactContext += `Website: ${cityContactResult.website}\n\n`;
        for (const dept of cityContactResult.departments) {
          cityContactContext += `**${dept.name}**:\n`;
          if (dept.phones?.length > 0) {
            cityContactContext += `  Phone: ${dept.phones.slice(0, 2).join(', ')}\n`;
          }
          if (dept.emails?.length > 0) {
            cityContactContext += `  Email: ${dept.emails.slice(0, 2).join(', ')}\n`;
          }
          if (dept.url) {
            cityContactContext += `  More info: ${dept.url}\n`;
          }
        }
        cityContactContext += `\nProvide these specific contacts in your response.`;
      }

      // Check for municipal code/ordinance queries
      let municipalCodeContext = '';
      const municipalCodeResult = await searchMunicipalCode(message, userLocation);
      if (municipalCodeResult) {
        municipalCodeContext = `\n\n[MUNICIPAL CODE REFERENCE]\n`;
        municipalCodeContext += `**${municipalCodeResult.name}** ${municipalCodeResult.type === 'County' ? 'County' : ''} Municipal Code\n`;
        municipalCodeContext += `Full code available at: ${municipalCodeResult.codeUrl}\n`;
        if (municipalCodeResult.topics?.length > 0) {
          municipalCodeContext += `\nUser appears to be asking about: ${municipalCodeResult.topics.join(', ')}\n`;
        }
        municipalCodeContext += `\nIMPORTANT: You don't have the specific code sections memorized. Tell the user you can point them to where they can find the official rules, and provide the municipal code link. Suggest they search the code for relevant terms or contact the city/county directly for specific questions. Don't make up specific rules or numbers.`;
      }

      // Check for California state law queries
      let californiaCodeContext = '';
      const californiaCodeResult = await searchCaliforniaCode(message);
      if (californiaCodeResult) {
        californiaCodeContext = `\n\n[CALIFORNIA STATE LAW REFERENCE]\n`;
        californiaCodeContext += `Relevant California codes:\n`;
        for (const code of californiaCodeResult.codes) {
          californiaCodeContext += `- **${code.name}**: ${code.url}\n`;
        }
        californiaCodeContext += `\nSearch all California codes at: ${californiaCodeResult.searchUrl}\n`;
        californiaCodeContext += `\nIMPORTANT: California state law applies statewide. Point users to the official California Legislative Information site. Don't make up specific code sections or numbers - direct them to search the official source.`;
      }

      // Check for California state agency/service queries
      let californiaResourcesContext = '';
      const californiaResourcesResult = await searchCaliforniaResources(message);
      if (californiaResourcesResult) {
        californiaResourcesContext = `\n\n[CALIFORNIA STATE RESOURCES]\n`;
        if (californiaResourcesResult.agencies?.length > 0) {
          californiaResourcesContext += `**Relevant State Agencies:**\n`;
          for (const agency of californiaResourcesResult.agencies) {
            californiaResourcesContext += `- **${agency.name}** (${agency.abbrev}): ${agency.url}`;
            if (agency.phone) californiaResourcesContext += ` | Phone: ${agency.phone}`;
            californiaResourcesContext += `\n  ${agency.description}\n`;
          }
        }
        if (californiaResourcesResult.services?.length > 0) {
          californiaResourcesContext += `\n**Quick Links:**\n`;
          for (const service of californiaResourcesResult.services) {
            californiaResourcesContext += `- ${service.name}: ${service.url}\n`;
          }
        }
        if (californiaResourcesResult.helplines?.length > 0) {
          californiaResourcesContext += `\n**Helplines:**\n`;
          for (const helpline of californiaResourcesResult.helplines) {
            californiaResourcesContext += `- ${helpline.name}: ${helpline.phone}\n`;
          }
        }
        californiaResourcesContext += `\nProvide these specific state resources in your response.`;
      }

      // Fetch live data if query matches specific topics
      let liveDataContext = '';

      // Check for transit-related queries
      if (isTransitQuery(message)) {
        const agencyFilter = detectTransitAgency(message);
        const transitAlerts = await fetchTransitAlerts(agencyFilter);
        liveDataContext += formatTransitAlertsForContext(transitAlerts, agencyFilter);
      }

      // Check for traffic-related queries
      if (isTrafficQuery(message)) {
        const trafficEvents = await fetchTrafficEvents();
        liveDataContext += formatTrafficForContext(trafficEvents, message);
      }

      // Check for library/digital resources queries
      if (isLibraryQuery(message)) {
        const county = userLocation?.county || userProfile?.county || null;
        liveDataContext += getLibraryResourcesForContext(message, county);
      }

      // Check for SF city facilities queries (only for SF users)
      if (isFacilitiesQuery(message)) {
        const county = userLocation?.county || userProfile?.county || null;
        if (!county || county.toLowerCase() === 'san francisco') {
          const facilityType = message.toLowerCase().includes('senior')
            ? 'senior'
            : message.toLowerCase().includes('rec')
              ? 'recreation'
              : null;
          const facilities = await fetchSFCityFacilities(facilityType);
          liveDataContext += formatFacilitiesForContext(facilities);
        }
      }

      // Check for food truck queries (SF data)
      if (isFoodTruckQuery(message)) {
        const county = userLocation?.county || userProfile?.county || null;
        if (!county || county.toLowerCase() === 'san francisco') {
          const trucks = await fetchFoodTrucks(userLocation?.neighborhood || null);
          liveDataContext += formatFoodTrucksForContext(trucks);
        }
      }

      // Check for community resources/211 queries
      if (isCommunityResourceQuery(message)) {
        liveDataContext += getCommunityResourcesContext(message);
      }

      // Check for public services (police, fire, hospital, library) queries
      if (isPublicServicesQuery(message) || isLibraryQuery(message)) {
        const county = userLocation?.county || userProfile?.county || null;
        liveDataContext += getPublicServicesContext(message, county);
      }

      // Build language context based on site translation setting
      let languageContext = '';
      if (currentLocale && currentLocale !== 'en') {
        const langName = LANGUAGE_NAMES[currentLocale] || currentLocale;
        languageContext = `\n\n[LANGUAGE PREFERENCE]: The user has selected ${langName} as their preferred language. IMPORTANT: Respond in ${langName}. Keep program names, organization names, and acronyms (like CalFresh, Medi-Cal, BART) in English, but translate everything else. Be warm and conversational in ${langName}.`;
      }

      // Build messages array for Ollama chat API
      const messages = [
        {
          role: 'system',
          content:
            SYSTEM_PROMPT +
            languageContext +
            ragContext +
            cityContactContext +
            municipalCodeContext +
            californiaCodeContext +
            californiaResourcesContext +
            locationContext +
            profileContext +
            liveDataContext,
        },
        ...conversationHistory.slice(-6),
        { role: 'user', content: message },
      ];

      // Add timeout for slow connections (60 seconds - model can be slow with large context)
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60000);

      // Stream the response with optimized settings for speed and quality
      // Uses activeEndpoint (Tor .onion or regular HTTPS) and activeApiKey
      const response = await fetch(activeEndpoint, {
        signal: controller.signal,
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(activeApiKey && { Authorization: `Bearer ${activeApiKey}` }),
        },
        body: JSON.stringify({
          model: modelName,
          messages: messages,
          stream: true,
          think: false, // Disable thinking mode for faster responses
          options: {
            temperature: 0.5, // Lower for more consistent, focused responses
            num_predict: 300, // Allow longer responses
            num_ctx: 8192, // Larger context for system prompt + RAG context
            top_k: 40, // Slightly wider token selection for better quality
            top_p: 0.9, // Standard nucleus sampling
            repeat_penalty: 1.1, // Moderate repetition avoidance
          },
        }),
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error('Failed to get response');
      }

      // Remove loading indicator and create response bubble
      loadingEl?.remove();
      const responseBubble = createResponseBubble();
      let fullResponse = '';
      setCarlState('responding');

      // Handle streaming response
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (!line.trim()) continue;
          try {
            const json = JSON.parse(line);
            if (json.message?.content) {
              fullResponse += json.message.content;
              updateResponseBubble(responseBubble, fullResponse);
            }
          } catch (e) {
            // Skip non-JSON lines
          }
        }
      }

      // Update conversation history
      conversationHistory.push({ role: 'user', content: message });
      conversationHistory.push({ role: 'assistant', content: fullResponse });

      // Save conversation to local history (if enabled)
      saveCurrentConversation();

      // Add source citations for programs mentioned in response
      if (relevantPrograms.length > 0) {
        addCitationsToResponse(responseBubble, fullResponse, relevantPrograms);
      }

      // Add feedback buttons (thumbs up/down) to the response
      addFeedbackToResponse(responseBubble, message);

      // Add program cards if we found relevant programs AND this isn't just a location response
      // Skip showing programs when user is just answering "what's your location?"
      if (relevantPrograms.length > 0 && !isJustLocation) {
        addProgramCards(relevantPrograms);
      }

      // Add follow-up suggestions based on context
      addFollowUpSuggestions(message, fullResponse, userLocation);
    } catch (error) {
      console.error('Assistant error:', error);
      console.error('Error name:', error.name);
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
      loadingEl?.remove();
      setCarlState('error');
      setTimeout(() => setCarlState('idle'), 1500);

      // Show helpful error message with fallback
      let errorMessage;
      if (error.name === 'AbortError') {
        errorMessage =
          'That took too long. Try a shorter question, or search the directory directly.';
      } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
        errorMessage = 'Network error - please check your connection and try again.';
      } else {
        errorMessage =
          "I'm having trouble connecting. You can search the programs directly at baynavigator.org/directory";
        // Log additional debug info in dev
        console.error(
          'Full error details:',
          JSON.stringify(
            {
              name: error.name,
              message: error.message,
              stack: error.stack,
            },
            null,
            2
          )
        );
      }
      addMessage(errorMessage, 'assistant', true);

      // Still show program cards if we found any (RAG still works even if AI fails)
      // But not if this was just a location response
      if (relevantPrograms && relevantPrograms.length > 0 && !isJustLocation) {
        addProgramCards(relevantPrograms);
      }
    } finally {
      isLoading = false;
      sendBtn?.removeAttribute('disabled');
      // Return to idle state (unless error handler already set a state)
      if (!cloudIcon?.classList.contains('carl-cloud--error')) {
        setCarlState('idle');
      }
    }
  }

  function createResponseBubble() {
    const wrapper = document.createElement('div');
    wrapper.className = 'assistant-message';

    const bubble = document.createElement('div');
    bubble.className =
      'bg-neutral-100 dark:bg-neutral-700 rounded-2xl rounded-tl-sm p-3 max-w-[85%]';

    const text = document.createElement('p');
    text.className = 'text-sm text-neutral-800 dark:text-neutral-200 whitespace-pre-wrap';

    bubble.appendChild(text);
    wrapper.appendChild(bubble);
    messagesContainer?.appendChild(wrapper);

    return text;
  }

  function updateResponseBubble(element, text) {
    if (element) {
      // Parse markdown to DOM safely
      element.textContent = ''; // Clear existing content
      const parsed = parseMarkdownToDOM(text);
      element.appendChild(parsed);
      messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    }
  }

  // Lightweight markdown parser - builds DOM safely without innerHTML
  function parseMarkdownToDOM(text) {
    const container = document.createDocumentFragment();

    // Split into paragraphs (double newline)
    const paragraphs = text.split(/\n\n+/);

    paragraphs.forEach((para) => {
      const trimmedPara = para.trim();
      if (!trimmedPara) return;

      // Check if this is a list
      if (isListParagraph(trimmedPara)) {
        const list = parseList(trimmedPara);
        container.appendChild(list);
      } else {
        // Regular paragraph - handle single newlines as line breaks
        const p = document.createElement('span');
        p.className = 'block mb-2 last:mb-0';

        const lines = trimmedPara.split('\n');
        lines.forEach((line, lineIndex) => {
          parseInlineElements(line, p);
          if (lineIndex < lines.length - 1) {
            p.appendChild(document.createElement('br'));
          }
        });

        container.appendChild(p);
      }
    });

    return container;
  }

  // Check if a paragraph is a list
  function isListParagraph(text) {
    const lines = text.split('\n').filter((l) => l.trim());
    if (lines.length === 0) return false;
    // Check if all non-empty lines start with list markers
    return lines.every((line) => {
      const trimmed = line.trim();
      return /^[-*]\s/.test(trimmed) || /^\d+\.\s/.test(trimmed);
    });
  }

  // Parse a list paragraph into a DOM list element
  function parseList(text) {
    const lines = text.split('\n').filter((l) => l.trim());
    const isOrdered = /^\d+\./.test(lines[0].trim());
    const list = document.createElement(isOrdered ? 'ol' : 'ul');
    list.className = isOrdered
      ? 'list-decimal list-inside space-y-1 mb-2'
      : 'list-disc list-inside space-y-1 mb-2';

    lines.forEach((line) => {
      const li = document.createElement('li');
      li.className = 'text-sm';
      // Remove list marker
      const content = line
        .trim()
        .replace(/^[-*]\s*/, '')
        .replace(/^\d+\.\s*/, '');
      parseInlineElements(content, li);
      list.appendChild(li);
    });

    return list;
  }

  // Parse inline markdown elements (bold, italic, links) safely
  function parseInlineElements(text, container) {
    // Process text to find markdown patterns
    const patterns = [
      { regex: /\*\*([^*]+)\*\*/g, type: 'bold' },
      { regex: /\*([^*]+)\*/g, type: 'italic' },
      { regex: /\[([^\]]+)\]\(([^)]+)\)/g, type: 'link' },
    ];

    // Find all matches and their positions
    const matches = [];
    patterns.forEach(({ regex, type }) => {
      let match;
      const r = new RegExp(regex.source, 'g');
      while ((match = r.exec(text)) !== null) {
        matches.push({
          type,
          start: match.index,
          end: match.index + match[0].length,
          text: match[1],
          url: match[2] || null,
        });
      }
    });

    // Sort by position
    matches.sort((a, b) => a.start - b.start);

    // Remove overlapping matches (keep first)
    const filteredMatches = [];
    let lastEnd = 0;
    matches.forEach((m) => {
      if (m.start >= lastEnd) {
        filteredMatches.push(m);
        lastEnd = m.end;
      }
    });

    // Build DOM from matches
    let pos = 0;
    filteredMatches.forEach((m) => {
      // Add text before this match
      if (m.start > pos) {
        container.appendChild(document.createTextNode(text.slice(pos, m.start)));
      }

      // Create element for match
      if (m.type === 'bold') {
        const strong = document.createElement('strong');
        strong.className = 'font-semibold';
        strong.textContent = m.text;
        container.appendChild(strong);
      } else if (m.type === 'italic') {
        const em = document.createElement('em');
        em.textContent = m.text;
        container.appendChild(em);
      } else if (m.type === 'link') {
        const link = document.createElement('a');
        // Only allow safe URLs (internal paths or https)
        if (m.url && (m.url.startsWith('/') || m.url.startsWith('https://'))) {
          link.href = m.url;
          link.className = 'text-primary-600 dark:text-primary-400 hover:underline';
          if (m.url.startsWith('https://')) {
            link.rel = 'noopener noreferrer';
            link.target = '_blank';
          }
        }
        link.textContent = m.text;
        container.appendChild(link);
      }

      pos = m.end;
    });

    // Add remaining text (this also handles the case when there are no matches,
    // since pos will be 0 and text.slice(0) is the full text)
    if (pos < text.length) {
      container.appendChild(document.createTextNode(text.slice(pos)));
    }
  }

  // Escape special regex characters in program names
  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Create citation footer with links to mentioned programs
  function createCitationFooter(citations) {
    if (!citations || citations.length === 0) return null;

    const footer = document.createElement('div');
    footer.className = 'mt-3 pt-2 border-t border-neutral-200 dark:border-neutral-600';

    const label = document.createElement('p');
    label.className = 'text-xs text-neutral-500 dark:text-neutral-400 mb-1';
    label.textContent = 'Sources:';
    footer.appendChild(label);

    const list = document.createElement('ul');
    list.className = 'text-xs space-y-0.5';

    citations.forEach((citation, index) => {
      const item = document.createElement('li');
      const link = document.createElement('a');
      link.href = citation.url;
      link.className = 'text-primary-600 dark:text-primary-400 hover:underline';
      link.textContent = `[${index + 1}] ${citation.name}`;
      item.appendChild(link);
      list.appendChild(item);
    });

    footer.appendChild(list);
    return footer;
  }

  // Find programs mentioned in response and create citations
  function findCitedPrograms(responseText, relevantPrograms) {
    if (!relevantPrograms || relevantPrograms.length === 0) return [];

    const citations = [];
    const responseLower = responseText.toLowerCase();

    // Sort by name length (longest first) to avoid partial matches
    const sortedPrograms = [...relevantPrograms].sort(
      (a, b) => (b.name?.length || 0) - (a.name?.length || 0)
    );

    sortedPrograms.forEach((program) => {
      if (!program.name) return;

      // Check if program name appears in response (case-insensitive)
      const nameLower = program.name.toLowerCase();
      if (responseLower.includes(nameLower) && !citations.find((c) => c.id === program.id)) {
        citations.push({
          id: program.id,
          name: program.name,
          url: getProgramLink(program),
        });
      }
    });

    return citations;
  }

  // Add citations to the response bubble
  function addCitationsToResponse(responseBubble, responseText, relevantPrograms) {
    const citations = findCitedPrograms(responseText, relevantPrograms);
    if (citations.length === 0) return;

    const bubbleContainer = responseBubble.parentElement;
    if (bubbleContainer) {
      const citationFooter = createCitationFooter(citations);
      if (citationFooter) {
        bubbleContainer.appendChild(citationFooter);
      }
    }
  }

  // Create thumbs up/down feedback button
  function createThumbButton(sentiment, questionText) {
    const btn = document.createElement('button');
    btn.className =
      'p-1.5 rounded-lg transition-all hover:bg-neutral-200 dark:hover:bg-neutral-600 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300';
    btn.setAttribute('aria-label', sentiment === 'up' ? 'Helpful' : 'Not helpful');
    btn.dataset.sentiment = sentiment;

    // SVG icons
    if (sentiment === 'up') {
      btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
      </svg>`;
    } else {
      btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.737 3h4.017c.163 0 .326.02.485.06L17 4m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-6h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
      </svg>`;
    }

    return btn;
  }

  // Create feedback buttons container
  function createFeedbackButtons(questionText) {
    const wrapper = document.createElement('div');
    wrapper.className =
      'flex items-center gap-1 mt-2 pt-2 border-t border-neutral-200 dark:border-neutral-600';

    const label = document.createElement('span');
    label.className = 'text-xs text-neutral-400 dark:text-neutral-500 mr-1';
    label.textContent = 'Helpful?';

    const thumbsUp = createThumbButton('up', questionText);
    const thumbsDown = createThumbButton('down', questionText);

    // Click handlers
    const handleFeedback = (selectedBtn, otherBtn, sentiment) => {
      // Track feedback via analytics
      if (window.analytics?.trackCarlFeedback) {
        window.analytics.trackCarlFeedback(questionText, sentiment);
      }

      // Visual feedback - fill the selected button
      selectedBtn.classList.remove(
        'text-neutral-400',
        'hover:text-neutral-600',
        'dark:hover:text-neutral-300'
      );
      selectedBtn.classList.add(
        sentiment === 'up' ? 'text-green-500' : 'text-red-500',
        'cursor-default'
      );
      selectedBtn.querySelector('svg').setAttribute('fill', 'currentColor');

      // Disable both buttons
      selectedBtn.disabled = true;
      otherBtn.disabled = true;
      otherBtn.classList.add('opacity-30', 'cursor-default');
      otherBtn.classList.remove('hover:bg-neutral-200', 'dark:hover:bg-neutral-600');

      // Update label
      label.textContent = sentiment === 'up' ? 'Thanks!' : 'Thanks for feedback';

      // Emotive cloud animation on thumbs up
      if (sentiment === 'up') {
        setCarlState('happy');
        setTimeout(() => setCarlState('idle'), 600);
      }
    };

    thumbsUp.addEventListener('click', () => handleFeedback(thumbsUp, thumbsDown, 'up'));
    thumbsDown.addEventListener('click', () => handleFeedback(thumbsDown, thumbsUp, 'down'));

    wrapper.appendChild(label);
    wrapper.appendChild(thumbsUp);
    wrapper.appendChild(thumbsDown);

    return wrapper;
  }

  // Add feedback buttons to a response bubble
  function addFeedbackToResponse(responseBubble, questionText) {
    // Find the parent bubble container (the rounded div)
    const bubbleContainer = responseBubble.parentElement;
    if (bubbleContainer) {
      const feedbackButtons = createFeedbackButtons(questionText);
      bubbleContainer.appendChild(feedbackButtons);
    }
  }

  function addProgramCards(programs) {
    const wrapper = document.createElement('div');
    wrapper.className = 'assistant-message mt-2';

    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'space-y-2';

    // Header
    const header = document.createElement('p');
    header.className = 'text-xs text-neutral-500 dark:text-neutral-400 mb-2';
    header.textContent = 'Related programs:';
    cardsContainer.appendChild(header);

    // Track shown programs so we can offer alternatives if user says "already tried those"
    programs.forEach((program) => {
      if (program.id) {
        shownProgramIds.add(program.id);
      }
      const card = document.createElement('a');
      card.href = getProgramLink(program);
      card.className =
        'block bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-600 rounded-xl p-3 hover:border-primary-500 hover:shadow-md transition-all group';

      const inner = document.createElement('div');
      inner.className = 'flex items-center justify-between gap-2';

      const content = document.createElement('div');
      content.className = 'flex-1 min-w-0';

      const name = document.createElement('h4');
      name.className =
        'font-medium text-sm text-neutral-900 dark:text-white truncate group-hover:text-primary-600';
      name.textContent = program.name;
      content.appendChild(name);

      if (program.category) {
        const cat = document.createElement('span');
        cat.className = 'text-xs text-primary-600 dark:text-primary-400';
        cat.textContent = program.category;
        content.appendChild(cat);
      }

      inner.appendChild(content);

      // Arrow icon
      const arrow = document.createElement('div');
      arrow.className = 'text-neutral-400 group-hover:text-primary-500 transition-colors';
      arrow.innerHTML =
        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
      inner.appendChild(arrow);

      card.appendChild(inner);
      cardsContainer.appendChild(card);
    });

    wrapper.appendChild(cardsContainer);
    messagesContainer?.appendChild(wrapper);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
  }

  // Add contextual follow-up suggestions
  function addFollowUpSuggestions(userMessage, aiResponse, location) {
    const lowerResp = aiResponse.toLowerCase();
    const suggestions = [];

    // Don't show suggestions if Carl is asking for location or clarification
    if (
      lowerResp.includes('what city') ||
      lowerResp.includes('what zip') ||
      lowerResp.includes('where are you') ||
      lowerResp.includes('which county') ||
      lowerResp.includes('can you tell me more') ||
      lowerResp.includes('could you clarify')
    ) {
      return;
    }

    // Check if Carl actually mentioned specific programs in the response
    // Only offer "application" follow-ups if programs were discussed
    const mentionedPrograms =
      lowerResp.includes('calfresh') ||
      lowerResp.includes('medi-cal') ||
      lowerResp.includes('section 8') ||
      lowerResp.includes('snap') ||
      lowerResp.includes('wic') ||
      lowerResp.includes('care program') ||
      lowerResp.includes('lifeline') ||
      lowerResp.includes('calworks');

    const mentionedFood =
      lowerResp.includes('food') || lowerResp.includes('calfresh') || lowerResp.includes('pantry');
    const mentionedHealth =
      lowerResp.includes('medi-cal') ||
      lowerResp.includes('healthcare') ||
      lowerResp.includes('clinic');
    const mentionedHousing =
      lowerResp.includes('section 8') ||
      lowerResp.includes('housing') ||
      lowerResp.includes('rent');
    const mentionedUtilities =
      lowerResp.includes('utility') ||
      lowerResp.includes('care program') ||
      lowerResp.includes('lifeline');

    // If Carl mentioned specific programs, offer relevant follow-ups
    if (mentionedPrograms) {
      if (mentionedFood) {
        suggestions.push('What are the income limits?');
        suggestions.push('Where can I apply?');
      } else if (mentionedHealth) {
        suggestions.push('What does Medi-Cal cover?');
        suggestions.push('I need dental care');
      } else if (mentionedHousing) {
        suggestions.push('How do I get on the waitlist?');
        suggestions.push("I'm facing eviction");
      } else if (mentionedUtilities) {
        suggestions.push('How do I sign up for CARE?');
        suggestions.push('Help with internet too');
      }
    }

    // If no location yet and Carl didn't already ask, suggest providing one
    if (!location && suggestions.length === 0) {
      suggestions.push("I'm in San Francisco");
      suggestions.push("I'm in Oakland");
    }

    // Always offer to explore more if we have room
    if (suggestions.length > 0 && suggestions.length < 3) {
      suggestions.push('What else is available?');
    }

    // Only show 2-3 suggestions
    const finalSuggestions = suggestions.slice(0, 3);
    if (finalSuggestions.length === 0) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'flex flex-wrap gap-2 mt-3';

    finalSuggestions.forEach((suggestion) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className =
        'text-xs px-3 py-1.5 rounded-full bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 hover:bg-primary-100 dark:hover:bg-primary-900/50 transition-colors';
      btn.textContent = suggestion;
      btn.addEventListener('click', () => {
        if (input && !isLoading) {
          input.value = suggestion;
          sendMessage();
        }
      });
      wrapper.appendChild(btn);
    });

    messagesContainer?.appendChild(wrapper);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
  }

  function showCrisisDialog(type) {
    const isEmergency = type === 'emergency';
    const dialog = document.createElement('div');
    dialog.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4';

    const content = document.createElement('div');
    content.className = 'bg-white dark:bg-neutral-800 rounded-2xl max-w-md w-full p-6 shadow-2xl';

    content.innerHTML = `
      <div class="flex items-center gap-3 mb-4">
        <div class="w-12 h-12 rounded-full flex items-center justify-center ${isEmergency ? 'bg-red-100 dark:bg-red-900/30' : 'bg-blue-100 dark:bg-blue-900/30'}">
          <svg class="w-6 h-6 ${isEmergency ? 'text-red-600' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${
              isEmergency
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>'
            }
          </svg>
        </div>
        <h3 class="text-lg font-bold ${isEmergency ? 'text-red-700 dark:text-red-400' : 'text-blue-700 dark:text-blue-400'}">
          ${isEmergency ? 'Emergency Resources' : 'Crisis Support Available'}
        </h3>
      </div>
      <p class="text-neutral-600 dark:text-neutral-300 mb-6">
        ${
          isEmergency
            ? 'If you or someone else is in immediate danger, please call 911.'
            : "If you're experiencing a mental health crisis, help is available 24/7."
        }
      </p>
      <div class="space-y-3">
        ${
          isEmergency
            ? `<a href="tel:911" class="flex items-center gap-4 p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 hover:bg-red-100 transition-colors">
              <div class="flex-1">
                <div class="font-semibold text-neutral-900 dark:text-white">Emergency Services</div>
                <div class="text-sm text-red-600 font-medium">Call 911</div>
              </div>
            </a>`
            : `<a href="tel:988" class="flex items-center gap-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 transition-colors">
              <div class="flex-1">
                <div class="font-semibold text-neutral-900 dark:text-white">988 Suicide & Crisis Lifeline</div>
                <div class="text-sm text-blue-600 font-medium">Call or text 988</div>
              </div>
            </a>
            <a href="sms:741741&body=HOME" class="flex items-center gap-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 transition-colors">
              <div class="flex-1">
                <div class="font-semibold text-neutral-900 dark:text-white">Crisis Text Line</div>
                <div class="text-sm text-blue-600 font-medium">Text HOME to 741741</div>
              </div>
            </a>`
        }
      </div>
      <button type="button" class="w-full mt-4 py-2 text-sm text-neutral-600 dark:text-neutral-400 hover:text-neutral-800" id="crisis-dialog-close">
        Continue searching
      </button>
    `;

    dialog.appendChild(content);
    document.body.appendChild(dialog);

    dialog.addEventListener('click', (e) => {
      if (e.target === dialog || e.target.id === 'crisis-dialog-close') {
        dialog.remove();
      }
    });
  }

  function addMessage(text, role, isError = false) {
    const wrapper = document.createElement('div');
    wrapper.className = role === 'user' ? 'flex justify-end' : 'assistant-message';

    const bubble = document.createElement('div');
    if (role === 'user') {
      bubble.className = 'bg-primary-600 text-white rounded-2xl rounded-tr-sm p-3 max-w-[85%]';
    } else {
      bubble.className = `${isError ? 'bg-red-100 dark:bg-red-900/30' : 'bg-neutral-100 dark:bg-neutral-700'} rounded-2xl rounded-tl-sm p-3 max-w-[85%]`;
    }

    const textEl = document.createElement('p');
    textEl.className = `text-sm ${role === 'user' ? 'text-white' : 'text-neutral-800 dark:text-neutral-200'} whitespace-pre-wrap`;
    textEl.textContent = text;

    bubble.appendChild(textEl);
    wrapper.appendChild(bubble);
    messagesContainer?.appendChild(wrapper);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
  }

  function addLoadingIndicator() {
    const wrapper = document.createElement('div');
    wrapper.className = 'assistant-message loading-indicator';

    const bubble = document.createElement('div');
    bubble.className =
      'bg-neutral-100 dark:bg-neutral-700 rounded-2xl rounded-tl-sm p-3 max-w-[85%]';

    const dots = document.createElement('div');
    dots.className = 'flex gap-1';
    dots.innerHTML = `
      <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
      <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
      <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
    `;

    bubble.appendChild(dots);
    wrapper.appendChild(bubble);
    messagesContainer?.appendChild(wrapper);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    return wrapper;
  }
</script>

<style>
  .assistant-message {
    animation: fadeInUp 0.3s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Carl Cloud Icon Emotive States */
  .carl-cloud {
    transition: all 0.3s ease;
  }

  .carl-cloud--idle {
    animation: carl-breathe 3s ease-in-out infinite;
  }

  .carl-cloud--thinking {
    animation: carl-bounce 0.6s ease-in-out infinite;
  }

  .carl-cloud--responding {
    animation: carl-pulse 1s ease-in-out infinite;
  }

  .carl-cloud--error {
    animation: carl-shake 0.5s ease;
    background-color: rgba(239, 68, 68, 0.3) !important;
  }

  .carl-cloud--happy {
    animation: carl-sparkle 0.6s ease;
  }

  @keyframes carl-breathe {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  @keyframes carl-bounce {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-3px);
    }
  }

  @keyframes carl-pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }

  @keyframes carl-shake {
    0%,
    100% {
      transform: translateX(0);
    }
    20% {
      transform: translateX(-2px);
    }
    40% {
      transform: translateX(2px);
    }
    60% {
      transform: translateX(-2px);
    }
    80% {
      transform: translateX(2px);
    }
  }

  @keyframes carl-sparkle {
    0% {
      transform: scale(1);
      filter: brightness(1);
    }
    50% {
      transform: scale(1.15);
      filter: brightness(1.3);
    }
    100% {
      transform: scale(1);
      filter: brightness(1);
    }
  }
</style>
