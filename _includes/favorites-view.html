<!-- Print-only header for favorites -->
<div class="print-favorites-header" aria-hidden="true">
  <h1>My Saved Programs</h1>
  <p>Bay Area Discounts - bayareadiscounts.com</p>
  <p class="print-date">Generated: <span id="favorites-print-date"></span></p>
</div>

<div id="favorites-view" class="favorites-view" style="display: none;">
  <div class="favorites-header">
    <h2>My Saved Programs</h2>
    <div class="favorites-actions">
      <button id="clear-favorites" class="btn-secondary" type="button">Clear All</button>
      <button id="close-favorites" class="btn-primary" type="button">Back to All Programs</button>
    </div>
  </div>

  <!-- Print/Export Controls - Only for saved programs -->
  <div class="print-export-controls favorites-export" role="group" aria-label="Export saved programs">
    <button type="button" class="export-btn" id="print-favorites" aria-label="Print saved programs list">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="6 9 6 2 18 2 18 9"></polyline>
        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
        <rect x="6" y="14" width="12" height="8"></rect>
      </svg>
      <span>Print List</span>
    </button>
    <button type="button" class="export-btn" id="export-favorites-pdf" aria-label="Save saved programs as PDF">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="12" y1="18" x2="12" y2="12"></line>
        <line x1="9" y1="15" x2="15" y2="15"></line>
      </svg>
      <span>Save PDF</span>
    </button>
  </div>

  <div id="favorites-list" class="favorites-list">
    <!-- Favorites will be rendered here -->
  </div>
  
  <div id="no-favorites" class="no-results" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 1rem;">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
    </svg>
        <h3 data-i18n="favorites.empty">No saved programs yet</h3>
        <p data-i18n="favorites.empty_hint">Click the heart icon on any program to save it here</p>
  </div>
</div>

<!-- Favorites toggle button in header -->
<button id="view-favorites" class="favorites-toggle-btn" type="button" aria-label="View saved programs" aria-pressed="false">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
  </svg>
  <span>Saved</span>
  <span id="favorites-count" class="favorites-count" role="status" aria-live="polite">0</span>
</button>

<style>
/* Print/Export Controls for Favorites */
.print-export-controls.favorites-export {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.favorites-export .export-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: #374151;
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  min-height: 44px;
}

.favorites-export .export-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.favorites-export .export-btn:focus {
  outline: 3px solid #2563eb;
  outline-offset: 2px;
}

.favorites-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 0.5rem;
  color: #374151;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  min-height: 48px;
  color: #374151;
}

.favorites-toggle-btn:hover {
  background: #fef2f2;
  border-color: #ef4444;
  color: #ef4444;
}

.favorites-count {
  background: #ef4444;
  color: white;
  border-radius: 1rem;
  padding: 0.125rem 0.5rem;
  font-size: 0.75rem;
  font-weight: 700;
  min-width: 1.5rem;
  text-align: center;
}

.favorites-view {
  margin: 2rem auto;
  max-width: 1200px;
  padding: 0 1rem;
}

.favorites-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
  padding: 1.5rem;
  text-align: center;
  color: #374151;
}

.favorites-card h3 {
  margin-top: 0.5rem;
  color: #1f2937;
}

.favorites-card p {
  color: #4b5563;
}

.favorites-list .favorite-row {
  padding: 0.75rem 0;
  border-bottom: 1px solid #e5e7eb;
}

.favorites-list .favorite-row a {
  color: inherit;
  text-decoration: underline;
}

.favorites-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.favorites-header h2 {
  margin: 0;
  color: #111827;
}

.favorites-actions {
  display: flex;
  gap: 0.75rem;
}

.btn-primary,
.btn-secondary {
  padding: 0.75rem 1.25rem;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  min-height: 48px;
}

.btn-primary {
  background: #2563eb;
  color: white;
  border: 2px solid #2563eb;
}

.btn-primary:hover {
  background: #1e40af;
  border-color: #1e40af;
}

.btn-secondary {
  background: white;
  color: #6b7280;
  border: 2px solid #e5e7eb;
}

.btn-secondary:hover {
  background: #f9fafb;
  border-color: #d1d5db;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  .favorites-export .export-btn {
    background: #374151;
    color: #f3f4f6;
    border-color: #4b5563;
  }

  .favorites-export .export-btn:hover {
    background: #4b5563;
    border-color: #6b7280;
  }

  .favorites-toggle-btn {
    background: #21262d;
    border-color: #30363d;
    color: #e8eef5;
  }
  
  .favorites-toggle-btn:hover {
    background: #30363d;
    border-color: #f87171;
    color: #f87171;
  }
  
  .favorites-header h2 {
    color: #e8eef5;
  }
  
  .btn-primary {
    background: #2563eb;
    border-color: #2563eb;
  }
  
  .btn-secondary {
    background: #21262d;
    border-color: #30363d;
    color: #c9d1d9;
  }
  
  .btn-secondary:hover {
    background: #30363d;
  }

  .favorites-card {
    background: #111827;
    border-color: #30363d;
    color: #e5e7eb;
  }

  .favorites-card h3 {
    color: #e8eef5;
  }

  .favorites-card p {
    color: #cbd5e1;
  }
}

@media (max-width: 768px) {
  .favorites-header {
    flex-direction: column;
    align-items: stretch;
  }

  .favorites-actions {
    width: 100%;
  }

  .btn-primary,
  .btn-secondary {
    flex: 1;
  }
}

/* Data-theme dark mode support */
:root[data-theme="dark"] .favorites-export .export-btn,
body[data-theme="dark"] .favorites-export .export-btn {
  background: #374151;
  color: #f3f4f6;
  border-color: #4b5563;
}

:root[data-theme="dark"] .favorites-export .export-btn:hover,
body[data-theme="dark"] .favorites-export .export-btn:hover {
  background: #4b5563;
  border-color: #6b7280;
}

/* Print styles for favorites */
@media print {
  /* Hide all UI elements except favorites content */
  .favorites-header,
  .favorites-export,
  .favorites-toggle-btn,
  .favorites-actions,
  #view-favorites,
  .site-header,
  .utility-bar,
  footer,
  .mobile-bottom-nav,
  .mobile-filter-toggle,
  .search-panel,
  .filters-section,
  .quick-filters,
  .accessibility-toolbar,
  .skip-link,
  .step-flow-page,
  #search-results {
    display: none !important;
  }

  /* Show favorites view */
  .favorites-view {
    display: block !important;
    margin: 0;
    padding: 0;
  }

  .favorites-list {
    display: block !important;
  }

  .favorites-card {
    page-break-inside: avoid;
    border: 1px solid #e5e7eb !important;
    box-shadow: none !important;
    margin-bottom: 1rem;
    padding: 1rem;
    background: white !important;
    color: #111827 !important;
  }

  .favorites-card h3 {
    color: #111827 !important;
    font-size: 12pt;
    margin-bottom: 0.5rem;
  }

  .favorites-card p {
    color: #374151 !important;
    font-size: 10pt;
  }

  .favorites-card a {
    color: #2563eb !important;
    text-decoration: underline;
  }

  /* Print header for favorites */
  .print-favorites-header {
    display: block !important;
    text-align: center;
    padding: 1rem 0 1.5rem;
    border-bottom: 2px solid #2563eb;
    margin-bottom: 1.5rem;
  }

  .print-favorites-header h1 {
    font-size: 18pt;
    color: #111827;
    margin: 0 0 0.5rem 0;
  }

  .print-favorites-header p {
    font-size: 11pt;
    color: #6b7280;
    margin: 0;
  }

  @page {
    margin: 0.75in;
    size: letter;
  }

  body {
    color: #111827 !important;
    background: white !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}

/* Hide print header on screen */
.print-favorites-header {
  display: none;
}
</style>

<script>
(function() {
  let initialized = false;

  const init = () => {
    if (initialized) return;
    const viewFavoritesBtn = document.getElementById('view-favorites');
    const closeFavoritesBtn = document.getElementById('close-favorites');
    const clearFavoritesBtn = document.getElementById('clear-favorites');
    const printFavoritesBtn = document.getElementById('print-favorites');
    const exportPdfBtn = document.getElementById('export-favorites-pdf');
    const favoritesView = document.getElementById('favorites-view');
    const favoritesList = document.getElementById('favorites-list');
    const noFavorites = document.getElementById('no-favorites');
    const printDateEl = document.getElementById('favorites-print-date');
    const mainContent = document.getElementById('search-results') || document.getElementById('results');
    const searchPanel = document.querySelector('.search-panel');

    if (!viewFavoritesBtn || !favoritesView || !favoritesList || !noFavorites) return;
    if (!window.favorites) return;

    initialized = true;

    // Set print date
    function updatePrintDate() {
      if (printDateEl) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        printDateEl.textContent = new Date().toLocaleDateString('en-US', options);
      }
    }

    // Show favorites view
    viewFavoritesBtn.addEventListener('click', function() {
      renderFavorites();
      favoritesView.style.display = 'block';
      viewFavoritesBtn.setAttribute('aria-pressed', 'true');
      if (mainContent) mainContent.style.display = 'none';
      if (searchPanel) searchPanel.style.display = 'none';
    });

    // Close favorites view
    if (closeFavoritesBtn) {
      closeFavoritesBtn.addEventListener('click', function() {
        favoritesView.style.display = 'none';
        viewFavoritesBtn.setAttribute('aria-pressed', 'false');
        if (mainContent) mainContent.style.display = '';
        if (searchPanel) searchPanel.style.display = '';
      });
    }

    // Clear all favorites
    if (clearFavoritesBtn) {
      clearFavoritesBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to remove all saved programs?')) {
          window.favorites.clear();
          renderFavorites();
        }
      });
    }

    // Print favorites
    if (printFavoritesBtn) {
      printFavoritesBtn.addEventListener('click', function() {
        const favs = typeof window.favorites.list === 'function' ? window.favorites.list() : [];
        if (favs.length === 0) {
          alert('No saved programs to print. Save some programs first by clicking the heart icon.');
          return;
        }
        updatePrintDate();
        window.print();
      });
    }

    // Export favorites as PDF
    if (exportPdfBtn) {
      exportPdfBtn.addEventListener('click', function() {
        const favs = typeof window.favorites.list === 'function' ? window.favorites.list() : [];
        if (favs.length === 0) {
          alert('No saved programs to export. Save some programs first by clicking the heart icon.');
          return;
        }
        updatePrintDate();
        alert('In the print dialog that opens:\n\n1. Select "Save as PDF" as your destination\n2. Click "Save"\n\nYour saved programs will be exported with Bay Area Discounts branding.');
        window.print();
      });
    }

    // Update date before printing
    window.addEventListener('beforeprint', updatePrintDate);

    // Render favorites (lightweight list, no cloning)
    function renderFavorites() {
      const favs = typeof window.favorites.list === 'function' ? window.favorites.list() : [];

      if (!favs.length) {
        favoritesList.innerHTML = '';
        noFavorites.style.display = 'block';
        return;
      }

      noFavorites.style.display = 'none';

      const items = favs
        .map(f => `<div class="favorite-row favorites-card"><h3>${f.title}</h3><p><a href="${f.url}">${f.linkText}</a></p></div>`)
        .join('');

      favoritesList.innerHTML = items;
    }

    document.addEventListener('favoritesUpdated', renderFavorites);
  };

  if (window.favorites) {
    init();
  } else {
    document.addEventListener('favoritesReady', init, { once: true });
  }
})();
</script>
